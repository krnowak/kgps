# COMMENT: CHANGES:
# COMMENT: REQ_50 before REQ_3
# COMMENT: CHECKSETUP_AND_UPGRADE_SPEEDUP before REQ_28
# COMMENT: CHECKSETUP_AND_UPGRADE_SPEEDUP before REQ_54
From f39373e61601802fdd60bea7f36329f4fdf9344f Mon Sep 17 00:00:00 2001
From: Krzesimir Nowak <qdlacz@gmail.com>
Date: Sun, 25 May 2014 21:38:46 +0200
Subject: [PATCH] gnome

---
# SECTION: REQ_1_403_PAGE - Requirement 1: 403 Page
# SECTION: REQ_2_ADD_VERSION_SCRIPTS - Requirement 2: add-version.cgi and add-version.pl
# SECTION: REQ_9_REDIRECT_BUG_HELP_HTML - Requirement 9: redirect bug-HOWTO.html and bugwritinghelp.html
# SECTION: REQ_12_NO_CHANGER_COMMENTER - Requirement 12: No changer/commenter email in bugmails
# SECTION: REQ_13_SELF_GLOBALWATCHING - Requirement 13: Self-globalwatching
# SECTION: REQ_14_DISABLE_MAIL_FOR_AT_GNOME_BUGS - Requirement 14: Disable mail for @gnome.bugs users
# SECTION: REQ_15_CHANGE_CONSTANTS - Requirement 15: Change MAX_COMMENT_LENGTH and DEFAULT_COLUMN_LIST.
# SECTION: REQ_24_USER_IS_REPORTER - Requirement 24: Note that a user is the reporter in comments
# SECTION: REQ_46_REMOVE_BUG_FILE_LOC - Requirement 46: Remove bug_file_loc from the UI
# SECTION: REQ_63_KEYWORDS_FIELD_FOR_ANYBODY - Requirement 63: Anybody can set the Keywords field
# SECTION: REQ_53_REPORTER_CANNOT_UNWONTFIX - Requirement 53: Reporter can't un-WONTFIX
# SECTION: REQ_47_REMOVE_REP_PLATFORM - Requirement 47: Remove rep_platform
# SECTION: REQ_57_ADD_PRIORITY_TO_ICAL - Requirement 57: Add PRIORITY to the iCal buglist
# SECTION: REQ_36_LINK_TO_LISTS_IN_ERRORS - Requirement 36: Link to correct lists in errors
# SECTION: REQ_16_GNOME_VERSION_AND_TARGET - Requirement 16: gnome_version and gnome_target
# SECTION: REQ_50_FLOAT_RIGHT_INFO_BOX - Requirement 50: Float-right info box (and re-arrange show_bug).
# SECTION: CHECKSETUP_AND_UPGRADE_SPEEDUP - Further speed up checksetup by changing certain queries.
# SECTION: REQ_3_ATTACHMENT_STATUS - Requirement 3: Attachment Status
# SECTION: REQ_3_ATTACHMENT_STATUS_MODULE - Requirement 3: Attachment Status (add Bugzilla/AttachmentStatus.pm)
# SECTION: REQ_19_CLASSIFICATION_GNOME - Requirement 19: classification.is_gnome
# SECTION: REQ_8_BUG_BUDDY_CGI - Requirement 8: bugbuddy.cgi
# SECTION: REQ_28_NEEDINFO - Requirement 28: NEEDINFO status
# SECTION: REQ_34_MILESTONE_URL_TO_HOME_PAGE - Requirement 34: Milestone URL -> Home Page
# SECTION: REQ_35_PATCH_EQUALS_ATTACHMENT - Requirement 35: "patch" == "attachment"
# SECTION: REQ_44_X_COMPRESSED_TAR - Requirement 44: x-compressed-tar in attachment type list
# SECTION: REQ_59_CHANGE_COLUMN_LENGTHS - Requirement 59: Change buglist column lengths
# SECTION: REQ_64_NO_GNOME_1_X_AND_NOTXIMIAN - Requirement 64: GNOME1.x and NOTXIMIAN resolutions are obsolete
# SECTION: REQ_43_EXTRA_TEXT - Requirement 43: Extra text in certain templates
# SECTION: REQ_40_PORT_FORWARD - Requirement 40: Port forward various pages/
# SECTION: REQ_39_GNOME_SKIN - Requirement 39: GNOME Skin
# SECTION: REQ_54_REMOVE_CLOSED - Requirement 54: Remove the CLOSED status
# SECTION: REQ_31_MIGRATE_BUG_STATUS_HTML - Requirement 31: Migrate bug-status.html.tmpl
# SECTION: REQ_19_B_DISPLAY_STUFF_FOR_GNOME_ONLY - Requirement 19b: Only display gnome version/target fields for is_gnome classifications
# SECTION: REQ_20_DEVELOPERS_SYSTEM - Requirement 20: "Developers" system
# SECTION: REQ_23_NOTE_DEVELOPER - Requirement 23: Note that somebody is a Developer
# SECTION: BRAND_HEADER_AND_FRONT_PAGE - "Brand" the header and front page a bit with the term "GNOME".
# SECTION: REQ_4_BROWSE_CGI - Requirement 4: browse.cgi
# SECTION: REQ_48_REARRANGE_ENTER_BUG_CGI - Requirement 48: Re-arrange enter_bug.cgi
# SECTION: REQ_25_UNCONFIRMED_ENABLED - Requirement 25: Set products' vote fields so UNCONFIRMED is enabled in every product
# SECTION: CLEANUP_OLD_INDEXES - Clean up old, unused indexes when upgrading.
# SECTION: MOD_PERL_GNOME - Various mod_perl changes for GNOME.
# SECTION: BUG_FORMAT_COMMENT_HOOK -  Bug format comment hook.
# SECTION: TRACEPARSER_SPEEDUP - Speeding up traceparser.
# SECTION: MESSAGES_HOOK_BACKPORT - Backport the hook for messages.html.tmpl.
# SECTION: BACKWARD_COMPAT_QUERY - Implement backwards-compat for "query=" in buglist.cgi.
# SECTION: SAVED_SEARCHES - On upgrade, convert "query=" saved searches into standard saved searches.
# SECTION: DEFAULTFORMAT_SHORT_TO_SPECIFIC - The old GNOME Bugzilla had a "short" query.cgi format that isn't valid in the new Bugzilla, and so loading query.cgi with a DEFAULTFORMAT cookie set to "short" was throwing an error.
# SECTION: SHOW_PRODUCT_NAME_IN_MAIL - Make newchangedmail show product name.
# SECTION: NO_HYPHEN_ESCAPE - Hyphens in product names were being replaced by &8209; on enter_bug.cgi, making it hard to do find-as-you-type for them.
# SECTION: FIX_DESCRIPTION_UPDATING - Component description wasn't updating because the JS was looking for the assigned_to and qa_contact fields, which weren't there.
# SECTION: ADD_RESOLUTION_BACK - Add Resolution back into the bug summary box on show_bug.cgi.
# SECTION: SERVER_CONFIG_REWRITES_TO_HTACCESS - Move the rewrites that were in the server config to the .htaccess.
# SECTION: PATCH_REPORT_EXTENSION - Port custom report: reports/patch-report.cgi
# SECTION: STOCK_ANSWERS - Stock Responses
# SECTION: DESCRIBE_USER - Bring back describeuser.cgi (user home page)
# SECTION: WEEKLY_BUG_SUMMARY - Port custom report: reports/weekly-bug-summary.cgi
# SECTION: NO_LARGE_DATA_RETRIEVAL_WARNING - Add warnings regarding automatic data retrieval
# SECTION: XSS_IN_SHOW_BUG_CGI - (CVE-2013-0785) [SECURITY] XSS in show_bug.cgi when using an invalid page format
# SECTION: ESCAPE_LDAP_USERNAME - (CVE-2012-3981) [SECURITY] Missing escaping of the username can lead to LDAP injection
# SECTION: JS_TEMPLATE_SEE_ALL_BUGS - (CVE-2012-0466) [SECURITY] The JS template for buglists permits attackers to access all bugs that the victim can see
# SECTION: MISC - Miscellaneous changes
 .bzrignore.moved                                   |  44 ++
 .htaccess                                          |  26 +
 Bugzilla/Attachment.pm                             |  59 +-
 Bugzilla/AttachmentStatus.pm                       | 118 +++
 Bugzilla/Auth/Verify/LDAP.pm                       |   2 +
 Bugzilla/Browse.pm                                 | 334 +++++++++
 Bugzilla/Bug.pm                                    |  92 ++-
 Bugzilla/BugMail.pm                                |  13 +-
 Bugzilla/CGI.pm                                    |   5 +
 Bugzilla/Classification.pm                         |   5 +
 Bugzilla/Config/Query.pm                           |   2 +-
 Bugzilla/Constants.pm                              |   8 +-
 Bugzilla/DB.pm                                     |   1 +
 Bugzilla/DB/Mysql.pm                               | 122 +++-
 Bugzilla/DB/Schema.pm                              |  20 +-
 Bugzilla/DB/Schema/Mysql.pm                        |  24 +-
 Bugzilla/Error.pm                                  |   3 +
 Bugzilla/Field.pm                                  |   5 +-
 Bugzilla/Field/Choice.pm                           |  10 +-
 Bugzilla/Hook.pm                                   |  81 ++-
 Bugzilla/Install.pm                                |  32 +-
 Bugzilla/Install/DB.pm                             | 553 ++++++++++++---
 Bugzilla/Install/Filesystem.pm                     |   1 +
 Bugzilla/Product.pm                                | 107 +++
 Bugzilla/Search.pm                                 |  27 +-
 Bugzilla/Search/Quicksearch.pm                     |  10 +-
 Bugzilla/Status.pm                                 |   8 +-
 Bugzilla/Template.pm                               | 100 +--
 Bugzilla/Token.pm                                  |  13 +-
 Bugzilla/User.pm                                   |  75 +-
 Bugzilla/Util.pm                                   |   7 +-
 Bugzilla/WebService/Bug.pm                         |   3 +-
 add-version.c                                      |  25 +
 add-version.cgi                                    | 101 +++
 add-version.pl                                     |   7 +
 attachment.cgi                                     |  18 +-
 browse.cgi                                         | 236 ++++++
 buglist.cgi                                        |  26 +-
 colchange.cgi                                      |   2 +-
 contrib/recode.pl                                  |   2 +-
 docs/en/xml/Bugzilla-Guide.xml                     |   6 +-
 docs/en/xml/administration.xml                     |  83 +--
 docs/en/xml/using.xml                              |  10 -
 editclassifications.cgi                            |   5 +-
 editflagtypes.cgi                                  |   2 +-
 editproducts.cgi                                   |  12 +-
 editvalues.cgi                                     |   2 +
 enter_bug.cgi                                      |   1 +
 extensions/bugbuddy/code/config-add_panels.pl      |  25 +
 extensions/bugbuddy/code/webservice.pl             |  25 +
 extensions/bugbuddy/info.pl                        |  26 +
 extensions/bugbuddy/lib/ConfigBugBuddy.pm          |  54 ++
 extensions/bugbuddy/lib/WSBugBuddy.pm              | 212 ++++++
 .../en/default/admin/params/bugbuddy.html.tmpl     |  23 +
 .../email/bug-buddy-account-created.txt.tmpl       |  50 ++
 .../describe-user/code/page-before_template.pl     |   7 +
 extensions/describe-user/lib/DescribeUser/Hooks.pm | 316 +++++++++
 .../template/en/default/global/user.html.tmpl      |  42 ++
 .../en/default/pages/describeuser.html.tmpl        | 377 ++++++++++
 extensions/example/code/bug-format_comment.pl      |  31 +
 .../patch-report/code/page-before_template.pl      |   7 +
 extensions/patch-report/lib/PatchReport/Hooks.pm   | 271 +++++++
 .../en/default/pages/patchreport.html.tmpl         |  77 ++
 .../en/bug/edit-after_comment_textarea.html.tmpl   |  97 +++
 .../code/page-before_template.pl                   |   7 +
 .../lib/WeeklyBugSummary/Hooks.pm                  | 790 +++++++++++++++++++++
 .../en/default/pages/weekly-bug-summary.html.tmpl  | 163 +++++
 images/gnome-16.png                                | Bin 0 -> 650 bytes
 js/attachment.js                                   |   9 +
 js/browse.js                                       | 116 +++
 js/field.js                                        |  10 +-
 js/util.js                                         |  10 +-
 mod_perl.pl                                        |  11 +-
 page.cgi                                           |   6 +
 query.cgi                                          |  17 +-
 robots.txt                                         |   5 +
 sanitycheck.cgi                                    |   6 +-
 search_plugin.cgi                                  |   2 +-
 show_bug.cgi                                       |  11 +-
 skins/contrib/Dusk/show_bug.css                    |   4 +
 skins/contrib/GNOME/buglist.css                    |   3 +
 skins/contrib/GNOME/global.css                     | 141 ++++
 skins/standard/browse.css                          |  35 +
 skins/standard/show_bug.css                        |  25 +-
 template/en/custom/pages/email.html.tmpl           | 124 ++++
 template/en/custom/pages/points.html.tmpl          |  78 ++
 template/en/custom/pages/reports.html.tmpl         | 180 +++++
 template/en/default/account/prefs/email.html.tmpl  |  29 +-
 .../en/default/admin/classifications/add.html.tmpl |   4 +
 .../en/default/admin/classifications/del.html.tmpl |   4 +
 .../default/admin/classifications/edit.html.tmpl   |   7 +
 .../default/admin/classifications/select.html.tmpl |   4 +-
 .../admin/components/confirm-delete.html.tmpl      |   2 +-
 .../en/default/admin/fieldvalues/create.html.tmpl  |   7 +
 .../en/default/admin/fieldvalues/edit.html.tmpl    |   8 +
 .../en/default/admin/keywords/create.html.tmpl     |  24 +
 .../admin/products/confirm-delete.html.tmpl        |   2 +-
 .../default/admin/products/edit-common.html.tmpl   |   2 +
 .../en/default/admin/products/updated.html.tmpl    |   2 +-
 .../en/default/attachment/content-types.html.tmpl  |   1 +
 template/en/default/attachment/create.html.tmpl    |   2 +-
 .../attachment/createformcontents.html.tmpl        |  11 +-
 template/en/default/attachment/edit.html.tmpl      |  10 +
 template/en/default/attachment/list.html.tmpl      |  18 +-
 .../en/default/attachment/show-multiple.html.tmpl  |   2 +-
 template/en/default/browse/main.html.tmpl          | 457 ++++++++++++
 template/en/default/bug/comments.html.tmpl         |  12 +-
 .../en/default/bug/create/create-guided.html.tmpl  |  28 -
 template/en/default/bug/create/create.html.tmpl    | 145 +---
 .../en/default/bug/create/user-message.html.tmpl   |   4 +-
 template/en/default/bug/edit.html.tmpl             | 279 ++++----
 template/en/default/bug/field-events.js.tmpl       |  15 +
 template/en/default/bug/field.html.tmpl            |   3 +
 template/en/default/bug/knob.html.tmpl             |  12 +-
 template/en/default/bug/show-multiple.html.tmpl    |  15 -
 template/en/default/bug/show.xml.tmpl              |  10 +
 template/en/default/email/newchangedmail.txt.tmpl  |   5 +-
 .../en/default/global/choose-product.html.tmpl     |   2 +-
 template/en/default/global/code-error.html.tmpl    |   3 +-
 template/en/default/global/common-links.html.tmpl  |   3 +-
 template/en/default/global/field-descs.none.tmpl   |   2 -
 template/en/default/global/header.html.tmpl        |   7 +-
 template/en/default/global/messages.html.tmpl      |  22 +-
 template/en/default/global/user-error.html.tmpl    |  25 +-
 template/en/default/index.html.tmpl                |   6 +-
 template/en/default/list/edit-multiple.html.tmpl   |  29 +-
 template/en/default/list/list.ics.tmpl             |   1 +
 template/en/default/list/list.js.tmpl              |  37 -
 template/en/default/list/table.html.tmpl           |   5 +-
 template/en/default/pages/403.html.tmpl            |  11 +
 template/en/default/pages/fields.html.tmpl         | 286 +++++---
 .../en/default/pages/quicksearchhack.html.tmpl     |  17 -
 template/en/default/pages/release-notes.html.tmpl  |   6 -
 template/en/default/reports/components.html.tmpl   |   5 +-
 template/en/default/search/form.html.tmpl          |  28 +-
 template/en/default/search/search-help.html.tmpl   |   7 -
 template/en/default/search/search-plugin.xml.tmpl  |   6 +-
 .../default/search/search-report-select.html.tmpl  |   2 +-
 template/en/default/whine/mail.html.tmpl           |   1 -
 userprefs.cgi                                      |  11 +
 140 files changed, 6565 insertions(+), 922 deletions(-)
 create mode 100644 .bzrignore.moved
 create mode 100644 .htaccess
 create mode 100644 Bugzilla/AttachmentStatus.pm
 create mode 100644 Bugzilla/Browse.pm
 create mode 100644 add-version.c
 create mode 100755 add-version.cgi
 create mode 100755 add-version.pl
 create mode 100755 browse.cgi
 create mode 100644 extensions/bugbuddy/code/config-add_panels.pl
 create mode 100644 extensions/bugbuddy/code/webservice.pl
 create mode 100644 extensions/bugbuddy/info.pl
 create mode 100644 extensions/bugbuddy/lib/ConfigBugBuddy.pm
 create mode 100644 extensions/bugbuddy/lib/WSBugBuddy.pm
 create mode 100644 extensions/bugbuddy/template/en/default/admin/params/bugbuddy.html.tmpl
 create mode 100644 extensions/bugbuddy/template/en/default/email/bug-buddy-account-created.txt.tmpl
 create mode 100644 extensions/describe-user/code/page-before_template.pl
 create mode 100644 extensions/describe-user/lib/DescribeUser/Hooks.pm
 create mode 100644 extensions/describe-user/template/en/default/global/user.html.tmpl
 create mode 100644 extensions/describe-user/template/en/default/pages/describeuser.html.tmpl
 create mode 100644 extensions/example/code/bug-format_comment.pl
 create mode 100644 extensions/patch-report/code/page-before_template.pl
 create mode 100644 extensions/patch-report/lib/PatchReport/Hooks.pm
 create mode 100644 extensions/patch-report/template/en/default/pages/patchreport.html.tmpl
 create mode 100644 extensions/stock-answers/template/en/bug/edit-after_comment_textarea.html.tmpl
 create mode 100644 extensions/weekly-bug-summary/code/page-before_template.pl
 create mode 100644 extensions/weekly-bug-summary/lib/WeeklyBugSummary/Hooks.pm
 create mode 100644 extensions/weekly-bug-summary/template/en/default/pages/weekly-bug-summary.html.tmpl
 create mode 100644 images/gnome-16.png
 create mode 100644 js/browse.js
 create mode 100644 skins/contrib/Dusk/show_bug.css
 create mode 100644 skins/contrib/GNOME/buglist.css
 create mode 100644 skins/contrib/GNOME/global.css
 create mode 100644 skins/standard/browse.css
 create mode 100644 template/en/custom/pages/email.html.tmpl
 create mode 100644 template/en/custom/pages/points.html.tmpl
 create mode 100644 template/en/custom/pages/reports.html.tmpl
 create mode 100644 template/en/default/browse/main.html.tmpl
 delete mode 100644 template/en/default/list/list.js.tmpl
 create mode 100644 template/en/default/pages/403.html.tmpl

diff --git a/.bzrignore.moved b/.bzrignore.moved
new file mode 100644
index 0000000..f852cf1
--- /dev/null
+++ b/.bzrignore.moved
@@ -0,0 +1,44 @@
+./*/.htaccess
+./graphs
+./data
+./localconfig
+./index.html
+./old-params.txt
+./skins/custom
+./skins/contrib/Dusk/IE-fixes.css
+./skins/contrib/Dusk/admin.css
+./skins/contrib/Dusk/browse.css
+./skins/contrib/Dusk/create_attachment.css
+./skins/contrib/Dusk/dependency-tree.css
+./skins/contrib/Dusk/duplicates.css
+./skins/contrib/Dusk/editusers.css
+./skins/contrib/Dusk/help.css
+./skins/contrib/Dusk/index.css
+./skins/contrib/Dusk/panel.css
+./skins/contrib/Dusk/params.css
+./skins/contrib/Dusk/release-notes.css
+./skins/contrib/Dusk/setup.css
+./skins/contrib/Dusk/show_multiple.css
+./skins/contrib/Dusk/summarize-time.css
+./skins/contrib/Dusk/voting.css
+./skins/contrib/Dusk/yui
+./lib/*
+./skins/contrib/GNOME/IE-fixes.css
+./skins/contrib/GNOME/admin.css
+./skins/contrib/GNOME/browse.css
+./skins/contrib/GNOME/create_attachment.css
+./skins/contrib/GNOME/dependency-tree.css
+./skins/contrib/GNOME/duplicates.css
+./skins/contrib/GNOME/editusers.css
+./skins/contrib/GNOME/help.css
+./skins/contrib/GNOME/index.css
+./skins/contrib/GNOME/panel.css
+./skins/contrib/GNOME/params.css
+./skins/contrib/GNOME/release-notes.css
+./skins/contrib/GNOME/setup.css
+./skins/contrib/GNOME/show_bug.css
+./skins/contrib/GNOME/show_multiple.css
+./skins/contrib/GNOME/summarize-time.css
+./skins/contrib/GNOME/voting.css
+./skins/contrib/GNOME/yui/calendar.css
+./extensions/traceparser
diff --git a/.htaccess b/.htaccess
new file mode 100644
index 0000000..ba141d1
--- /dev/null
+++ b/.htaccess
@@ -0,0 +1,26 @@
# SECTION: REQ_1_403_PAGE
+# Don't allow people to retrieve non-cgi executable files or our private data
+<FilesMatch ^(.*\.pm|.*\.pl|.*localconfig.*)$>
+  deny from all
+</FilesMatch>
+
+<FilesMatch "\.cgi$">
+  ErrorDocument 403 /page.cgi?id=403.html
+</FilesMatch>
# SECTION: REQ_9_REDIRECT_BUG_HELP_HTML
+
+RewriteEngine On
+RewriteRule bug-HOWTO.html$ /page.cgi?id=bug-writing.html [R=301,L]
+RewriteRule bugwritinghelp.html$ /page.cgi?id=bug-writing.html [R=301,L]
# SECTION: REQ_3_ATTACHMENT_STATUS
+RewriteRule describeflagtypes.cgi$ /page.cgi?id=fields.html#attachments.status [NE,R=301,L]
# SECTION: REQ_8_BUG_BUDDY_CGI
+RewriteRule bugbuddy.cgi /xmlrpc.cgi [PT,L]
# SECTION: SERVER_CONFIG_REWRITES_TO_HTACCESS
+
+# 15 Jul 2006: ovitters: prevent some common names from being interpreted
+# as aliases
+RewriteRule ^/(dupfinder|reports)$ - [L]
+
+# Rewrite plain bug numbers
+# 15 Jul 2006: ovitters: and rewrite aliases as well.
+RewriteRule ^/([A-Za-z0-9]+)$ /show_bug.cgi?id=$1 [L,R]
+
+RewriteCond %{THE_REQUEST} id=472370
+#RewriteRule show_bug.cgi http://blogs.gnome.org/ovitters/2007/09/06/how-to-report-inappropriate-content-on-gnome-bugzilla/?
+RewriteRule show_bug.cgi http://www.gnome.org/?
diff --git a/Bugzilla/Attachment.pm b/Bugzilla/Attachment.pm
index 4aa74dc..7cecb1e 100644
--- a/Bugzilla/Attachment.pm
+++ b/Bugzilla/Attachment.pm
@@ -81,6 +81,7 @@ sub DB_COLUMNS {
# SECTION: REQ_3_ATTACHMENT_STATUS
         isprivate
         isurl
         mimetype
+        status
         modification_time
         submitter_id),
         $dbh->sql_date_format('attachments.creation_ts', '%Y.%m.%d %H:%i') . ' AS creation_ts';
@@ -281,6 +282,22 @@ sub isprivate {
# SECTION: REQ_3_ATTACHMENT_STATUS
 
 =over
 
+=item C<status>
+
+the attachment status
+
+=back
+
+=cut
+
+sub status {
+    my $self = shift;
+    return $self->{status};
+}
+
+
+=over
+
 =item C<is_viewable>
 
 Returns 1 if the attachment has a content-type viewable in this browser.
@@ -765,6 +782,27 @@ sub validate_obsolete {
# SECTION: REQ_3_ATTACHMENT_STATUS
     return @obsolete_attachments;
 }
 
+=item C<validate_status($throw_error)>
+
+Description: validates the attachment status
+
+Returns:     1 on success.
+
+=cut
+
+sub validate_status {
+    my ($class, $throw_error) = @_;
+    my $cgi = Bugzilla->cgi;
+
+    my ($field) = Bugzilla->get_fields({ name => 'attachments.status' });
+
+    (grep($_->name eq $cgi->param('attachments.status'),
+          @{$field->legal_values}))
+     || ($throw_error ? ThrowUserError("missing_attachment_status") : return 0);
+
+    return 1;
+}
+
 ###############################
 ####     Constructors     #####
 ###############################
@@ -862,6 +900,17 @@ sub create {
# SECTION: REQ_3_ATTACHMENT_STATUS
         $hr_vars->{'message'} = 'user_match_multiple';
     }
 
+    my $status;
+    if ($cgi->param('ispatch') and Bugzilla->user->in_group('editbugs')
+        and defined $cgi->param('attachments.status'))
+    {
+        $class->validate_status($throw_error) || return;
+        $status = $cgi->param('attachments.status');
+        trick_taint($status);
+    } else {
+        $status = 'none';
+    }
+
     # Escape characters in strings that will be used in SQL statements.
     my $description = $cgi->param('description');
     trick_taint($description);
@@ -871,9 +920,9 @@ sub create {
# SECTION: REQ_3_ATTACHMENT_STATUS
     my $sth = $dbh->do(
         "INSERT INTO attachments
             (bug_id, creation_ts, modification_time, filename, description,
-             mimetype, ispatch, isurl, isprivate, submitter_id)
-         VALUES (?,?,?,?,?,?,?,?,?,?)", undef, ($bug->bug_id, $timestamp, $timestamp,
-              $filename, $description, $contenttype, $cgi->param('ispatch'),
+             mimetype, status, ispatch, isurl, isprivate, submitter_id)
+         VALUES (?,?,?,?,?,?,?,?,?,?,?)", undef, ($bug->bug_id, $timestamp, $timestamp,
+              $filename, $description, $contenttype, $status, $cgi->param('ispatch'),
               $isurl, $isprivate, $user->id));
     # Retrieve the ID of the newly created attachment record.
     my $attachid = $dbh->bz_last_key('attachments', 'attach_id');
@@ -980,8 +1029,8 @@ sub remove_from_db {
# SECTION: REQ_3_ATTACHMENT_STATUS
     $dbh->bz_start_transaction();
     $dbh->do('DELETE FROM flags WHERE attach_id = ?', undef, $self->id);
     $dbh->do('DELETE FROM attach_data WHERE id = ?', undef, $self->id);
-    $dbh->do('UPDATE attachments SET mimetype = ?, ispatch = ?, isurl = ?, isobsolete = ?
-              WHERE attach_id = ?', undef, ('text/plain', 0, 0, 1, $self->id));
+    $dbh->do('UPDATE attachments SET mimetype = ?, ispatch = ?, isurl = ?, isobsolete = ?, status = ?
+              WHERE attach_id = ?', undef, ('text/plain', 0, 0, 1, 'none', $self->id));
     $dbh->bz_commit_transaction();
 }
 
diff --git a/Bugzilla/AttachmentStatus.pm b/Bugzilla/AttachmentStatus.pm
new file mode 100644
index 0000000..4ea5157
--- /dev/null
+++ b/Bugzilla/AttachmentStatus.pm
@@ -0,0 +1,118 @@
# SECTION: REQ_3_ATTACHMENT_STATUS_MODULE
+# -*- Mode: perl; indent-tabs-mode: nil -*-
+#
+# The contents of this file are subject to the Mozilla Public
+# License Version 1.1 (the "License"); you may not use this file
+# except in compliance with the License. You may obtain a copy of
+# the License at http://www.mozilla.org/MPL/
+#
+# Software distributed under the License is distributed on an "AS
+# IS" basis, WITHOUT WARRANTY OF ANY KIND, either express or
+# implied. See the License for the specific language governing
+# rights and limitations under the License.
+#
+# The Original Code is the Bugzilla Bug Tracking System.
+#
+# The Initial Developer of the Original Code is Everything Solved.
+# Portions created by Everything Solved are Copyright (C) 2009
+# Everything Solved. All Rights Reserved.
+#
+# Contributor(s): Bradley Baetz <bbaetz@everythingsolved.com>
+
+use strict;
+
+package Bugzilla::AttachmentStatus;
+
+use base qw(Bugzilla::Field::Choice);
+
+################################
+#####   Initialization     #####
+################################
+
+use constant DB_TABLE => 'attachment_status';
+
+# This has all the standard Bugzilla::Field::Choice columns plus "description"
+sub DB_COLUMNS {
+    return ($_[0]->SUPER::DB_COLUMNS, 'description');
+}
+
+sub UPDATE_COLUMNS {
+    return ($_[0]->SUPER::UPDATE_COLUMNS, 'description');
+}
+
+use constant PARENT_TABLE => 'attachments';
+
+###############################
+#####     Accessors        ####
+###############################
+
+sub description { return $_[0]->{'description'}; }
+
+# XXX - evil hack; this returns the number of bugs with
+# attachments with this flag set, for compat with everything else
+sub bug_count {
+    my $self = shift;
+    return $self->{bug_count} if defined $self->{bug_count};
+    my $dbh = Bugzilla->dbh;
+    my $fname = $self->field->name;
+    my $count;
+    $count = $dbh->selectrow_array("SELECT COUNT(DISTINCT bugs.bug_id)
+                                    FROM bugs, attachments, attachment_status
+                                    WHERE bugs.bug_id = attachments.bug_id
+                                    AND attachments.status = attachment_status.value
+                                    AND attachment_status.value = ?",
+                                    undef, $self->name);
+    $self->{bug_count} = $count;
+    return $count;
+}
+
+############
+# Mutators #
+############
+
+sub set_description { $_[0]->set('description', $_[1]);   }
+
+#####################################
+# Implement Bugzilla::Field::Choice #
+#####################################
+
+# This should be abstracted a bit more - the only thing different to the
+# parent class is that the field name is attachments.status not DB_TABLE
+sub field {
+    my $invocant = shift;
+    my $class = ref $invocant || $invocant;
+    my $cache = Bugzilla->request_cache;
+    $cache->{"field_$class"} ||= new Bugzilla::Field({ name => 'attachments.status' });
+    return $cache->{"field_$class"};
+}
+
+sub is_static {
+    my $self = shift;
+    return $self->name eq 'none';
+}
+
+# Default is hardcoded to 'none', not a param
+use constant is_default => 0;
+
+###############################
+#####       Methods        ####
+###############################
+
+1;
+
+__END__
+
+=head1 NAME
+
+Bugzilla::AttachmentStatus - Attachment status class.
+
+=head1 SYNOPSIS
+
+    use Bugzilla::AttachmentStatus;
+
+=head1 DESCRIPTION
+
+AttachmentStatus.pm represents an attachment status object. It is an
+implementation of L<Bugzilla::Object>, and thus provides all methods that
+L<Bugzilla::Object> provides.
+
+=cut
diff --git a/Bugzilla/Auth/Verify/LDAP.pm b/Bugzilla/Auth/Verify/LDAP.pm
index b590430..cad7d5d 100644
--- a/Bugzilla/Auth/Verify/LDAP.pm
+++ b/Bugzilla/Auth/Verify/LDAP.pm
@@ -41,6 +41,7 @@ use Bugzilla::User;
# SECTION: ESCAPE_LDAP_USERNAME
 use Bugzilla::Util;
 
 use Net::LDAP;
+use Net::LDAP::Util qw(escape_filter_value);
 
 use constant admin_can_create_account => 0;
 use constant user_can_create_account  => 0;
@@ -121,6 +122,7 @@ sub check_credentials {
# SECTION: ESCAPE_LDAP_USERNAME
 
 sub _bz_search_params {
     my ($username) = @_;
+    $username = escape_filter_value($username);
     return (base   => Bugzilla->params->{"LDAPBaseDN"},
             scope  => "sub",
             filter => '(&(' . Bugzilla->params->{"LDAPuidattribute"} 
diff --git a/Bugzilla/Browse.pm b/Bugzilla/Browse.pm
new file mode 100644
index 0000000..b8bafbb
--- /dev/null
+++ b/Bugzilla/Browse.pm
@@ -0,0 +1,334 @@
# SECTION: REQ_4_BROWSE_CGI
+# -*- Mode: perl; indent-tabs-mode: nil -*-
+#
+# The contents of this file are subject to the Mozilla Public
+# License Version 1.1 (the "License"); you may not use this file
+# except in compliance with the License. You may obtain a copy of
+# the License at http://www.mozilla.org/MPL/
+#
+# Software distributed under the License is distributed on an "AS
+# IS" basis, WITHOUT WARRANTY OF ANY KIND, either express or
+# implied. See the License for the specific language governing
+# rights and limitations under the License.
+#
+# The Original Code is the Bugzilla Bug Tracking System.
+#
+# The Initial Developer of the Original Code is Everything Solved.
+# Portions created by Everything Solved are Copyright (C) 2006 
+# Everything Solved. All Rights Reserved.
+#
+# Contributor(s): Dave Lawrence <dklawren@gmail.com>
+
+package Bugzilla::Browse;
+
+use strict;
+
+use base qw(Exporter);
+@Bugzilla::Browse::EXPORT = qw(
+    total_open_bugs
+    what_new_means
+    new_bugs
+    new_patches
+    keyword_bugs
+    no_response_bugs
+    critical_warning_bugs
+    string_bugs
+    by_patch_status
+    by_version
+    needinfo_split
+    by_target
+    by_priority
+    by_severity
+    by_component
+    by_assignee
+    gnome_target_development 
+    gnome_target_stable
+    list_blockers
+    browse_bug_link
+);
+
+use Bugzilla::User;
+use Bugzilla::Search;
+use Bugzilla::Field;
+use Bugzilla::Status;
+use Bugzilla::Util;
+use Bugzilla::Install::Util qw(vers_cmp);
+
+use constant IMPORTANT_PATCH_STATUSES => qw(
+    none
+    accepted-commit_now
+    accepted-commit_after_freeze
+);
+
+sub browse_open_states {
+    my $dbh = Bugzilla->dbh;
+    return join(",", map { $dbh->quote($_) } grep($_ ne "NEEDINFO", BUG_STATE_OPEN));
+}
+
+sub total_open_bugs {
+    my $product = shift;
+    my $dbh = Bugzilla->dbh;
+
+    return $dbh->selectrow_array("SELECT COUNT(bug_id) 
+                                    FROM bugs 
+                                   WHERE bug_status IN (" . browse_open_states() . ") 
+                                         AND product_id = ?", undef, $product->id);
+}
+
+sub what_new_means {
+    my $dbh = Bugzilla->dbh;
+    return $dbh->selectrow_array("SELECT NOW() - " . $dbh->sql_interval(7, 'DAY'));
+}
+
+sub new_bugs {
+    my $product = shift;
+    my $dbh = Bugzilla->dbh;
+
+    return $dbh->selectrow_array("SELECT COUNT(bug_id) 
+                                    FROM bugs 
+                                   WHERE bug_status IN (" . browse_open_states() . ") 
+                                         AND creation_ts >= NOW() - " . $dbh->sql_interval(7, 'DAY') . " 
+                                         AND product_id = ?", undef, $product->id);
+}
+
+sub new_patches {
+    my $product = shift;
+    my $dbh = Bugzilla->dbh;
+
+    return $dbh->selectrow_array("SELECT COUNT(attach_id) 
+                                    FROM bugs, attachments 
+                                   WHERE bugs.bug_id = attachments.bug_id
+                                         AND bug_status IN (" . browse_open_states() . ") 
+                                         AND attachments.ispatch = 1 AND attachments.isobsolete = 0
+                                         AND attachments.status = 'none' 
+                                         AND attachments.creation_ts >= NOW() - " . $dbh->sql_interval(7, 'DAY') . " 
+                                         AND product_id = ?", undef, $product->id);
+}
+
+sub keyword_bugs {
+    my ($product, $keyword) = @_;
+    my $dbh = Bugzilla->dbh;
+
+    return $dbh->selectrow_array("SELECT COUNT(bugs.bug_id) 
+                                    FROM bugs, keywords 
+                                   WHERE bugs.bug_id = keywords.bug_id 
+                                         AND bug_status IN (" . browse_open_states() . ") 
+                                         AND keywords.keywordid = ? 
+                                         AND product_id = ?", undef, ($keyword->id, $product->id));
+}
+
+sub no_response_bugs {
+    my $product = shift;
+    my $dbh = Bugzilla->dbh;
+    my @developer_ids = map { $_->id } @{$product->developers};
+
+    if (@developer_ids) {
+        return $dbh->selectcol_arrayref("SELECT bugs.bug_id
+                                           FROM bugs INNER JOIN longdescs ON longdescs.bug_id = bugs.bug_id 
+                                          WHERE bug_status IN (" . browse_open_states() . ") 
+                                                AND bug_severity != 'enhancement' 
+                                                AND product_id = ? 
+                                                AND bugs.reporter NOT IN (" . join(",", @developer_ids) . ") 
+                                          GROUP BY bugs.bug_id 
+                                         HAVING COUNT(distinct longdescs.who) = 1", undef, $product->id);
+    }
+    else {
+        return [];
+    }
+}
+
+sub critical_warning_bugs {
+    my $product = shift;
+    my $dbh = Bugzilla->dbh;
+ 
+    return $dbh->selectrow_array("SELECT COUNT(bugs.bug_id) 
+                                    FROM bugs INNER JOIN bugs_fulltext ON bugs_fulltext.bug_id = bugs.bug_id 
+                                   WHERE bug_status IN (" . browse_open_states() . ") 
+                                         AND " . $dbh->sql_fulltext_search("bugs_fulltext.comments_noprivate", "'+G_LOG_LEVEL_CRITICAL'") . " 
+                                         AND product_id = ?", undef, $product->id);
+}
+
+sub string_bugs {
+    my $product = shift;
+    my $dbh = Bugzilla->dbh;
+    
+    return $dbh->selectrow_array("SELECT COUNT(bugs.bug_id) 
+                                    FROM bugs, keywords, keyworddefs 
+                                   WHERE bugs.bug_id = keywords.bug_id 
+                                         AND keywords.keywordid = keyworddefs.id 
+                                         AND keyworddefs.name = 'string' 
+                                         AND bug_status IN (" . browse_open_states() . ") 
+                                         AND product_id = ?", undef, $product->id);
+}
+
+sub by_patch_status {
+    my $product = shift;
+    my $dbh = Bugzilla->dbh;
+
+    return $dbh->selectall_arrayref("SELECT attachments.status, COUNT(attach_id) 
+                                       FROM bugs, attachments
+                                      WHERE attachments.bug_id = bugs.bug_id 
+                                            AND bug_status IN (" . browse_open_states() . ") 
+                                            AND product_id = ? 
+                                            AND attachments.ispatch = 1 
+                                            AND attachments.isobsolete != 1 
+                                            AND attachments.status IN (" . join(",", map { $dbh->quote($_) } IMPORTANT_PATCH_STATUSES) . ") 
+                                            GROUP BY attachments.status", undef, $product->id);
+}
+
+sub browse_bug_link {
+    my $product = shift;
+    
+    return correct_urlbase() . 'buglist.cgi?product=' . url_quote($product->name) . 
+           join('' ,map { '&bug_status=' . url_quote($_) } grep ($_ ne "NEEDINFO", BUG_STATE_OPEN));
+}
+
+sub by_version {
+    my $product = shift;
+    my $dbh = Bugzilla->dbh;
+
+    my @result = sort { vers_cmp($a->[0], $b->[0]) } 
+        @{$dbh->selectall_arrayref("SELECT version, COUNT(bug_id) 
+                                      FROM bugs 
+                                     WHERE bug_status IN (" . browse_open_states() . ") 
+                                           AND product_id = ? 
+                                     GROUP BY version", undef, $product->id)};
+    
+    return \@result;
+}
+
+sub needinfo_split {
+    my $product = shift;
+    my $dbh = Bugzilla->dbh;
+
+    my $ni_a = Bugzilla::Search::SqlifyDate('-2w');
+    my $ni_b = Bugzilla::Search::SqlifyDate('-4w');
+    my $ni_c = Bugzilla::Search::SqlifyDate('-3m');
+    my $ni_d = Bugzilla::Search::SqlifyDate('-6m');
+    my $ni_e = Bugzilla::Search::SqlifyDate('-1y');
+    my $needinfo_case = "CASE WHEN delta_ts < '$ni_e' THEN 'F'
+                              WHEN delta_ts < '$ni_d' THEN 'E'
+                              WHEN delta_ts < '$ni_c' THEN 'D'
+                              WHEN delta_ts < '$ni_b' THEN 'C'
+                              WHEN delta_ts < '$ni_a' THEN 'B'
+                              ELSE 'A' END";
+
+    my %results = @{$dbh->selectcol_arrayref("SELECT $needinfo_case age, COUNT(bug_id) 
+                                       FROM bugs 
+                                      WHERE bug_status = 'NEEDINFO' 
+                                            AND product_id = ? 
+                                      GROUP BY $needinfo_case", { Columns=>[1,2] }, $product->id)};
+    return \%results;
+}
+
+sub by_target {
+    my $product = shift;
+    my $dbh = Bugzilla->dbh;
+
+    my @result = sort { vers_cmp($a->[0], $b->[0]) } 
+        @{$dbh->selectall_arrayref("SELECT target_milestone, COUNT(bug_id) 
+                                      FROM bugs 
+                                     WHERE bug_status IN (" . browse_open_states() . ") 
+                                           AND target_milestone != '---' 
+                                           AND product_id = ? 
+                                     GROUP BY target_milestone", undef, $product->id)};
+    
+    return \@result;
+}
+
+sub by_priority {
+    my $product = shift;
+    my $dbh = Bugzilla->dbh;
+
+    my $i = 0;
+    my %order_priority = map { $_ => $i++  } @{get_legal_field_values('priority')};
+    
+    my @result = sort { $order_priority{$a->[0]} <=> $order_priority{$b->[0]} } 
+        @{$dbh->selectall_arrayref("SELECT priority, COUNT(bug_id) 
+                                      FROM bugs 
+                                     WHERE bug_status IN (" . browse_open_states() . ") 
+                                           AND product_id = ? 
+                                     GROUP BY priority", undef, $product->id)};
+
+    return \@result;
+}
+
+sub by_severity {
+    my $product = shift;
+    my $dbh = Bugzilla->dbh;
+
+    my $i = 0;
+    my %order_severity = map { $_ => $i++  } @{get_legal_field_values('bug_severity')};
+
+    my @result = sort { $order_severity{$a->[0]} <=> $order_severity{$b->[0]} } 
+        @{$dbh->selectall_arrayref("SELECT bug_severity, COUNT(bug_id) 
+                                      FROM bugs 
+                                     WHERE bug_status IN (" . browse_open_states() . ") 
+                                           AND product_id = ? 
+                                     GROUP BY bug_severity", undef, $product->id)};
+
+    return \@result;
+}
+
+sub by_component {
+    my $product = shift;
+    my $dbh = Bugzilla->dbh;
+
+    return $dbh->selectall_arrayref("SELECT components.name, COUNT(bugs.bug_id) 
+                                       FROM bugs INNER JOIN components ON bugs.component_id = components.id 
+                                      WHERE bug_status IN (" . browse_open_states() . ") 
+                                            AND bugs.product_id = ? 
+                                      GROUP BY components.name", undef, $product->id);
+}
+
+sub by_assignee {
+    my $product = shift;
+    my $dbh = Bugzilla->dbh;
+
+    my @result = map { Bugzilla::User->new($_) } 
+        @{$dbh->selectall_arrayref("SELECT bugs.assignee AS userid, COUNT(bugs.bug_id) 
+                                      FROM bugs 
+                                     WHERE bug_status IN (" . browse_open_states() . ") 
+                                           AND bugs.product_id = ? 
+                                     GROUP BY components.name", undef, $product->id)};
+    
+    return \@result;
+}
+
+sub gnome_target_development { 
+    my @legal_gnome_target = @{get_legal_field_values('cf_gnome_target')};
+    return $legal_gnome_target[(scalar @legal_gnome_target) -1];
+}
+
+sub gnome_target_stable {
+    my @legal_gnome_target = @{get_legal_field_values('cf_gnome_target')};
+    return $legal_gnome_target[(scalar @legal_gnome_target) -2];
+}
+
+sub list_blockers {
+    my $product = shift;
+    my $dbh = Bugzilla->dbh;
+
+    my $sth = $dbh->prepare("SELECT bugs.bug_id, products.name AS product, bugs.bug_status, 
+                                        bugs.resolution, bugs.bug_severity, bugs.short_desc 
+                                   FROM bugs INNER JOIN products ON bugs.product_id = products.id
+                                  WHERE product_id = ? 
+                                        AND bugs.cf_gnome_target = ? 
+                                        AND bug_status IN (" . browse_open_states() . ") 
+                                  ORDER BY bug_id DESC");
+
+    my @list_blockers_development;
+    $sth->execute($product->id, gnome_target_development());
+    while (my $bug = $sth->fetchrow_hashref) {
+        push(@list_blockers_development, $bug);
+    }
+    
+    my @list_blockers_stable;
+    $sth->execute($product->id, gnome_target_stable());
+    while (my $bug = $sth->fetchrow_hashref) {
+        push(@list_blockers_stable, $bug);
+    }
+    
+    return (\@list_blockers_stable, \@list_blockers_development);
+}
+
+1;
diff --git a/Bugzilla/Bug.pm b/Bugzilla/Bug.pm
index 57094c9..6a88182 100644
--- a/Bugzilla/Bug.pm
+++ b/Bugzilla/Bug.pm
@@ -853,6 +853,7 @@ sub update {
# SECTION: REQ_53_REPORTER_CANNOT_UNWONTFIX
     # Remove obsolete internal variables.
     delete $self->{'_old_assigned_to'};
     delete $self->{'_old_qa_contact'};
+    delete $self->{'_old_resolution'};
 
     # Also flush the visible_bugs cache for this bug as the user's
     # relationship with this bug may have changed.
@@ -1068,26 +1069,15 @@ sub _check_bug_status {
# SECTION: REQ_48_REARRANGE_ENTER_BUG_CGI
         @valid_statuses = @{Bugzilla::Status->can_change_to()};
     }
 
-    if (!$product->votes_to_confirm) {
-        # UNCONFIRMED becomes an invalid status if votes_to_confirm is 0,
-        # even if you are in editbugs.
-        @valid_statuses = grep {$_->name ne 'UNCONFIRMED'} @valid_statuses;
-    }
-
     # Check permissions for users filing new bugs.
     if (!ref $invocant) {
-        if ($user->in_group('editbugs', $product->id)
-            || $user->in_group('canconfirm', $product->id)) {
-            # If the user with privs hasn't selected another status,
-            # select the first one of the list.
-            unless ($new_status) {
-                if (scalar(@valid_statuses) == 1) {
-                    $new_status = $valid_statuses[0];
-                }
-                else {
-                    $new_status = ($valid_statuses[0]->name ne 'UNCONFIRMED') ?
-                                  $valid_statuses[0] : $valid_statuses[1];
-                }
+        # If a user is a developer in a particular product, he always files bugs as NEW
+        if ($user->is_developer($product)) {
+            if (grep {$_->name eq 'NEW'} @valid_statuses) {
+                $new_status = 'NEW';
+            }
+            else {
+                $new_status = $valid_statuses[0];
             }
         }
         else {
@@ -1182,8 +1172,8 @@ sub _check_comment_type {
# SECTION: REQ_36_LINK_TO_LISTS_IN_ERRORS
 sub _check_component {
     my ($invocant, $name, $product) = @_;
     $name = trim($name);
-    $name || ThrowUserError("require_component");
     ($product = $invocant->product_obj) if ref $invocant;
+    $name || ThrowUserError("require_component", { product => $product });
     my $obj = Bugzilla::Component->check({ product => $product, name => $name });
     return $obj;
 }
@@ -1409,11 +1399,6 @@ sub _check_keywords {
# SECTION: REQ_63_KEYWORDS_FIELD_FOR_ANYBODY
     $keyword_string = trim($keyword_string);
     return [] if !$keyword_string;
     
-    # On creation, only editbugs users can set keywords.
-    if (!ref $invocant) {
-        return [] if !Bugzilla->user->in_group('editbugs', $product->id);
-    }
-    
     my %keywords;
     foreach my $keyword (split(/[\s,]+/, $keyword_string)) {
         next unless $keyword;
@@ -2069,6 +2054,8 @@ sub set_resolution {
# SECTION: REQ_53_REPORTER_CANNOT_UNWONTFIX
     my ($self, $value, $params) = @_;
     
     my $old_res = $self->resolution;
+    # Store the old resolution. check_can_change_field() needs it.
+    $self->{'_old_resolution'} = $old_res;
     $self->set('resolution', $value);
     my $new_res = $self->resolution;
 
@@ -2105,6 +2092,7 @@ sub clear_resolution {
# SECTION: REQ_53_REPORTER_CANNOT_UNWONTFIX
     if (!$self->status->is_open) {
         ThrowUserError('resolution_cant_clear', { bug_id => $self->id });
     }
+    $self->{'_old_resolution'} = $self->resolution;
     $self->{'resolution'} = ''; 
     $self->_clear_dup_id; 
 }
@@ -2118,7 +2106,9 @@ sub set_status {
# SECTION: REQ_28_NEEDINFO
     
     if ($new_status->is_open) {
         # Check for the everconfirmed transition
-        $self->_set_everconfirmed($new_status->name eq 'UNCONFIRMED' ? 0 : 1);
+        if ($new_status->name ne 'NEEDINFO') {
+            $self->_set_everconfirmed($new_status->name eq 'UNCONFIRMED' ? 0 : 1);
+        }
         $self->clear_resolution();
     }
     else {
@@ -2588,6 +2578,15 @@ sub classification {
# SECTION: REQ_19_B_DISPLAY_STUFF_FOR_GNOME_ONLY
     return $self->{classification};
 }
 
+sub classification_obj {
+    my ($self) = @_;
+    return $self->{classification_obj} if defined $self->{classification_obj};
+    return {} if $self->{error};
+    $self->{classification_obj} =
+        new Bugzilla::Classification($self->classification_id);
+    return $self->{classification_obj};
+}
+
 sub dependson {
     my ($self) = @_;
     return $self->{'dependson'} if exists $self->{'dependson'};
@@ -2738,6 +2737,18 @@ sub show_attachment_flags {
# SECTION: REQ_3_ATTACHMENT_STATUS
     return $self->{'show_attachment_flags'};
 }
 
+sub show_attachment_status {
+    my ($self) = @_;
+    return $self->{'show_attachment_status'} 
+        if exists $self->{'show_attachment_status'};
+    return 0 if $self->{'error'};
+
+    $self->{'show_attachment_status'} =
+        grep { $_->ispatch } @{$self->attachments};
+
+    return $self->{'show_attachment_status'};
+}
+
 sub use_votes {
     my ($self) = @_;
     return 0 if $self->{'error'};
@@ -3429,6 +3440,10 @@ sub check_can_change_field {
# SECTION: REQ_63_KEYWORDS_FIELD_FOR_ANYBODY
     if ($field =~ /^longdesc/) {
         return 1;
     }
+    # And keywords
+    if ($field eq 'keywords') {
+        return 1;
+    }
 
     # If the user isn't allowed to change a field, we must tell him who can.
     # We store the required permission set into the $PrivilegesRequired
@@ -3448,6 +3463,12 @@ sub check_can_change_field {
# SECTION: REQ_16_GNOME_VERSION_AND_TARGET
         }
     }
 
+    # GNOME: require loads of priviledges to change the GNOME target field
+    if ($field eq 'cf_gnome_target' && !$user->in_group('editclassifications')) {
+        $$PrivilegesRequired = 3;
+        return 0;
+    }
+
     # Allow anyone with (product-specific) "editbugs" privs to change anything.
     if ($user->in_group('editbugs', $self->{'product_id'})) {
         return 1;
@@ -3511,6 +3532,20 @@ sub check_can_change_field {
# SECTION: REQ_53_REPORTER_CANNOT_UNWONTFIX
         $$PrivilegesRequired = 2;
         return 0;
     }
+    # - change the status/resolution if the bug is WONTFIX
+    # Note that we have to check against the old resolution
+    # value not the current one, because the order of the fields
+    # passed to this sub is undefined, and if resolution is
+    # checked first then it could be changed to WONTFIX and the
+    # subsequent bug_status check would fail
+    if ($field eq 'bug_status' or $field eq 'resolution') {
+        my $oldres = exists $self->{'_old_resolution'} ?
+            $self->{'_old_resolution'} : $self->resolution;
+        if ($oldres eq 'WONTFIX') {
+            $$PrivilegesRequired = 2;
+            return 0;
+        }
+    }
     # - unconfirm bugs (confirming them is handled above)
     if ($field eq 'everconfirmed') {
         $$PrivilegesRequired = 2;
@@ -3520,8 +3555,11 @@ sub check_can_change_field {
# SECTION: REQ_28_NEEDINFO
     if ($field eq 'bug_status'
         && is_open_state($oldvalue) && is_open_state($newvalue)) 
     {
-       $$PrivilegesRequired = 2;
-       return 0;
+       # Though they can change from NEEDINFO -> UNCONFIRMED
+       if (!($oldvalue eq 'NEEDINFO' and $newvalue eq 'UNCONFIRMED')) {
+           $$PrivilegesRequired = 2;
+           return 0;
+       }
     }
 
     # The reporter is allowed to change anything else.
diff --git a/Bugzilla/BugMail.pm b/Bugzilla/BugMail.pm
index 55a9598..a96f18c 100644
--- a/Bugzilla/BugMail.pm
+++ b/Bugzilla/BugMail.pm
@@ -137,8 +137,11 @@ sub Send {
# SECTION: REQ_19_B_DISPLAY_STUFF_FOR_GNOME_ONLY
 
     my $product = new Bugzilla::Product($values{product_id});
     $values{product} = $product->name;
+    my $is_gnome = 0;
     if (Bugzilla->params->{'useclassification'}) {
-        $values{classification} = Bugzilla::Classification->new($product->classification_id)->name;
+        my $c = Bugzilla::Classification->new($product->classification_id);
+        $values{classification} = $c->name;
+        $is_gnome = $c->is_gnome;
     }
     my $component = new Bugzilla::Component($values{component_id});
     $values{component} = $component->name;
@@ -257,9 +260,16 @@ sub Send {
# SECTION: REQ_19_B_DISPLAY_STUFF_FOR_GNOME_ONLY
     foreach my $ref (@$diffs) {
         my ($who, $whoname, $what, $when, $old, $new, $attachid, $fieldname) = (@$ref);
         my $diffpart = {};
+
+        # Only show these if the bug is a gnome classification
+        next if (!$is_gnome &&
+                 ($fieldname eq 'cf_gnome_target'
+                  || $fieldname eq 'cf_gnome_version'));
+
# SECTION: REQ_12_NO_CHANGER_COMMENTER
         if ($who ne $lastwho) {
             $lastwho = $who;
             $fullwho = $whoname ? "$whoname <$who>" : $who;
+            $fullwho = email_filter($fullwho, 'force');
             $diffheader = "\n$fullwho changed:\n\n";
             $diffheader .= three_columns("What    ", "Removed", "Added");
             $diffheader .= ('-' x 76) . "\n";
@@ -627,6 +637,7 @@ sub sendMail {
# SECTION: SHOW_PRODUCT_NAME_IN_MAIL
         severity => $values{'bug_severity'},
         status => $values{'bug_status'},
         priority => $values{'priority'},
+        version => $values{'version'},
         assignedto => $values{'assigned_to'},
         assignedtoname => Bugzilla::User->new({name => $values{'assigned_to'}})->name,
         targetmilestone => $values{'target_milestone'},
diff --git a/Bugzilla/CGI.pm b/Bugzilla/CGI.pm
index 5f81a5b..356214f 100644
--- a/Bugzilla/CGI.pm
+++ b/Bugzilla/CGI.pm
@@ -374,6 +374,11 @@ sub remove_cookie {
# SECTION: REQ_8_BUG_BUDDY_CGI
 # Redirect to https if required
 sub require_https {
     my ($self, $url) = @_;
+
+    # For GNOME, bugbuddy.cgi is exempted from this forced redirect,
+    # because it does not handle it properly.
+    return if ($ENV{REQUEST_URI} and $ENV{REQUEST_URI} =~ m{^/bugbuddy.cgi});
+
     # Do not create query string if data submitted via XMLRPC
     # since we want the data to be resubmitted over POST method.
     my $query = Bugzilla->usage_mode == USAGE_MODE_WEBSERVICE ? 0 : 1;
diff --git a/Bugzilla/Classification.pm b/Bugzilla/Classification.pm
index a7f59b4..39c94ba 100644
--- a/Bugzilla/Classification.pm
+++ b/Bugzilla/Classification.pm
@@ -38,6 +38,7 @@ use constant DB_COLUMNS => qw(
# SECTION: REQ_19_CLASSIFICATION_GNOME
     name
     description
     sortkey
+    is_gnome
 );
 
 use constant REQUIRED_CREATE_FIELDS => qw(
@@ -48,12 +49,14 @@ use constant UPDATE_COLUMNS => qw(
# SECTION: REQ_19_CLASSIFICATION_GNOME
     name
     description
     sortkey
+    is_gnome
 );
 
 use constant VALIDATORS => {
     name        => \&_check_name,
     description => \&_check_description,
     sortkey     => \&_check_sortkey,
+    is_gnome    => \&Bugzilla::Object::check_boolean,
 };
 
 ###############################
@@ -122,6 +125,7 @@ sub _check_sortkey {
# SECTION: REQ_19_CLASSIFICATION_GNOME
 sub set_name        { $_[0]->set('name', $_[1]); }
 sub set_description { $_[0]->set('description', $_[1]); }
 sub set_sortkey     { $_[0]->set('sortkey', $_[1]); }
+sub set_is_gnome    { $_[0]->set('is_gnome', $_[1]); }
 
 sub product_count {
     my $self = shift;
@@ -156,6 +160,7 @@ sub products {
# SECTION: REQ_19_CLASSIFICATION_GNOME
 
 sub description { return $_[0]->{'description'}; }
 sub sortkey     { return $_[0]->{'sortkey'};     }
+sub is_gnome    { return $_[0]->{'is_gnome'};    }
 
 1;
 
diff --git a/Bugzilla/Config/Query.pm b/Bugzilla/Config/Query.pm
index fbfdb4c..0abf308 100644
--- a/Bugzilla/Config/Query.pm
+++ b/Bugzilla/Config/Query.pm
@@ -58,7 +58,7 @@ sub get_param_list {
# SECTION: DESCRIBE_USER
   {
    name => 'mybugstemplate',
    type => 't',
-   default => 'buglist.cgi?bug_status=UNCONFIRMED&amp;bug_status=NEW&amp;bug_status=ASSIGNED&amp;bug_status=REOPENED&amp;emailassigned_to1=1&amp;emailreporter1=1&amp;emailtype1=exact&amp;email1=%userid%&amp;field0-0-0=bug_status&amp;type0-0-0=notequals&amp;value0-0-0=UNCONFIRMED&amp;field0-0-1=reporter&amp;type0-0-1=equals&amp;value0-0-1=%userid%'
+   default => 'page.cgi?id=describeuser.html'
   },
 
   {
diff --git a/Bugzilla/Constants.pm b/Bugzilla/Constants.pm
index 2083e9f..fc397d7 100644
--- a/Bugzilla/Constants.pm
+++ b/Bugzilla/Constants.pm
@@ -134,6 +134,7 @@ use File::Basename;
# SECTION: REQ_8_BUG_BUDDY_CGI
     ERROR_MODE_WEBPAGE
     ERROR_MODE_DIE
     ERROR_MODE_DIE_SOAP_FAULT
+    ERROR_MODE_BUGBUDDY
 
     INSTALLATION_MODE_INTERACTIVE
     INSTALLATION_MODE_NON_INTERACTIVE
@@ -172,7 +173,7 @@ use File::Basename;
 # CONSTANTS
 #
 # Bugzilla version
-use constant BUGZILLA_VERSION => "3.4.14+";
+use constant BUGZILLA_VERSION => "3.4.13";
 
 # These are unique values that are unlikely to match a string or a number,
 # to be used in criteria for match() functions and other things. They start
@@ -262,7 +263,7 @@ use constant MAILTO_GROUP => 1;
# SECTION: REQ_15_CHANGE_CONSTANTS
 
 # The default list of columns for buglist.cgi
 use constant DEFAULT_COLUMN_LIST => (
-    "bug_severity", "priority", "op_sys","assigned_to",
+    "bug_severity", "priority", "op_sys", "product",
     "bug_status", "resolution", "short_desc"
 );
 
@@ -277,7 +278,7 @@ use constant LIST_OF_BUGS => 1;
# SECTION: REQ_15_CHANGE_CONSTANTS
 # The column length for displayed (and wrapped) bug comments.
 use constant COMMENT_COLS => 80;
 # Used in _check_comment(). Gives the max length allowed for a comment.
-use constant MAX_COMMENT_LENGTH => 65535;
+use constant MAX_COMMENT_LENGTH => 131072;
 
 # The type of bug comments.
 use constant CMT_NORMAL => 0;
@@ -392,6 +393,7 @@ use constant USAGE_MODE_EMAIL      => 3;
# SECTION: REQ_8_BUG_BUDDY_CGI
 use constant ERROR_MODE_WEBPAGE        => 0;
 use constant ERROR_MODE_DIE            => 1;
 use constant ERROR_MODE_DIE_SOAP_FAULT => 2;
+use constant ERROR_MODE_BUGBUDDY       => 999;
 
 # The various modes that checksetup.pl can run in.
 use constant INSTALLATION_MODE_INTERACTIVE => 0;
diff --git a/Bugzilla/DB.pm b/Bugzilla/DB.pm
index 9ede5bd..d873e15 100644
--- a/Bugzilla/DB.pm
+++ b/Bugzilla/DB.pm
@@ -444,6 +444,7 @@ sub bz_setup_foreign_keys {
# SECTION: CHECKSETUP_AND_UPGRADE_SPEEDUP
     # items from _bz_real_schema.
     my @tables = $self->_bz_schema->get_table_list();
     foreach my $table (@tables) {
+        next if $table eq 'bugs_fulltext';
         my @columns = $self->_bz_schema->get_table_columns($table);
         foreach my $column (@columns) {
             my $def = $self->_bz_schema->get_column_abstract($table, $column);
diff --git a/Bugzilla/DB/Mysql.pm b/Bugzilla/DB/Mysql.pm
index 3a1c4ae..5a8dfd9 100644
--- a/Bugzilla/DB/Mysql.pm
+++ b/Bugzilla/DB/Mysql.pm
@@ -348,6 +348,34 @@ EOT
# SECTION: CHECKSETUP_AND_UPGRADE_SPEEDUP
 
     my ($sd_index_deleted, $longdescs_index_deleted);
     my @tables = $self->bz_table_list_real();
+
+    # For GNOME, we need to speed up the very long (20+ hours)
+    # upgrade process. We do this by taking all the largest tables
+    # and copying them over into a new version of themselves directly,
+    # or performing large changes before the InnoDB conversion.
+    if (grep($_ eq 'bz_schema', @tables)) {
+        if (!$self->bz_column_info('longdescs', 'comment_id')) {
+            $self->bz_rename_table('longdescs', 'longdescs_old');
+            $self->bz_add_table('longdescs');
+            print "Populating longdescs...\n";
+            $self->do('INSERT INTO longdescs (bug_id, who, bug_when, thetext,
+                                              work_time, isprivate, 
+                                              already_wrapped)
+                            SELECT bug_id, who, bug_when, thetext, work_time, 
+                                   isprivate, already_wrapped
+                              FROM longdescs_old ORDER BY bug_when');
+            $self->bz_drop_table('longdescs_old');
+        }
+
+        if (!$self->bz_table_info('attach_data')) {
+            require Bugzilla::Install::DB;
+            $self->bz_add_table('attach_data');
+            $self->do("ALTER TABLE attach_data AVG_ROW_LENGTH=1000000,
+                       MAX_ROWS=100000, DEFAULT CHARACTER SET utf8");
+            Bugzilla::Install::DB::_copy_attachments_thedata_to_attach_data();
+        }
+    }
+
     # We want to convert tables to InnoDB, but it's possible that they have 
     # fulltext indexes on them, and conversion will fail unless we remove
     # the indexes.
@@ -680,7 +708,9 @@ EOT
# SECTION: CHECKSETUP_AND_UPGRADE_SPEEDUP
     $self->_after_table_status([map($_->{Name}, @$utf_table_status)]);
     my @non_utf8_tables = grep(defined($_->{Collation}) && $_->{Collation} !~ /^utf8/, @$utf_table_status);
     
-    if (Bugzilla->params->{'utf8'} && scalar @non_utf8_tables) {
+    # For GNOME, we always want to do the UTF-8 conversion on upgrade. We'll
+    # turn on the utf8 parameter later.
+    if (Bugzilla->params->{'utf8'} and scalar @non_utf8_tables) {
         print <<EOT;
 
 WARNING: We are about to convert your table storage format to UTF8. This
@@ -721,6 +751,7 @@ EOT
# SECTION: CHECKSETUP_AND_UPGRADE_SPEEDUP
         foreach my $table ($self->bz_table_list_real) {
             my $info_sth = $self->prepare("SHOW FULL COLUMNS FROM $table");
             $info_sth->execute();
+            my (@binary_sql, @utf8_sql);
             while (my $column = $info_sth->fetchrow_hashref) {
                 # Our conversion code doesn't work on enum fields, but they
                 # all go away later in checksetup anyway.
@@ -733,31 +764,13 @@ EOT
# SECTION: CHECKSETUP_AND_UPGRADE_SPEEDUP
                 {
                     my $name = $column->{Field};
 
-                    # The code below doesn't work on a field with a FULLTEXT
-                    # index. So we drop it, which we'd do later anyway.
-                    if ($table eq 'longdescs' && $name eq 'thetext') {
-                        $self->bz_drop_index('longdescs', 
-                                             'longdescs_thetext_idx');
-                    }
-                    if ($table eq 'bugs' && $name eq 'short_desc') {
-                        $self->bz_drop_index('bugs', 'bugs_short_desc_idx');
-                    }
-                    my %ft_indexes;
-                    if ($table eq 'bugs_fulltext') {
-                        %ft_indexes = $self->_bz_real_schema->get_indexes_on_column_abstract(
-                            'bugs_fulltext', $name);
-                        foreach my $index (keys %ft_indexes) {
-                            $self->bz_drop_index('bugs_fulltext', $index);
-                        }
-                    }
+                    print "$table.$name needs to be converted UTF-8...\n";
 
                     my $dropped = $self->bz_drop_related_fks($table, $name);
                     push(@dropped_fks, @$dropped);
 
-                    print "Converting $table.$name to be stored as UTF-8...\n";
-                    my $col_info = 
+                    my $col_info =
                         $self->bz_column_info_real($table, $name);
-
                     # CHANGE COLUMN doesn't take PRIMARY KEY
                     delete $col_info->{PRIMARYKEY};
                     my $sql_def = $self->_bz_schema->get_type_ddl($col_info);
@@ -771,21 +784,38 @@ EOT
# SECTION: CHECKSETUP_AND_UPGRADE_SPEEDUP
                     my $type = $self->_bz_schema->convert_type($col_info->{TYPE});
                     $binary =~ s/(\Q$type\E)/$1 CHARACTER SET binary/;
                     $utf8   =~ s/(\Q$type\E)/$1 CHARACTER SET utf8/;
-                    $self->do("ALTER TABLE $table CHANGE COLUMN $name $name 
-                              $binary");
-                    $self->do("ALTER TABLE $table CHANGE COLUMN $name $name 
-                              $utf8");
-
-                    if ($table eq 'bugs_fulltext') {
-                        foreach my $index (keys %ft_indexes) {
-                            $self->bz_add_index('bugs_fulltext', $index,
-                                                $ft_indexes{$index});
-                        }
+                    push(@binary_sql, "MODIFY COLUMN $name $binary");
+                    push(@utf8_sql, "MODIFY COLUMN $name $utf8");
+                }
+            } # foreach column
+
+            if (@binary_sql) {
+                my %indexes = %{ $self->bz_table_indexes($table) };
+                foreach my $index_name (keys %indexes) {
+                    my $index = $indexes{$index_name};
+                    if ($index->{TYPE} and $index->{TYPE} eq 'FULLTEXT') {
+                        $self->bz_drop_index($table, $index_name);
+                    }
+                    else {
+                        delete $indexes{$index_name};
                     }
                 }
-            }
 
-            $self->do("ALTER TABLE $table DEFAULT CHARACTER SET utf8");
+                print "Converting the $table table to UTF-8...\n";
+                my $bin = "ALTER TABLE $table " . join(', ', @binary_sql);
+                my $utf = "ALTER TABLE $table " . join(', ', @utf8_sql,
+                          'DEFAULT CHARACTER SET utf8');
+                $self->do($bin);
+                $self->do($utf);
+
+                # Re-add any removed FULLTEXT indexes.
+                foreach my $index (keys %indexes) {
+                    $self->bz_add_index($table, $index, $indexes{$index});
+                }
+            }
+            else {
+                $self->do("ALTER TABLE $table DEFAULT CHARACTER SET utf8");
+            }
 
         } # foreach my $table (@tables)
 
@@ -826,22 +856,40 @@ sub _fix_defaults {
# SECTION: CHECKSETUP_AND_UPGRADE_SPEEDUP
     # a default.
     return unless (defined $assi_default && $assi_default ne '');
 
+    my %fix_columns;
     foreach my $table ($self->_bz_real_schema->get_table_list()) {
         foreach my $column ($self->bz_table_columns($table)) {
-        my $abs_def = $self->bz_column_info($table, $column);
+            my $abs_def = $self->bz_column_info($table, $column);
+            # BLOB/TEXT columns never have defaults
+            next if $abs_def->{TYPE} =~ /BLOB|TEXT/i;
             if (!defined $abs_def->{DEFAULT}) {
                 # Get the exact default from the database without any
                 # "fixing" by bz_column_info_real.
                 my $raw_info = $self->_bz_raw_column_info($table, $column);
                 my $raw_default = $raw_info->{COLUMN_DEF};
                 if (defined $raw_default) {
-                    $self->bz_alter_column_raw($table, $column, $abs_def);
-                    $raw_default = "''" if $raw_default eq '';
-                    print "Removed incorrect DB default: $raw_default\n";
+                    if ($raw_default eq '') {
+                        # Only (var)char columns can have empty strings as 
+                        # defaults, so if we got an empty string for some
+                        # other default type, then it's bogus.
+                        next unless $abs_def->{TYPE} =~ /char/i;
+                        $raw_default = "''";
+                    }
+                    $fix_columns{$table} ||= [];
+                    push(@{ $fix_columns{$table} }, $column);
+                    print "$table.$column has incorrect DB default: $raw_default\n";
                 }
             }
         } # foreach $column
     } # foreach $table
+
+    print "Fixing defaults...\n";
+    foreach my $table (reverse sort keys %fix_columns) {
+        my @alters = map("ALTER COLUMN $_ DROP DEFAULT", 
+                         @{ $fix_columns{$table} });
+        my $sql = "ALTER TABLE $table " . join(',', @alters);
+        $self->do($sql);
+    }
 }
 
 # There is a bug in MySQL 4.1.0 - 4.1.15 that makes certain SELECT
diff --git a/Bugzilla/DB/Schema.pm b/Bugzilla/DB/Schema.pm
index 680f754..2b09efb 100644
--- a/Bugzilla/DB/Schema.pm
+++ b/Bugzilla/DB/Schema.pm
@@ -454,12 +454,17 @@ use constant ABSTRACT_SCHEMA => {
# SECTION: REQ_3_ATTACHMENT_STATUS
                              DEFAULT => 'FALSE'},
             isurl        => {TYPE => 'BOOLEAN', NOTNULL => 1,
                              DEFAULT => 'FALSE'},
+            status       => {TYPE => 'varchar(64)', NOTNULL => 1,
+                             REFERENCES => {TABLE  => 'attachment_status',
+                                            COLUMN => 'value',
+                                            DELETE => 'CASCADE'}},
         ],
         INDEXES => [
             attachments_bug_id_idx => ['bug_id'],
             attachments_creation_ts_idx => ['creation_ts'],
             attachments_modification_time_idx => ['modification_time'],
             attachments_submitter_id_idx => ['submitter_id', 'bug_id'],
+            attachments_status_idx => ['status'],
         ],
     },
     attach_data => {
@@ -472,6 +477,18 @@ use constant ABSTRACT_SCHEMA => {
# SECTION: REQ_3_ATTACHMENT_STATUS
             thedata => {TYPE => 'LONGBLOB', NOTNULL => 1},
         ],
     },
+    attachment_status => {
+        FIELDS => [
+            @{ dclone(FIELD_TABLE_SCHEMA->{FIELDS}) },
+            description => {TYPE => 'MEDIUMTEXT', NOTNULL => 1},
+        ],
+        INDEXES => [
+            attachment_status_value_idx   => {FIELDS => ['value'],
+                                             TYPE => 'UNIQUE'},
+            attachment_status_sortkey_idx => ['sortkey', 'value'],
+            attachment_status_visibility_value_id_idx => ['visibility_value_id'],
+        ],
+    },
 
     duplicates => {
         FIELDS => [
@@ -1152,6 +1169,7 @@ use constant ABSTRACT_SCHEMA => {
# SECTION: REQ_19_CLASSIFICATION_GNOME
             name        => {TYPE => 'varchar(64)', NOTNULL => 1},
             description => {TYPE => 'MEDIUMTEXT'},
             sortkey     => {TYPE => 'INT2', NOTNULL => 1, DEFAULT => '0'},
+            is_gnome    => {TYPE => 'BOOLEAN', NOTNULL => 1, DEFAULT => 'FALSE'},
         ],
         INDEXES => [
             classifications_name_idx => {FIELDS => ['name'],
@@ -1176,7 +1194,7 @@ use constant ABSTRACT_SCHEMA => {
# SECTION: REQ_25_UNCONFIRMED_ENABLED
             maxvotesperbug    => {TYPE => 'INT2', NOTNULL => 1,
                                   DEFAULT => '10000'},
             votestoconfirm    => {TYPE => 'INT2', NOTNULL => 1,
-                                  DEFAULT => 0},
+                                  DEFAULT => 10000},
             defaultmilestone  => {TYPE => 'varchar(20)',
                                   NOTNULL => 1, DEFAULT => "'---'"},
         ],
diff --git a/Bugzilla/DB/Schema/Mysql.pm b/Bugzilla/DB/Schema/Mysql.pm
index 6277169..49e6add 100644
--- a/Bugzilla/DB/Schema/Mysql.pm
+++ b/Bugzilla/DB/Schema/Mysql.pm
@@ -178,13 +178,33 @@ sub get_alter_column_ddl {
# SECTION: CHECKSETUP_AND_UPGRADE_SPEEDUP
         delete $new_def_copy{PRIMARYKEY};
     }
 
-    my $new_ddl = $self->get_type_ddl(\%new_def_copy);
     my @statements;
 
     push(@statements, "UPDATE $table SET $column = $set_nulls_to
                         WHERE $column IS NULL") if defined $set_nulls_to;
-    push(@statements, "ALTER TABLE $table CHANGE COLUMN 
+
+    # Calling SET DEFAULT or DROP DEFAULT is *way* faster than calling
+    # CHANGE COLUMN, so just do that if we're just changing the default.
+    my %old_defaultless = %$old_def;
+    my %new_defaultless = %$new_def;
+    delete $old_defaultless{DEFAULT};
+    delete $new_defaultless{DEFAULT};
+    if ($self->columns_equal(\%new_defaultless, \%old_defaultless)) {
+        if (defined $old_def->{DEFAULT} and !defined $new_def->{DEFAULT}) {
+            push(@statements,
+                 "ALTER TABLE $table ALTER COLUMN $column DROP DEFAULT");
+        }
+        else {
+            push(@statements, "ALTER TABLE $table ALTER COLUMN $column 
+                               SET DEFAULT " . $new_def->{DEFAULT});
+        }
+    }
+    else {
+        my $new_ddl = $self->get_type_ddl(\%new_def_copy);
+        push(@statements, "ALTER TABLE $table CHANGE COLUMN 
                        $column $column $new_ddl");
+    }
+
     if ($old_def->{PRIMARYKEY} && !$new_def->{PRIMARYKEY}) {
         # Dropping a PRIMARY KEY needs an explicit DROP PRIMARY KEY
         push(@statements, "ALTER TABLE $table DROP PRIMARY KEY");
diff --git a/Bugzilla/Error.pm b/Bugzilla/Error.pm
index d15336a..1f38c08 100644
--- a/Bugzilla/Error.pm
+++ b/Bugzilla/Error.pm
@@ -113,6 +113,9 @@ sub _throw_error {
# SECTION: REQ_8_BUG_BUDDY_CGI
                 $code = ERROR_UNKNOWN_TRANSIENT if $name =~ /user/i;
             }
             die SOAP::Fault->faultcode($code)->faultstring($message);
+        } elsif (Bugzilla->error_mode == ERROR_MODE_BUGBUDDY) {
+            # bug-buddy uses the strings, not a code
+            die SOAP::Fault->faultcode(999)->faultstring($error);
         }
     }
     exit;
diff --git a/Bugzilla/Field.pm b/Bugzilla/Field.pm
index bd9a4e1..d62562e 100644
--- a/Bugzilla/Field.pm
+++ b/Bugzilla/Field.pm
@@ -162,7 +162,7 @@ use constant DEFAULT_FIELDS => (
# SECTION: REQ_47_REMOVE_REP_PLATFORM
     {name => 'version',      desc => 'Version',    in_new_bugmail => 1,
      buglist => 1},
     {name => 'rep_platform', desc => 'Platform',   in_new_bugmail => 1,
-     type => FIELD_TYPE_SINGLE_SELECT, buglist => 1},
+     type => FIELD_TYPE_SINGLE_SELECT, buglist => 1, obsolete => 1},
     {name => 'bug_file_loc', desc => 'URL',        in_new_bugmail => 1},
     {name => 'op_sys',       desc => 'OS/Version', in_new_bugmail => 1,
      type => FIELD_TYPE_SINGLE_SELECT, buglist => 1},
@@ -197,6 +197,8 @@ use constant DEFAULT_FIELDS => (
# SECTION: REQ_3_ATTACHMENT_STATUS
     {name => 'attachments.ispatch',     desc => 'Attachment is patch'},
     {name => 'attachments.isobsolete',  desc => 'Attachment is obsolete'},
     {name => 'attachments.isprivate',   desc => 'Attachment is private'},
+    {name => 'attachments.status',      desc => 'Attachment status',
+     type => FIELD_TYPE_SINGLE_SELECT},
     {name => 'attachments.submitter',   desc => 'Attachment creator'},
 
     {name => 'target_milestone',      desc => 'Target Milestone',
@@ -906,6 +908,7 @@ sub populate_field_definitions {
# SECTION: REQ_47_REMOVE_REP_PLATFORM
             $field->set_description($def->{desc});
             $field->set_in_new_bugmail($def->{in_new_bugmail});
             $field->set_buglist($def->{buglist});
+            $field->set_obsolete($def->{obsolete});
             $field->_set_type($def->{type}) if $def->{type};
             $field->update();
         }
diff --git a/Bugzilla/Field/Choice.pm b/Bugzilla/Field/Choice.pm
index cfb9117..f0ca625 100644
--- a/Bugzilla/Field/Choice.pm
+++ b/Bugzilla/Field/Choice.pm
@@ -49,6 +49,8 @@ use constant UPDATE_COLUMNS => qw(
# SECTION: REQ_3_ATTACHMENT_STATUS
     visibility_value_id
 );
 
+use constant PARENT_TABLE => 'bugs';
+
 use constant NAME_FIELD => 'value';
 use constant LIST_ORDER => 'sortkey, value';
 
@@ -63,6 +65,7 @@ use constant VALIDATORS => {
# SECTION: REQ_3_ATTACHMENT_STATUS
 use constant CLASS_MAP => {
     bug_status => 'Bugzilla::Status',
     product    => 'Bugzilla::Product',
+    'attachments.status' => 'Bugzilla::AttachmentStatus',
 };
 
 use constant DEFAULT_MAP => {
@@ -87,7 +90,10 @@ sub type {
# SECTION: REQ_3_ATTACHMENT_STATUS
     my $field_name = $field_obj->name;
 
     if ($class->CLASS_MAP->{$field_name}) {
-        return $class->CLASS_MAP->{$field_name};
+        # Make sure that the class is loaded
+        my $c = $class->CLASS_MAP->{$field_name};
+        eval "require $c";
+        return $c;
     }
 
     # For generic classes, we use a lowercase class name, so as
@@ -159,7 +165,7 @@ sub update {
# SECTION: REQ_3_ATTACHMENT_STATUS
                      undef, $new, $old);
         }
         else {
-            $dbh->do("UPDATE bugs SET $fname = ? WHERE $fname = ?",
+            $dbh->do("UPDATE " . $self->PARENT_TABLE . " SET $fname = ? WHERE $fname = ?",
                      undef, $new, $old);
         }
 
diff --git a/Bugzilla/Hook.pm b/Bugzilla/Hook.pm
index 4833f44..a80256c 100644
--- a/Bugzilla/Hook.pm
+++ b/Bugzilla/Hook.pm
@@ -21,12 +21,25 @@
# SECTION: MOD_PERL_GNOME
 #
 
 package Bugzilla::Hook;
+use strict;
 
 use Bugzilla::Constants;
 use Bugzilla::Util;
 use Bugzilla::Error;
 
-use strict;
+use Scalar::Util qw(blessed);
+
+BEGIN {
+    if ($ENV{MOD_PERL}) {
+        require ModPerl::Const;
+        import ModPerl::Const -compile => 'EXIT';
+     }
+    else {
+        # Create a fake constant. We have to do this in a string eval,
+        # otherwise this will always be defined.
+        eval('sub ModPerl::EXIT;');
+    }
+}
 
 sub process {
     my ($name, $args) = @_;
@@ -49,8 +62,16 @@ sub process {
# SECTION: MOD_PERL_GNOME
             # Allow extensions to load their own libraries.
             local @INC = ("$extension/lib", @INC);
             do($extension.'/code/'.$name.'.pl');
-            ThrowCodeError('extension_invalid', 
-                { errstr => $@, name => $name, extension => $extension }) if $@;
+            if ($@) {
+                if ($ENV{MOD_PERL} and blessed $@ and $@ == ModPerl::EXIT) {
+                    exit;
+                }
+                else {
+                    ThrowCodeError('extension_invalid', 
+                        { errstr => $@, name => $name,
+                          extension => $extension });
+                }
+            }
             # Flush stored data.
             Bugzilla->hook_args({});
         }
@@ -274,6 +295,60 @@ your column name(s) onto the array.
# SECTION: BUG_FORMAT_COMMENT_HOOK
 
 =back
 
+=head2 bug-format_comment
+
+Allows you to do custom parsing on comments before they are displayed. You do
+this by returning two regular expressions: one that matches the section you 
+want to replace, and then another that says what you want to replace that 
+match with.
+
+The matching and replacement will be run with the C</g> switch on the regex.
+
+Params:
+
+=over
+
+=item C<regexes>
+
+An arrayref of hashrefs.
+
+You should push a hashref containing two keys (C<match> and C<replace>)
+in to this array. C<match> is the regular expression that matches the
+text you want to replace, C<replace> is what you want to replace that
+text with. (This gets passed into a regular expression like 
+C<s/$match/$replace/>.)
+
+B<You are responsible for HTML-escaping your returned data.> Failing to
+do so could open a security hole in Bugzilla.
+
+=item C<text>
+
+A B<reference> to the exact text that you are parsing.
+
+Generally you should not modify this yourself. Instead you should be 
+returning regular expressions using the C<regexes> array.
+
+The text has already been word-wrapped, but has not been parsed in any way
+otherwise. (So, for example, it is not HTML-escaped. You get "&", not 
+"&amp;".)
+
+=item C<bug>
+
+The L<Bugzilla::Bug> object that this comment is on. Sometimes this is
+C<undef>, meaning that we are parsing text that is not on a bug.
+
+=item C<comment>
+
+A hashref representing the comment you are about to parse, including
+all of the fields that comments contain when they are returned by
+by L<Bugzilla::Bug/longdescs>.
+
+Sometimes this is C<undef>, meaning that we are parsing text that is
+not a bug comment (but could still be some other part of a bug, like
+the summary line).
+
+=back
+
 =head2 buglist-columns
 
 This happens in buglist.cgi after the standard columns have been defined and
diff --git a/Bugzilla/Install.pm b/Bugzilla/Install.pm
index 0a1f0e9..09de779 100644
--- a/Bugzilla/Install.pm
+++ b/Bugzilla/Install.pm
@@ -56,7 +56,7 @@ sub SETTINGS {
# SECTION: REQ_39_GNOME_SKIN
     state_addselfcc    => { options => ['always', 'never',  'cc_unless_role'],
                             default => 'cc_unless_role' },
     # 2006-08-04 wurblzap@gmail.com -- Bug 322693
-    skin               => { subclass => 'Skin', default => 'Dusk' },
+    skin               => { subclass => 'Skin', default => 'GNOME' },
     # 2006-12-10 LpSolit@gmail.com -- Bug 297186
     lang               => { subclass => 'Lang',
                             default => ${Bugzilla->languages}[0] },
@@ -181,36 +181,6 @@ sub update_system_groups {
# SECTION: CHECKSETUP_AND_UPGRADE_SPEEDUP
         $dbh->do('INSERT INTO group_group_map (grantor_id, member_id) 
                        VALUES (?,?)', undef, $sudo_protect->id, $sudo->id);
     }
-
-    # Re-evaluate all regexps, to keep them up-to-date.
-    my $sth = $dbh->prepare(
-        "SELECT profiles.userid, profiles.login_name, groups.id, 
-                groups.userregexp, user_group_map.group_id
-           FROM (profiles CROSS JOIN groups)
-                LEFT JOIN user_group_map
-                ON user_group_map.user_id = profiles.userid
-                   AND user_group_map.group_id = groups.id
-                   AND user_group_map.grant_type = ?
-          WHERE userregexp != '' OR user_group_map.group_id IS NOT NULL");
-
-    my $sth_add = $dbh->prepare(
-        "INSERT INTO user_group_map (user_id, group_id, isbless, grant_type)
-              VALUES (?, ?, 0, " . GRANT_REGEXP . ")");
-
-    my $sth_del = $dbh->prepare(
-        "DELETE FROM user_group_map
-          WHERE user_id  = ? AND group_id = ? AND isbless = 0 
-                AND grant_type = " . GRANT_REGEXP);
-
-    $sth->execute(GRANT_REGEXP);
-    while (my ($uid, $login, $gid, $rexp, $present) = $sth->fetchrow_array()) {
-        if ($login =~ m/$rexp/i) {
-            $sth_add->execute($uid, $gid) unless $present;
-        } else {
-            $sth_del->execute($uid, $gid) if $present;
-        }
-    }
-
 }
 
 # This function should be called only after creating the admin user.
diff --git a/Bugzilla/Install/DB.pm b/Bugzilla/Install/DB.pm
index 8636a58..4995fb8 100644
--- a/Bugzilla/Install/DB.pm
+++ b/Bugzilla/Install/DB.pm
@@ -26,6 +26,7 @@ use Bugzilla::Constants;
# SECTION: SAVED_SEARCHES
 use Bugzilla::Hook;
 use Bugzilla::Install::Util qw(indicate_progress install_string);
 use Bugzilla::Util;
+use Bugzilla::Search::Quicksearch;
 use Bugzilla::Series;
 
 use Date::Parse;
@@ -414,11 +415,12 @@ sub update_table_definitions {
# SECTION: CHECKSETUP_AND_UPGRADE_SPEEDUP
     _fix_attachments_submitter_id_idx();
     _copy_attachments_thedata_to_attach_data();
     _fix_broken_all_closed_series();
-
     # 2005-08-14 bugreport@peshkin.net -- Bug 304583
     # Get rid of leftover DERIVED group permissions
-    use constant GRANT_DERIVED => 1;
-    $dbh->do("DELETE FROM user_group_map WHERE grant_type = " . GRANT_DERIVED);
+    # Note: We used to have "use constant GRANT_DERIVED => 1;"
+    $dbh->do("DELETE FROM user_group_map WHERE grant_type = 1");
+
+    _rederive_regex_groups();
 
     # PUBLIC is a reserved word in Oracle.
     $dbh->bz_rename_column('series', 'public', 'is_public');
@@ -463,13 +465,23 @@ sub update_table_definitions {
# SECTION: REQ_25_UNCONFIRMED_ENABLED
                           {TYPE => 'BOOLEAN', NOTNULL => 1,  DEFAULT => 0});
     $dbh->bz_alter_column('products', 'votesperuser', 
                           {TYPE => 'INT2', NOTNULL => 1, DEFAULT => 0});
-    $dbh->bz_alter_column('products', 'votestoconfirm',
-                          {TYPE => 'INT2', NOTNULL => 1, DEFAULT => 0});
+    my $vtc_info = $dbh->bz_column_info('products', 'votestoconfirm');
+    if (!defined $vtc_info->{DEFAULT}) {
+        $dbh->bz_alter_column('products', 'votestoconfirm',
+                              {TYPE => 'INT2', NOTNULL => 1, DEFAULT => 0});
+    }
# SECTION: REQ_3_ATTACHMENT_STATUS
 
     # 2006-08-04 LpSolit@gmail.com - Bug 305941
     $dbh->bz_drop_column('profiles', 'refreshed_when');
     $dbh->bz_drop_column('groups', 'last_changed');
 
+    # GNOME had a "0" in the flagtypes id column, which needs to be changed
+    # to a 7 before we can alter the column.
+    if ($dbh->bz_column_info('attachments', 'status_id')) {
+        $dbh->do('UPDATE flagtypes SET id = 7 WHERE id = 0');
+        $dbh->do('UPDATE attachments SET status_id = 7 WHERE status_id = 0');
+    }
+
     # 2006-08-06 LpSolit@gmail.com - Bug 347521
     $dbh->bz_alter_column('flagtypes', 'id',
           {TYPE => 'SMALLSERIAL', NOTNULL => 1, PRIMARYKEY => 1});
@@ -518,6 +530,7 @@ sub update_table_definitions {
# SECTION: CHECKSETUP_AND_UPGRADE_SPEEDUP
 
     # 2007-05-17 LpSolit@gmail.com - Bug 344965
     _initialize_workflow($old_params);
+    _create_duplicate_or_move_status_transitions();
 
     # 2007-08-08 LpSolit@gmail.com - Bug 332149
     $dbh->bz_add_column('groups', 'icon_url', {TYPE => 'TINYTEXT'});
@@ -556,7 +569,68 @@ sub update_table_definitions {
# SECTION: REQ_16_GNOME_VERSION_AND_TARGET
 
     # 2009-03-02 arbingersys@gmail.com - Bug 423613
     _add_extern_id_index();
+
+    # 2009-05-06 bbaetz@everythingsolved.com - gnome specific
+    # Move from the old hacked-up custom fields to the new ones
+    my $gnome_version = new Bugzilla::Field({'name' => 'cf_gnome_version'});
+    if (!$gnome_version) {
+        $gnome_version = Bugzilla::Field->create({
+            name        => 'cf_gnome_version',
+            description => 'GNOME version',
+            type        => FIELD_TYPE_SINGLE_SELECT,
+            sortkey     => 200,
+            mailhead    => 1,
+            enter_bug   => 1,
+            obsolete    => 0,
+            custom      => 1,
+        });
+        _port_gnome_cf('gnome_version', 'cf_gnome_version');
+    }
+
+    my $gnome_target = new Bugzilla::Field({'name' => 'cf_gnome_target'});
+    if (!$gnome_target) {
+        $gnome_target = Bugzilla::Field->create({
+            name        => 'cf_gnome_target',
+            description => 'GNOME target',
+            type        => FIELD_TYPE_SINGLE_SELECT,
+            sortkey     => 200,
+            mailhead    => 1,
+            enter_bug   => 1,
+            obsolete    => 0,
+            custom      => 1,
+        });
+        _port_gnome_cf('gnome_target', 'cf_gnome_target');
+    }
# SECTION: REQ_3_ATTACHMENT_STATUS
  
+    # 2009-05-07 bbaetz@everythingsolved.com.au
+    # Migrate attachment statuses from flagtypes to their own table
+    # (gnome change)
+    _migrate_gnome_attachment_status();
+    # We need at least one attachment status, so if there was nothing to
+    # migrate make sure that we have the 'none' entry
+    _populate_gnome_attachment_status();
# SECTION: REQ_19_CLASSIFICATION_GNOME
+
+    if (!$dbh->bz_column_info('classifications', 'is_gnome')) {
+        $dbh->bz_add_column('classifications', 'is_gnome',
+            {TYPE => 'BOOLEAN', NOTNULL => 1, DEFAULT => 'FALSE'});
+
+        $dbh->do("UPDATE classifications
+                     SET is_gnome = 1
+                   WHERE name IN ('Desktop', 'Platform', 'Bindings')");
+    }
# SECTION: REQ_20_DEVELOPERS_SYSTEM
+        
+    # 2009-05-31 dlawrence@everythingsolved.com
+    # Migrate developers table to new group based system
+    _migrate_gnome_developers();
+
# SECTION: REQ_54_REMOVE_CLOSED
+    _gnome_remove_closed_status();
+
# SECTION: REQ_25_UNCONFIRMED_ENABLED
+    _set_vote_fields();
+
# SECTION: CLEANUP_OLD_INDEXES
+    _cleanup_old_gnome_db();
+
# SECTION: SAVED_SEARCHES
+    _fix_saved_searches();
+
     ################################################################
     # New --TABLE-- changes should go *** A B O V E *** this point #
     ################################################################
@@ -2200,17 +2274,9 @@ sub _clone_email_event {
# SECTION: CHECKSETUP_AND_UPGRADE_SPEEDUP
     my ($source, $target) = @_;
     my $dbh = Bugzilla->dbh;
 
-    my $sth1 = $dbh->prepare("SELECT user_id, relationship FROM email_setting
-                              WHERE event = $source");
-    my $sth2 = $dbh->prepare("INSERT into email_setting " .
-                             "(user_id, relationship, event) VALUES (" .
-                             "?, ?, $target)");
-
-    $sth1->execute();
-
-    while (my ($userid, $relationship) = $sth1->fetchrow_array()) {
-        $sth2->execute($userid, $relationship);
-    }
+    $dbh->do("INSERT INTO email_setting (user_id, relationship, event)
+                   SELECT user_id, relationship, $target FROM email_setting
+                    WHERE event = $source");
 }
 
 sub _migrate_email_prefs_to_new_table {
@@ -2326,15 +2392,15 @@ sub _initialize_dependency_tree_changes_email_pref {
# SECTION: CHECKSETUP_AND_UPGRADE_SPEEDUP
 
     foreach my $desc (keys %events) {
         my $event = $events{$desc};
-        my $sth = $dbh->prepare("SELECT COUNT(*) FROM email_setting 
-                                  WHERE event = $event");
-        $sth->execute();
-        if (!($sth->fetchrow_arrayref()->[0])) {
-            # No settings in the table yet, so we assume that this is the
-            # first time it's being set.
-            print "Initializing \"$desc\" email_setting ...\n";
-            _clone_email_event(EVT_OTHER, $event);
-        }
+        my $has_events = $dbh->selectrow_array(
+           'SELECT 1 FROM email_setting WHERE event = ? ' 
+           . $dbh->sql_limit(1), undef, $event);
+        next if $has_events;
+
+        # No settings in the table yet, so we assume that this is the
+        # first time it's being set.
+        print "Initializing \"$desc\" email_setting ...\n";
+        _clone_email_event(EVT_OTHER, $event);
     }
 }
 
@@ -2593,6 +2659,54 @@ EOT
# SECTION: CHECKSETUP_AND_UPGRADE_SPEEDUP
     } # if (@$broken_nonopen_series)
 }
 
+# This needs to happen at two times: when we upgrade from 2.16 (thus creating 
+# user_group_map), and when we kill derived gruops in the DB.
+sub _rederive_regex_groups {
+    my $dbh = Bugzilla->dbh;
+
+    my $regex_groups_exist = $dbh->selectrow_array(
+        "SELECT 1 FROM groups WHERE userregexp = '' " . $dbh->sql_limit(1));
+    return if !$regex_groups_exist;
+
+    my $regex_derivations = $dbh->selectrow_array(
+        'SELECT 1 FROM user_group_map WHERE grant_type = ' . GRANT_REGEXP 
+        . ' ' . $dbh->sql_limit(1));
+    return if $regex_derivations;
+
+    print "Deriving regex group memberships...\n";
+
+    # Re-evaluate all regexps, to keep them up-to-date.
+    my $sth = $dbh->prepare(
+        "SELECT profiles.userid, profiles.login_name, groups.id, 
+                groups.userregexp, user_group_map.group_id
+           FROM (profiles CROSS JOIN groups)
+                LEFT JOIN user_group_map
+                       ON user_group_map.user_id = profiles.userid
+                          AND user_group_map.group_id = groups.id
+                          AND user_group_map.grant_type = ?
+          WHERE userregexp != '' OR user_group_map.group_id IS NOT NULL");
+
+    my $sth_add = $dbh->prepare(
+        "INSERT INTO user_group_map (user_id, group_id, isbless, grant_type)
+              VALUES (?, ?, 0, " . GRANT_REGEXP . ")");
+
+    my $sth_del = $dbh->prepare(
+        "DELETE FROM user_group_map
+          WHERE user_id  = ? AND group_id = ? AND isbless = 0 
+                AND grant_type = " . GRANT_REGEXP);
+
+    $sth->execute(GRANT_REGEXP);
+    while (my ($uid, $login, $gid, $rexp, $present) = 
+               $sth->fetchrow_array()) 
+    {
+        if ($login =~ m/$rexp/i) {
+            $sth_add->execute($uid, $gid) unless $present;
+        } else {
+            $sth_del->execute($uid, $gid) if $present;
+        }
+    }
+}
+
 sub _clean_control_characters_from_short_desc {
     my $dbh = Bugzilla->dbh;
 
@@ -2833,10 +2947,12 @@ sub _initialize_workflow {
# SECTION: CHECKSETUP_AND_UPGRADE_SPEEDUP
     $dbh->bz_add_column('bug_status', 'is_open',
                         {TYPE => 'BOOLEAN', NOTNULL => 1, DEFAULT => 'TRUE'});
 
-    # Till now, bug statuses were not customizable. Nevertheless, local
-    # changes are possible and so we will try to respect these changes.
-    # This means: get the status of bugs having a resolution different from ''
-    # and mark these statuses as 'closed', even if some of these statuses are
+    # Populate the status_workflow table. We do nothing if the table already
+    # has entries. If all bug status transitions have been deleted, the
+    # workflow will be restored to its default schema.
+    my $count = $dbh->selectrow_array('SELECT COUNT(*) FROM status_workflow');
+    return if $count;
+
     # expected to be open statuses. Bug statuses we have no information about
     # are left as 'open'.
     my @closed_statuses =
@@ -2862,67 +2978,74 @@ sub _initialize_workflow {
# SECTION: CHECKSETUP_AND_UPGRADE_SPEEDUP
                   join(', ', @closed_statuses) . ')');
     }
 
-    # Populate the status_workflow table. We do nothing if the table already
-    # has entries. If all bug status transitions have been deleted, the
-    # workflow will be restored to its default schema.
-    my $count = $dbh->selectrow_array('SELECT COUNT(*) FROM status_workflow');
-
-    if (!$count) {
-        # Make sure the variables below are defined as
-        # status_workflow.require_comment cannot be NULL.
-        my $create = $old_params->{'commentoncreate'} || 0;
-        my $confirm = $old_params->{'commentonconfirm'} || 0;
-        my $accept = $old_params->{'commentonaccept'} || 0;
-        my $resolve = $old_params->{'commentonresolve'} || 0;
-        my $verify = $old_params->{'commentonverify'} || 0;
-        my $close = $old_params->{'commentonclose'} || 0;
-        my $reopen = $old_params->{'commentonreopen'} || 0;
-        # This was till recently the only way to get back to NEW for
-        # confirmed bugs, so we use this parameter here.
-        my $reassign = $old_params->{'commentonreassign'} || 0;
-
-        # This is the default workflow.
-        my @workflow = ([undef, 'UNCONFIRMED', $create],
-                        [undef, 'NEW', $create],
-                        [undef, 'ASSIGNED', $create],
-                        ['UNCONFIRMED', 'NEW', $confirm],
-                        ['UNCONFIRMED', 'ASSIGNED', $accept],
-                        ['UNCONFIRMED', 'RESOLVED', $resolve],
-                        ['NEW', 'ASSIGNED', $accept],
-                        ['NEW', 'RESOLVED', $resolve],
-                        ['ASSIGNED', 'NEW', $reassign],
-                        ['ASSIGNED', 'RESOLVED', $resolve],
-                        ['REOPENED', 'NEW', $reassign],
-                        ['REOPENED', 'ASSIGNED', $accept],
-                        ['REOPENED', 'RESOLVED', $resolve],
-                        ['RESOLVED', 'UNCONFIRMED', $reopen],
-                        ['RESOLVED', 'REOPENED', $reopen],
-                        ['RESOLVED', 'VERIFIED', $verify],
-                        ['RESOLVED', 'CLOSED', $close],
-                        ['VERIFIED', 'UNCONFIRMED', $reopen],
-                        ['VERIFIED', 'REOPENED', $reopen],
-                        ['VERIFIED', 'CLOSED', $close],
-                        ['CLOSED', 'UNCONFIRMED', $reopen],
-                        ['CLOSED', 'REOPENED', $reopen]);
-
-        print "Now filling the 'status_workflow' table with valid bug status transitions...\n";
-        my $sth_select = $dbh->prepare('SELECT id FROM bug_status WHERE value = ?');
-        my $sth = $dbh->prepare('INSERT INTO status_workflow (old_status, new_status,
-                                             require_comment) VALUES (?, ?, ?)');
-
-        foreach my $transition (@workflow) {
-            my ($from, $to);
-            # If it's an initial state, there is no "old" value.
-            $from = $dbh->selectrow_array($sth_select, undef, $transition->[0])
-              if $transition->[0];
-            $to = $dbh->selectrow_array($sth_select, undef, $transition->[1]);
-            # If one of the bug statuses doesn't exist, the transition is invalid.
-            next if (($transition->[0] && !$from) || !$to);
-
-            $sth->execute($from, $to, $transition->[2] ? 1 : 0);
-        }
+    # Make sure the variables below are defined as
+    # status_workflow.require_comment cannot be NULL.
+    my $create = $old_params->{'commentoncreate'} || 0;
+    my $confirm = $old_params->{'commentonconfirm'} || 0;
+    my $accept = $old_params->{'commentonaccept'} || 0;
+    my $resolve = $old_params->{'commentonresolve'} || 0;
+    my $verify = $old_params->{'commentonverify'} || 0;
+    my $close = $old_params->{'commentonclose'} || 0;
+    my $reopen = $old_params->{'commentonreopen'} || 0;
+    # This was till recently the only way to get back to NEW for
+    # confirmed bugs, so we use this parameter here.
+    my $reassign = $old_params->{'commentonreassign'} || 0;
# SECTION: REQ_28_NEEDINFO
+    my $needinfo = 0;
# SECTION: CHECKSETUP_AND_UPGRADE_SPEEDUP
+
+    # This is the default workflow.
+    my @workflow = ([undef, 'UNCONFIRMED', $create],
+                    [undef, 'NEW', $create],
+                    [undef, 'ASSIGNED', $create],
+                    ['UNCONFIRMED', 'NEW', $confirm],
+                    ['UNCONFIRMED', 'ASSIGNED', $accept],
# SECTION: REQ_28_NEEDINFO
+                    ['UNCONFIRMED', 'NEEDINFO', $needinfo],
# SECTION: CHECKSETUP_AND_UPGRADE_SPEEDUP
+                    ['UNCONFIRMED', 'RESOLVED', $resolve],
+                    ['NEW', 'ASSIGNED', $accept],
# SECTION: REQ_28_NEEDINFO
+                    ['NEW', 'NEEDINFO', $needinfo],
# SECTION: CHECKSETUP_AND_UPGRADE_SPEEDUP
+                    ['NEW', 'RESOLVED', $resolve],
+                    ['ASSIGNED', 'NEW', $reassign],
# SECTION: REQ_28_NEEDINFO
+                    ['ASSIGNED', 'NEEDINFO', $needinfo],
# SECTION: CHECKSETUP_AND_UPGRADE_SPEEDUP
+                    ['ASSIGNED', 'RESOLVED', $resolve],
+                    ['REOPENED', 'NEW', $reassign],
+                    ['REOPENED', 'ASSIGNED', $accept],
# SECTION: REQ_28_NEEDINFO
+                    ['REOPENED', 'NEEDINFO', $needinfo],
# SECTION: CHECKSETUP_AND_UPGRADE_SPEEDUP
+                    ['REOPENED', 'RESOLVED', $resolve],
# SECTION: REQ_28_NEEDINFO
+                    ['NEEDINFO', 'UNCONFIRMED', $reassign],
+                    ['NEEDINFO', 'NEW', $reassign],
+                    ['NEEDINFO', 'ASSIGNED', $accept],
+                    ['NEEDINFO', 'RESOLVED', $resolve],
# SECTION: CHECKSETUP_AND_UPGRADE_SPEEDUP
+                    ['RESOLVED', 'UNCONFIRMED', $reopen],
+                    ['RESOLVED', 'REOPENED', $reopen],
+                    ['RESOLVED', 'VERIFIED', $verify],
+                    ['RESOLVED', 'CLOSED', $close],
+                    ['VERIFIED', 'UNCONFIRMED', $reopen],
+                    ['VERIFIED', 'REOPENED', $reopen],
+                    ['VERIFIED', 'CLOSED', $close],
+                    ['CLOSED', 'UNCONFIRMED', $reopen],
# SECTION: REQ_54_REMOVE_CLOSED
+                    ['CLOSED', 'VERIFIED', 0],
# SECTION: CHECKSETUP_AND_UPGRADE_SPEEDUP
+                    ['CLOSED', 'REOPENED', $reopen]);
+
+    print "Now filling the 'status_workflow' table with valid bug status transitions...\n";
+    my $sth_select = $dbh->prepare('SELECT id FROM bug_status WHERE value = ?');
+    my $sth = $dbh->prepare('INSERT INTO status_workflow (old_status, new_status,
+                                         require_comment) VALUES (?, ?, ?)');
+
+    foreach my $transition (@workflow) {
+        my ($from, $to);
+        # If it's an initial state, there is no "old" value.
+        $from = $dbh->selectrow_array($sth_select, undef, $transition->[0])
+          if $transition->[0];
+        $to = $dbh->selectrow_array($sth_select, undef, $transition->[1]);
+        # If one of the bug statuses doesn't exist, the transition is invalid.
+        next if (($transition->[0] && !$from) || !$to);
+
+        $sth->execute($from, $to, $transition->[2] ? 1 : 0);
     }
+}
 
+sub _create_duplicate_or_move_status_transitions {
+    my $dbh = Bugzilla->dbh;
+    
     # Make sure the bug status used by the 'duplicate_or_move_bug_status'
     # parameter has all the required transitions set.
     my $dup_status = Bugzilla->params->{'duplicate_or_move_bug_status'};
@@ -3077,6 +3200,10 @@ sub _populate_bugs_fulltext {
# SECTION: CHECKSETUP_AND_UPGRADE_SPEEDUP
         if (UNIVERSAL::can($dbh, 'sql_group_concat')) {
             print "Populating bugs_fulltext...";
             print " (this can take a long time.)\n";
+
+            # As recommended by Monty Widenius for GNOME's upgrade.
+            $dbh->do('SET SESSION myisam_sort_buffer_size = 3221225472');
+
             $dbh->do(
                 q{INSERT INTO bugs_fulltext (bug_id, short_desc, comments, 
                                              comments_noprivate)
@@ -3143,6 +3270,256 @@ sub _add_visiblity_value_to_value_tables {
# SECTION: REQ_16_GNOME_VERSION_AND_TARGET
     }
 }
 
+# Move the old gnome custom fields to standard Bugzilla ones
+# Code taken from gnome's partly updated customizations
+sub _port_gnome_cf {
+    my ($old_field_name, $new_field_name) = (@_);
+
+    my $old_field = new Bugzilla::Field({'name' => $old_field_name});
+    my $new_field = new Bugzilla::Field({'name' => $new_field_name});
+
+    if ($old_field && $new_field) {
+        my $dbh = Bugzilla->dbh;
+
+        $dbh->bz_start_transaction();
+
+        $dbh->do('UPDATE bugs_activity SET fieldid = ? WHERE fieldid = ?', undef, 
+                 ($new_field->id, $old_field->id));
+
+        # Move options
+        $dbh->do("INSERT INTO $new_field_name (value, sortkey, isactive)
+                    SELECT value, sortkey, isactive
+                      FROM $old_field_name
+                     WHERE id > 1");
+
+        my $new_default_value = $dbh->selectrow_array(
+            "SELECT value FROM $new_field_name WHERE id = 1");
+        my $old_default_value = $dbh->selectrow_array(
+            "SELECT value FROM $old_field_name WHERE id = 1");
+
+        $dbh->do("UPDATE bugs SET $new_field_name = $old_field_name");
+        $dbh->do("UPDATE bugs SET $new_field_name = ? WHERE $new_field_name = ?",
+            undef, ($new_default_value, $old_default_value));
+
+        $dbh->do('DELETE FROM fielddefs WHERE id = ?', undef,
+                 $old_field->id);
+        $dbh->bz_commit_transaction();
+
+        $dbh->bz_drop_column('bugs', $old_field_name);
+        $dbh->bz_drop_table($old_field_name);
+    }
+}
+
# SECTION: REQ_3_ATTACHMENT_STATUS
+sub _migrate_gnome_attachment_status {
+    my $dbh = Bugzilla->dbh;
+
+    if (!$dbh->bz_column_info('attachments', 'status')) {
+        # Gnome was overloading flagtypes for statuses
+
+        # Allow NULL values till the conversion has happened
+        $dbh->bz_add_column('attachments', 'status',
+                            {TYPE => 'varchar(64)'});
+
+        $dbh->bz_start_transaction();
+
+        my $sth = $dbh->prepare("SELECT id, name, description, sortkey
+                                  FROM flagtypes
+                                 WHERE target_type = 'a'");
+        $sth->execute;
+
+        my $ins_sth = $dbh->prepare("INSERT INTO attachment_status
+                                     (value, description, sortkey)
+                                     VALUES (?, ?, ?)");
+        my %status_map;
+        while (my ($id, $value, $desc, $sortkey) = $sth->fetchrow_array) {
+            $ins_sth->execute($value, $desc, $sortkey);
+            $status_map{$id} = $value;
+        }
+        
+        my $upd_sth = $dbh->prepare("UPDATE attachments
+                                        SET status = ?
+                                      WHERE status_id = ?");
+        foreach my $s (keys %status_map) {
+            $upd_sth->execute($status_map{$s}, $s);
+        }
+        # And clean up the existing 'flags'
+        $dbh->do("DELETE FROM flagtypes WHERE target_type='a'");
+
+        $dbh->bz_drop_column('attachments', 'status_id');
+
+        $dbh->bz_commit_transaction();
+
+        # Now that we're done, disallow NULLs
+        $dbh->bz_alter_column('attachments', 'status',
+                              {TYPE => 'varchar(64)', NOTNULL => 1});
+
+        # Add the index last
+        $dbh->bz_add_index('attachments', 'attachments_status',
+                           [qw(status)]);
+    }
+}
+
+sub _populate_gnome_attachment_status {
+    my $dbh = Bugzilla->dbh;
+
+    if (!$dbh->selectrow_arrayref("SELECT 1 FROM attachment_status LIMIT 1")) {
+        $dbh->do("INSERT INTO attachment_status (value, sortkey, description)
+                       VALUES ('none', 0, 'None')");
+    }
+}
+
# SECTION: REQ_20_DEVELOPERS_SYSTEM
+sub _migrate_gnome_developers {
+    my $dbh = Bugzilla->dbh;
+    if ($dbh->bz_table_info("developers")) {
+        # Create the global developer group if it doesn't yet exist
+        my $dev_group = Bugzilla::Group->new({ name => 'developers' });
+        if (!$dev_group) {
+            $dev_group = Bugzilla::Group->create({
+                name        => 'developers',
+                description => 'Developer Group',
+                isbuggroup  => 1,
+                isactive    => 1,
+            });
+        }
+
+        # Create product specific groups:
+        foreach my $product (Bugzilla::Product->get_all) {
+            my $group = Bugzilla::Group->new(
+                { name => $product->name . '_developers' });
+            if (!$group) {
+                # Create the group
+                $group = Bugzilla::Group->create({
+                    name        => $product->name . '_developers',
+                    description => $product->name . ' Developers',
+                    isbuggroup  => 1,
+                    isactive    => 1,
+                });
+
+                $dbh->do('INSERT INTO group_control_map
+                          (group_id, product_id, entry, membercontrol,
+                           othercontrol, canedit, editcomponents)
+                          VALUES (?, ?, 0, ?, ?, 0, 1)',
+                          undef, ($group->id, $product->id, CONTROLMAPSHOWN, 
+                                  CONTROLMAPNA));
+
+                $dbh->do('INSERT INTO group_group_map
+                          (member_id, grantor_id, grant_type)
+                          VALUES (?, ?, ?)',
+                          undef, ($group->id, $dev_group->id, GROUP_MEMBERSHIP));
+            }
+
+            # Make existing 'developers' members of this group
+            my $developers = $dbh->selectcol_arrayref('SELECT userid FROM developers
+                                                       WHERE product_id = ?', undef, $product->id);
+            my $sth_ugm = $dbh->prepare('INSERT INTO user_group_map
+                                         (grant_type, group_id, isbless, user_id)
+                                         VALUES (?, ?, ?, ?)');
+            foreach my $userid (@$developers) {
+                $sth_ugm->execute(GRANT_DIRECT, $group->id, 0, $userid);
+            }
+        }
+    
+        # Drop developers table as all developers have been migrated by now
+        $dbh->bz_drop_table('developers');
+    }
+}
+
# SECTION: REQ_54_REMOVE_CLOSED
+sub _gnome_remove_closed_status {
+    my $dbh = Bugzilla->dbh;
+
+    my ($total) = $dbh->selectrow_array("SELECT COUNT(*)
+                                           FROM bugs
+                                          WHERE bug_status = 'CLOSED'");
+    if ($total) {
+        require Bugzilla::Bug;
+        require Bugzilla::Status;
+        require Bugzilla::User;
+
+        $dbh->bz_start_transaction();
+
+        my $status = Bugzilla::Status->check('CLOSED');
+
+        my $bugmaster = Bugzilla::User->check('mkanat@bugzilla.org');
+        Bugzilla->set_user($bugmaster);
+
+        my $bug_ids = $dbh->selectcol_arrayref(
+            "SELECT bug_id FROM bugs WHERE bug_status = 'CLOSED'");
+        my $bugs = Bugzilla::Bug->new_from_list($bug_ids);
+
+        my $timestamp = $dbh->selectrow_array("SELECT NOW()");
+
+        print "Moving $total CLOSED bugs to VERIFIED\n";
+
+        my $cnt = 0;
+        foreach my $bug (@$bugs) {
+            $bug->set_status('VERIFIED');
+            $bug->update($timestamp);
+
+            $cnt++;
+            indicate_progress({ total => $total,
+                                current => $cnt,
+                                every => 50 });
+        }
+
+        # No FKs!
+        $dbh->do("DELETE FROM status_workflow
+                   WHERE old_status = ?
+                      OR new_status = ?",
+                 undef, $status->id, $status->id);
+        $dbh->do("DELETE FROM bug_status WHERE value = 'CLOSED'");
+
+        $dbh->bz_commit_transaction();
+    }
+}
+
# SECTION: REQ_25_UNCONFIRMED_ENABLED
+sub _set_vote_fields {
+    my $dbh = Bugzilla->dbh;
+
+    my $vtc_info = $dbh->bz_column_info('products', 'votestoconfirm');
+    if ($vtc_info->{DEFAULT} == 0) {
+        print "Enabling UNCONFIRMED in every product...\n";
+        $dbh->do('UPDATE products SET votestoconfirm = 10000, votesperuser = 0,
+                                      maxvotesperbug = 0');
+        $dbh->bz_alter_column('products', 'votestoconfirm',
+            {TYPE => 'INT2', NOTNULL => 1, DEFAULT => 10000});
+    }
+}
+
# SECTION: CLEANUP_OLD_INDEXES
+sub _cleanup_old_gnome_db {
+    my $dbh = Bugzilla->dbh;
+    # The GNOME Bugzilla had extra indexes
+    $dbh->bz_drop_index('bugs', 'status_index');
+    $dbh->bz_drop_index('longdescs', 'comment_text');
+}
+
# SECTION: SAVED_SEARCHES
+# In the old GNOME Bugzilla, you could save searches with the 
+# "query=" string literally in the search. Now we have to translate them
+# into QuickSearch queries.
+sub _fix_saved_searches {
+    my $dbh = Bugzilla->dbh;
+    my $queries_to_fix = $dbh->selectall_arrayref(
+        "SELECT id, query FROM namedqueries WHERE query LIKE 'query=%'");
+    return if !@$queries_to_fix;
+
+    my $total = scalar @$queries_to_fix;
+    my $count = 1;
+    print "Fixing saved searches...\n";
+    $dbh->bz_start_transaction();
+    foreach my $row (@$queries_to_fix) {
+        my ($id, $query) = @$row;
+        indicate_progress({ current => $count++, total => $total,
+                            every => 10 });
+        my $cgi = new Bugzilla::CGI($query);
+        my $quicksearch = $cgi->param('query');
+        my $fixed = quicksearch($quicksearch, 1);
+        $dbh->do('UPDATE namedqueries SET query = ? WHERE id = ?',
+                 undef, $fixed, $id);
+        # quicksearch() uses Bugzilla->cgi to store its variables.
+        Bugzilla->cgi->delete_all();
+    }
+    $dbh->bz_commit_transaction();
+}
+
 sub _add_extern_id_index {
     my $dbh = Bugzilla->dbh;
     if (!$dbh->bz_index_info('profiles', 'profiles_extern_id_idx')) {
diff --git a/Bugzilla/Install/Filesystem.pm b/Bugzilla/Install/Filesystem.pm
index 38927ad..45a16f7 100644
--- a/Bugzilla/Install/Filesystem.pm
+++ b/Bugzilla/Install/Filesystem.pm
@@ -113,6 +113,7 @@ sub FILESYSTEM {
# SECTION: REQ_2_ADD_VERSION_SCRIPTS
     my %files = (
         '*'               => { perms => $ws_readable },
         '*.cgi'           => { perms => $ws_executable },
+        'add-version.pl'  => { perms => $owner_executable },
         'whineatnews.pl'  => { perms => $ws_executable },
         'collectstats.pl' => { perms => $ws_executable },
         'checksetup.pl'   => { perms => $owner_executable },
diff --git a/Bugzilla/Product.pm b/Bugzilla/Product.pm
index b118d4b..ace4f82 100644
--- a/Bugzilla/Product.pm
+++ b/Bugzilla/Product.pm
@@ -119,6 +119,9 @@ sub create {
# SECTION: REQ_20_DEVELOPERS_SYSTEM
     $product->_create_bug_group() if Bugzilla->params->{'makeproductgroups'};
     $product->_create_series() if $create_series;
 
+    # Create developer group for the new product
+    $product->_create_developer();
+
     $dbh->bz_commit_transaction();
     return $product;
 }
@@ -358,6 +361,20 @@ sub update {
# SECTION: REQ_20_DEVELOPERS_SYSTEM
             }
         }
     }
+
+    # We also have to fix the developer group name if one exists
+    if ($changes->{name}) {
+        my $developer_group = new Bugzilla::Group(
+            { name => $old_self->name . "_developers" });
+        my $new_group = new Bugzilla::Group(
+            { name => $self->name . '_developers' });
+        if ($developer_group && !$new_group) {
+            $developer_group->set_name($self->name . "_developers");
+            $developer_group->set_description($self->name . " Developers");
+            $developer_group->update();
+        }        
+    }
+
     $dbh->bz_commit_transaction();
     # Changes have been committed.
     delete $self->{check_group_controls};
@@ -394,6 +411,22 @@ sub remove_from_db {
# SECTION: REQ_20_DEVELOPERS_SYSTEM
         }
     }
 
+    # Delete this product's developer group and its members
+    my $group = Bugzilla::Group->new({ name => $self->name . '_developers' });
+    if ($group) {
+        $dbh->do('DELETE FROM user_group_map WHERE group_id = ?',
+                  undef, $group->id);
+        $dbh->do('DELETE FROM group_group_map 
+                  WHERE grantor_id = ? OR member_id = ?',
+                  undef, ($group->id, $group->id));
+        $dbh->do('DELETE FROM bug_group_map WHERE group_id = ?',
+                  undef, $group->id);
+        $dbh->do('DELETE FROM group_control_map WHERE group_id = ?',
+                  undef, $group->id);
+        $dbh->do('DELETE FROM groups WHERE id = ?',
+                  undef, $group->id);
+    }
+
     # XXX - This line can go away as soon as bug 427455 is fixed.
     $dbh->do("DELETE FROM group_control_map WHERE product_id = ?", undef, $self->id);
     $dbh->do("DELETE FROM products WHERE id = ?", undef, $self->id);
@@ -597,6 +630,54 @@ sub _create_series {
# SECTION: REQ_20_DEVELOPERS_SYSTEM
     }
 }
 
+sub _create_developer {
+    my $self = shift;
+
+    # For every product in Bugzilla, create a group named like 
+    # "<product_name>_developers". 
+    # Every developer in the product should be made a member of this group.
+    my $new_group = Bugzilla::Group->create({
+        name        => $self->{'name'} . '_developers',
+        description => $self->{'name'} . ' Developers',
+        isactive    => 1,
+        isbuggroup  => 1,
+    });
+ 
+    # The "<product name>_developers" group should be set to
+    # "MemberControl: Shown, OtherControl: N/A" in the product's group controls.
+    #
+    # The "<product name>_developers" group should also be given editcomponents 
+    # for the product.
+    my $dbh = Bugzilla->dbh;
+    $dbh->do('INSERT INTO group_control_map
+              (group_id, product_id, entry, membercontrol,
+               othercontrol, canedit, editcomponents)
+              VALUES (?, ?, 0, ?, ?, 0, 1)',
+              undef, ($new_group->id, $self->id, CONTROLMAPSHOWN, CONTROLMAPNA));
+
+    # The group should be able to bless itself.
+    $dbh->do('INSERT INTO group_group_map (grantor_id, member_id, grant_type)
+                   VALUES (?,?,?)',
+              undef, $new_group->id, $new_group->id, GROUP_BLESS);
+
+    # The new <product_name>_developers groups should be automatically
+    # made a member of the global developers group
+    my $dev_group = Bugzilla::Group->new({ name => 'developers' });
+    if (!$dev_group) {
+        $dev_group = Bugzilla::Group->create({
+            name        => 'developers',
+            description => 'Developers',
+            isbuggroup  => 1,
+            isactive    => 1,
+        });
+    }
+
+    $dbh->do('INSERT INTO group_group_map
+              (member_id, grantor_id, grant_type)
+              VALUES (?, ?, ?)',
+             undef, ($new_group->id, $dev_group->id, GROUP_MEMBERSHIP));
+}
+
 sub set_name { $_[0]->set('name', $_[1]); }
 sub set_description { $_[0]->set('description', $_[1]); }
 sub set_default_milestone { $_[0]->set('defaultmilestone', $_[1]); }
@@ -852,6 +933,19 @@ sub flag_types {
# SECTION: REQ_20_DEVELOPERS_SYSTEM
     return $self->{'flag_types'};
 }
 
+sub developers {
+    my ($self) = @_;
+
+    if (!defined $self->{'developers'}) {
+        $self->{'developers'} = [];
+
+        my $group = Bugzilla::Group->new({ name => $self->name . '_developers' });
+        $self->{developers} = $group->members_non_inherited;
+    }
+
+    return $self->{'developers'};
+}
+
 ###############################
 ####      Accessors      ######
 ###############################
@@ -865,6 +959,10 @@ sub votes_to_confirm  { return $_[0]->{'votestoconfirm'};    }
# SECTION: REQ_19_B_DISPLAY_STUFF_FOR_GNOME_ONLY
 sub default_milestone { return $_[0]->{'defaultmilestone'};  }
 sub classification_id { return $_[0]->{'classification_id'}; }
 
+sub classification {
+    return Bugzilla::Classification->new($_[0]->classification_id);
+}
+
 ###############################
 ####      Subroutines    ######
 ###############################
@@ -1050,6 +1148,15 @@ groups, in this product.
# SECTION: REQ_20_DEVELOPERS_SYSTEM
 
  Returns:     Two references to an array of flagtype objects.
 
+=item C<developers()>
+ 
+ Description: Returns list of users that are currently
+              in the developers group for this product.
+
+ Params:      none.
+ 
+ Returns:     Reference to an array of user objects.
+
 =back
 
 =head1 SUBROUTINES
diff --git a/Bugzilla/Search.pm b/Bugzilla/Search.pm
index 51f611a..2c15c24 100644
--- a/Bugzilla/Search.pm
+++ b/Bugzilla/Search.pm
@@ -290,6 +290,20 @@ sub init {
# SECTION: REQ_16_GNOME_VERSION_AND_TARGET
         push(@specialchart, ["bug_id", $type, join(',', $params->param('bug_id'))]);
     }
 
+    # Compat for pre-cf gnome fields
+    # The 'none' case has changed from 'Unspecified' to '---' like all the
+    # other fields. These fields can contain multiple values
+    foreach my $gcompat (qw(gnome_version gnome_target)) {
+        if ($params->param($gcompat)) {
+            $params->param("cf_$gcompat",
+                           map { lc($_) eq 'unspecified' ? '---' : $_ }
+                            $params->param($gcompat));
+            # Delete the old param so that edit/save has the new data
+            $params->delete($gcompat);
+            
+        }
+    }
+
     # If the user has selected all of either status or resolution, change to
     # selecting none. This is functionally equivalent, but quite a lot faster.
     # Also, if the status is __open__ or __closed__, translate those
@@ -811,11 +825,22 @@ sub init {
# SECTION: REQ_16_GNOME_VERSION_AND_TARGET
                  $params->param("field$chart-$row-$col") ;
                  $col++) {
                 $f = $params->param("field$chart-$row-$col") || "noop";
-                my $original_f = $f; # Saved for search_description
                 $t = $params->param("type$chart-$row-$col") || "noop";
                 $v = $params->param("value$chart-$row-$col");
                 $v = "" if !defined $v;
                 $v = trim($v);
+                # Compat for pre-cf gnome fields
+                # Rewrite the params so that edit/save has the correct
+                # values
+                if ($f eq 'gnome_version' || $f eq 'gnome_target') {
+                    $f = "cf_$f";
+                    $params->param("field$chart-$row-$col", $f);
+                    if (lc($v) eq 'unspecified') {
+                        $v = '---';
+                        $params->param("value$chart-$row-$col", $v);
+                    }
+                }
+                my $original_f = $f; # Saved for search_description
                 if ($f eq "noop" || $t eq "noop" || $v eq "") {
                     next;
                 }
diff --git a/Bugzilla/Search/Quicksearch.pm b/Bugzilla/Search/Quicksearch.pm
index 54f6c93..38e1ec4 100644
--- a/Bugzilla/Search/Quicksearch.pm
+++ b/Bugzilla/Search/Quicksearch.pm
@@ -112,7 +112,7 @@ use constant COMPONENT_EXCEPTIONS => (
# SECTION: SAVED_SEARCHES
 our ($chart, $and, $or);
 
 sub quicksearch {
-    my ($searchstring) = (@_);
+    my ($searchstring, $permissive) = (@_);
     my $cgi = Bugzilla->cgi;
     my $urlbase = correct_urlbase();
 
@@ -130,7 +130,7 @@ sub quicksearch {
# SECTION: SAVED_SEARCHES
         # Allow separation by comma or whitespace.
         $searchstring =~ s/[,\s]+/,/g;
 
-        if (index($searchstring, ',') < $[) {
+        if (!$permissive and index($searchstring, ',') < $[) {
             # Single bug number; shortcut to show_bug.cgi.
             print $cgi->redirect(-uri => "${urlbase}show_bug.cgi?id=$searchstring");
             exit;
@@ -145,7 +145,7 @@ sub quicksearch {
# SECTION: SAVED_SEARCHES
     else {
         # It's not just a bug number or a list of bug numbers.
         # Maybe it's an alias?
-        if ($searchstring =~ /^([^,\s]+)$/) {
+        if (!$permissive and $searchstring =~ /^([^,\s]+)$/) {
             if (Bugzilla->dbh->selectrow_array(q{SELECT COUNT(*)
                                                    FROM bugs
                                                   WHERE alias = ?},
@@ -397,13 +397,13 @@ sub quicksearch {
# SECTION: SAVED_SEARCHES
         } # foreach (@words)
 
         # Inform user about any unknown fields
-        if (scalar(@unknownFields)) {
+        if (!$permissive and scalar(@unknownFields)) {
             ThrowUserError("quicksearch_unknown_field",
                            { fields => \@unknownFields });
         }
 
         # Make sure we have some query terms left
-        scalar($cgi->param())>0 || ThrowUserError("buglist_parameters_required");
+        scalar($cgi->param())>0 || (!$permissive and ThrowUserError("buglist_parameters_required"));
     }
 
     # List of quicksearch-specific CGI parameters to get rid of.
diff --git a/Bugzilla/Status.pm b/Bugzilla/Status.pm
index 289e172..8fc9d3c 100644
--- a/Bugzilla/Status.pm
+++ b/Bugzilla/Status.pm
@@ -66,6 +66,7 @@ sub VALIDATORS {
# SECTION: TRACEPARSER_SPEEDUP
 sub create {
     my $class = shift;
     my $self = $class->SUPER::create(@_);
+    delete Bugzilla->request_cache->{status_bug_state_open};
     add_missing_bug_status_transitions();
     return $self;
 }
@@ -120,9 +121,12 @@ sub _check_value {
# SECTION: TRACEPARSER_SPEEDUP
 ###############################
 
 sub BUG_STATE_OPEN {
-    # XXX - We should cache this list.
     my $dbh = Bugzilla->dbh;
-    return @{$dbh->selectcol_arrayref('SELECT value FROM bug_status WHERE is_open = 1')};
+    my $cache = Bugzilla->request_cache;
+    $cache->{status_bug_state_open} ||=
+        $dbh->selectcol_arrayref('SELECT value FROM bug_status 
+                                   WHERE is_open = 1');
+    return @{ $cache->{status_bug_state_open} };
 }
 
 # Tells you whether or not the argument is a valid "open" state.
diff --git a/Bugzilla/Template.pm b/Bugzilla/Template.pm
index 5630fc2..77deb88 100644
--- a/Bugzilla/Template.pm
+++ b/Bugzilla/Template.pm
@@ -34,6 +34,7 @@ package Bugzilla::Template;
# SECTION: TRACEPARSER_SPEEDUP
 
 use strict;
 
+use Bugzilla::Bug;
 use Bugzilla::Constants;
 use Bugzilla::Install::Requirements;
 use Bugzilla::Install::Util qw(install_string template_include_path include_languages);
@@ -51,6 +52,7 @@ use File::Find;
# SECTION: TRACEPARSER_SPEEDUP
 use File::Path qw(rmtree mkpath);
 use File::Spec;
 use IO::Dir;
+use Scalar::Util qw(blessed);
 
 use base qw(Template);
 
@@ -123,6 +125,7 @@ sub get_format {
# SECTION: XSS_IN_SHOW_BUG_CGI
     return
     {
         'template'    => $template,
+        'format'      => $format,
         'extension'   => $ctype,
         'ctype'       => Bugzilla::Constants::contenttypes->{$ctype}
     };
@@ -136,7 +139,7 @@ sub get_format {
# SECTION: BUG_FORMAT_COMMENT_HOOK
 # If you want to modify this routine, read the comments carefully
 
 sub quoteUrls {
-    my ($text, $curr_bugid) = (@_);
+    my ($text, $bug, $comment) = (@_);
     return $text unless $text;
 
     # We use /g for speed, but uris can have other things inside them
@@ -164,6 +167,17 @@ sub quoteUrls {
# SECTION: BUG_FORMAT_COMMENT_HOOK
     my $count = 0;
     my $tmp;
 
+    my @hook_regexes;
+    Bugzilla::Hook::process('bug-format_comment',
+        { text => \$text, bug => $bug, regexes => \@hook_regexes,
+          comment => $comment });
+
+    foreach my $re (@hook_regexes) {
+        my ($match, $replace) = @$re{qw(match replace)};
+        $text =~ s/$match/($things[$count++] = $replace) 
+                          && ("\0\0" . ($count-1) . "\0\0")/egx;
+    }
+
     # Provide tooltips for full bug links (Bug 74355)
     my $urlbase_re = '(' . join('|',
         map { qr/$_/ } grep($_, Bugzilla->params->{'urlbase'}, 
@@ -205,13 +219,13 @@ sub quoteUrls {
# SECTION: REQ_35_PATCH_EQUALS_ATTACHMENT
                ("\0\0" . ($count-1) . "\0\0")
               ~egmx;
 
-    $text =~ s~\b(attachment\s*\#?\s*(\d+))
+    $text =~ s~\b((?:attachment|patch)\s*\#?\s*(\d+))
# SECTION: BUG_FORMAT_COMMENT_HOOK
               ~($things[$count++] = get_attachment_link($2, $1)) &&
                ("\0\0" . ($count-1) . "\0\0")
               ~egmxi;
 
     # Current bug ID this comment belongs to
-    my $current_bugurl = $curr_bugid ? "show_bug.cgi?id=$curr_bugid" : "";
+    my $current_bugurl = $bug ? ("show_bug.cgi?id=" . $bug->id) : "";
 
     # This is a hack to speed up displaying comments for the Bugzilla 3.4
     # branch.
@@ -296,20 +310,22 @@ sub get_attachment_link {
# SECTION: TRACEPARSER_SPEEDUP
 #    comment in the bug
 
 sub get_bug_link {
-    my ($bug_num, $link_text, $options) = @_;
+    my ($bug, $link_text, $options) = @_;
     my $dbh = Bugzilla->dbh;
 
-    if (!defined($bug_num) || ($bug_num eq "")) {
-        return "&lt;missing bug number&gt;";
+    if (!$bug) {
+        return html_quote('<missing bug number>');
     }
     my $quote_bug_num = html_quote($bug_num);
     detaint_natural($bug_num) || return "&lt;invalid bug number: $quote_bug_num&gt;";
     ($bug_num <= MAX_INT_32) || return $link_text;
 
-    my ($bug_alias, $bug_state, $bug_res, $bug_desc) =
-        $dbh->selectrow_array('SELECT bugs.alias, bugs.bug_status, bugs.resolution, bugs.short_desc
-                               FROM bugs WHERE bugs.bug_id = ?',
-                               undef, $bug_num);
+    $bug = blessed($bug) ? $bug : new Bugzilla::Bug($bug);
+    return $link_text if $bug->{error};
+    
+    # Initialize these variables to be "" so that we don't get warnings
+    # if we don't change them below (which is highly likely).
+    my ($pre, $title, $post) = ("", "", "");
 
     # This is a hack to speed up displaying comments for the Bugzilla 3.4
     # branch.
@@ -317,44 +333,36 @@ sub get_bug_link {
# SECTION: TRACEPARSER_SPEEDUP
     Bugzilla->template_inner; # populates request_cache->{language}
     my $lang = Bugzilla->request_cache->{language} || '';
 
-    if ($bug_state) {
-        # Initialize these variables to be "" so that we don't get warnings
-        # if we don't change them below (which is highly likely).
-        my ($pre, $title, $post) = ("", "", "");
-
-        my $status = $word_cache->{$lang}->{status}->{$bug_state} 
-                     ||= get_text('get_status', {status => $bug_state});
-        $title = $status;
-        if ($bug_state eq 'UNCONFIRMED') {
-            $pre = "<i>";
-            $post = "</i>";
-        }
-        elsif (!is_open_state($bug_state)) {
-            $pre = '<span class="bz_closed">';
-            my $resolution = $word_cache->{$lang}->{resolution}->{$bug_res}
-                             ||= get_text('get_resolution', 
-                                          { resolution => $bug_res });
-            $title .= ' ' . $resolution;
-            $post = '</span>';
-        }
-        if (Bugzilla->user->can_see_bug($bug_num)) {
-            $title .= " - $bug_desc";
-            if ($options->{use_alias} && $link_text =~ /^\d+$/ && $bug_alias) {
-                $link_text = $bug_alias;
-            }
-        }
-        # Prevent code injection in the title.
-        $title = html_quote(clean_text($title));
+    my $status = $word_cache->{$lang}->{status}->{$bug->bug_status}
+                 ||= get_text('get_status', {status => $bug->bug_status});
+    $title = $status;
 
-        my $linkval = "show_bug.cgi?id=$bug_num";
-        if ($options->{comment_num}) {
-            $linkval .= "#c" . $options->{comment_num};
+    if ($bug->bug_status eq 'UNCONFIRMED') {
+        $pre = "<i>";
+        $post = "</i>";
+    }
+    if ($bug->resolution) {
+        $pre = '<span class="bz_closed">';
+        my $resolution = $word_cache->{$lang}->{resolution}->{$bug->resolution}
+                         ||= get_text('get_resolution', 
+                                      { resolution => $bug->resolution });
+        $title .= ' ' . $resolution;
+        $post = '</span>';
+    }
+    if (Bugzilla->user->can_see_bug($bug)) {
+        $title .= " - " . $bug->short_desc;
+        if ($options->{use_alias} && $link_text =~ /^\d+$/ && $bug->alias) {
+            $link_text = $bug->alias;
         }
-        return qq{$pre<a href="$linkval" title="$title">$link_text</a>$post};
     }
-    else {
-        return qq{$link_text};
+    # Prevent code injection in the title.
+    $title = html_quote(clean_text($title));
+
+    my $linkval = "show_bug.cgi?id=" . $bug->id;
+    if ($options->{comment_num}) {
+        $linkval .= "#c" . $options->{comment_num};
     }
+    return qq{$pre<a href="$linkval" title="$title">$link_text</a>$post};
 }
 
 ###############################################################################
@@ -558,10 +566,10 @@ sub create {
# SECTION: BUG_FORMAT_COMMENT_HOOK
             clean_text => \&Bugzilla::Util::clean_text ,
 
             quoteUrls => [ sub {
-                               my ($context, $bug) = @_;
+                               my ($context, $bug, $comment) = @_;
                                return sub {
                                    my $text = shift;
-                                   return quoteUrls($text, $bug);
+                                   return quoteUrls($text, $bug, $comment);
                                };
                            },
                            1
diff --git a/Bugzilla/Token.pm b/Bugzilla/Token.pm
index 4aee056..1e7d4ff 100644
--- a/Bugzilla/Token.pm
+++ b/Bugzilla/Token.pm
@@ -126,6 +126,15 @@ sub IssueEmailChangeToken {
# SECTION: REQ_8_BUG_BUDDY_CGI
     MessageToMTA($message);
 }
 
+# Generates a password token, and returns it and the expiration time
+sub GeneratePasswordToken {
+    my ($user) = @_;
+
+    my ($token, $token_ts) = _create_token($user->id, 'password', $::ENV{'REMOTE_ADDR'});
+
+    return ($token, ctime($token_ts + MAX_TOKEN_AGE * 86400));
+}
+
 # Generates a random token, adds it to the tokens table, and sends it
 # to the user with instructions for using it to change their password.
 sub IssuePasswordToken {
@@ -142,7 +151,7 @@ sub IssuePasswordToken {
# SECTION: REQ_8_BUG_BUDDY_CGI
 
     ThrowUserError('too_soon_for_new_token', {'type' => 'password'}) if $too_soon;
 
-    my ($token, $token_ts) = _create_token($user->id, 'password', $::ENV{'REMOTE_ADDR'});
+    my ($token, $expiration_ts) = GeneratePasswordToken($user);
 
     # Mail the user the token along with instructions for using it.
     my $template = Bugzilla->template_inner($user->settings->{'lang'}->{'value'});
@@ -150,7 +159,7 @@ sub IssuePasswordToken {
# SECTION: REQ_8_BUG_BUDDY_CGI
 
     $vars->{'token'} = $token;
     $vars->{'emailaddress'} = $user->email;
-    $vars->{'expiration_ts'} = ctime($token_ts + MAX_TOKEN_AGE * 86400);
+    $vars->{'expiration_ts'} = $expiration_ts;
     # The user is not logged in (else he wouldn't request a new password).
     # So we have to pass this information to the template.
     $vars->{'timezone'} = $user->timezone;
diff --git a/Bugzilla/User.pm b/Bugzilla/User.pm
index ad7ff5c..7612bb2 100644
--- a/Bugzilla/User.pm
+++ b/Bugzilla/User.pm
@@ -694,6 +694,23 @@ sub get_selectable_classifications {
# SECTION: REQ_19_B_DISPLAY_STUFF_FOR_GNOME_ONLY
     return $self->{selectable_classifications};
 }
 
+sub get_selectable_gnome_products {
+    my ($self) = @_;
+
+    my @gnome_products = ();
+    my %visible_products = map { $_->name => $_ }
+        @{$self->get_selectable_products};
+
+    foreach my $c (@{Bugzilla::Classification->match({ 'is_gnome' => 1 })}) {
+        foreach my $p (@{$c->products}) {
+            next unless $visible_products{$p->name};
+            push @gnome_products, $p;
+        }
+    }
+
+    return \@gnome_products;
+}
+
 sub can_enter_product {
     my ($self, $product_name, $warn) = @_;
     my $dbh = Bugzilla->dbh;
@@ -1489,6 +1506,9 @@ sub wants_mail {
# SECTION: REQ_14_DISABLE_MAIL_FOR_AT_GNOME_BUGS
     # No mail if there are no events
     return 0 if !scalar(@$events);
 
+    # No mail if you are an @gnome.bugs user.
+    return 0 if $self->login =~ /\@gnome\.bugs$/;
+
     # If a relationship isn't given, default to REL_ANY.
     if (!defined($relationship)) {
         $relationship = REL_ANY;
@@ -1536,10 +1556,9 @@ sub is_insider {
# SECTION: REQ_13_SELF_GLOBALWATCHING
 sub is_global_watcher {
     my $self = shift;
 
-    if (!defined $self->{'is_global_watcher'}) {
-        my @watchers = split(/[,\s]+/, Bugzilla->params->{'globalwatchers'});
-        $self->{'is_global_watcher'} = scalar(grep { $_ eq $self->login } @watchers) ? 1 : 0;
-    }
+    my @watchers = split(/[,\s]+/, Bugzilla->params->{'globalwatchers'});
+    $self->{'is_global_watcher'} = 
+        scalar(grep { $_ eq $self->login } @watchers) ? 1 : 0;
     return  $self->{'is_global_watcher'};
 }
 
@@ -1750,6 +1769,45 @@ sub validate_password {
# SECTION: REQ_4_BROWSE_CGI
     return 1;
 }
 
+sub product_interests {
+    my $self = shift;
+
+    return $self->{'product_int'} if defined $self->{'product_int'};
+    return [] unless $self->id;
+
+    my $product_ids = Bugzilla->dbh->selectcol_arrayref(
+        qq{SELECT products.id
+             FROM components
+                  INNER JOIN products
+                  ON components.product_id = products.id
+                  LEFT JOIN watch
+                  ON components.initialowner = watch.watched
+            WHERE watch.watcher = ?
+                  OR components.initialowner = ?
+            ORDER BY products.name}, 
+    undef, ($self->id, $self->id));
+
+    $self->{'product_int'} = Bugzilla::Product->new_from_list($product_ids);
+
+    return $self->{'product_int'};
+}
+
# SECTION: REQ_23_NOTE_DEVELOPER
+sub is_developer {
+    my ($self, $product) = @_;
+
+    if ($product) {
+        # Given the only use of this is being passed bug.product_obj,
+        # at the moment the performance of this should be fine.
+        my $devs = $product->developers;
+        my $is_dev = grep { $_->id == $self->id } @$devs;
+        return $is_dev ? 1 : 0;
+    }
+    else {
+        return $self->in_group("developers") ? 1 : 0;
+    }
+           
+    return 0; 
+}
 
 1;
 
@@ -2138,6 +2196,11 @@ i.e. if the 'insidergroup' parameter is set and the user belongs to this group.
# SECTION: REQ_23_NOTE_DEVELOPER
 Returns true if the user is a global watcher,
 i.e. if the 'globalwatchers' parameter contains the user.
 
+=item C<is_developer>
+
+Returns true if the user is either a developer for the given product specifically
+or simply a developer for any product if no product is given. Otherwise returns false.
+
 =back
 
 =head1 CLASS FUNCTIONS
@@ -2223,6 +2286,10 @@ Untaints C<$passwd1> if successful.
# SECTION: REQ_4_BROWSE_CGI
 If a second password is passed in, this function also verifies that
 the two passwords match.
 
+=item C<product_interests()>
+
+Returns list of distinct products based on component owners that the user is currently watching.
+
 =back
 
 =head1 SEE ALSO
diff --git a/Bugzilla/Util.pm b/Bugzilla/Util.pm
index 5d75343..d1bdaf0 100644
--- a/Bugzilla/Util.pm
+++ b/Bugzilla/Util.pm
@@ -35,6 +35,7 @@ use base qw(Exporter);
# SECTION: REQ_12_NO_CHANGER_COMMENTER
                              detaint_signed
                              html_quote url_quote xml_quote
                              css_class_quote html_light_quote url_decode
+                             email_filter
                              i_am_cgi get_netaddr correct_urlbase
                              lsearch ssl_require_redirect use_attachbase
                              diff_arrays
@@ -172,8 +173,8 @@ sub html_light_quote {
# SECTION: REQ_12_NO_CHANGER_COMMENTER
 }
 
 sub email_filter {
-    my ($toencode) = @_;
-    if (!Bugzilla->user->id) {
+    my ($toencode, $force) = @_;
+    if ($force || !Bugzilla->user->id) {
         my @emails = Email::Address->parse($toencode);
         if (scalar @emails) {
             my @hosts = map { quotemeta($_->host) } @emails;
@@ -623,7 +624,7 @@ sub _do_srand {
 sub validate_email_syntax {
     my ($addr) = @_;
     my $match = Bugzilla->params->{'emailregexp'};
-    my $ret = ($addr =~ /$match/ && $addr !~ /[\\\(\)<>&,;:"\[\] \t\r\n\P{ASCII}]/);
+    my $ret = ($addr =~ /$match/ && $addr !~ /[\\\(\)<>&,;:"\[\] \t\r\n]/);
     if ($ret) {
         # We assume these checks to suffice to consider the address untainted.
         trick_taint($_[0]);
diff --git a/Bugzilla/WebService/Bug.pm b/Bugzilla/WebService/Bug.pm
index 9ea5477..813162c 100644
--- a/Bugzilla/WebService/Bug.pm
+++ b/Bugzilla/WebService/Bug.pm
@@ -310,7 +310,8 @@ sub legal_values {
# SECTION: REQ_3_ATTACHMENT_STATUS
 
     my $values;
     if (grep($_->name eq $field, @global_selects)) {
-        $values = get_legal_field_values($field);
+        my $field_object = Bugzilla::Field->check($field);
+        $values = [map { $_->name } @{ $field_object->legal_values }];
     }
     elsif (grep($_ eq $field, PRODUCT_SPECIFIC_FIELDS)) {
         my $id = $params->{product_id};
diff --git a/add-version.c b/add-version.c
new file mode 100644
index 0000000..a38f734
--- /dev/null
+++ b/add-version.c
@@ -0,0 +1,25 @@
# SECTION: REQ_2_ADD_VERSION_SCRIPTS
+/*
+ * See http://www.perl.com/doc/manual/html/pod/perlsec.html, section
+ * "Security Bugs" for an explanation of this file (and to find out where I
+ * got the code in this file from).
+ *
+ * A simple perl script that could be used with this file to explain
+ * how things work is the following:
+ *
+ *   #!/usr/bin/perl -w
+ *   use English; # For UID & EUID
+ *   print getpwuid($UID) . "\n";   # could use $< instead of $UID
+ *   print getpwuid($EUID) . "\n";  # could use $> instead of $EUID
+ *
+ * The output of this file should have the setuid bit set and be
+ * executable by all relevant users (probably group and others), while
+ * the perl script only needs to be executable by the user.
+ *
+ * Anyway, simply compile with
+ *   gcc add-version.c -o add-version
+ */
+
+#define REAL_PATH "/usr/local/www/bugzilla/bugzilla/add-version.pl"
+int main(int argc, char **argv) {
+  execv(REAL_PATH, argv);
+}
diff --git a/add-version.cgi b/add-version.cgi
new file mode 100755
index 0000000..647cfc4
--- /dev/null
+++ b/add-version.cgi
@@ -0,0 +1,101 @@
# SECTION: REQ_2_ADD_VERSION_SCRIPTS
+#!/usr/bin/perl -wT
+
+use strict;
+use lib qw(. lib);
+
+use Bugzilla;
+use Bugzilla::Constants;
+use Bugzilla::Error;
+use Bugzilla::Product;
+use Bugzilla::Util qw(i_am_cgi);
+use Bugzilla::Version;
+
+use constant ALLOWED_HOSTS => qw(
+    209.132.180.167
+    209.132.180.178
+);
+
+###############
+# Subroutines #
+###############
+
+sub check_if_version_exists {
+    my ($name, $product) = @_;
+    my $version = new Bugzilla::Version({ product => $product, name => $name });
+    if ($version) {
+      print ", exists (", $product->name, ")";
+      exit;
+    }
+}
+
+###############
+# Main Script #
+###############
+
+Bugzilla->error_mode(ERROR_MODE_DIE);
+
+my $cgi = Bugzilla->cgi;
+
+if (i_am_cgi()) {
+    print $cgi->header(-type => 'text/html');
+
+    if (!grep {$_ eq $cgi->remote_addr} ALLOWED_HOSTS) {
+        print "Not allowed access from " . $cgi->remote_addr; 
+        exit;
+    }
+}
+
+# We get parameters in a weird way for this script, separated by a |
+my ($product_name, $new_version) = split(/\|/, $ENV{'QUERY_STRING'}, 2);
+
+if (!defined($product_name) || !defined($new_version)) {
+    print <<END;
+Usage: add-version.cgi?product|version
+       add-version.pl product version
+
+  product - the bugzilla product with a new version
+  version - the new version that has been released
+
+The program calculates what version to add to the database
+(e.g. 2.0.x) based on existing versions in that product.
+If that doesn't make sense, don't use this script.
+
+For add-version.cgi:
+
+The | in the argument Usage description above is a literal "|", not
+an "or" symbol.
+
+This script does not do any un-escaping of CGI query string characters,
+so a "+" in the string will be treated as a literal "+"
+END
+    exit;
+}
+
+my $product = Bugzilla::Product::check_product($product_name);
+
+# If the full version already exists, we don't create a .x version.
+check_if_version_exists($new_version, $product);
+
+# The version number, but ending in .x instead of its final number.
+my $version_x = $new_version;
+$version_x =~ s/^([\d\.]+)\.\d+$/$1.x/;
+
+# The version number with explicitly two sets of digits and then ending
+# in .x (for example, "2.22" would above become "2.x" but here it would
+# become 2.22.x).
+my $version_major_minor_x = $new_version;
+$version_major_minor_x =~ s/^(\d*?)\.(\d*?)\..*/$1.$2.x/;
+
+# Check if the higher v.x versions exist.
+my $last_version_x;
+while (1) {
+    check_if_version_exists($version_x, $product);
+    $last_version_x = $version_x;
+    $version_x =~ s/^([\d\.]+)\.\d\.x+$/$1.x/;
+    # We go until we get to something like "3.x", which doesn't match the
+    # s/// regex, so it'll stay the same and we're done.
+    last if $version_x eq $last_version_x;
+}
+
+Bugzilla::Version::create($version_major_minor_x, $product);
+print ", added";
diff --git a/add-version.pl b/add-version.pl
new file mode 100755
index 0000000..2f794be
--- /dev/null
+++ b/add-version.pl
@@ -0,0 +1,7 @@
# SECTION: REQ_2_ADD_VERSION_SCRIPTS
+#!/usr/bin/perl -w
+
+use strict;
+use lib qw(. lib);
+
+$ENV{'QUERY_STRING'} = join('|', @ARGV);
+do 'add-version.cgi' || die $@;
diff --git a/attachment.cgi b/attachment.cgi
index f39fa56..b1ed302 100755
--- a/attachment.cgi
+++ b/attachment.cgi
@@ -633,6 +633,13 @@ sub update {
# SECTION: REQ_3_ATTACHMENT_STATUS
     Bugzilla::Attachment->validate_description(THROW_ERROR);
     Bugzilla::Attachment->validate_is_patch(THROW_ERROR);
     Bugzilla::Attachment->validate_content_type(THROW_ERROR) unless $cgi->param('ispatch');
+
+    # Only shows for patches
+    if ($cgi->param('attachments.status')) {
+        Bugzilla::Attachment->validate_status(THROW_ERROR);
+    } else {
+        $cgi->param('attachments.status', $attachment->status);
+    }
     $cgi->param('isobsolete', $cgi->param('isobsolete') ? 1 : 0);
     $cgi->param('isprivate', $cgi->param('isprivate') ? 1 : 0);
 
@@ -703,10 +710,12 @@ sub update {
# SECTION: REQ_3_ATTACHMENT_STATUS
   my $description = $cgi->param('description');
   my $contenttype = $cgi->param('contenttype');
   my $filename = $cgi->param('filename');
+  my $status = $cgi->param('attachments.status');
   # we can detaint this way thanks to placeholders
   trick_taint($description);
   trick_taint($contenttype);
   trick_taint($filename);
+  trick_taint($status);
 
   # Figure out when the changes were made.
   my ($timestamp) = $dbh->selectrow_array("SELECT NOW()");
@@ -725,11 +734,12 @@ sub update {
# SECTION: REQ_3_ATTACHMENT_STATUS
                     ispatch     = ?,
                     isobsolete  = ?,
                     isprivate   = ?,
+                    status      = ?,
                     modification_time = ?
             WHERE   attach_id   = ?",
             undef, ($description, $contenttype, $filename,
             $cgi->param('ispatch'), $cgi->param('isobsolete'), 
-            $cgi->param('isprivate'), $timestamp, $attachment->id));
+            $cgi->param('isprivate'), $status, $timestamp, $attachment->id));
 
   my $updated_attachment = new Bugzilla::Attachment($attachment->id);
   # Record changes in the activity table.
@@ -775,6 +785,12 @@ sub update {
# SECTION: REQ_3_ATTACHMENT_STATUS
                   $attachment->isprivate, $updated_attachment->isprivate);
     $updated = 1;
   }
+  if ($attachment->status ne $updated_attachment->status) {
+    my $fieldid = get_field_id('attachments.status');
+    $sth->execute($bug->id, $attachment->id, $user->id, $timestamp, $fieldid,
+                  $attachment->status, $updated_attachment->status);
+    $updated = 1;
+  }
 
   if ($updated) {
     $dbh->do("UPDATE bugs SET delta_ts = ? WHERE bug_id = ?", undef,
diff --git a/browse.cgi b/browse.cgi
new file mode 100755
index 0000000..44867c0
--- /dev/null
+++ b/browse.cgi
@@ -0,0 +1,236 @@
# SECTION: REQ_4_BROWSE_CGI
+#!/usr/bin/perl -wT
+# -*- Mode: perl; indent-tabs-mode: nil -*-
+#
+# The contents of this file are subject to the Mozilla Public
+# License Version 1.1 (the "License"); you may not use this file
+# except in compliance with the License. You may obtain a copy of
+# the License at http://www.mozilla.org/MPL/
+#
+# Software distributed under the License is distributed on an "AS
+# IS" basis, WITHOUT WARRANTY OF ANY KIND, either express or
+# implied. See the License for the specific language governing
+# rights and limitations under the License.
+#
+# The Original Code is the Bugzilla Bug Tracking System.
+# 
+# The Initial Developer of the Original Code is Netscape Communications
+# Corporation. Portions created by Netscape are Copyright (C) 1998
+# Netscape Communications Corporation. All Rights Reserved.
+#
+# Contributor(s): Terry Weissman <terry@mozilla.org>
+#                 Myk Melez <myk@mozilla.org>
+#                 Gervase Markham <gerv@gerv.net>
+#                 Dave Lawrence <dkl@redhat.com>
+
+use strict;
+
+use lib qw(. lib);
+
+use Bugzilla;
+use Bugzilla::Browse;
+use Bugzilla::Status;
+
+use Bugzilla::Constants;
+use Bugzilla::Util;
+use Bugzilla::Error;
+use Bugzilla::Product;
+use Bugzilla::Classification;
+use Bugzilla::Keyword;
+use Bugzilla::Field;
+
+my $user = Bugzilla->login();
+
+my $cgi      = Bugzilla->cgi;
+my $dbh      = Bugzilla->dbh;
+my $template = Bugzilla->template;
+my $vars     = {};
+
+# All pages point to the same part of the documentation.
+$vars->{'doc_section'} = 'bugreports.html';
+
+my $product_name = trim($cgi->param('product') || '');
+my $product;
+
+if (!$product_name && $cgi->cookie('DEFAULTPRODUCT')) {
+    $product_name = $cgi->cookie('DEFAULTPRODUCT');
+}
+
+my $product_interests = $user->product_interests();
+
+# If the user didn't select a product and there isn't a default from a cookie,
+# try getting the first valid product from their interest list.
+if (!$product_name && scalar @$product_interests) {
+    foreach my $try (@$product_interests) {
+        next if !$user->can_enter_product($try->name);
+        $product_name = $try->name;
+        last;
+    }
+}
+
+if ($product_name eq '') {
+    # If the user cannot enter bugs in any product, stop here.
+    my @enterable_products = @{$user->get_enterable_products};
+    ThrowUserError('no_products') unless scalar(@enterable_products);
+
+    my $classification = Bugzilla->params->{'useclassification'} ?
+        scalar($cgi->param('classification')) : '__all';
+
+    # Unless a real classification name is given, we sort products
+    # by classification.
+    my @classifications;
+
+    unless ($classification && $classification ne '__all') {
+        if (Bugzilla->params->{'useclassification'}) {
+            my $class;
+            # Get all classifications with at least one enterable product.
+            foreach my $product (@enterable_products) {
+                $class->{$product->classification_id}->{'object'} ||=
+                    new Bugzilla::Classification($product->classification_id);
+                # Nice way to group products per classification, without querying
+                # the DB again.
+                push(@{$class->{$product->classification_id}->{'products'}}, $product);
+            }
+            @classifications = sort {$a->{'object'}->sortkey <=> $b->{'object'}->sortkey
+                                     || lc($a->{'object'}->name) cmp lc($b->{'object'}->name)}
+                                    (values %$class);
+        }
+        else {
+            @classifications = ({object => undef, products => \@enterable_products});
+        }
+    }
+
+    unless ($classification) {
+        # We know there is at least one classification available,
+        # else we would have stopped earlier.
+        if (scalar(@classifications) > 1) {
+            # We only need classification objects.
+            $vars->{'classifications'} = [map {$_->{'object'}} @classifications];
+
+            $vars->{'target'} = "browse.cgi";
+            $vars->{'format'} = $cgi->param('format');
+
+            print $cgi->header();
+            $template->process("global/choose-classification.html.tmpl", $vars)
+               || ThrowTemplateError($template->error());
+            exit;
+        }
+        # If we come here, then there is only one classification available.
+        $classification = $classifications[0]->{'object'}->name;
+    }
+
+    # Keep only enterable products which are in the specified classification.
+    if ($classification ne "__all") {
+        my $class = new Bugzilla::Classification({'name' => $classification});
+        # If the classification doesn't exist, then there is no product in it.
+        if ($class) {
+            @enterable_products
+              = grep {$_->classification_id == $class->id} @enterable_products;
+            @classifications = ({object => $class, products => \@enterable_products});
+        }
+        else {
+            @enterable_products = ();
+        }
+    }
+
+    if (scalar(@enterable_products) == 0) {
+        ThrowUserError('no_products');
+    }
+    elsif (scalar(@enterable_products) > 1) {
+        $vars->{'classifications'} = \@classifications;
+        $vars->{'target'} = "browse.cgi";
+        $vars->{'format'} = $cgi->param('format');
+
+        print $cgi->header();
+        $template->process("global/choose-product.html.tmpl", $vars)
+          || ThrowTemplateError($template->error());
+        exit;
+    } else {
+        # Only one product exists.
+        $product = $enterable_products[0];
+    }
+}
+else {
+    # Do not use Bugzilla::Product::check_product() here, else the user
+    # could know whether the product doesn't exist or is not accessible.
+    $product = new Bugzilla::Product({'name' => $product_name});
+}
+
+# We need to check and make sure that the user has permission
+# to enter a bug against this product.
+$user->can_enter_product($product ? $product->name : $product_name, THROW_ERROR);
+
+# Remember selected product
+$cgi->send_cookie(-name => 'DEFAULTPRODUCT',
+                  -value => $product->name,
+                  -expires => "Fri, 01-Jan-2038 00:00:00 GMT");
+
+# Create data structures representing each classification
+my @classifications = (); 
+if (scalar @$product_interests) {
+    my %watches = ( 
+        'name'     => 'Watched Products',
+        'products' => $product_interests
+    );  
+    push @classifications, \%watches;
+}
+
+if (Bugzilla->params->{'useclassification'}) {
+    foreach my $c (@{$user->get_selectable_classifications}) {
+        # Create hash to hold attributes for each classification.
+        my %classification = ( 
+            'name'       => $c->name, 
+            'products'   => [ @{$user->get_selectable_products($c->id)} ]
+        );  
+        # Assign hash back to classification array.
+        push @classifications, \%classification;
+    }   
+}
+
+$vars->{'classifications'}  = \@classifications;
+$vars->{'product'}          = $product;
+$vars->{'total_open_bugs'}  = total_open_bugs($product);
+$vars->{'what_new_means'}   = what_new_means();
+$vars->{'new_bugs'}         = new_bugs($product);
+$vars->{'new_patches'}      = new_patches($product);
+$vars->{'no_response_bugs'} = scalar(@{no_response_bugs($product)});
+
+my $keyword = Bugzilla::Keyword->new({ name => 'gnome-love' });
+if ($keyword) {
+    $vars->{'gnome_love_bugs'}  = keyword_bugs($product, $keyword);
+}
+
+######################################################################
+# Begin temporary searches; If the search will be reused again next
+# release cycle, please just comment it out instead of deleting it.
+######################################################################
+
+$vars->{'critical_warning_bugs'} = critical_warning_bugs($product);
+#$vars->{'string_bugs'} = string_bugs($product);
+
+######################################################################
+# End temporary searches
+######################################################################
+
+$vars->{'by_patch_status'}    = by_patch_status($product);
+$vars->{'buglink'}            = browse_bug_link($product);
+$vars->{'by_version'}         = by_version($product);
+$vars->{'by_target'}          = by_target($product);
+$vars->{'by_priority'}        = by_priority($product);
+$vars->{'by_severity'}        = by_severity($product);
+$vars->{'by_component'}       = by_component($product);
+$vars->{'target_development'} = gnome_target_development();
+$vars->{'target_stable'}      = gnome_target_stable();
+$vars->{'needinfo_split'}     = needinfo_split($product);
+
+($vars->{'blockers_stable'}, $vars->{'blockers_development'}) = list_blockers($product);
+
+print Bugzilla->cgi->header();
+
+my $format = $template->get_format("browse/main",
+                                   scalar $cgi->param('format'),
+                                   scalar $cgi->param('ctype'));
+ 
+print $cgi->header($format->{'ctype'});
+$template->process($format->{'template'}, $vars)
+   || ThrowTemplateError($template->error());
+
diff --git a/buglist.cgi b/buglist.cgi
index 5c7b676..6e619a2 100755
--- a/buglist.cgi
+++ b/buglist.cgi
@@ -92,6 +92,11 @@ if ($cgi->request_method() eq 'POST') {
# SECTION: BACKWARD_COMPAT_QUERY
     }
 }
 
+# Backwards-compat for old GNOME Bugzilla 2.20 saved searches and links.
+if (defined $cgi->param('query') and !defined $cgi->param('quicksearch')) {
+    $cgi->param('quicksearch', $cgi->param('query'));
+    $cgi->delete('query');
+}
 # Determine whether this is a quicksearch query.
 my $searchstring = $cgi->param('quicksearch');
 if (defined($searchstring)) {
@@ -134,16 +139,6 @@ if (defined $cgi->param('ctype') && $cgi->param('ctype') eq "rss") {
# SECTION: JS_TEMPLATE_SEE_ALL_BUGS
     $cgi->param('ctype', "atom");
 }
 
-# The js ctype presents a security risk; a malicious site could use it  
-# to gather information about secure bugs. So, we only allow public bugs to be
-# retrieved with this format.
-#
-# Note that if and when this call clears cookies or has other persistent 
-# effects, we'll need to do this another way instead.
-if ((defined $cgi->param('ctype')) && ($cgi->param('ctype') eq "js")) {
-    Bugzilla->logout_request();
-}
-
 # An agent is a program that automatically downloads and extracts data
 # on its user's behalf.  If this request comes from an agent, we turn off
 # various aspects of bug list functionality so agent requests succeed
@@ -1091,6 +1086,17 @@ $vars->{'displaycolumns'} = \@displaycolumns;
# SECTION: REQ_57_ADD_PRIORITY_TO_ICAL
 $vars->{'openstates'} = [BUG_STATE_OPEN];
 $vars->{'closedstates'} = [map {$_->name} closed_bug_statuses()];
 
+# The iCal file needs priorities ordered from 1 to 9 (highest to lowest)
+# If there are more than 9 values, just make all the lower ones 9
+if ($format->{'extension'} eq 'ics') {
+    my $n = 1;
+    $vars->{'ics_priorities'} = {};
+    my $priorities = get_legal_field_values('priority');
+    foreach my $p (@$priorities) {
+        $vars->{'ics_priorities'}->{$p} = ($n > 9) ? 9 : $n++;
+    }
+}
+
 # The list of query fields in URL query string format, used when creating
 # URLs to the same query results page with different parameters (such as
 # a different sort order or when taking some action on the set of query
diff --git a/colchange.cgi b/colchange.cgi
index a521ee1..1b9015f 100755
--- a/colchange.cgi
+++ b/colchange.cgi
@@ -45,7 +45,7 @@ my $vars = {};
# SECTION: REQ_47_REMOVE_REP_PLATFORM
 # The master list not only says what fields are possible, but what order
 # they get displayed in.
 my @masterlist = ("opendate", "changeddate", "bug_severity", "priority",
-                  "rep_platform", "assigned_to", "assigned_to_realname",
+                  "assigned_to", "assigned_to_realname",
                   "reporter", "reporter_realname", "bug_status",
                   "resolution");
 
diff --git a/contrib/recode.pl b/contrib/recode.pl
index f7ba034..750eec7 100755
--- a/contrib/recode.pl
+++ b/contrib/recode.pl
@@ -284,7 +284,7 @@ foreach my $table ($dbh->bz_table_list_real) {
# SECTION: TRACEPARSER_SPEEDUP
 
                 # We only fix it if it's not ASCII or UTF-8 already.
                 if ($encoding && !grep($_ eq $encoding, IGNORE_ENCODINGS)) {
-                    my $decoded = encode('utf8', decode($encoding, $data));
+                    my $decoded = encode('UTF-8', decode($encoding, $data));
                     if ($switch{'dry-run'} && $data ne $decoded) {
                         print "Row:  [$pk_line]\n",
                               "From: [" . trunc($data) . "] Key: $digest\n",
diff --git a/docs/en/xml/Bugzilla-Guide.xml b/docs/en/xml/Bugzilla-Guide.xml
index 8e86217..39fad92 100644
--- a/docs/en/xml/Bugzilla-Guide.xml
+++ b/docs/en/xml/Bugzilla-Guide.xml
@@ -33,10 +33,10 @@
      For a devel release, simple bump bz-ver and bz-date
 -->
 
-<!ENTITY bz-ver "3.4.14">
+<!ENTITY bz-ver "3.4.13">
 <!ENTITY bz-nextver "3.6">
-<!ENTITY bz-date "2012-01-31">
-<!ENTITY current-year "2012">
+<!ENTITY bz-date "2011-12-28">
+<!ENTITY current-year "2011">
 
 <!ENTITY landfillbase "http://landfill.bugzilla.org/bugzilla-3.4-branch/">
 <!ENTITY bz "http://www.bugzilla.org/">
diff --git a/docs/en/xml/administration.xml b/docs/en/xml/administration.xml
index 9299671..cca663a 100644
--- a/docs/en/xml/administration.xml
+++ b/docs/en/xml/administration.xml
@@ -801,68 +801,6 @@
 
           <varlistentry>
             <term>
-              smtpserver
-            </term>
-            <listitem>
-              <para>
-                This is the SMTP server address, if the <quote>mail_delivery_method</quote>
-                parameter is set to SMTP.  Use "localhost" if you have a local MTA
-                running, otherwise use a remote SMTP server.  Append ":" and the port
-                number, if a non-default port is needed.
-              </para>
-            </listitem>
-          </varlistentry>
-
-          <varlistentry>
-            <term>
-              smtp_username
-            </term>
-            <listitem>
-              <para>
-                Username to use for SASL authentication to the SMTP server.  Leave
-                this parameter empty if your server does not require authentication.
-              </para>
-            </listitem>
-          </varlistentry>
-
-          <varlistentry>
-            <term>
-              smtp_password
-            </term>
-            <listitem>
-              <para>
-                Password to use for SASL authentication to the SMTP server. This
-                parameter will be ignored if the <quote>smtp_username</quote>
-                parameter is left empty.
-              </para>
-            </listitem>
-          </varlistentry>
-
-          <varlistentry>
-            <term>
-              smtp_ssl
-            </term>
-            <listitem>
-              <para>
-                Enable SSL support for connection to the SMTP server.
-              </para>
-            </listitem>
-          </varlistentry>
-
-          <varlistentry>
-            <term>
-              smtp_debug
-            </term>
-            <listitem>
-              <para>
-                This parameter allows you to enable detailed debugging output.
-                Log messages are printed the web server's error log.
-              </para>
-            </listitem>
-          </varlistentry>
-
-          <varlistentry>
-            <term>
               whinedays
             </term>
             <listitem>
@@ -2617,7 +2555,7 @@ ReadOnly: ENTRY, NA/NA, CANEDIT
       <title>Viewing/Editing legal values</title>
       <para>
         Editing legal values requires <quote>admin</quote> privileges.
-        Select "Field Values" from the Administration page. A list of all
+        Select "Legal Values" from the Administration page. A list of all
         fields, both system fields and Custom Fields, for which legal values
         can be edited appears. Click a field name to edit its legal values.
       </para>
@@ -2738,12 +2676,12 @@ ReadOnly: ENTRY, NA/NA, CANEDIT
     </para>
   
     <para>
-      Quip submission is controlled by the <emphasis>quip_list_entry_control</emphasis>
-      parameter.  It has several possible values: open, moderated, or closed.
-      In order to enable quips approval you need to set this parameter to
-      "moderated". In this way, users are free to submit quips for addition
-      but an administrator must explicitly approve them before they are
-      actually used.
+      Quips are controlled by the <emphasis>enablequips</emphasis> parameter.
+      It has several possible values: on, approved, frozen or off.
+      In order to enable quips approval you need to set this parameter
+      to "approved". In this way, users are free to submit quips for
+      addition but an administrator must explicitly approve them before
+      they are actually used.
     </para>
 
     <para>
@@ -2758,7 +2696,7 @@ ReadOnly: ENTRY, NA/NA, CANEDIT
     </para>
 
     <para>
-      Next to each quip there is a checkbox, under the
+      Next to each tip there is a checkbox, under the
       "Approved" column. Quips who have this checkbox checked are
       already approved and will appear next to the search results.
       The ones that have it unchecked are still preserved in the
@@ -2770,11 +2708,6 @@ ReadOnly: ENTRY, NA/NA, CANEDIT
       Also, there is a delete link next to each quip,
       which can be used in order to permanently delete a quip.
     </para>
-
-    <para>
-      Display of quips is controlled by the <emphasis>display_quips</emphasis>
-      user preference.  Possible values are "on" and "off".
-    </para>
   </section>
 
   <section id="groups">
diff --git a/docs/en/xml/using.xml b/docs/en/xml/using.xml
index e26de42..316eb95 100644
--- a/docs/en/xml/using.xml
+++ b/docs/en/xml/using.xml
@@ -661,16 +661,6 @@
# SECTION: JS_TEMPLATE_SEE_ALL_BUGS
         </member>
       </simplelist>
       </para>
-
-      <para>
-        If you would like to access the bug list from another program
-        it is often useful to have the list returned in something other
-        than HTML. By adding the ctype=type parameter into the bug list URL
-        you can specify several alternate formats. Besides the types described
-        above, the following formats are also supported: ECMAScript, also known
-        as JavaScript (ctype=js), and Resource Description Framework RDF/XML
-        (ctype=rdf).
-      </para>
     </section>
 
     <section id="individual-buglists">
diff --git a/editclassifications.cgi b/editclassifications.cgi
index 61b014c..20075e1 100755
--- a/editclassifications.cgi
+++ b/editclassifications.cgi
@@ -103,7 +103,9 @@ if ($action eq 'new') {
# SECTION: REQ_19_CLASSIFICATION_GNOME
     my $classification =
       Bugzilla::Classification->create({name        => $class_name,
                                         description => scalar $cgi->param('description'),
-                                        sortkey     => scalar $cgi->param('sortkey')});
+                                        sortkey     => scalar $cgi->param('sortkey'),
+                                        is_gnome    => scalar $cgi->param('is_gnome'),
+                                       });
 
     delete_token($token);
 
@@ -182,6 +184,7 @@ if ($action eq 'update') {
# SECTION: REQ_19_CLASSIFICATION_GNOME
     $classification->set_name($class_name);
     $classification->set_description(scalar $cgi->param('description'));
     $classification->set_sortkey(scalar $cgi->param('sortkey'));
+    $classification->set_is_gnome(scalar $cgi->param('is_gnome'));
 
     my $changes = $classification->update;
     delete_token($token);
diff --git a/editflagtypes.cgi b/editflagtypes.cgi
index 81d5127..255fe72 100755
--- a/editflagtypes.cgi
+++ b/editflagtypes.cgi
@@ -587,7 +587,7 @@ sub validateCCList {
     # - do not contain any illegal character.
     foreach my $address (@addresses) {
         ($address =~ /^[\w\.\+\-=]+@[\w\.\-]+\.[\w\-]+$/
-           && $address !~ /[\\\(\)<>&,;:"\[\] \t\r\n\P{ASCII}]/)
+           && $address !~ /[\\\(\)<>&,;:"\[\] \t\r\n]/)
           || ThrowUserError('illegal_email_address',
                             {addr => $address, default => 1});
     }
diff --git a/editproducts.cgi b/editproducts.cgi
index adbe974..2711e70 100755
--- a/editproducts.cgi
+++ b/editproducts.cgi
@@ -184,9 +184,9 @@ if ($action eq 'new') {
# SECTION: REQ_25_UNCONFIRMED_ENABLED
                                  defaultmilestone => scalar $cgi->param('defaultmilestone'),
                                  milestoneurl     => scalar $cgi->param('milestoneurl'),
                                  disallownew      => scalar $cgi->param('disallownew'),
-                                 votesperuser     => scalar $cgi->param('votesperuser'),
-                                 maxvotesperbug   => scalar $cgi->param('maxvotesperbug'),
-                                 votestoconfirm   => scalar $cgi->param('votestoconfirm'),
+                                 #votesperuser     => scalar $cgi->param('votesperuser'),
+                                 #maxvotesperbug   => scalar $cgi->param('maxvotesperbug'),
+                                 #votestoconfirm   => scalar $cgi->param('votestoconfirm'),
                                  create_series    => scalar $cgi->param('createseries')});
 
     delete_token($token);
@@ -296,9 +296,9 @@ if ($action eq 'update') {
# SECTION: REQ_25_UNCONFIRMED_ENABLED
     $product->set_default_milestone(scalar $cgi->param('defaultmilestone'));
     $product->set_milestone_url(scalar $cgi->param('milestoneurl'));
     $product->set_disallow_new(scalar $cgi->param('disallownew'));
-    $product->set_votes_per_user(scalar $cgi->param('votesperuser'));
-    $product->set_votes_per_bug(scalar $cgi->param('maxvotesperbug'));
-    $product->set_votes_to_confirm(scalar $cgi->param('votestoconfirm'));
+    #$product->set_votes_per_user(scalar $cgi->param('votesperuser'));
+    #$product->set_votes_per_bug(scalar $cgi->param('maxvotesperbug'));
+    #$product->set_votes_to_confirm(scalar $cgi->param('votestoconfirm'));
 
     my $changes = $product->update();
 
diff --git a/editvalues.cgi b/editvalues.cgi
index 3c553c8..64bc4be 100755
--- a/editvalues.cgi
+++ b/editvalues.cgi
@@ -188,6 +188,8 @@ if ($action eq 'update') {
# SECTION: REQ_3_ATTACHMENT_STATUS
     $value->set_name($cgi->param('value_new'));
     $value->set_sortkey($cgi->param('sortkey'));
     $value->set_visibility_value($cgi->param('visibility_value_id'));
+    # XXX - hack!
+    $value->set_description($cgi->param('description')) if $value->can('set_description');
     $vars->{'changes'} = $value->update();
     delete_token($token);
     $vars->{'message'} = 'field_value_updated';
diff --git a/enter_bug.cgi b/enter_bug.cgi
index 9ea093c..08c38cd 100755
--- a/enter_bug.cgi
+++ b/enter_bug.cgi
@@ -410,6 +410,7 @@ foreach my $field (@enter_bug_fields) {
# SECTION: REQ_19_B_DISPLAY_STUFF_FOR_GNOME_ONLY
 # This allows the Field visibility and value controls to work with the
 # Product field as a parent.
 $default{'product'} = $product->name;
+$default{'classification_obj'} = $product->classification;
 
 if ($cloned_bug_id) {
 
diff --git a/extensions/bugbuddy/code/config-add_panels.pl b/extensions/bugbuddy/code/config-add_panels.pl
new file mode 100644
index 0000000..eefd54c
--- /dev/null
+++ b/extensions/bugbuddy/code/config-add_panels.pl
@@ -0,0 +1,25 @@
# SECTION: REQ_8_BUG_BUDDY_CGI
+# -*- Mode: perl; indent-tabs-mode: nil -*-
+#
+# The contents of this file are subject to the Mozilla Public
+# License Version 1.1 (the "License"); you may not use this file
+# except in compliance with the License. You may obtain a copy of
+# the License at http://www.mozilla.org/MPL/
+#
+# Software distributed under the License is distributed on an "AS
+# IS" basis, WITHOUT WARRANTY OF ANY KIND, either express or
+# implied. See the License for the specific language governing
+# rights and limitations under the License.
+#
+# The Original Code is the Bugzilla BugBuddy Plugin.
+#
+# The Initial Developer of the Original Code is Canonical Ltd.
+# Portions created by Canonical Ltd. are Copyright (C) 2009
+# Canonical Ltd. All Rights Reserved.
+#
+# Contributor(s): Bradley Baetz <bbaetz@acm.org>
+
+use strict;
+use warnings;
+use Bugzilla;
+my $dispatch = Bugzilla->hook_args->{panel_modules};
+$dispatch->{BugBuddy} = "extensions::bugbuddy::lib::ConfigBugBuddy";
diff --git a/extensions/bugbuddy/code/webservice.pl b/extensions/bugbuddy/code/webservice.pl
new file mode 100644
index 0000000..fa24234
--- /dev/null
+++ b/extensions/bugbuddy/code/webservice.pl
@@ -0,0 +1,25 @@
# SECTION: REQ_8_BUG_BUDDY_CGI
+# -*- Mode: perl; indent-tabs-mode: nil -*-
+#
+# The contents of this file are subject to the Mozilla Public
+# License Version 1.1 (the "License"); you may not use this file
+# except in compliance with the License. You may obtain a copy of
+# the License at http://www.mozilla.org/MPL/
+#
+# Software distributed under the License is distributed on an "AS
+# IS" basis, WITHOUT WARRANTY OF ANY KIND, either express or
+# implied. See the License for the specific language governing
+# rights and limitations under the License.
+#
+# The Original Code is the Bugzilla BugBuddy Plugin.
+#
+# The Initial Developer of the Original Code is Canonical Ltd.
+# Portions created by Canonical Ltd. are Copyright (C) 2009
+# Canonical Ltd. All Rights Reserved.
+#
+# Contributor(s): Bradley Baetz <bbaetz@acm.org>
+
+use strict;
+use warnings;
+use Bugzilla;
+my $dispatch = Bugzilla->hook_args->{dispatch};
+$dispatch->{BugBuddy} = "extensions::bugbuddy::lib::WSBugBuddy";
diff --git a/extensions/bugbuddy/info.pl b/extensions/bugbuddy/info.pl
new file mode 100644
index 0000000..6a6b450
--- /dev/null
+++ b/extensions/bugbuddy/info.pl
@@ -0,0 +1,26 @@
# SECTION: REQ_8_BUG_BUDDY_CGI
+# -*- Mode: perl; indent-tabs-mode: nil -*-
+#
+# The contents of this file are subject to the Mozilla Public
+# License Version 1.1 (the "License"); you may not use this file
+# except in compliance with the License. You may obtain a copy of
+# the License at http://www.mozilla.org/MPL/
+#
+# Software distributed under the License is distributed on an "AS
+# IS" basis, WITHOUT WARRANTY OF ANY KIND, either express or
+# implied. See the License for the specific language governing
+# rights and limitations under the License.
+#
+# The Original Code is the Bugzilla BugBuddy Plugin.
+#
+# The Initial Developer of the Original Code is Canonical Ltd.
+# Portions created by Canonical Ltd. are Copyright (C) 2009
+# Canonical Ltd. All Rights Reserved.
+#
+# Contributor(s): Bradley Baetz <bbaetz@acm.org>
+
+use strict;
+no warnings qw(void); # Avoid "useless use of a constant in void context"
+{
+    version => 1,
+    name    => 'BugBuddy',
+};
diff --git a/extensions/bugbuddy/lib/ConfigBugBuddy.pm b/extensions/bugbuddy/lib/ConfigBugBuddy.pm
new file mode 100644
index 0000000..b88f43c
--- /dev/null
+++ b/extensions/bugbuddy/lib/ConfigBugBuddy.pm
@@ -0,0 +1,54 @@
# SECTION: REQ_8_BUG_BUDDY_CGI
+# -*- Mode: perl; indent-tabs-mode: nil -*-
+#
+# The contents of this file are subject to the Mozilla Public
+# License Version 1.1 (the "License"); you may not use this file
+# except in compliance with the License. You may obtain a copy of
+# the License at http://www.mozilla.org/MPL/
+#
+# Software distributed under the License is distributed on an "AS
+# IS" basis, WITHOUT WARRANTY OF ANY KIND, either express or
+# implied. See the License for the specific language governing
+# rights and limitations under the License.
+#
+# The Original Code is the Bugzilla BugBuddy Plugin.
+#
+# The Initial Developer of the Original Code is Canonical Ltd.
+# Portions created by Canonical Ltd. are Copyright (C) 2009
+# Canonical Ltd. All Rights Reserved.
+#
+# Contributor(s): Bradley Baetz <bbaetz@acm.org>
+
+package extensions::bugbuddy::lib::ConfigBugBuddy;
+
+use strict;
+
+use Bugzilla::Config::Common;
+
+$extensions::bugbuddy::lib::ConfigBugBuddy::sortkey = '99';
+
+sub check_version {
+    my $version = shift;
+
+    # This may not capture everything, but it handles gnome version numbers
+    if ($version !~ /^\d+[a-z]*([-.]\d+[a-z]*)*$/i) {
+        return "Must be a version number";
+    }
+
+    return "";
+}
+
+sub get_param_list {
+    my ($class) = @_;
+
+    my @param_list = (
+    {
+        name => 'bugbuddy_min_version',
+        type => 't',
+        default => '2.20.0',
+        checker => \&check_version,
+    },
+    );
+    return @param_list;
+}
+
+1;
diff --git a/extensions/bugbuddy/lib/WSBugBuddy.pm b/extensions/bugbuddy/lib/WSBugBuddy.pm
new file mode 100644
index 0000000..dacc277
--- /dev/null
+++ b/extensions/bugbuddy/lib/WSBugBuddy.pm
@@ -0,0 +1,212 @@
# SECTION: REQ_8_BUG_BUDDY_CGI
+# -*- Mode: perl; indent-tabs-mode: nil -*-
+#
+# The contents of this file are subject to the Mozilla Public
+# License Version 1.1 (the "License"); you may not use this file
+# except in compliance with the License. You may obtain a copy of
+# the License at http://www.mozilla.org/MPL/
+#
+# Software distributed under the License is distributed on an "AS
+# IS" basis, WITHOUT WARRANTY OF ANY KIND, either express or
+# implied. See the License for the specific language governing
+# rights and limitations under the License.
+#
+# The Original Code is the Bugzilla BugBuddy Plugin.
+#
+# The Initial Developer of the Original Code is Canonical Ltd.
+# Portions created by Canonical Ltd. are Copyright (C) 2009
+# Canonical Ltd. All Rights Reserved.
+#
+# Contributor(s): Bradley Baetz <bbaetz@acm.org>
+
+package extensions::bugbuddy::lib::WSBugBuddy;
+use strict;
+use warnings;
+
+use base qw(Bugzilla::WebService);
+
+# We have this, so use it rather than requiring another module
+use Bugzilla::Install::Util qw(vers_cmp);
+
+use Bugzilla::Auth::Verify::Stack;
+use Bugzilla::BugMail;
+use Bugzilla::Constants qw(ERROR_MODE_BUGBUDDY);
+use Bugzilla::Error;
+use Bugzilla::Field;
+use Bugzilla::Mailer;
+use Bugzilla::Token;
+
+# Alias for compat
+BEGIN { *Add = \&createBug; }
+
+# Based on gnome 2.20 customisations
+sub createBug {
+    my ($self, $params) = @_;
+
+    # BugBuddy errors are handled slightly differently
+    Bugzilla->error_mode(ERROR_MODE_BUGBUDDY);
+
+    my $given_gnome_version = $params->{'gnome_version'};
+    if (!defined($given_gnome_version)) {
+        my $cgi = Bugzilla->cgi;
+        if ($cgi->user_agent() =~ /^Bug-Buddy: ([0-9]+\.[0-9]+[0-9.]+)$/) {
+            $given_gnome_version = $1;
+        }
+    }
+    if (defined($given_gnome_version)
+        && vers_cmp($given_gnome_version,
+                    Bugzilla->params->{'bugbuddy_min_version'}) == -1)
+    {
+        ThrowUserError("please_try_with_newer_gnome");
+    }
+
+    my $reporter = $params->{reporter};
+    my $user = Bugzilla::User->new({ name => $reporter });
+    if (!$user) {
+        # New user - create an account
+        # This implicitly requires that the auth mechanism is the DB.
+        # The code itself is generic to any auth method, but we only add the
+        # user to the Bugzilla DB, without checking if its present in the
+        # external system first. Also, the logic assumes that that's
+        # where auth is done, and therefore that we can change the password
+        # later
+
+        $reporter = Bugzilla::User->check_login_name_for_creation($reporter);
+
+        # You might assume that a method called 'check_...for_creation'
+        # would check to see if the address meets the requirements for
+        # an account to be created, but you'd be wrong...
+        my $createexp = Bugzilla->params->{'createemailregexp'};
+        ThrowUserError('invalid_username') if ($reporter !~ /$createexp/);
+
+        # Rather than sending a password in plain text, issue an expiring
+        # one-time token.
+        # After that has expired, the user can still go through the normal
+        # password reset process
+        # If we had a way of enforcing a password change on login that
+        # would be much better/simpler, but we don't.
+        $user = Bugzilla::User->create({
+            login_name    => $reporter,
+            cryptpassword => '*',
+        });
+
+        my ($token, $expiration_ts) =
+            Bugzilla::Token::GeneratePasswordToken($user);
+
+        my $message;
+        my $template = Bugzilla->template;
+        $template->process('email/bug-buddy-account-created.txt.tmpl',
+                           { account       => $reporter,
+                             token         => $token,
+                             expiration_ts => $expiration_ts,
+                             timezone      => $user->timezone }, \$message)
+          || ThrowTemplateError($template->error);
+        MessageToMTA($message);
+    } elsif ($params->{password}) {
+        # Auth, but don't set a cookie
+        # bug-buddy doesn't currently send a password. When it does, this
+        # could later be changed to require a password
+
+        my $auth = Bugzilla::Auth::Verify::Stack->new(Bugzilla->params->{'user_verify_class'});
+        my $login_info = $auth->check_credentials({username => $reporter,
+                                                   password => $params->{password}});
+        if ($login_info->{failure}) {
+            Bugzilla::Error::ThrowUserError("invalid_username_or_password");
+        }
+    }
+
+    if ($user->is_disabled) {
+        ThrowUserError('account_disabled');
+    }
+
+    Bugzilla->set_user($user);
+
+    # Map XMLRPC params onto what Bugzilla::Bug wants
+
+    # Stuff to copy directly (if present; let ->create handle
+    # defaults for stuff not supplied)
+    my @bug_fields = qw(
+        product component
+        short_desc comment
+        priority bug_severity
+        bug_file_loc status_whiteboard
+    );
+
+    my $bug_params = {};
+    foreach my $f (@bug_fields) {
+        $bug_params->{$f} = $params->{$f}
+            if exists $params->{$f};
+    }
+    if (!$bug_params->{op_sys}) {
+        my $op_syses = get_legal_field_values('op_sys');
+        $bug_params->{op_sys} = $op_syses->[0];
+    }
+
+    # Force nautilus-cd-burner -> nautilus, see bug 352989
+    if (lc($params->{product}) eq "nautilus-cd-burner") {
+        $bug_params->{product} = 'nautilus';
+        $bug_params->{component} = 'general';
+    }
+
+    $bug_params->{bug_status} = 'UNCONFIRMED';
+
+    # The gnome versions in the database are like:
+    #       2.1/2.2
+    #   or: 2.0
+    # so we need to parse it out and match against the valid field values
+    if ($given_gnome_version =~ /^([0-9]+\.[0-9]+)[. ]/) {
+        my $match = $1;
+        my $legal_versions = get_legal_field_values('cf_gnome_version');
+
+        my @matches;
+        if (@matches = grep($_ =~ /(?:^|\/)\Q$match\E(?:\/|$)/,
+                            @$legal_versions)) {
+            $bug_params->{cf_gnome_version} = $matches[0];
+        }
+    }
+
+    # Parse version
+    my $prod = Bugzilla::Product->new({'name' => $params->{product}});
+    ThrowUserError('product_doesnt_exist') unless $prod;
+    # Parse component (need to give a specific error message back)
+    grep { $_->name eq $params->{component} } @{$prod->components}
+        or ThrowUserError('component_doesnt_exist');
+
+    my $err = "";
+
+    my $versions = $prod->versions;
+    if (@$versions) {
+        my $version_x = $params->{version};
+        $version_x =~ s/^([\d\.]+\.)\d+$/$1x/;
+
+        my @version;
+        if (@version = grep(lc($_->name) eq lc($params->{version}),
+                            @$versions)) {
+            $bug_params->{'version'} = $version[0]->name;
+        } elsif ($params->{version} =~ /^[\d\.]+\d+$/) {
+            if (@version = grep(/^$version_x$/i,
+                                map { $_->name } @$versions)) {
+              # We were able to match when the last number was replaced
+              # with an 'x' e.g. '1.2.x' instead of '1.2.3'
+              $err .= "Version: " . $params->{version} . "\n";
+              $bug_params->{'version'} = $version[0]; 
+            }
+        }
+    }
+    if (!exists $bug_params->{'version'} && @$versions) {
+        $err .= "Version: " . $params->{'version'} . "\n";
+        $bug_params->{'version'} = $versions->[0]->name;
+    }
+    
+    # XXX - trace parsing goes here
+
+    $bug_params->{comment} = $err . "\n" . $bug_params->{comment}
+        if $err;
+
+    my $bug = Bugzilla::Bug->create($bug_params);
+
+    Bugzilla::BugMail::Send($bug->bug_id, { changer => $bug->reporter->login });
+    
+    return $bug->bug_id;
+}
+
+1;
diff --git a/extensions/bugbuddy/template/en/default/admin/params/bugbuddy.html.tmpl b/extensions/bugbuddy/template/en/default/admin/params/bugbuddy.html.tmpl
new file mode 100644
index 0000000..060304b
--- /dev/null
+++ b/extensions/bugbuddy/template/en/default/admin/params/bugbuddy.html.tmpl
@@ -0,0 +1,23 @@
# SECTION: REQ_8_BUG_BUDDY_CGI
+[%#
+  # The contents of this file are subject to the Mozilla Public
+  # License Version 1.1 (the "License"); you may not use this file
+  # except in compliance with the License. You may obtain a copy of
+  # the License at http://www.mozilla.org/MPL/
+  #
+  # Software distributed under the License is distributed on an "AS
+  # IS" basis, WITHOUT WARRANTY OF ANY KIND, either express or
+  # implied. See the License for the specific language governing
+  # rights and limitations under the License.
+  #
+  # The Original Code is the Bugzilla BugBuddy Plugin.
+  #
+  # The Initial Developer of the Original Code is Canonical Ltd.
+  # Portions created by Canonical are Copyright (C) 2009 Canonical Ltd.
+  # All Rights Reserved.
+  #
+  # Contributor(s): Bradley Baetz <bbaetz@acm.org>
+  #%]
+[%
+    title = "BugBuddy Integration"
+    desc = "Set up BugBuddy integration"
+%]
diff --git a/extensions/bugbuddy/template/en/default/email/bug-buddy-account-created.txt.tmpl b/extensions/bugbuddy/template/en/default/email/bug-buddy-account-created.txt.tmpl
new file mode 100644
index 0000000..d012aac
--- /dev/null
+++ b/extensions/bugbuddy/template/en/default/email/bug-buddy-account-created.txt.tmpl
@@ -0,0 +1,50 @@
# SECTION: REQ_8_BUG_BUDDY_CGI
+[%# The contents of this file are subject to the Mozilla Public
+  # License Version 1.1 (the "License"); you may not use this file
+  # except in compliance with the License. You may obtain a copy of
+  # the License at http://www.mozilla.org/MPL/
+  #
+  # Software distributed under the License is distributed on an "AS
+  # IS" basis, WITHOUT WARRANTY OF ANY KIND, either express or
+  # implied. See the License for the specific language governing
+  # rights and limitations under the License.
+  #
+  # The Original Code is the Bugzilla BugBuddy Plugin
+  #
+  # The Initial Developer of the Original Code is Neiscape Communications
+  # Corporation. Portions created by Netscape are
+  # Copyright (C) 2005 Netscape Communications Corporation. All
+  # Rights Reserved.
+  #
+  # Contributor(s): Olav Vitters <olav@bkor.dhs.org>
+  #%]
+
+[% PROCESS global/variables.none.tmpl %]
+
+From: [% Param("maintainer") %]
+To: [% account %]
+Subject: [[% terms.Bug %]-buddy] Account created on bugzilla.gnome.org
+X-Bugzilla-Type: admin
+
+[%+ terms.Bug %]-buddy has added your [% terms.bug %] report to http://bugzilla.gnome.org/. You should
+receive another email with a copy of your [% terms.bug %] report. You will be kept informed
+of the progress via email.
+
+When answering questions please go to the webpage listed at the top of each
+email. Here you will also be able to make other changes to your  [% terms.bug %] report
+(such as adding attachments). Replies to the [% terms.bug %] emails are unfortunately
+ignored.
+
+The website will ask you for your email address and password. Your email
+address is [% account %].
+
+To set your password, visit the following link:
+
+[%+ urlbase %]token.cgi?t=[% token FILTER url_quote %]&a=cfmpw
+
+before [% expiration_ts FILTER time("%B %e, %Y at %H:%M %Z", timezone) %].
+
+After that time, you can visit:
+
+[%+ urlbase %]?GoAheadAndLogIn=1#forgot
+
+to reset your password.
diff --git a/extensions/describe-user/code/page-before_template.pl b/extensions/describe-user/code/page-before_template.pl
new file mode 100644
index 0000000..4b5ca72
--- /dev/null
+++ b/extensions/describe-user/code/page-before_template.pl
@@ -0,0 +1,7 @@
# SECTION: DESCRIBE_USER
+use strict;
+use warnings;
+use Bugzilla;
+use DescribeUser::Hooks;
+
+page(%{ Bugzilla->hook_args });
+
diff --git a/extensions/describe-user/lib/DescribeUser/Hooks.pm b/extensions/describe-user/lib/DescribeUser/Hooks.pm
new file mode 100644
index 0000000..1993505
--- /dev/null
+++ b/extensions/describe-user/lib/DescribeUser/Hooks.pm
@@ -0,0 +1,316 @@
# SECTION: DESCRIBE_USER
+# -*- Mode: perl; indent-tabs-mode: nil -*-
+#
+# The contents of this file are subject to the Mozilla Public
+# License Version 1.1 (the "License"); you may not use this file
+# except in compliance with the License. You may obtain a copy of
+# the License at http://www.mozilla.org/MPL/
+#
+# Software distributed under the License is distributed on an "AS
+# IS" basis, WITHOUT WARRANTY OF ANY KIND, either express or
+# implied. See the License for the specific language governing
+# rights and limitations under the License.
+#
+# The Original Code is the Bugzilla Bug Tracking System.
+#
+# The Initial Developer of the Original Code is Olav Vitters.
+# Portions created by Olav Vitters are
+# Copyright (C) 2000 Olav Vitters. All
+# Rights Reserved.
+
+package DescribeUser::Hooks;
+
+use strict;
+use base qw(Exporter);
+
+use Bugzilla;
+use Bugzilla::Constants;
+use Bugzilla::User;
+use Bugzilla::Error;
+use Bugzilla::Util;
+
+our @EXPORT = qw(
+    page
+);
+
+sub page {
+    my %params = @_;
+    my ($vars, $page) = @params{qw(vars page_id)};
+    if ($page =~ /^describeuser\./) {
+        _page_describeuser($vars);
+    }
+}
+
+sub _page_describeuser {
+    my $vars = shift;
+
+    my $cgi = Bugzilla->cgi;
+    my $dbh = Bugzilla->dbh;
+    my $user = Bugzilla->user;
+
+    my $userid = $user->id;
+
+    my $r_userid;
+    my $r_user;
+    my $displayname;
+    my $to_be_conjugation;
+
+    if (defined $cgi->param('login') && (!Bugzilla->user->id || (trim($cgi->param('login')) != Bugzilla->user->login))) {
+        $r_userid = login_to_id(trim($cgi->param('login')));
+        if ($r_userid == 0) {
+                ThrowUserError('invalid_username', { name => $cgi->param('login') });
+        }
+        $r_user = Bugzilla::User->new($r_userid);
+        $displayname = $r_user->name || $r_user->login;
+        $to_be_conjugation = 'is';
+    } else {
+        $r_user = Bugzilla->user;
+        $r_userid = Bugzilla->user->id;
+        $displayname = "you";
+        $to_be_conjugation = 'are';
+    }
+
+    $vars->{'userinfo'} = $r_user;
+    $vars->{'displayname'} = $displayname;
+    $vars->{'to_be_conjugation'} = $to_be_conjugation;
+
+    my $sec_join = " LEFT JOIN bug_group_map
+                            ON bug_group_map.bug_id = bugs.bug_id ";
+
+    if ($user->groups) {
+        $sec_join .= "
+                AND bug_group_map.group_id NOT IN (" . $user->groups_as_string . ") ";
+    }
+    $sec_join .= "
+            LEFT JOIN cc
+                   ON cc.bug_id = bugs.bug_id AND cc.who = " . $user->id;
+
+    my $sec_where = "
+        AND bugs.creation_ts IS NOT NULL
+        AND ((bug_group_map.group_id IS NULL)
+             OR (bugs.reporter_accessible = 1 AND bugs.reporter = $userid)
+             OR (bugs.cclist_accessible = 1 AND cc.who IS NOT NULL)
+             OR (bugs.assigned_to = $userid) ";
+
+    if (defined $cgi->param('useqacontact')) {
+        $sec_where .= "
+             OR (bugs.qa_contact = $userid) ";
+    }
+
+    my $sec_where_minus_grouping = $sec_where . ")";
+    $sec_where .= ") " . $dbh->sql_group_by("bugs.bug_id", 'product, bugs.bug_status, bugs.resolution, bugs.bug_severity, bugs.short_desc');
+
+    my $comments = $dbh->selectrow_array(
+        "SELECT COUNT(thetext)
+           FROM longdescs
+          WHERE who = ?", undef, $r_userid);
+
+    $vars->{'comments'} = $comments;
+    my $bugs_closed = $dbh->selectrow_array(
+           "SELECT COUNT(bugs.bug_id)
+              FROM bugs
+        INNER JOIN bugs_activity
+                ON bugs.bug_id = bugs_activity.bug_id
+             WHERE bugs.bug_status IN ('RESOLVED','CLOSED','VERIFIED')
+               AND bugs_activity.added IN ('RESOLVED','CLOSED')
+               AND bugs_activity.bug_when =
+                     (SELECT MAX(bug_when)
+                        FROM bugs_activity ba
+                       WHERE ba.added IN ('RESOLVED','CLOSED')
+                         AND ba.removed IN ('UNCONFIRMED','REOPENED',
+                                            'NEW','ASSIGNED','NEEDINFO')
+                         AND ba.bug_id = bugs_activity.bug_id)
+               AND bugs_activity.who = ?", undef, $r_userid);
+
+    $vars->{'bugs_closed'} = $bugs_closed;
+    my $bugs_reported = $dbh->selectrow_array(
+           "SELECT COUNT(DISTINCT bug_id)
+              FROM bugs
+             WHERE bugs.reporter = ?
+               AND NOT (bugs.bug_status = 'RESOLVED' AND 
+                        bugs.resolution IN ('DUPLICATE','INVALID','NOTABUG',
+                                            'NOTGNOME','INCOMPLETE'))",
+           undef, $r_userid);
+    $vars->{'bugs_reported'} = $bugs_reported;
+
+    $vars->{'developed_products'} = developed_products($r_user);
+
+    my @patches;
+    my $sth = $dbh->prepare("
+            SELECT attachments.bug_id, attachments.status as status,
+                   attachments.attach_id, products.name as product,
+                   attachments.description
+              FROM attachments, bugs, products
+             WHERE attachments.bug_id = bugs.bug_id
+               AND bugs.product_id = products.id
+               AND bugs.bug_status IN ('UNCONFIRMED','NEW','ASSIGNED','REOPENED')
+               AND attachments.submitter_id = ?
+               AND attachments.ispatch='1'
+               AND attachments.isobsolete != '1'
+               AND attachments.status IN ('accepted-commit_after_freeze',
+                                      'accepted-commit_now', 'needs-work', 'none',
+                                      'rejected', 'reviewed')
+          ORDER BY attachments.status");
+
+    $sth->execute($r_userid);
+    while (my $patch = $sth->fetchrow_hashref) {
+        push(@patches, $patch);
+    }
+    $vars->{'patches'} = \@patches;
+
+    my @assignedbugs;
+    $sth = $dbh->prepare(
+           "SELECT bugs.bug_id, products.name AS product, bugs.bug_status,
+                   bugs.resolution, bugs.bug_severity, bugs.short_desc
+              FROM bugs
+                   $sec_join
+        INNER JOIN products
+                ON bugs.product_id = products.id
+             WHERE assigned_to = ?
+               AND bug_status IN ('UNCONFIRMED','NEW','ASSIGNED','REOPENED')
+                   $sec_where
+          ORDER BY bug_id DESC");
+
+    $sth->execute($r_userid);
+    while (my $bug = $sth->fetchrow_hashref) {
+        push(@assignedbugs, $bug);
+    }
+    $vars->{'assignedbugs'} = \@assignedbugs;
+
+    my @needinfoassignedbugs;
+    $sth = $dbh->prepare(
+           "SELECT bugs.bug_id, products.name AS product, bugs.bug_status,
+                   bugs.resolution, bugs.bug_severity, bugs.short_desc
+              FROM bugs
+                   $sec_join
+        INNER JOIN products
+                ON bugs.product_id = products.id
+             WHERE assigned_to = ?
+               AND bug_status IN ('NEEDINFO')
+                   $sec_where
+          ORDER BY bug_id DESC");
+
+    $sth->execute($r_userid);
+    while (my $bug = $sth->fetchrow_hashref) {
+        push(@needinfoassignedbugs, $bug);
+    }
+    $vars->{'needinfoassignedbugs'} = \@needinfoassignedbugs;
+
+    my @needinforeporterbugs;
+    $sth = $dbh->prepare(
+           "SELECT bugs.bug_id, products.name AS product, bugs.bug_status,
+                   bugs.resolution, bugs.bug_severity, bugs.short_desc
+              FROM bugs
+                   $sec_join
+        INNER JOIN products
+                ON bugs.product_id = products.id
+             WHERE reporter=?
+               AND bug_status IN ('NEEDINFO')
+                   $sec_where
+          ORDER BY bug_id DESC");
+
+    $sth->execute($r_userid);
+    while (my $bug = $sth->fetchrow_hashref) {
+        push(@needinforeporterbugs, $bug);
+    }
+    $vars->{'needinforeporterbugs'} = \@needinforeporterbugs;
+
+    my @newbugs;
+    $sth = $dbh->prepare(
+           "SELECT bugs.bug_id, products.name AS product, bugs.bug_status,
+                   bugs.resolution, bugs.bug_severity, bugs.short_desc
+              FROM bugs
+                   $sec_join
+        INNER JOIN products
+                ON bugs.product_id = products.id
+             WHERE reporter = ?
+               AND bug_status IN ('UNCONFIRMED','NEW','REOPENED')
+                   $sec_where
+          ORDER BY bug_id DESC");
+
+    $sth->execute($r_userid);
+    while (my $bug = $sth->fetchrow_hashref) {
+        push(@newbugs, $bug);
+    }
+    $vars->{'newbugs'} = \@newbugs;
+
+    my @inprogressbugs;
+    $sth = $dbh->prepare(
+           "SELECT bugs.bug_id, products.name AS product, bugs.bug_status, bugs.resolution, bugs.bug_severity, bugs.short_desc
+              FROM bugs
+                   $sec_join
+        INNER JOIN products
+                ON bugs.product_id = products.id
+             WHERE reporter=?
+               AND bug_status = 'ASSIGNED'
+                   $sec_where
+          ORDER BY bug_id DESC");
+
+    $sth->execute($r_userid);
+    while (my $bug = $sth->fetchrow_hashref) {
+        push(@inprogressbugs, $bug);
+    }
+    $vars->{'inprogressbugs'} = \@inprogressbugs;
+
+    my @recentlyclosed;
+    $sth = $dbh->prepare("
+            SELECT bugs.bug_id, products.name AS product, bugs.bug_status, 
+                   bugs.resolution, bugs.bug_severity, bugs.short_desc 
+              FROM bugs
+                   $sec_join
+        INNER JOIN products
+                ON bugs.product_id = products.id
+        INNER JOIN bugs_activity
+                ON bugs.bug_id = bugs_activity.bug_id
+             WHERE bugs.reporter = ?
+               AND bugs_activity.added='RESOLVED'
+               AND (bugs.bug_status='RESOLVED' OR bugs.bug_status = 'VERIFIED' 
+                    OR bugs.bug_status='CLOSED')
+               AND bugs_activity.bug_when >= NOW() - " . $dbh->sql_interval(7, 'DAY')
+                 . $sec_where);
+
+    $sth->execute($r_userid);
+    while (my $bug = $sth->fetchrow_hashref) {
+        push(@recentlyclosed, $bug);
+    }
+    $vars->{'recentlyclosed'} = \@recentlyclosed;
+
+    if ($user->in_group('editbugs') && $r_user->login =~ '.*@gnome\.bugs$') {
+        my $watcher_ids = $dbh->selectcol_arrayref(
+            "SELECT watcher FROM watch WHERE watched = ?",
+            undef, $r_userid);
+
+        my @watchers;
+        foreach my $watcher_id (@$watcher_ids) {
+            my $watcher = new Bugzilla::User($watcher_id);
+            push (@watchers, Bugzilla::User::identity($watcher));
+        }
+
+        @watchers = sort { lc($a) cmp lc($b) } @watchers;
+        $vars->{'watchers'} = \@watchers;
+    }
+
+    # XXX: this is just a temporary measure until points get back in a table, it
+    # can be done here at not cost as numbers are already collected.
+    my $points = log(1 + $comments) / log(10) +
+                 log(1 + $bugs_closed) / log(2) + 
+                 log(1 + $bugs_reported) / log(2);
+    $vars->{'points'} = int($points + 0.5);
+}
+
+sub developed_products {
+    my $self = shift;
+
+    return [] unless $self->id;
+
+    # Get the list of products
+    my $groups = $self->{groups};
+    my $group_membership;
+    foreach my $group (@$groups) {
+         push (@$group_membership,
+               substr($group->name, 0, index($group->name, '_developers')))
+               if $group->name =~ /_developers$/;
+    }
+
+    # return it
+    return $group_membership;
+}
diff --git a/extensions/describe-user/template/en/default/global/user.html.tmpl b/extensions/describe-user/template/en/default/global/user.html.tmpl
new file mode 100644
index 0000000..e463aa7
--- /dev/null
+++ b/extensions/describe-user/template/en/default/global/user.html.tmpl
@@ -0,0 +1,42 @@
# SECTION: DESCRIBE_USER
+[%# The contents of this file are subject to the Mozilla Public
+  # License Version 1.1 (the "License"); you may not use this file
+  # except in compliance with the License. You may obtain a copy of
+  # the License at http://www.mozilla.org/MPL/
+  #
+  # Software distributed under the License is distributed on an "AS
+  # IS" basis, WITHOUT WARRANTY OF ANY KIND, either express or
+  # implied. See the License for the specific language governing
+  # rights and limitations under the License.
+  #
+  # The Original Code is the Bugzilla Bug Tracking System.
+  #
+  # The Initial Developer of the Original Code is Daniel Brooks.
+  # Portions created by the Initial Developer are Copyright (C) 2007
+  # the Initial Developer. All Rights Reserved.
+  #
+  # Contributor(s): 
+  #   Daniel Brooks <db48x@db48x.net>
+  #   Max Kanat-Alexander <mkanat@bugzilla.org>
+  #
+  # Modification for the describe-user extension:
+  #  - replace mailto: link by link to the describeuser page
+  #%]
+
+[%# INTERFACE:
+  # who: A Bugzilla::User object that we are going to represent.
+  #%]
+
+<span class="vcard">
+  [% FILTER collapse %]
+    [% IF user.id %]
+      <a href="page.cgi?id=describeuser.html&login=[% who.email FILTER url_quote %]"
+         title="[% who.identity FILTER html %]">
+    [%- END -%]
+    [% IF who.name %]
+       <span class="fn">[% who.name FILTER html %]</span>
+    [% ELSE %]
+      [% who.login FILTER email FILTER html %]
+    [% END %]
+    [% '</a>' IF user.id %]
+  [% END %]
+</span>
diff --git a/extensions/describe-user/template/en/default/pages/describeuser.html.tmpl b/extensions/describe-user/template/en/default/pages/describeuser.html.tmpl
new file mode 100644
index 0000000..7a5dd06
--- /dev/null
+++ b/extensions/describe-user/template/en/default/pages/describeuser.html.tmpl
@@ -0,0 +1,377 @@
# SECTION: DESCRIBE_USER
+[%# 1.0@bugzilla.org %]
+[%# The contents of this file are subject to the Mozilla Public
+  # License Version 1.1 (the "License"); you may not use this file
+  # except in compliance with the License. You may obtain a copy of
+  # the License at http://www.mozilla.org/MPL/
+  #
+  # Software distributed under the License is distributed on an "AS
+  # IS" basis, WITHOUT WARRANTY OF ANY KIND, either express or
+  # implied. See the License for the specific language governing
+  # rights and limitations under the License.
+  #
+  # The Original Code is the Bugzilla Bug Tracking System.
+  #
+  # The Initial Developer of the Original Code is Netscape Communications
+  # Corporation. Portions created by Netscape are
+  # Copyright (C) 1998 Netscape Communications Corporation. All
+  # Rights Reserved.
+  #
+  # Contributor(s): Gervase Markham <gerv@gerv.net>
+  #%]
+
+[%# INTERFACE:
+  # displayname:        displayname for user
+  # to_be_conjugation:  "is" or "are"
+  # comments:           Number of comments user has added to bugs
+  # bugs_closed:        Number of comments user has added to bugs
+  # bugs_reported:      Number of comments user has added to bugs
+  # developed_products: products the user is a developer for
+  #
+  # userinfo: info about the user; contains
+  #   id:                 bugzilla userid
+  #   email:              email address
+  #   points:             points the user has acquired
+  #   products_interests: products the user is interested in
+  #
+  # patches: list of patches; each patch has
+  #   status:      review status of the patch (e.g. 'needs-work')
+  #   attach_id:   attachment id, for attachment.cgi
+  #   bug_id:      bug where patch is filed against
+  #   product:     name of product in which the bug is filed against
+  #   description: patch description
+  # 
+  # assignedbugs:
+  # needinfoassignedbugs:
+  # needinforeporterbugs:
+  # newbugs:
+  # inprogressbugs:
+  # recentlyclosed:
+  # <All provide lists of bugs, with the fields>
+  #   bug_id:       bug id
+  #   product:      product the bug is filed against
+  #   bug_status:   status of the bug
+  #   resolution:   resolution of the bug
+  #   bug_severity: severity of the bug
+  #   short_desc:   summary (short description) of the bug
+ %]
+
+[% PROCESS global/variables.none.tmpl %]
+
+[%### Setting up the "Bugzilla User Info for <user>" header ###%]
+  [% linked_name = BLOCK %]
+    [% IF userinfo.id == user.id %]
+      [% showuser = '' %]
+    [% ELSE %]
+      [% showuser = displayname %]
+    [% END %]
+
+    [% IF showuser != '' %]
+      for 
+      [% IF user.in_group('editusers') || user.can_bless %]
+        <a href="editusers.cgi?action=edit&userid=[% userinfo.id 
+                FILTER url_quote %]">
+      [% END %]
+      [% showuser FILTER html %]
+      [% IF user.in_group('editusers') %]
+        </a>
+      [% END %]
+    [% END %]
+  [% END %]
+
+  [% name_title = BLOCK %]
+    [% linked_name FILTER remove('<[^>]*>') %]
+  [% END %]
+
+[%### Actually handling the header ###%]
+  [% PROCESS global/header.html.tmpl
+    title = "$terms.Bugzilla User Info$name_title"
+    header = "$terms.Bugzilla User Info$linked_name"
+    style = "
+  table.figures td { padding-top: 0px; padding-bottom: 0px }
+  table.figures td { margin-top: 0px; margin-bottom: 0px }
+  table.figures tr { margin-top: 0px; margin-bottom: 0px }
+  .blocker { margin-top: 1em; }
+  #body { padding-right: 0px; }
+  h3 { padding-top: 1em; }
+  h3 span { background-color: #babdb6; }
+  ul { padding-left: 1em; padding-top: 0px; padding-bottom: 0px; margin-top: 0px;
+  margin-bottom: 0px; }
+  "
+  %]
+
+[%### The info in the right hand side bar ###%]
+  <div style="position: relative; float: right; -moz-border-radius-topleft: 20px;
+              -webkit-border-top-left-radius: 20px; -webkit-border-bottom-left-radius: 20px;
+              -moz-border-radius-bottomleft: 20px; padding-right: 1em;
+              margin-right: 0px; margin-left: 1ex; background-color: #ffeafd;
+              padding-left: 1em; padding-bottom: 1em; width: 15em;">
+
+  <h3>Basic stats</h3>
+  [% displayname FILTER html %]
+  <ul>
+    <li> added [% comments FILTER html %] comments to [% terms.bugs %].</li>
+    <li> closed [% bugs_closed FILTER html %] [%+ terms.bugs %].</li>
+    <li> reported [% bugs_reported FILTER html %] [%+ terms.bugs %].</li>
+    <li> gathered [% points FILTER html %] points.</li>
+  </ul>
+
+  [% IF developed_products.size > 0 %]
+    <h3>Developer of</h3>
+
+    <ul>
+    [% FOREACH product = developed_products %]
+      <li><a href="browse.cgi?product=[% product.name FILTER url_quote %]">[% product 
+          FILTER html %]</a></li>
+    [% END %]
+    </ul>
+  [% END %]
+
+  [% IF userinfo.product_interests.size > 0 %]
+    <h3>Interested products</h3>
+
+    <ul>
+    [% FOREACH product = userinfo.product_interests %]
+      <li><a href="browse.cgi?product=[% product.name FILTER url_quote %]">[% product.name
+           FILTER html %]</a></li>
+    [% END %]
+    </ul>
+  [% END %]
+
+  [% IF watchers && watchers.size > 0 %]
+    <h3>Watchers</h3>
+    
+    <ul>
+    [% FOREACH watcher = watchers %]
+      <li>[% watcher FILTER html %]</li>
+    [% END %]
+    </ul>
+  [% END %]
+
+  <h3>Reports</h3>
+  <ul>
+    <li><a href="[% "buglist.cgi?bug_status=RESOLVED,VERIFIED,CLOSED" _
+                    "&amp;emailreporter1=1&amp;emailtype1=exact&amp;email1=" %]
+                 [% userinfo.email FILTER url_quote %]">All closed bugs</a></li>
+    <li><a href="[% "buglist.cgi?emailcc1=1&amp;emailtype1=exact&amp;email1=" %]
+                 [% userinfo.email FILTER url_quote %]">All bugs cc'ed</a></li>
+    <li><a href="[% "buglist.cgi?emaillongdesc1=1&amp;emailtype1=exact&amp;" _
+                    "email1=" %]
+                 [% userinfo.email FILTER url_quote %]">All bugs commented</a></li>
+  </ul>
+
+  </div>
+
+[%### Bugs ###%]
+  <p>
+    <h3><span>Open Issues: 
+      <a href="
+        [% "buglist.cgi?bug_status=UNCONFIRMED&amp;bug_status=NEW" %]
+        [% "&amp;bug_status=REOPENED&amp;bug_status=ASSIGNED" %]
+        [% "&amp;emailassigned_to1=1&amp;emailtype1=exact&amp;email1=" %]
+        [% userinfo.email FILTER url_quote %]">
+        <b>Assigned to [% displayname FILTER html %]</b></a> 
+      [% "(the issue has been assigned to" %]
+      [%+ displayname FILTER html %]
+      [%+ "and it is not resolved or closed yet)" %]
+    </span></h3>
+    <table border="0" cellpadding="2" cellspacing="0">
+    [% FOREACH bug = assignedbugs %]
+      <tr class="[%+ IF loop.count() % 2 == 0 %]
+                   [% "bz_row_even" %]
+                 [% ELSE %]
+                   [% "bz_row_odd" %]
+                 [% END %]">
+        <td nowrap="nowrap" style="width: 6ex" align="center">
+          [% %]<a href="[% "show_bug.cgi?id=" %]
+          [% bug.bug_id FILTER url_quote%]">
+          [% bug.bug_id FILTER html %]</a></td>
+        <td nowrap="nowrap" style="width: 12ex">
+          [% %]<a href="[% "browse.cgi?product=" %]
+          [% bug.product FILTER url_quote %]">
+          [% bug.product FILTER html %]</a></td>
+        <td nowrap="nowrap" style="width: 4ex" align="center">
+          [% bug.bug_status.truncate(4) FILTER html %]</td>
+        <td nowrap="nowrap" style="width: 3ex" align="center">
+          [% bug.bug_severity.truncate(3) FILTER html %]</td>
+        <td><a href="[% "show_bug.cgi?id=" %]
+          [% bug.bug_id FILTER url_quote%]">
+          [% bug.short_desc FILTER html %]</a></td>
+      </tr>
+    [% END %]
+    </table>
+  </p>
+
+  <p>
+    <h3><span>Open Issues:
+      <a href="
+        [% "buglist.cgi?bug_status=NEEDINFO&amp;emailreporter1=1&amp;emailtype1=" %]
+        [% "exact&amp;email1=" %] [% userinfo.email FILTER url_quote %]">
+        <b>Needinfo</b></a>
+      ([% displayname FILTER html %] 
+      [%+ "reported this issue, it requires more information and you should " %]
+      [% "provide it) " %]
+    </span></h3>
+    <table border="0" cellpadding="3" cellspacing="1">
+    [% FOREACH bug = needinforeporterbugs %]
+      <tr class="[%+ IF loop.count() % 2 == 0 %]
+                   [% "bz_row_even" %]
+                 [% ELSE %]
+                   [% "bz_row_odd" %]
+                 [% END %]">
+        <td nowrap="nowrap" style="width: 6ex" align="center">
+          [% %]<a href="show_bug.cgi?id=[% bug.bug_id FILTER url_quote %]">
+          [% bug.bug_id FILTER html %]</a></td>
+        <td nowrap="nowrap" style="width: 12ex">
+          [% %]<a href="browse.cgi?product=[% bug.product FILTER url_quote %]">
+          [% bug.product FILTER html %]</a></td>
+        <td nowrap="nowrap" style="width: 4ex" align="center">
+          [% bug.bug_status.truncate(4) FILTER html %]</td>
+        <td nowrap="nowrap" style="width: 3ex" align="center">
+          [% bug.bug_severity.truncate(3) FILTER html %]</td>
+        <td><a href="show_bug.cgi?id=[% bug.bug_id FILTER url_quote%]">
+          [% bug.short_desc FILTER html %]</a></td>
+      </tr>
+    [% END %]
+    </table>
+  </p>
+
+  <p>
+    <h3><span>Open Issues: 
+      <a href="
+        [% "buglist.cgi?bug_status=UNCONFIRMED&amp;bug_status=NEW&amp;" %]
+        [% "bug_status=REOPENED&amp;emailreporter1=1&amp;emailtype1=exact" %]
+        [% "&amp;email1=" %] [% userinfo.email FILTER url_quote %]">
+        <b>New</b></a>
+      ([% displayname FILTER html %] 
+      [%+ "reported it but nobody has accepted it yet)" %]
+     </span></h3>
+    <table border="0" cellpadding="3" cellspacing="0">
+    [% FOREACH bug = newbugs %]
+      <tr class="[%+ IF loop.count() % 2 == 0 %]
+                   [% "bz_row_even" %]
+                 [% ELSE %]
+                   [% "bz_row_odd" %]
+                 [% END %]">
+        <td nowrap="nowrap" style="width: 6ex" align="center">
+          [% %]<a href="show_bug.cgi?id=[% bug.bug_id FILTER url_quote %]">
+          [% bug.bug_id FILTER html %]</a></td>
+        <td nowrap="nowrap" style="width: 12ex" >
+          [% %]<a href="browse.cgi?product=[% bug.product FILTER url_quote %]">
+          [% bug.product FILTER html %]</a></td>
+        <td nowrap="nowrap" style="width: 4ex" align="center">
+          [% bug.bug_status.truncate(4) FILTER html %]</td>
+        <td nowrap="nowrap" style="width: 3ex" align="center">
+          [% bug.bug_severity.truncate(3) FILTER html %]</td>
+        <td>
+          [% %]<a href="show_bug.cgi?id=[% bug.bug_id FILTER url_quote%]">
+          [% bug.short_desc FILTER html %]</a></td>
+      </tr>
+    [% END %]
+    </table>
+  </p>
+
+  <p>
+    <h3><span>Open Issues:
+      <a href="
+        [% "buglist.cgi?bug_status=ASSIGNED&amp;emailreporter1=1&amp;" %]
+        [% "emailtype1=exact&amp;email1=" %]
+        [% userinfo.email FILTER url_quote %]">
+        <b>In progress</b></a>
+      ([% displayname FILTER html %]
+       [%+ "reported it, the developer accepted the issue and is hopefully " %]
+       [% "working on it)" %]
+    </span></h3>
+    <table border="0" cellpadding="3" cellspacing="0">
+    [% FOREACH bug = inprogressbugs %]
+      <tr class="[%+ IF loop.count() % 2 == 0 %]
+                   [% "bz_row_even" %]
+                 [% ELSE %]
+                   [% "bz_row_odd" %]
+                 [% END %]">
+        <td nowrap="nowrap" style="width: 6ex" align="center">
+          [% %]<a href="show_bug.cgi?id=[% bug.bug_id FILTER url_quote %]">
+          [% bug.bug_id FILTER html %]</a></td>
+        <td nowrap="nowrap" style="width: 12ex">
+          [% %]<a href="browse.cgi?product=[% bug.product FILTER url_quote %]">
+          [% bug.product FILTER html %]</a></td>
+        <td nowrap="nowrap" style="width: 4ex" align="center">
+          [% bug.bug_status.truncate(4) FILTER html %]</td>
+        <td nowrap="nowrap" style="width: 3ex" align="center">
+          [% bug.bug_severity.truncate(3) FILTER html %]</td>
+        <td>
+          [% %]<a href="show_bug.cgi?id=[% bug.bug_id FILTER url_quote%]">
+          [% bug.short_desc FILTER html %]</a></td>
+      </tr>
+    [% END %]
+    </table>
+  </p>
+
+  <p>
+    <h3><span>Closed Issues: <b>Recently closed</b></a> ([% displayname FILTER html %] reported it and the issue was closed in the last 7 days)</span></h3>
+    <table border="0" cellpadding="3" cellspacing="0">
+    [% FOREACH bug = recentlyclosed %]
+      <tr class="[%+ IF loop.count() % 2 == 0 %]
+                   [% "bz_row_even" %]
+                 [% ELSE %]
+                   [% "bz_row_odd" %]
+                 [% END %]">
+        <td nowrap="nowrap" style="width: 6ex" align="center">
+          [% %]<a href="show_bug.cgi?id=[% bug.bug_id FILTER url_quote %]">
+          [% bug.bug_id FILTER html %]</a></td>
+        <td nowrap="nowrap" style="width: 12ex">
+          [% %]<a href="browse.cgi?product=[% bug.product FILTER url_quote %]">
+          [% bug.product FILTER html %]</a></td>
+        <td nowrap="nowrap" style="width: 4ex" align="center">
+          [% bug.resolution.truncate(4) FILTER html %]</td>
+        <td nowrap="nowrap" style="width: 3ex" align="center">
+          [% bug.bug_severity.truncate(3) FILTER html %]</td>
+        <td>
+          [% %]<a href="show_bug.cgi?id=[% bug.bug_id FILTER url_quote%]">
+          [% bug.short_desc FILTER html %]</a></td>
+      </tr>
+    [% END %]
+    </table>
+  </p>
+
+[%### Patches ###%]
+  [% IF patches.size %]
+    [% status = '' %]
+    [% FOREACH patch = patches %]
+      [% IF patch.status != status %]
+        [% IF status != '' %]
+          [% "\n    </table>\n  </p>\n\n" %]
+        [% END %]
+        [% status = patch.status %]
+        [% "  <p>\n" _
+           "    <h3><span>Patches: " %]
+        [% status.replace('none','unreviewed') %]
+        [% "</span></h3>\n" %]
+        [% "    <table border=\"0\" cellpadding=\"2\" cellspacing=\"0\">" %]
+      [% END %]
+      <tr class="[%+ IF loop.count() % 2 == 0 %]
+                   [% "bz_row_even" %]
+                 [% ELSE %]
+                   [% "bz_row_odd" %]
+                 [% END %]">
+        <td><a href="[% "show_bug.cgi?id=" %]
+                     [% patch.bug_id FILTER url_quote%]">
+                     [% patch.bug_id FILTER html %]</a></td>
+        <td><a href="[% "attachment.cgi?id=" %]
+                     [% patch.attach_id FILTER url_quote %]
+                     [% "&amp;action=diff" %]">(#
+                     [% patch.attach_id FILTER html %])</a></td>
+        <td nowrap="nowrap" style="width: 12ex">
+          [% %]<a href="[% "browse.cgi?product=" %]
+                        [% patch.product FILTER url_quote %]
+                        [% "\">" %]
+                        [% patch.product FILTER html %]</a></td>
+        <td><a href="[% "attachment.cgi?id=" %]
+                     [% patch.attach_id FILTER url_quote %]
+                     [% "&amp;action=diff" %]">
+                     [% patch.description FILTER html %]</a></td>
+      </tr>
+    [% END %]
+    [% "    </table>\n  </p>" %]
+  [% END %]
+
+[% PROCESS global/footer.html.tmpl %]
diff --git a/extensions/example/code/bug-format_comment.pl b/extensions/example/code/bug-format_comment.pl
new file mode 100644
index 0000000..5ed22c5
--- /dev/null
+++ b/extensions/example/code/bug-format_comment.pl
@@ -0,0 +1,31 @@
# SECTION: BUG_FORMAT_COMMENT_HOOK
+# -*- Mode: perl; indent-tabs-mode: nil -*-
+#
+# The contents of this file are subject to the Mozilla Public
+# License Version 1.1 (the "License"); you may not use this file
+# except in compliance with the License. You may obtain a copy of
+# the License at http://www.mozilla.org/MPL/
+#
+# Software distributed under the License is distributed on an "AS
+# IS" basis, WITHOUT WARRANTY OF ANY KIND, either express or
+# implied. See the License for the specific language governing
+# rights and limitations under the License.
+#
+# The Original Code is the Bugzilla Example Plugin.
+#
+# The Initial Developer of the Original Code is Canonical Ltd.
+# Portions created by Canonical Ltd. are Copyright (C) 2009
+# Canonical Ltd. All Rights Reserved.
+#
+# Contributor(s):
+#   Max Kanat-Alexander <mkanat@bugzilla.org>
+
+
+use strict;
+use warnings;
+use Bugzilla;
+
+# This replaces every occurrence of the word "foo" with the word
+# "bar"
+
+my $regexes = Bugzilla->hook_args->{'regexes'};
+push(@$regexes, { match => qr/\bfoo\b/, replace => 'bar' });
diff --git a/extensions/patch-report/code/page-before_template.pl b/extensions/patch-report/code/page-before_template.pl
new file mode 100644
index 0000000..fe66798
--- /dev/null
+++ b/extensions/patch-report/code/page-before_template.pl
@@ -0,0 +1,7 @@
# SECTION: PATCH_REPORT_EXTENSION
+use strict;
+use warnings;
+use Bugzilla;
+use PatchReport::Hooks;
+
+page(%{ Bugzilla->hook_args });
+
diff --git a/extensions/patch-report/lib/PatchReport/Hooks.pm b/extensions/patch-report/lib/PatchReport/Hooks.pm
new file mode 100644
index 0000000..c7f3cc1
--- /dev/null
+++ b/extensions/patch-report/lib/PatchReport/Hooks.pm
@@ -0,0 +1,271 @@
# SECTION: PATCH_REPORT_EXTENSION
+# (c) Copyright Elijah Newren 2005
+# (c) Copyright Frederic Peters 2009
+# Licensed under whatever Free/Open Source license is necessary to
+# allow this to be in upstream bugzilla (if they want my ugly hacks)
+# and be the most useful to the Gnome Bugsquad (is there a "please
+# bury this code deep beneath the Ocean's bed and pretend one of our
+# people never wrote it" license?).  I give permission to the Gnome
+# Foundation board of directors to declare what that means.
+#
+# Sucks to be you to have to work to figure out the license, doesn't
+# it?  Well, better you than me.  ;-)
+
+package PatchReport::Hooks;
+
+use strict;
+use base qw(Exporter);
+
+use Bugzilla;
+use Bugzilla::Constants;
+use Bugzilla::Error;
+use Bugzilla::Util;
+use Bugzilla::User;
+
+our @EXPORT = qw(
+    page
+);
+
+sub page {
+    my %params = @_;
+    my ($vars, $page) = @params{qw(vars page_id)};
+    if ($page =~ /^patchreport\./) {
+        _page_patch_report($vars);
+    }
+}
+
+sub _page_patch_report {
+    my $vars = shift;
+
+    my $cgi = Bugzilla->cgi;
+    my $dbh = Bugzilla->dbh;
+    my $user = Bugzilla->user;
+
+    my $quoted_product="'%'";   # (string) which product to search, % for all
+    my $quoted_component="'%'"; # (string) which component to search, % for all
+    my $patch_status="none";  # (string) status of patches to search for
+    my $min_days = -1;    # (int) Don't show patches younger than this (in days)
+    my $max_days = -1;    # (int) Don't show patches older than this (in days)
+    my $submitter;        # (int) submitter id
+
+    my @products = $cgi->param('product');
+    my @components = $cgi->param('component');
+
+    @products = grep { defined $_ && $_ ne "" } @products;
+    @components = grep { defined $_ && $_ ne "" } @components;
+
+    if (scalar @products) {
+        $quoted_product = join(',', map($dbh->quote($_), @products));
+    }
+    if (scalar @components) {
+        $quoted_component = join(',', map($dbh->quote($_), @components));
+    }
+
+    if (defined $cgi->param('patch-status') && $cgi->param('patch-status') ne ""){
+        $patch_status = $cgi->param('patch-status');
+    }
+    if (defined $cgi->param('min_days') && $cgi->param('min_days') ne ""){
+        $min_days = $cgi->param('min_days');
+        detaint_natural($min_days) || die "min_days parameter must be a number";
+    }
+    if (defined $cgi->param('max_days') && $cgi->param('max_days') ne ""){
+        $max_days = $cgi->param('max_days');
+        detaint_natural($max_days) || die "max_days parameter must be a number";
+    }
+    if (defined $cgi->param('submitter') && $cgi->param('submitter') ne "") {
+        $submitter = login_to_id($cgi->param('submitter'));
+        unless ($submitter > 0) {
+            ThrowUserError('invalid_username', { name => $cgi->param('submitter') });
+        }
+    }
+
+    # Determine the report type...
+    my $type;
+    if ($patch_status eq "none") {
+        $type = "Unreviewed";
+    }
+    elsif ($patch_status eq "obsolete") {
+        $type = "Obsolete";
+    }
+    else {
+        trick_taint($patch_status);
+        $type = $dbh->selectrow_array(
+                    "SELECT value
+                       FROM attachment_status
+                       WHERE attachment_status.value = ?",
+                       undef, $patch_status);
+    }
+
+    #
+    # Then collect the needed information
+    #
+    my $stats = get_unreviewed_patches_and_stats($quoted_product,
+                                                 $quoted_component,
+                                                 $patch_status,
+                                                 $min_days,
+                                                 $max_days,
+                                                 $submitter);
+
+    #
+    # Finally, print it all out
+    #
+    $vars->{'patch_type'} = $type;
+    $vars->{'stats'} = $stats;
+}
+
+
+sub get_unreviewed_patches_and_stats {
+    my ($quoted_product, $quoted_component, $patch_status,
+        $min_days, $max_days, $submitter) = (@_);
+
+    my $query;
+    my $dbh = Bugzilla->dbh;
+
+    $query = " SELECT attachments.attach_id, attachments.bug_id,
+                      (" . $dbh->sql_to_days('NOW()') . "-" .
+                       $dbh->sql_to_days('attachments.creation_ts') . ") AS age,
+                      substring(attachments.description, 1, 70),
+                      products.name AS product, components.name AS component
+                 FROM attachments
+           INNER JOIN bugs
+                   ON attachments.bug_id = bugs.bug_id
+           INNER JOIN products
+                   ON bugs.product_id = products.id
+           INNER JOIN components
+                   ON bugs.component_id = components.id
+                WHERE attachments.ispatch = '1'";
+
+    if ($quoted_product && $quoted_product ne "'%'") {
+      trick_taint($quoted_product);
+      $query .= " AND products.name IN ($quoted_product)";
+    }
+    if ($quoted_component && $quoted_component ne "'%'") {
+      trick_taint($quoted_component);
+      $query .= " AND components.name IN ($quoted_component)";
+    }
+    if ($submitter) {
+      # $submitter is a numeric
+      $query .= " AND attachments.submitter_id = $submitter";
+    }
+    if ($min_days && $min_days != -1) {
+      $query .= " AND attachments.creation_ts <= NOW() - " .
+          $dbh->sql_interval($min_days, 'DAY');
+    }
+    if ($max_days && $max_days != -1) {
+      $query .= " AND attachments.creation_ts >= NOW() - " .
+          $dbh->sql_interval($max_days, 'DAY');
+    }
+    if ($patch_status eq 'obsolete') {
+      $query .= " AND attachments.isobsolete  = '1'";
+    } else {
+      $query .= " AND attachments.isobsolete != '1'";
+    }
+    if ($patch_status ne 'obsolete') {
+        $query .= " AND attachments.status = '" . $patch_status . "'";
+    }
+    $query .= "   AND (bugs.bug_status = 'UNCONFIRMED'
+                       OR bugs.bug_status = 'NEW'
+                       OR bugs.bug_status = 'ASSIGNED'
+                       OR bugs.bug_status = 'REOPENED')
+             ORDER BY products.name, components.name, attachments.bug_id, attachments.attach_id";
+    open(BLABLABLA, ">/tmp/foobar") || die "Crap!\n";
+    print BLABLABLA "hello world\n" . $query . "\n";
+
+
+    my $sth = $dbh->prepare($query);
+    $sth->execute();
+
+    $query = "SELECT substring(short_desc, 1, 70), priority, bug_severity
+                FROM bugs
+               WHERE bug_id = ?";
+
+    my $sth_Buginfo = $dbh->prepare($query);
+
+    my ($cur_product, $cur_component, $cur_bug) = ('', '', 0);
+    my ($prod_list, $comp_list, $bug_list, $patch_list) = ([], [], [], []);
+    my ($new_product, $new_component);
+    my ($total_count, $prod_count, $comp_count) = (0, 0, 0);
+    my $stats = {
+        'count' => 0,
+        'product_list' => []
+    };
+
+    $prod_list = $stats->{product_list};
+    while (my ($attach_id, $bug_id, $age, $desc, $prod, $comp) = $sth->fetchrow_array) {
+
+        # Check if we've moved on to a new product
+        if ($cur_product ne $prod) {
+            if ($cur_product ne '') {
+                $new_product->{count} = $prod_count;
+                $prod_count = 0;
+                $new_component->{count} = $comp_count;
+                $comp_count = 0;
+            }
+
+            $cur_product = $prod;
+            $new_product = {
+                'name' => $prod,
+                'component_list' => []
+            };
+
+            push @{$prod_list}, $new_product;
+            $cur_component = '';
+            $comp_list = $new_product->{component_list};
+        }
+
+        # Check if we've moved on to a new component
+        if ($cur_component ne $comp) {
+            if ($cur_component ne '') {
+                $new_component->{count} = $comp_count;
+                $comp_count = 0;
+            }
+            $cur_component = $comp;
+
+            $new_component = {
+                'name' => $comp,
+                'bug_list' => []
+            };
+            push @{$comp_list}, $new_component;
+            $cur_bug = 0;
+            $bug_list = $new_component->{bug_list};
+        }
+
+        # Check if we've moved on to a new bug
+        if ($cur_bug ne $bug_id) {
+            $cur_bug = $bug_id;
+
+            $sth_Buginfo->execute($bug_id);
+            my ($bug_desc, $priority, $severity) = $sth_Buginfo->fetchrow_array;
+
+            my $new_bug = {
+                'id' => $bug_id,
+                'summary' => $bug_desc,
+                'priority' => $priority,
+                'severity' => $severity,
+                'patch_list' => []
+            };
+            push @{$bug_list}, $new_bug;
+            $patch_list = $new_bug->{patch_list};
+        }
+
+        my $new_patch = {
+            'id' => $attach_id,
+            'age' => $age,
+            'description' => $desc
+        };
+        push @{$patch_list}, $new_patch;
+
+        $total_count++;
+        $prod_count++;
+        $comp_count++;
+
+        # printf "%6d %6d %s %s %s\n", $attach_id, $bug_id, $prod, $comp, $desc;
+    }
+
+    # Update the counts for the final product and component, as well as the total
+    $stats->{count} = $total_count;
+    $new_product->{count} = $prod_count;
+    $new_component->{count} = $comp_count;
+
+    return $stats;
+}
+
diff --git a/extensions/patch-report/template/en/default/pages/patchreport.html.tmpl b/extensions/patch-report/template/en/default/pages/patchreport.html.tmpl
new file mode 100644
index 0000000..8fc1b20
--- /dev/null
+++ b/extensions/patch-report/template/en/default/pages/patchreport.html.tmpl
@@ -0,0 +1,77 @@
# SECTION: PATCH_REPORT_EXTENSION
+[%# 1.0@bugzilla.org %]
+[%# -*- mode: html -*- %]
+[%# The contents of this file are subject to the Mozilla Public
+  # License Version 1.1 (the "License"); you may not use this file
+  # except in compliance with the License. You may obtain a copy of
+  # the License at http://www.mozilla.org/MPL/
+  #
+  # Software distributed under the License is distributed on an "AS
+  # IS" basis, WITHOUT WARRANTY OF ANY KIND, either express or
+  # implied. See the License for the specific language governing
+  # rights and limitations under the License.
+  #
+  # The Original Code is the Bugzilla Bug Tracking System.
+  #
+  # Copyright (C) 2005 Olav Vitters.
+  #
+  #%]
+
+[%# INTERFACE:
+  # This template has no interface.
+  #%]
+
+[% PROCESS global/variables.none.tmpl %]
+
+[% title = "Patch Report" %]
+[% PROCESS global/header.html.tmpl
+    h1 = "" %]
+
+  <center><h1>[% patch_type FILTER html %] Patches</h1></center>
+
+[% FOREACH product = stats.product_list %]
+  <h3>[% product.name FILTER html %]<a name="[% product.name FILTER html %]"></a> ([% product.count FILTER html %])</h3>
+  <ul>
+  
+  [% FOREACH component = product.component_list %]
+    <li>Component: [% component.name FILTER html %] ([% component.count FILTER html %])</li>
+    <ul>
+
+    [% FOREACH bug = component.bug_list %]
+      <li>[% terms.Bug %] <a href="show_bug.cgi?id=[% bug.id FILTER url_quote %]">[% bug.id FILTER html %]</a>: 
+          [% bug.summary FILTER html %] ([% "$bug.priority / $bug.severity" FILTER html %])</li>
+      <ul>
+
+      [% FOREACH patch = bug.patch_list %]
+        <li><i>Attachment [% patch.id FILTER html %]</i> ([% patch.age FILTER html %] days)
+        <a href="attachment.cgi?id=[% patch.id FILTER url_quote %]&amp;action=diff">
+          [% patch.description FILTER html %]</a>
+        </li>
+      [% END %]
+
+      </ul>
+    [% END %]    
+
+    </ul>
+  [% END %]
+  </ul>
+[% END %]
+
+[% IF stats.count > 1 %]
+  <p>[% stats.count FILTER html %] [% type FILTER lower FILTER html %] patches found.</p>
+[% ELSIF stats.count == 1 %]
+  <p>[% stats.count FILTER html %] [% type FILTER lower FILTER html %] patch found.</p>
+[% ELSE %]
+  <p>No patches found matching your criteria.</p>
+[% END %]
+
+<!-- 
+  SOME USEFUL PARAMETERS TO PASS THIS SCRIPT:
+  product   (Only show unreviewed patches in this product)
+  component (Only show unreviewed patches in this component)
+  min_days  (Don't show patches younger than this)
+  max_days  (Don't show patches older than this)
+ -->
+
+<p> If you spot any errors in this page please report it to the bugzilla component of bugzilla.gnome.org. Thanks.</p>
+
+[% PROCESS global/footer.html.tmpl %]
diff --git a/extensions/stock-answers/template/en/bug/edit-after_comment_textarea.html.tmpl b/extensions/stock-answers/template/en/bug/edit-after_comment_textarea.html.tmpl
new file mode 100644
index 0000000..ee560f3
--- /dev/null
+++ b/extensions/stock-answers/template/en/bug/edit-after_comment_textarea.html.tmpl
@@ -0,0 +1,97 @@
# SECTION: STOCK_ANSWERS
+  [% IF bug.user.canedit %]
+  <script type="text/javascript">
+  <!--
+
+  /* Adds the reply text to the `comment' textarea */
+  function addTextToComment(text, bug_status, resolution, crasher) {
+    /* pre id="comment_name_N" */
+    /* make sure we split on all newlines -- IE or Moz use \r and \n
+     * respectively */
+    text = text.split(/\r|\n/);
+
+    var replytext = "";
+    for (var i=0; i < text.length; i++) {
+        replytext += text[i] + "\n"; 
+    }
+
+    if (resolution && resolution != '') {
+      bug_status = 'RESOLVED';
+    }
+
+    if (bug_status && bug_status != '') {
+      document.getElementsByName('bug_status')[0].value = bug_status;
+      bz_fireEvent(document.getElementsByName('bug_status')[0], 'change');
+    }
+
+    if (resolution && resolution != '') {
+      document.getElementsByName('resolution')[0].value = resolution;
+      bz_fireEvent(document.getElementsByName('resolution')[0], 'change');
+    }
+
+    if (crasher == "1") {
+      document.getElementsByName('priority')[0].value = 'High';
+      document.getElementsByName('bug_severity')[0].value = 'critical';
+    }
+
+    var textarea = document.getElementById('comment');
+    textarea.value += replytext;
+
+    if (resolution && resolution == "DUPLICATE") {
+      document.getElementsByName('dup_id')[0].focus();
+    } else {
+      textarea.focus();
+    }
+
+    return false;
+  }
+
+  /* Outputs a link to call addTextToComment(); used to reduce HTML output */
+  function addStockLink(text, shorttext, knob, resolve, crasher) {
+    document.write('[<a href="[% self_url FILTER html %]#add_comment" onclick="return addTextToComment(\'' +
+        text.replace(/'/g, "\\'").replace(/\n/g, "\\n") + "','" + knob + "','" + resolve + "','" + crasher + "');\">" + shorttext + '<' + '/a>] ');
+  }
+
+  //-->
+
+
+  </script>
+  [% IF bug.bug_status == 'UNCONFIRMED' || bug.bug_status == 'NEW' || bug.bug_status == 'ASSIGNED' || bug.bug_status == 'REOPENED' %]
+  <div style="display: block" id="stocklinks" name="stocklinks">
+    <script type="text/javascript">
+      addStockLink("Thanks for taking the time to report this [% terms.bug %].\nWithout a stack trace from the crash it's very hard to determine what caused it.\nCan you get us a stack trace? Please see http://live.gnome.org/GettingTraces for more information on how to do so. Thanks in advance!", 'need_stacktrace', 'NEEDINFO', '', '1');
+      addStockLink("Thanks for taking the time to report this [% terms.bug %].\nThis [% terms.bug %] report isn't very useful because it doesn't describe the [% terms.bug %] well. If you have time and can still reproduce the [% terms.bug %], please read http://bugzilla.gnome.org/bug-HOWTO.html and add a more useful description to this [% terms.bug %].", 'bad_description', 'NEEDINFO', '', '');
+      addStockLink("Thanks for taking the time to report this [% terms.bug %].\nThis [% terms.bug %] report isn't very useful because it doesn't describe the [% terms.bug %] well. If you have time and can still reproduce the [% terms.bug %], please read http://bugzilla.gnome.org/bug-HOWTO.html and add a description of how to reproduce this [% terms.bug %].\n\nYou'll also need to add a stack trace; please see http://live.gnome.org/GettingTraces for more information about how to do so. Thanks in advance!", 'bad_description+crasher', 'NEEDINFO', '', '1');
+      addStockLink("Thanks for taking the time to report this [% terms.bug %].\nUnfortunately, that stack trace is missing some elements that will help a lot to solve the problem, so it will be hard for the developers to fix that crash. Can you get us a stack trace with debugging symbols? Please see http://live.gnome.org/GettingTraces for more information on how to do so and reopen this bug or report a new one. Thanks in advance!", 'bad_stacktrace', '', 'INCOMPLETE', '1');
+      addStockLink("Thanks for taking the time to report this [% terms.bug %].\nHowever, you are using a version that is too old and not supported anymore. GNOME developers are no longer working on that version, so unfortunately there will not be any bug fixes for the version that you use.\n\nBy upgrading to a newer version of GNOME you could receive bug fixes and new functionality. You may need to upgrade your Linux distribution to obtain a newer version of GNOME.\nPlease feel free to reopen this [% terms.bug %] if the problem still occurs with a newer version of GNOME.", 'obsolete', '', 'OBSOLETE', '');
+      addStockLink("Thanks for taking the time to report this [% terms.bug %].\nThis trace indicates that Mozilla (which was being used by the program) was responsible for the crash, or alternatively that the program was compiled against a different version of Mozilla. Make sure the program was built against the most recent mozilla, and if you can duplicate the crash in mozilla itself, report the [% terms.bug %] to https://bugzilla.mozilla.org/", 'mozilla', '','NOTGNOME', '');
+      addStockLink("Thanks for taking the time to report this [% terms.bug %].\nHowever, this application does not track its [% terms.bugs %] in the GNOME [% terms.Bugzilla %]. We kindly ask you to report the [% terms.bug %] to the application authors. For a selective list of other bug tracking systems please consult http://live.gnome.org/Bugsquad/TriageGuide/NonGnome.\n\nIf the affected third party application has a [% terms.bug %] tracking system you should investigate whether a [% terms.bug %] for the reported issue is already filed in this system. If it has not been filed yet please do so. Also ensure that both [% terms.bug %] reports contain a link to each other.\nThanks in advance!", 'not_gnome', '', 'NOTGNOME', '');
+      addStockLink("Thanks for the [% terms.bug %] report. This particular [% terms.bug %] has already been reported into our [% terms.bug %] tracking system, but please feel free to report any further [% terms.bugs %] you find.", 'duplicate', '', 'DUPLICATE', '');
+      addStockLink("Thanks for taking the time to report this [% terms.bug %].\nThis particular [% terms.bug %] has already been reported into our [% terms.bug %] tracking system, but the maintainers need more information to fix the [% terms.bug %]. Could you please answer the questions in the other report in order to help the developers?", 'dupe+needinfo', '', 'DUPLICATE', '');
+      addStockLink("Thanks for taking the time to report this [% terms.bug %].\nThis particular [% terms.bug %] has already been reported into our [% terms.bug %] tracking system, but we are happy to tell you that the problem has already been fixed. It should be solved in the next software version. You may want to check for a software upgrade.", 'dupe+fixed', '', 'DUPLICATE', '');
+      addStockLink("This problem has been fixed in our software repository. The fix will go into the next software release. Thank you for your [% terms.bug %] report.", 'fixed_in_stable', '', 'FIXED', '');
+      addStockLink("This problem has been fixed in the development version. The fix will be available in the next major software release. Thank you for your [% terms.bug %] report.", 'fixed_in_head', '', 'FIXED', '');
+
+    [% IF bug.product == 'evince' %]
+      addStockLink("Thanks for the [% terms.bug %] report. Unfortunately it lacks some information that may help us in finding the cause of the [% terms.bug %]. Can you, if possible, attach the file causing the crash? Also this may be a Poppler [% terms.Bug %] (the backend used by Evince to render PDF), could you please supply the poppler version and type? You can find it in the Help->About menu in Evince.", 'crash-evince', 'NEEDINFO', '', '1');
+    [% ELSIF bug.product == 'metacity' %]
+      addStockLink("Thanks for the [% terms.bug %] report.  Unfortunately it lacks some information that may help us in finding the cause of the [% terms.bug %].  Can you provide a verbose debugging log?  To do so:\n\n  1. Reduce your desktop to as few windows as possible to reproduce the [% terms.bug %]\n  2. Run METACITY_VERBOSE=1 METACITY_USE_LOGFILE=1 metacity --replace\n  3. On stdout metacity will print the name of the logfile\n  4. Reproduce the [% terms.bug %] as quickly as possible\n  5. Kill the metacity you started above to stop the logfile from growing any longer\n  6. Attach the logfile here", 'metacity-verbose-log', 'NEEDINFO', '', '');
+    [% ELSIF bug.product == 'epiphany' || bug.product == 'galeon' %]
+      addStockLink("Thanks for the [% terms.bug %] report.  However, the stack trace shows this to be a crash in the closed-source flash-plugin, which does not track its [% terms.bugs %] in the GNOME Bugzilla.  We kindly ask you to report the [% terms.bug %] to the application authors.", 'crash-flash-plugin', '','NOTGNOME', '');
+    [% END %]
+    [% IF bug.product == 'epiphany' || bug.product == 'yelp' || bug.product == 'devhelp' %]
+      addStockLink("Thanks for taking the time to report this [% terms.bug %]. This trace indicates that WebKit (which was being used by the program) might be responsible for the crash. Make sure the program was built against a recent version of WebKit, and if you can still duplicate the crash, report the [% terms.bug %] to http://bugs.webkit.org/ including a link to this [% terms.bug %] report and noting the WebKit version/revision number. When reporting the WebKit [% terms.bug %], be sure to include '[GTK]' in the summary and use the 'gtk' keyword.", 'webkit', '','NOTGNOME', '');
+    [% END %]
+    </script>
+    </div>
+  [% ELSIF bug.bug_status == 'NEEDINFO' %]
+  <div style="display: block" id="stocklinks" name="stocklinks">
+    <script type="text/javascript">
+      addStockLink("Closing this [% terms.bug %] report as no further information has been provided. Please feel free to reopen this [% terms.bug %] if you can provide the information asked for.\nThanks!", 'incomplete', '', 'INCOMPLETE', '')
+      addStockLink("Thanks for the [% terms.bug %] report. This particular [% terms.bug %] has already been reported into our [% terms.bug %] tracking system, but please feel free to report any further [% terms.bugs %] you find.", 'duplicate', 'duplicate', '', '');
+      addStockLink("Thanks for taking the time to report this [% terms.bug %].\nThis particular [% terms.bug %] has already been reported into our [% terms.bug %] tracking system, but the maintainers need more information to fix the [% terms.bug %]. Could you please answer the questions in the other report in order to help the developers?", 'dupe+needinfo', 'duplicate', '', '');
+      addStockLink("Thanks for taking the time to report this [% terms.bug %].\nThis particular [% terms.bug %] has already been reported into our [% terms.bug %] tracking system, but we are happy to tell you that the problem has already been fixed. It should be solved in the next software version. You may want to check for a software upgrade.", 'dupe+fixed', 'duplicate', '', '');
+    </script>
+  </div>
+  [% END %]
+  [% END %]
+
diff --git a/extensions/weekly-bug-summary/code/page-before_template.pl b/extensions/weekly-bug-summary/code/page-before_template.pl
new file mode 100644
index 0000000..05dabed
--- /dev/null
+++ b/extensions/weekly-bug-summary/code/page-before_template.pl
@@ -0,0 +1,7 @@
# SECTION: WEEKLY_BUG_SUMMARY
+use strict;
+use warnings;
+use Bugzilla;
+use WeeklyBugSummary::Hooks;
+
+page(%{ Bugzilla->hook_args });
+
diff --git a/extensions/weekly-bug-summary/lib/WeeklyBugSummary/Hooks.pm b/extensions/weekly-bug-summary/lib/WeeklyBugSummary/Hooks.pm
new file mode 100644
index 0000000..c3aecad
--- /dev/null
+++ b/extensions/weekly-bug-summary/lib/WeeklyBugSummary/Hooks.pm
@@ -0,0 +1,790 @@
# SECTION: WEEKLY_BUG_SUMMARY
+# The contents of this file are subject to the Mozilla Public
+# License Version 1.1 (the "License"); you may not use this file
+# except in compliance with the License. You may obtain a copy of
+# the License at http://www.mozilla.org/MPL/
+#
+# weekly-bug-summary.cgi
+#
+# Display some nice bug stats for the Gnome weekly summary.
+#
+# This file was based on the original mostfrequent.cgi but has been
+# modified GREATLY by Wayne Schuller (k_wayne@linuxpower.org), Jan 2002.
+#
+# It was later ported to be a Bugzilla extension by Frederic Peters
+# (fpeters@0d.be), Sep 2009.
+#
+# TODO
+#   - Some products have way too many bugs. Break it down via component.
+#   - Use percentages for the diff figures.
+
+package WeeklyBugSummary::Hooks;
+
+use strict;
+use base qw(Exporter);
+
+use Bugzilla;
+use Bugzilla::Constants;
+use Bugzilla::Error;
+use Bugzilla::Util;
+use Bugzilla::User;
+use Bugzilla::Field;
+
+our @EXPORT = qw(
+    page
+);
+
+sub page {
+    my %params = @_;
+    my ($vars, $page) = @params{qw(vars page_id)};
+    if ($page =~ /^weekly-bug-summary\./) {
+        _page_weekly_bug_summary($vars);
+    }
+}
+
+sub _page_weekly_bug_summary {
+    my $vars = shift;
+
+    my $cgi = Bugzilla->cgi;
+    my $dbh = Bugzilla->dbh;
+    my $user = Bugzilla->user;
+
+    # make sensible defaults.
+    my $version = undef;               # Don't limit to "2.7/2.8" or "2.5/2.6", etc.
+    my $days = 7;           # Change this if defn of week changes.
+    my $products = 15;      # Show the top 15 products.
+    my $hunters = 15;       # Show the top 15 hunters 
+    my $reporters = 15;     # Show the top 15 reporters
+    my $patchers = 10;      # Show the top 10 patchers
+    my $reviewers = 10;     # Show the top 10 reviewers
+    my $keyword = undef;    # Don't limit to any keyword.
+    my $classification=undef;   # Don't limit to just one classification.
+    my $product = undef;    # Don't limit to just one product.
+    my $links = "yes";      # Create links (can get very large sometimes)
+
+    if (defined $cgi->param('days') && $cgi->param('days') ne ""){
+        $days = $cgi->param('days');
+        detaint_natural($days) || die "days parameter must be a number";
+    }
+
+    if (defined $cgi->param('products') && $cgi->param('products') ne ""){
+        $products = $cgi->param('products');
+        detaint_natural($products) || die "products parameter must be a number";
+    }
+
+    if (defined $cgi->param('hunters') && $cgi->param('hunters') ne ""){
+        $hunters = $cgi->param('hunters');
+        detaint_natural($hunters) || die "hunters parameter must be a number";
+    }
+
+    if (defined $cgi->param('reporters') && $cgi->param('reporters') ne ""){
+        $reporters = $cgi->param('reporters');
+        detaint_natural($reporters) || die "reporters parameter must be a number";
+    }
+
+    if (defined $cgi->param('patchers') && $cgi->param('patchers') ne ""){
+        $patchers = $cgi->param('patchers');
+        detaint_natural($patchers) || die "patchers parameter must be a number";
+    }
+
+    if (defined $cgi->param('reviewers') && $cgi->param('reviewers') ne ""){
+        $reviewers = $cgi->param('reviewers');
+        detaint_natural($reviewers) || die "reviewers parameter must be a number";
+    }
+
+    if (defined $cgi->param('links')){
+        $links = $cgi->param('links');
+    }
+
+    if (defined $cgi->param('keyword')){
+        $keyword = $cgi->param('keyword');
+        trick_taint($keyword);
+    }
+
+    if (defined $cgi->param('version') && $cgi->param('version') ne ""){
+        $version = $cgi->param('version');
+        trick_taint($version);
+    }
+
+    if (defined $cgi->param('classification') && $cgi->param('classification') ne ""){
+        $classification = get_classification_id($cgi->param('classification'));
+    }
+
+    if (defined $cgi->param('product') && $cgi->param('product') ne ""){
+        $product = get_product_id($cgi->param('product'));
+        $products = 0;
+        $classification = undef;
+    }
+
+    if ($days >= 90) {
+        $links = 'no';
+    }
+
+    my $totalbugs = &get_total_bugs_on_bugzilla($keyword, $version, 
+                                                $classification, $product);
+
+    my ($bugs_opened, $opened_buglist) = &bugs_opened($days, $keyword, $version,
+                                                      $classification, $product);
+    my ($bugs_closed, $closed_buglist) = &bugs_closed($days, $keyword, $version,
+                                                      $classification, $product);
+
+    #if ($links eq "yes") {
+    #    print "<a href=\"$buglist\">$bugs_closed</a> reports closed";
+    #} else {
+    #    print "$bugs_closed reports closed";
+    #}
+
+    my ($productlist) =
+        &get_product_bug_lists($products, $days, $keyword, $links, $version,
+                               $classification);
+
+    my ($hunterlist) = 
+        &get_bug_hunters_list($hunters, $days, $keyword, 
+                              $links, $version, $classification, $product);
+
+    my ($reporterlist) =
+        &get_bug_reporters_list($reporters, $days, $keyword, 
+                                $links, $version, $classification, $product);
+
+    my ($patchsubmitterlist) = 
+        &get_patch_submitters_list($patchers, $days, $keyword,
+                                   $links, $version, $classification, $product);
+
+    my ($patchreviewerlist) = 
+        &get_patch_reviewers_list($reviewers, $days, $keyword,
+                                  $links, $version, $classification, $product);
+
+    # CGI params / defaults:
+    $vars->{'days'} = $days;
+    $vars->{'keyword'} = $keyword;
+    $vars->{'links'} = $links;
+    $vars->{'version'} = $version;
+    $vars->{'classification'} =
+        $classification ? get_classification_name($classification) : undef;;
+    $vars->{'product'} = $product ? get_product_name($product) : undef;
+    $vars->{'products'} = $products;
+    $vars->{'hunters'} = $hunters;
+    $vars->{'reporters'} = $reporters;
+    $vars->{'patchers'} = $patchers;
+    $vars->{'reviewers'} = $reviewers;
+
+    # Retrieved from queries:
+    $vars->{'totalbugs'} = $totalbugs;
+    $vars->{'openbugs'} = $bugs_opened;
+    $vars->{'openbuglist'} = $opened_buglist;
+    $vars->{'closedbugs'} = $bugs_closed;
+    $vars->{'closedbuglist'} = $closed_buglist;
+    $vars->{'productlist'} = $productlist;
+    $vars->{'hunterlist'} = $hunterlist;
+    $vars->{'reporterlist'} = $reporterlist;
+    $vars->{'patcherlist'} = $patchsubmitterlist;
+    $vars->{'reviewerlist'} = $patchreviewerlist;
+}
+
+sub get_total_bugs_on_bugzilla {
+    my($keyword, $version, $classification_id, $product_id) = @_;
+
+    my @args;
+
+    my $query = "
+     SELECT COUNT(bugs.bug_id)
+       FROM bugs";
+
+    if ($classification_id) {
+        $query .= "
+ INNER JOIN products
+         ON bugs.product_id = products.id";
+    }
+
+    $query .= "
+      WHERE (bugs.bug_status = 'NEW' OR bugs.bug_status = 'ASSIGNED'
+             OR bugs.bug_status = 'REOPENED'
+             OR bugs.bug_status = 'UNCONFIRMED')";
+
+    if ($keyword) {
+        push(@args, lc($keyword));
+        $query .= "
+        AND INSTR(LOWER(bugs.keywords), ?)";
+    }
+    if ($version) {
+        push(@args, $version);
+        $query .= "
+        AND bugs.gnome_version = ?";
+    }
+    if ($classification_id) {
+        push(@args, $classification_id);
+        $query .= "
+        AND products.classification_id = ?";
+    }
+    if ($product_id) {
+        push(@args, $product_id);
+        $query .= "
+        AND bugs.product_id = ?";
+    }
+
+    my ($count) = Bugzilla->dbh->selectrow_array($query, undef, @args);
+    return($count);
+}
+
+# bugs_closed
+# Show how many bugs have been closed for $product_id in $days.
+# Pass undef as product_id to get all products.
+sub bugs_closed {
+    my($days, $keyword, $version, $classification_id, $product_id) = @_;
+
+    my @args;
+
+    # We are going to build a long SQL query.
+    my $query = "
+     SELECT DISTINCT bugs.bug_id
+       FROM bugs
+ INNER JOIN bugs_activity
+         ON bugs.bug_id = bugs_activity.bug_id";
+
+    if ($classification_id) {
+        $query .= "
+ INNER JOIN products
+         ON bugs.product_id = products.id";
+    }
+
+    $query .= "
+      WHERE bugs.bug_status IN ('RESOLVED','CLOSED','VERIFIED')
+        AND bugs_activity.added IN ('RESOLVED','CLOSED')
+        AND bugs_activity.bug_when >= NOW() - " .
+            Bugzilla->dbh->sql_interval('?', 'DAY');
+
+    push(@args, $days);
+
+    if ($keyword) {
+        push(@args, lc($keyword));
+        $query .= "
+        AND INSTR(LOWER(bugs.keywords), ?)";
+    }
+    if ($version) {
+        push(@args, $version);
+        $query .= "
+        AND bugs.gnome_version = ?";
+    }
+    if ($classification_id) {
+        push(@args, $classification_id);
+        $query .= "
+        AND products.classification_id = ?";
+    }
+    if ($product_id) {
+        $query .= "
+        AND bugs.product_id = $product_id";
+    }
+
+    $query .= "
+   GROUP BY bugs.bug_id";
+
+    my $bugs = Bugzilla->dbh->selectcol_arrayref($query, undef, @args);
+
+    # Create URL of all the bugs that match this function.
+    my $urlbase = Bugzilla->params->{'urlbase'};
+    my $buglist = "$urlbase/buglist.cgi?bug_id=" . join(",", @$bugs);
+    my $count = scalar @$bugs;
+
+    return(($count, $buglist));
+}
+
+# bugs_opened
+# Show how many bugs have been opened for $product_id in $days.
+# Pass undef as product_id to get all products.
+sub bugs_opened {
+    my($days, $keyword, $version, $classification_id, $product_id) = @_;
+
+    my @args;
+
+    # We are going to build a long SQL query.
+    my $query = "
+     SELECT bugs.bug_id
+       FROM bugs";
+    
+    if ($classification_id) {
+        $query .= "
+ INNER JOIN products
+         ON bugs.product_id = products.id";
+    }
+
+    $query .= "
+      WHERE bugs.creation_ts >= NOW() - " . Bugzilla->dbh->sql_interval('?', 'DAY');
+
+    push(@args, $days);
+
+    if ($keyword) {
+        push(@args, lc($keyword));
+        $query .= "
+        AND INSTR(LOWER(bugs.keywords), ?)";
+    }
+    if ($version) {
+        push(@args, $version);
+        $query .= "
+        AND bugs.gnome_version = ?";
+    }
+    if ($classification_id) {
+        push(@args, $classification_id);
+        $query .= "
+        AND products.classification_id = ?";
+    }
+    if ($product_id) {
+        push(@args, $product_id);
+        $query .= "
+        AND bugs.product_id = ?";
+    }
+
+    $query .= "
+      GROUP BY bugs.bug_id";
+
+    my $bugs = Bugzilla->dbh->selectcol_arrayref($query, undef, @args);
+
+    # Create URL of all the bugs that match this function.
+    my $urlbase = Bugzilla->params->{'urlbase'};
+    my $buglist = "$urlbase/buglist.cgi?bug_id=" . join(",", @$bugs);
+    my $count = scalar @$bugs;
+
+    return(($count, $buglist));
+}
+
+sub get_product_bug_lists {
+    my($number, $days, $keyword, $links, $version, $classification_id) = @_;
+
+    my @args;
+
+    # We are going to build a long SQL query.
+    my $query = "
+        SELECT bugs.product_id, products.name AS product, COUNT(bugs.bug_id) AS n 
+          FROM bugs
+    INNER JOIN products
+            ON bugs.product_id = products.id
+         WHERE (bugs.bug_status = 'NEW' OR bugs.bug_status = 'ASSIGNED' 
+                OR bugs.bug_status = 'REOPENED'
+                OR bugs.bug_status = 'UNCONFIRMED')
+           AND bugs.bug_severity != 'enhancement'";
+
+    if ($keyword) {
+        push(@args, lc($keyword));
+        $query .= "
+           AND INSTR(LOWER(bugs.keywords), ?)";
+    }
+    if ($version) {
+        push(@args, $version);
+        $query .= "
+           AND bugs.gnome_version = ?";
+    }
+    if ($classification_id) {
+        push(@args, $classification_id);
+        $query .= "
+           AND products.classification_id = ?";
+    }
+
+    $query .= "
+      GROUP BY bugs.product_id
+      ORDER BY n DESC " . Bugzilla->dbh->sql_limit($number);
+
+    my $productlist = Bugzilla->dbh->selectall_arrayref($query, undef, @args);
+
+    foreach my $rowRef (@$productlist) {
+        my ($product_id, $product, $count) = @$rowRef;
+
+        my ($opened, $openedlist) = &bugs_opened($days, $keyword, $version,
+                                                 $classification_id, $product_id);
+        my ($closed, $closedlist) = &bugs_closed($days, $keyword, $version,
+                                                 $classification_id, $product_id);
+
+        my $change = $opened-$closed;
+
+        push(@$rowRef, $opened, $openedlist, $closed, $closedlist, $change);
+    }
+
+    return $productlist;
+}
+
+sub get_bug_hunters_list {
+    my($number, $days, $keyword, $links, $version,
+       $classification_id, $product_id) = @_;
+
+    my @args;
+
+    # We are going to build a long SQL query.
+    my $query = "
+        SELECT bugs_activity.who AS userid, COUNT(bugs.bug_id) as n 
+          FROM bugs
+    INNER JOIN bugs_activity
+            ON bugs.bug_id = bugs_activity.bug_id";
+
+    if ($classification_id) {
+        $query .= "
+    INNER JOIN products
+            ON bugs.product_id = products.id";
+    }
+
+    $query .= "
+         WHERE bugs.bug_status IN ('RESOLVED','CLOSED','VERIFIED')
+           AND bugs_activity.added IN ('RESOLVED','CLOSED')
+           AND bugs_activity.bug_when =
+                 (SELECT MAX(bug_when)
+                    FROM bugs_activity ba
+                   WHERE ba.added IN ('RESOLVED','CLOSED')
+                     AND ba.removed IN ('UNCONFIRMED','REOPENED',
+                                        'NEW','ASSIGNED','NEEDINFO')
+                     AND ba.bug_id = bugs_activity.bug_id)
+           AND bugs_activity.bug_when >= NOW() - " .
+                   Bugzilla->dbh->sql_interval('?', 'DAY');
+
+    push(@args, $days);
+
+    if ($keyword) {
+        push(@args, lc($keyword));
+        $query .= "
+           AND INSTR(LOWER(bugs.keywords), ?)";
+    }
+    if ($version) {
+        push(@args, $version);
+        $query .= "
+           AND bugs.gnome_version = ?";
+    }
+    if ($classification_id) {
+        push(@args, $classification_id);
+        $query .= "
+           AND products.classification_id = ?";
+    }
+    if ($product_id) {
+        push(@args, $product_id);
+        $query .= "
+           AND bugs.product_id = ?";
+    }
+
+    $query .= "
+      GROUP BY bugs_activity.who
+      ORDER BY n desc " . Bugzilla->dbh->sql_limit($number);
+
+    my $hunterlist = Bugzilla->dbh->selectall_arrayref($query, undef, @args);
+
+    foreach my $rowRef (@$hunterlist) {
+        my($userid, $count) = @$rowRef;
+        
+        push(@$rowRef, new Bugzilla::User($userid));
+        if ($links eq "yes") {
+            my $buglist = &get_hunter_bugs($userid, $days, $keyword, $version,
+                                           $classification_id, $product_id);
+            push(@$rowRef, $buglist);
+        }
+    }
+
+    return $hunterlist;
+}
+
+sub get_hunter_bugs {
+    my($userid, $days, $keyword, $version, $classification_id, $product_id) = @_;
+
+    my @args;
+
+    # We are going to build a long SQL query.
+    my $query = "
+         SELECT DISTINCT bugs.bug_id
+           FROM bugs
+     INNER JOIN bugs_activity
+             ON bugs.bug_id = bugs_activity.bug_id";
+
+    if ($classification_id) {
+        $query .= "
+          INNER JOIN products
+                  ON bugs.product_id = products.id";
+    }
+
+    $query .= "
+         WHERE bugs.bug_status IN ('RESOLVED','CLOSED','VERIFIED')
+           AND bugs_activity.added IN ('RESOLVED','CLOSED')
+           AND bugs_activity.bug_when =
+                 (SELECT MAX(bug_when)
+                    FROM bugs_activity ba
+                   WHERE ba.added IN ('RESOLVED','CLOSED')
+                     AND ba.removed IN ('UNCONFIRMED','REOPENED',
+                                        'NEW','ASSIGNED','NEEDINFO')
+                     AND ba.bug_id = bugs_activity.bug_id)
+            AND bugs_activity.bug_when >= NOW() - " .
+                    Bugzilla->dbh->sql_interval('?', 'DAY') . "
+            AND bugs_activity.who = ?";
+
+    push(@args, $days, $userid);
+
+    if ($keyword) {
+        push(@args, lc($keyword));
+        $query .= "
+           AND INSTR(LOWER(bugs.keywords), ?)";
+    }
+    if ($version) {
+        push(@args, $version);
+        $query .= "
+           AND bugs.gnome_version = ?";
+    }
+    if ($classification_id) {
+        push(@args, $classification_id);
+        $query .= "
+                 AND products.classification_id = ?";
+    }
+    if ($product_id) {
+        push(@args, $product_id);
+        $query .= "
+           AND bugs.product_id = ?";
+    }
+
+    my $bugs = Bugzilla->dbh->selectcol_arrayref($query, undef, @args);
+
+    my $urlbase = Bugzilla->params->{'urlbase'};
+    my $buglist = "$urlbase/buglist.cgi?bug_id=" . join(",", @$bugs);
+
+    return ($buglist);
+}
+
+sub get_bug_reporters_list {
+    my($number, $days, $keyword, $links, $version,
+       $classification_id, $product_id) = @_;
+
+    my @args;
+
+    # We are going to build a long SQL query.
+    my $query = "
+        SELECT bugs.reporter AS userid, COUNT(DISTINCT bugs.bug_id) AS n 
+          FROM bugs";
+
+    if ($classification_id) {
+        $query .= "
+          INNER JOIN products
+                  ON bugs.product_id = products.id";
+    }
+
+    $query .= "
+         WHERE bugs.creation_ts >= NOW() - " . Bugzilla->dbh->sql_interval('?', 'DAY') . "
+           AND NOT (bugs.bug_status = 'RESOLVED' AND 
+                    bugs.resolution IN ('DUPLICATE','INVALID','NOTABUG',
+                                        'NOTGNOME','INCOMPLETE'))";
+
+    push(@args, $days);
+
+    if ($keyword) {
+        push(@args, lc($keyword));
+        $query .= "
+           AND INSTR(LOWER(bugs.keywords), ?)";
+    }
+    if ($version) {
+        push(@args, $version);
+        $query .= "
+           AND bugs.gnome_version = ?";
+    }
+    if ($classification_id) {
+        push(@args, $classification_id);
+        $query .= "
+           AND products.classification_id = ?";
+    }
+    if ($product_id) {
+        push(@args, $product_id);
+        $query .= "
+           AND bugs.product_id = ?";
+    }
+    
+    $query .= "
+      GROUP BY bugs.reporter
+      ORDER BY n DESC " . Bugzilla->dbh->sql_limit($number);
+
+    my $reporterlist = Bugzilla->dbh->selectall_arrayref($query, undef, @args);
+
+    foreach my $rowRef (@$reporterlist) {
+        my ($userid, $count) = @$rowRef;
+
+        push(@$rowRef, new Bugzilla::User($userid));
+        if ($links eq "yes") {
+            my $buglist = &get_reporter_bugs($userid, $days, $keyword,
+                                             $version, $classification_id,
+                                             $product_id);
+            push(@$rowRef, $buglist);
+        }
+    }
+
+    return $reporterlist;
+}
+
+sub get_reporter_bugs() {
+    my($userid, $days, $keyword, $version, $classification_id, $product_id) = @_;
+
+    my @args;
+
+    # We are going to build a long SQL query.
+    my $query = "
+     SELECT bugs.bug_id
+       FROM bugs";
+
+    if ($classification_id) {
+        $query .= "
+ INNER JOIN products
+         ON bugs.product_id = products.id";
+    }
+
+    $query .= "
+      WHERE bugs.creation_ts >= NOW() - " . Bugzilla->dbh->sql_interval('?', 'DAY') . "
+        AND bugs.reporter = ?
+        AND NOT (bugs.bug_status = 'RESOLVED' AND 
+                 bugs.resolution IN ('DUPLICATE','INVALID','NOTABUG',
+                                     'NOTGNOME','INCOMPLETE'))";
+    
+    push(@args, $days, $userid);
+    
+    if ($keyword) {
+        push(@args, lc($keyword));
+        $query .= "
+           AND INSTR(LOWER(bugs.keywords), ?)";
+    }
+    if ($version) {
+        push(@args, $version);
+        $query .= "
+           AND bugs.gnome_version = ?";
+    }
+    if ($classification_id) {
+        push(@args, $classification_id);
+        $query .= "
+       AND products.classification_id = ?";
+    }
+    if ($product_id) {
+        push(@args, $product_id);
+        $query .= "
+       AND bugs.product_id = ?";
+    }
+
+    my $bugs = Bugzilla->dbh->selectcol_arrayref($query, undef, @args);
+
+    my $urlbase = Bugzilla->params->{'urlbase'};
+    my $buglist = "$urlbase/buglist.cgi?bug_id=" . join(",", @$bugs);
+
+    return ($buglist);
+}
+
+sub get_patch_submitters_list {
+    my($number, $days, $keyword, $links, $version,
+       $classification_id, $product_id) = @_;
+
+    my @args;
+
+    # We are going to build a long SQL query.
+    my $query = "      SELECT attachments.submitter_id AS userid, 
+                              COUNT(DISTINCT attachments.attach_id) AS n 
+                         FROM attachments ";
+    if ($keyword || $version || $classification_id || $product_id) {
+        $query .=" INNER JOIN bugs
+                           ON attachments.bug_id = bugs.bug_id ";
+    }
+    if ($classification_id) {
+        $query .= "
+          INNER JOIN products
+                  ON bugs.product_id = products.id";
+    }
+    $query .= "         WHERE attachments.creation_ts >= NOW() - " .
+                                  Bugzilla->dbh->sql_interval('?', 'DAY') . "
+                          AND attachments.ispatch = 1
+                          AND attachments.isobsolete = 0";
+
+    push(@args, $days);
+
+    if ($keyword) {
+        push(@args, lc($keyword));
+        $query .= "       AND INSTR(LOWER(bugs.keywords), ?)";
+    }
+    if ($version) {
+        push(@args, $version);
+        $query .= "       AND bugs.gnome_version = ?";
+    }
+    if ($classification_id) {
+        push(@args, $classification_id);
+        $query .= "
+                 AND products.classification_id = ?";
+    }
+    if ($product_id) {
+        push(@args, $product_id);
+        $query .= "
+       AND bugs.product_id = ?";
+    }
+    
+    $query .= "      GROUP BY attachments.submitter_id
+                     ORDER BY n DESC " . Bugzilla->dbh->sql_limit($number);
+
+    my $submitterlist = Bugzilla->dbh->selectall_arrayref($query, undef, @args);
+
+    foreach my $rowRef (@$submitterlist) {
+        my ($userid, $count) = @$rowRef;
+
+        push(@$rowRef, new Bugzilla::User($userid));
+#        if ($links eq "yes") {
+#            my $buglist = &get_reporter_bugs($userid, $days, $keyword, $version);
+#            push(@$rowRef, $buglist);
+#        }
+    }
+
+    return $submitterlist;
+}
+
+sub get_patch_reviewers_list {
+    my($number, $days, $keyword, $links, $version,
+       $classification_id, $product_id) = @_;
+
+    my @args;
+
+    # We are going to build a long SQL query.
+    my $query = "
+        SELECT bugs_activity.who AS userid, COUNT(DISTINCT bugs_activity.attach_id) as n 
+          FROM bugs_activity ";
+    if ($keyword || $version || $classification_id || $product_id) {
+        $query .= "
+    INNER JOIN bugs
+            ON bugs_activity.bug_id = bugs.bug_id ";
+    }
+    if ($classification_id) {
+        $query .= "
+    INNER JOIN products
+            ON bugs.product_id = products.id";
+    }
+    $query .= "
+         WHERE bugs_activity.fieldid = ?
+           AND bugs_activity.removed = 'none'
+           AND bugs_activity.bug_when >= NOW() - " .
+                   Bugzilla->dbh->sql_interval('?', 'DAY');
+
+    push(@args, get_field_id('attachments.status'), $days);
+
+    if ($keyword) {
+        push(@args, lc($keyword));
+        $query .= "
+           AND INSTR(LOWER(bugs.keywords), ?)";
+    }
+    if ($version) {
+        push(@args, $version);
+        $query .= "
+           AND bugs.gnome_version = ?";
+    }
+    if ($classification_id) {
+        push(@args, $classification_id);
+        $query .= "
+           AND products.classification_id = ?";
+    }
+    if ($product_id) {
+        push(@args, $product_id);
+        $query .= "
+           AND bugs.product_id = ?";
+    }
+
+    $query .= "
+      GROUP BY bugs_activity.who
+      ORDER BY n desc " . Bugzilla->dbh->sql_limit($number);
+
+    my $hunterlist = Bugzilla->dbh->selectall_arrayref($query, undef, @args);
+
+    foreach my $rowRef (@$hunterlist) {
+        my($userid, $count) = @$rowRef;
+        
+        push(@$rowRef, new Bugzilla::User($userid));
+#        if ($links eq "yes") {
+#            my $buglist = &get_hunter_bugs($userid, $days, $keyword, $version);
+#            push(@$rowRef, $buglist);
+#        }
+    }
+
+    return $hunterlist;
+}
diff --git a/extensions/weekly-bug-summary/template/en/default/pages/weekly-bug-summary.html.tmpl b/extensions/weekly-bug-summary/template/en/default/pages/weekly-bug-summary.html.tmpl
new file mode 100644
index 0000000..a3714ec
--- /dev/null
+++ b/extensions/weekly-bug-summary/template/en/default/pages/weekly-bug-summary.html.tmpl
@@ -0,0 +1,163 @@
# SECTION: WEEKLY_BUG_SUMMARY
+[%# 1.0@bugzilla.org %]
+[%# -*- mode: html -*- %]
+[%# The contents of this file are subject to the Mozilla Public
+  # License Version 1.1 (the "License"); you may not use this file
+  # except in compliance with the License. You may obtain a copy of
+  # the License at http://www.mozilla.org/MPL/
+  #
+  # Software distributed under the License is distributed on an "AS
+  # IS" basis, WITHOUT WARRANTY OF ANY KIND, either express or
+  # implied. See the License for the specific language governing
+  # rights and limitations under the License.
+  #
+  # The Original Code is the Bugzilla Bug Tracking System.
+  #
+  # The Initial Developer of the Original Code is Olav Vitters
+  # Corporation. Portions created by Netscape are
+  # Copyright (C) 1998 Olav Vitters Corporation. All
+  # Rights Reserved.
+  #
+  #%]
+
+[%# INTERFACE:
+  # This template has no interface.
+  #%]
+
+[% PROCESS global/variables.none.tmpl %]
+
+[% title = "Weekly $terms.Bug Summary" %]
+[% PROCESS global/header.html.tmpl
+    h1 = "" %]
+
+<p>Some [% terms.bug %] summary info from bugzilla.gnome.org
+   [% IF classification %]
+     for products in the [% classification %] classification
+   [% END %]
+   [% IF product %] for [% product %][% END %]
+   [% %], covering the last [% days %] days.</p>
+
+
+  Total Reports: [% totalbugs FILTER html %] 
+  [% IF links == "yes" %]
+    (<a href="[% openbuglist FILTER html %]">[% openbugs FILTER html %]</a>
+  [% ELSE %]
+    ([% openbugs FILTER html %]
+  [% END %]
+  reports opened and 
+  
+  [% IF links == "yes" %]
+    <a href="[% closedbuglist FILTER html %]">[% closedbugs FILTER html %]</a>
+  [% ELSE %]
+    [% closedbugs FILTER html %]
+  [% END %]
+  reports closed. Including enhancement requests)
+
+[% IF products > 0 %]
+<h2>Top [% products FILTER html %] Gnome modules</h2>
+
+<table border=1 cellspacing=0 cellpadding=5>
+<tr><th>Product</th><th>Open [% terms.bugs %]</th><th>Opened in last [% days FILTER html %] days</th><th>Closed in last [% days FILTER html %] days</th><th>Change</th></tr>
+[% FOREACH row = productlist %]
+<tr class="[%+ IF loop.count() % 2 == 0 %]bz_row_even[% ELSE %]bz_row_odd[% END %]">
+  <td><a href="browse.cgi?product=[% row.1 FILTER url_quote %]">[% row.1 FILTER html %]</a></td>
+  <td><a href="buglist.cgi?product=[% row.1 FILTER url_quote %]&amp;bug_status=UNCONFIRMED&amp;bug_status=NEW&amp;bug_status=ASSIGNED&amp;bug_status=REOPENED&amp;bug_severity=blocker&amp;bug_severity=critical&amp;bug_severity=major&amp;bug_severity=normal&amp;bug_severity=minor&amp;bug_severity=trivial&amp;gnome_version=[% version FILTER url_quote %]">[% row.2 FILTER html %]</a></td>
+  <td><a href="[% row.4 FILTER html %]">+[% row.3 FILTER html %]</a></td>
+  <td><a href="[% row.6 FILTER html %]">-[% row.5 FILTER html %]</a></td>
+  [% IF row.7 > 0 %]
+    <td bgcolor="#ffc849">[% row.7 FILTER html %]</td>
+  [% ELSE %]
+    <td bgcolor="#00d51d">[% row.7 FILTER html %]</td>
+  [% END %]
+</tr>
+[% END %]
+</table>
+[% END %]
+
+
+[% IF hunters > 0 %]
+<h2>Top [% hunters FILTER html %] [%+ terms.bug %] closers</h2>
+
+<table border=1 cellspacing=0 cellpadding=5>
+<tr><th>Position</th><th>Who</th><th>Number of [% terms.bugs %] closed</th></tr>
+[% position = 1 %]
+[% FOREACH row = hunterlist %]
+<tr class="[%+ IF loop.count() % 2 == 0 %]bz_row_even[% ELSE %]bz_row_odd[% END %]">
+  <td>[% position FILTER html %]</td>
+  <td>
+    [% INCLUDE global/user.html.tmpl who = row.2 %]
+  </td>
+  [% IF links == "yes" %]
+    <td><a href="[% row.3 FILTER html %]">[% row.1 FILTER html %]</a></td>
+  [% ELSE %]
+    <td>[% row.1 FILTER html %]</td>
+  [% END %]
+</tr>
+[% position = position + 1 %]
+[% END %]
+</table>
+[% END %]
+
+[% IF reporters > 0 %]
+<h2>Top [% reporters FILTER html %] [%+ terms.bug %] reporters</h2>
+
+<table border=1 cellspacing=0 cellpadding=5>
+<tr><th>Position</th><th>Who</th><th>Number of [% terms.bugs %] reported</th></tr>
+[% position = 1 %]
+[% FOREACH row = reporterlist %]
+<tr class="[%+ IF loop.count() % 2 == 0 %]bz_row_even[% ELSE %]bz_row_odd[% END %]">
+  <td>[% position FILTER html %]</td>
+  <td>
+    [% INCLUDE global/user.html.tmpl who = row.2 %]
+  </td>
+  [% IF links == "yes" %]
+    <td><a href="[% row.3 FILTER html %]">[% row.1 FILTER html %]</a></td>
+  [% ELSE %]
+    <td>[% row.1 FILTER html %]</td>
+  [% END %]
+</tr>
+[% position = position + 1 %]
+[% END %]
+</table>
+[% END %]
+
+[% IF patchers > 0 %]
+<h2>Top [% patchers FILTER html %] patch contributors</h2>
+
+<table border=1 cellspacing=0 cellpadding=5>
+<tr><th>Position</th><th>Who</th><th>Number of patches contributed</th></tr>
+[% position = 1 %]
+[% FOREACH row = patcherlist %]
+<tr class="[%+ IF loop.count() % 2 == 0 %]bz_row_even[% ELSE %]bz_row_odd[% END %]">
+  <td>[% position FILTER html %]</td>
+  <td>
+    [% INCLUDE global/user.html.tmpl who = row.2 %]
+  </td>
+    <td>[% row.1 FILTER html %]</td>
+</tr>
+[% position = position + 1 %]
+[% END %]
+</table>
+[% END %]
+
+[% IF reviewers > 0 %]
+<h2>Top [% reviewers FILTER html %] patch reviewers</h2>
+
+<table border=1 cellspacing=0 cellpadding=5>
+<tr><th>Position</th><th>Who</th><th>Number of patches reviewed</th></tr>
+[% position = 1 %]
+[% FOREACH row = reviewerlist %]
+<tr class="[%+ IF loop.count() % 2 == 0 %]bz_row_even[% ELSE %]bz_row_odd[% END %]">
+  <td>[% position FILTER html %]</td>
+  <td>
+    [% INCLUDE global/user.html.tmpl who = row.2 %]
+  </td>
+    <td>[% row.1 FILTER html %]</td>
+</tr>
+[% position = position + 1 %]
+[% END %]
+</table>
+[% END %]
+
+<p> If you spot any errors in this page please report it to <a href="mailto:bugmaster@gnome.org">bugmaster@gnome.org</a>. Thanks.</p>
+
+[% PROCESS global/footer.html.tmpl %]
diff --git a/images/gnome-16.png b/images/gnome-16.png
new file mode 100644
index 0000000000000000000000000000000000000000..95c4ff6e89151914b61f0995ccccca642b0b6e33
GIT binary patch
# SECTION: BRAND_HEADER_AND_FRONT_PAGE
literal 650
zcmV;50(Jd~P)<h;3K|Lk000e1NJLTq000mG000mO1^@s6AM^iV00009a7bBm000XS
z000XS0e@s)kpKVy2XskIMF-Lb8W1xPp*yo}0006hNkl<Zc${NkpcUZd<749C<@Ms>
z<rQUMU|`_k;fdhp=03&E&3(kh)m0p)Mqv?AIUx~I1py)9Z~;M~|Dj=FYXpTw>;wdb
z{t5^R{TC7z`G4ljnL3zyCUgUsSXkC5D=Y676cprVWoKt_a&nSqVPy?uWoKt%WoKuI
zi;H70Ha6aeVY9THLZG~|YOtiN{93=jp#NL8ZL>+w%6{_c)2Av)S@}jOS^582xq1J;
zef!pmtd9l8U}j|t5f>K^EX>cfP*ji?*tlie)sLUP<Qtk<v51I@{h2bMZ@HbV%@#&R
z#${Ly5EB<~a&mO^mzI`RjY>#)^#A|=rwj}XoD2*M3}3!|XGloPe50+US&!jm7~{;b
z!#DW_1?|)Gil#HMuqH6GvT-uAvN0fGk>J39N}L8TFfcI8U$!#qF9V|}6Du17I<~X5
zWrzq3K8bDs3o?h1h0Oq60UIkTLuy>qzm(XhMotcnnRpFgU}n9|z`$Sx<7#WDGBlMJ
zUC>rnP1CS(yN9kB!wdgeSmyp`VP*Kw!pgwT&CM{kzjNuVWosPO?L1ffXJUR6mR_(B
zuK~9X@7&GF%`@*m6Dz~_-~Soh;<8?CKXfAEKNG9ce<oIjxUfJSbORXC1#aDc$lWw~
z&c>4$uQ~t!{~s=%8t(tEEG^ETk&$r=UIQ2y7#RNl|IfT-|Ixf_cOPVNva_q`Yp7he
kGc~AWWMtfkO+7^b02Skx#B+*xzW@LL07*qoM6N<$g3pyB_W%F@

literal 0
HcmV?d00001

diff --git a/js/attachment.js b/js/attachment.js
index 2543316..8271473 100644
--- a/js/attachment.js
+++ b/js/attachment.js
@@ -43,6 +43,15 @@ function setContentTypeDisabledState(form)
# SECTION: REQ_3_ATTACHMENT_STATUS
     form.contenttypeentry.disabled = isdisabled;
 }
 
+function setStatusDisabledState(form)
+{
+    var isdisabled = false;
+    if (!form.ispatch.checked)
+        isdisabled = true;
+
+    document.getElementById('attachments.status').disabled = isdisabled;
+}
+
 function URLFieldHandler() {
     var field_attachurl = document.getElementById("attachurl");
     var greyfields = new Array("data", "ispatch", "autodetect",
diff --git a/js/browse.js b/js/browse.js
new file mode 100644
index 0000000..8d47a38
--- /dev/null
+++ b/js/browse.js
@@ -0,0 +1,116 @@
# SECTION: REQ_4_BROWSE_CGI
+function setCaretToEnd (control) {
+  if (control.createTextRange) {
+    var range = control.createTextRange();
+    range.collapse(false);
+    range.select();
+  }
+  else if (control.setSelectionRange) {
+    control.focus();
+    var length = control.value.length;
+    control.setSelectionRange(length, length);
+  }
+}
+
+function addText(text) {
+  /* Get the querytype */
+  var colonloc = text.indexOf(":");
+  var querytype;
+  var searchBox = document.getElementById('boogle_search_box');
+
+  if (colonloc != -1)
+    querytype = text.substring(0,colonloc);
+  else { 
+    /* comment or +critical_warning */
+    var oldvalue = searchBox.value;
+    var location = oldvalue.indexOf(text);
+
+    if (location == -1) {
+      /* This is new; just prepend it */
+      searchBox.value = text + " " + oldvalue;
+
+    } else {
+      searchBox.value = oldvalue.substring(0, location)
+                        + oldvalue.substring(location + text.length + 1);
+    }
+    return;
+  } /* if (colonloc != -1) */
+
+  /* Quote the value, if needed */
+  var value = text.substring(colonloc+1);
+  if (value.match(/^[A-Za-z0-9+][A-Za-z0-9_\.-]*$/)) {
+  } else {
+    if (colonloc != -1)
+      text = querytype + ':' + '"' + value + '"';
+    else
+      text = '"' + value + '"';
+
+    value = '"' + value + '"';
+  }
+
+  /* Find if this querytype is already in the boogle query */
+  var oldvalue = searchBox.value;
+  var location = oldvalue.search(querytype);
+
+  if (location == -1) {
+    /* This is a new query type; just prepend it */
+    searchBox.value = text + " " + oldvalue;
+  } else {
+    /* This querytype already appears, so doing an and with a different
+     * value does not make any sense.  So, just add it as a comma separated
+     * list item if it is not already present; otherwise, remove it.
+     */
+
+    if (oldvalue.search(value) == -1) {
+      /* prepend the new value */
+      searchBox.value = oldvalue.substring(0,location) + text + "," 
+                        + oldvalue.substring(location + querytype.length + 1);
+
+    } else {
+
+      /* value is already in list, remove it */
+      var vlocation = oldvalue.indexOf(value);
+    
+      /* how many values are there for the current querytype? */
+      var queryvalues = oldvalue.substring(location + querytype.length + 1);
+      if (queryvalues.indexOf(":") >= 0) {
+        /* other querytypes follow, discard them */
+        queryvalues = queryvalues.substring(0,queryvalues.indexOf(":") - 1);
+      }
+
+      /* count the commas (up to the next colon) */
+      var numberofvalues = 1;
+      while ( queryvalues.indexOf(",") >= 0 ) {
+        queryvalues = queryvalues.substring(queryvalues.indexOf(",")+1);
+        numberofvalues += 1;
+      }
+
+      if (numberofvalues == 1) {
+        /* remove the querytype name and value */
+        searchBox.value = oldvalue.substring(0,location)
+                          + oldvalue.substring(vlocation + value.length + 1);
+      } else {
+        /* only remove one value */
+
+        /* last of all value in querytype? 
+           then do not remove the trailing but the preceding character */
+
+        if ( (vlocation + value.length == oldvalue.length) /*last in string? */
+            ||
+             (oldvalue.substring(vlocation + value.length, /*trailing space? */
+              vlocation + value.length + 1) == ' ')   
+           ) 
+        {
+          searchBox.value = oldvalue.substring(0,vlocation-1)
+                            + oldvalue.substring(vlocation + value.length);
+
+        } else {
+          searchBox.value = oldvalue.substring(0,vlocation)
+                            + oldvalue.substring(vlocation + value.length + 1);
+        }
+      } /* if(numberofvalues == 1) */
+
+    } /* if(oldvalue.search(value) == -1) */
+
+  } /* if (location == -1) */
+}
+
diff --git a/js/field.js b/js/field.js
index 62ca7e4..a2cf17e 100644
--- a/js/field.js
+++ b/js/field.js
@@ -375,15 +375,15 @@ function updateCommentTagControl(checkbox, form) {
# SECTION: REQ_19_B_DISPLAY_STUFF_FOR_GNOME_ONLY
 
 /**
  * Says that a field should only be displayed when another field has
- * a certain value. May only be called after the controller has already
+ * certain values. May only be called after the controller has already
  * been added to the DOM.
  */
-function showFieldWhen(controlled_id, controller_id, value) {
+function showFieldWhen(controlled_id, controller_id, values) {
     var controller = document.getElementById(controller_id);
     // Note that we don't get an object for "controlled" here, because it
     // might not yet exist in the DOM. We just pass along its id.
     YAHOO.util.Event.addListener(controller, 'change', 
-        handleVisControllerValueChange, [controlled_id, controller, value]);
+        handleVisControllerValueChange, [controlled_id, controller, values]);
 }
 
 /**
@@ -393,13 +393,13 @@ function showFieldWhen(controlled_id, controller_id, value) {
# SECTION: REQ_19_B_DISPLAY_STUFF_FOR_GNOME_ONLY
 function handleVisControllerValueChange(e, args) {
     var controlled_id = args[0];
     var controller = args[1];
-    var value = args[2];
+    var values = args[2];
 
     var label_container = 
         document.getElementById('field_label_' + controlled_id);
     var field_container =
         document.getElementById('field_container_' + controlled_id);
-    if (bz_valueSelected(controller, value)) {
+    if (bz_valueSelected(controller, values)) {
         YAHOO.util.Dom.removeClass(label_container, 'bz_hidden_field');
         YAHOO.util.Dom.removeClass(field_container, 'bz_hidden_field');
     }
diff --git a/js/util.js b/js/util.js
index 666f266..18fc995 100644
--- a/js/util.js
+++ b/js/util.js
@@ -207,12 +207,18 @@ function bz_populateSelectFromArray(aSelect, aArray) {
# SECTION: REQ_19_B_DISPLAY_STUFF_FOR_GNOME_ONLY
  * case-sensitive.
  *
  * @param aSelect        The select you're checking.
- * @param aValue         The value that you want to know about.
+ * @param aValue         The value(s) that you want to know about.
  */
 function bz_valueSelected(aSelect, aValue) {
     var options = aSelect.options;
+    var vals;
+    if (YAHOO.lang.isArray(aValue)) {
+	vals = aValue;
+    } else {
+	vals = new Array(aValue);
+    }
     for (var i = 0; i < options.length; i++) {
-        if (options[i].selected && options[i].value == aValue) {
+        if (options[i].selected && bz_isValueInArray(vals, options[i].value)) {
             return true;
         }
     }
diff --git a/mod_perl.pl b/mod_perl.pl
index 207430d..c3161fb 100644
--- a/mod_perl.pl
+++ b/mod_perl.pl
@@ -45,8 +45,13 @@ use Bugzilla::Template ();
# SECTION: MOD_PERL_GNOME
 use Bugzilla::Util ();
 
 # This means that every httpd child will die after processing
-# a CGI if it is taking up more than 70MB of RAM all by itself.
-$Apache2::SizeLimit::MAX_UNSHARED_SIZE = 70000;
+# a CGI if it is taking up more than 350MB of RAM all by itself.
+# This number is so high (GNOME-specifically) because we're on
+# a RHEL server that can't use Linux::Smaps (see:
+# https://bugzilla.redhat.com/show_bug.cgi?id=322881 )
+# and so Apache2::SizeLimit thinks we're always our full virt
+# size instead of just our real unshared size.
+$Apache2::SizeLimit::MAX_UNSHARED_SIZE = 350000;
 
 my $cgi_path = Bugzilla::Constants::bz_locations()->{'cgi_path'};
 
@@ -63,7 +68,7 @@ PerlChildInitHandler "sub { srand(); }"
# SECTION: MOD_PERL_GNOME
     PerlCleanupHandler  Apache2::SizeLimit
     PerlOptions +ParseHeaders
     Options +ExecCGI
-    AllowOverride Limit
+    AllowOverride All
     DirectoryIndex index.cgi index.html
 </Directory>
 EOT
diff --git a/page.cgi b/page.cgi
index 914ba3f..a179357 100755
--- a/page.cgi
+++ b/page.cgi
@@ -51,6 +51,12 @@ if ($id) {
# SECTION: REQ_31_MIGRATE_BUG_STATUS_HTML
         ThrowCodeError("bad_page_cgi_id", { "page_id" => $id });
     }
 
+    if ($1 eq 'bug-status') {
+        print $cgi->redirect(-location=>'page.cgi?id=fields.html',
+                             -status=>'301 Permanent Redirect');
+        exit;
+    }
+
     my %vars;
     Bugzilla::Hook::process('page-before_template', 
                             { page_id => $id, vars => \%vars });
diff --git a/query.cgi b/query.cgi
index 71748a1..c0126ac 100755
--- a/query.cgi
+++ b/query.cgi
@@ -268,6 +268,16 @@ $vars->{'op_sys'} = get_legal_field_values('op_sys');
# SECTION: REQ_16_GNOME_VERSION_AND_TARGET
 $vars->{'priority'} = get_legal_field_values('priority');
 $vars->{'bug_severity'} = get_legal_field_values('bug_severity');
 
+# Also need to set up values for custom fields that may want their values
+# This is a bit ugly - rather than having a $vars->{field} be an array
+# (and possibly collide with names used internally), the
+# template should call get_legal_field_values itself (in |BLOCK select|)
+my @custom_select_fields =
+  grep { $_->is_select } Bugzilla->active_custom_fields;
+foreach my $cf (@custom_select_fields) {
+    $vars->{$cf->name} = get_legal_field_values($cf->name);
+}
+
 # Boolean charts
 my @fields = Bugzilla->get_fields({ obsolete => 0 });
 
@@ -370,8 +380,11 @@ $vars->{'query_format'} = $cgi->param('query_format');
# SECTION: DEFAULTFORMAT_SHORT_TO_SPECIFIC
 
 # Set default page to "specific" if none provided
 if (!($cgi->param('query_format') || $cgi->param('format'))) {
-    if (defined $cgi->cookie('DEFAULTFORMAT')) {
-        $vars->{'format'} = $cgi->cookie('DEFAULTFORMAT');
+    if (my $cookie_format = $cgi->cookie('DEFAULTFORMAT')) {
+        if ($cookie_format =~ /short/) {
+            $cookie_format = 'specific';
+        }
+        $vars->{'format'} = $cookie_format;
     } else {
         $vars->{'format'} = 'specific';
     }
diff --git a/robots.txt b/robots.txt
index 0f823cb..c5d4d59 100644
--- a/robots.txt
+++ b/robots.txt
@@ -1,3 +1,8 @@
# SECTION: NO_LARGE_DATA_RETRIEVAL_WARNING
 User-agent: *
 Allow: /index.cgi
 Disallow: /
+
+# Do NOT automatically retrieve large amounts of data from GNOME Bugzilla
+#
+# This will likely result in a permanent ban.
+# bugmaster@gnome.org
diff --git a/sanitycheck.cgi b/sanitycheck.cgi
index 0bb965c..c0e8344 100755
--- a/sanitycheck.cgi
+++ b/sanitycheck.cgi
@@ -229,7 +229,8 @@ if ($cgi->param('repair_creation_date')) {
# SECTION: REQ_28_NEEDINFO
 if ($cgi->param('repair_everconfirmed')) {
     Status('everconfirmed_start');
 
-    my @confirmed_open_states = grep {$_ ne 'UNCONFIRMED'} BUG_STATE_OPEN;
+    my @confirmed_open_states = grep {$_ ne 'UNCONFIRMED' and $_ ne 'NEEDINFO'}
+                                     BUG_STATE_OPEN;
     my $confirmed_open_states = join(', ', map {$dbh->quote($_)} @confirmed_open_states);
 
     $dbh->do("UPDATE bugs SET everconfirmed = 0 WHERE bug_status = 'UNCONFIRMED'");
@@ -961,7 +962,8 @@ Status('bug_check_status_everconfirmed');
# SECTION: REQ_28_NEEDINFO
 BugCheck("bugs WHERE bug_status = 'UNCONFIRMED' AND everconfirmed = 1",
          'bug_check_status_everconfirmed_error_text', 'repair_everconfirmed');
 
-my @confirmed_open_states = grep {$_ ne 'UNCONFIRMED'} BUG_STATE_OPEN;
+my @confirmed_open_states = grep {$_ ne 'UNCONFIRMED' and $_ ne 'NEEDINFO'}
+                                 BUG_STATE_OPEN;
 my $confirmed_open_states = join(', ', map {$dbh->quote($_)} @confirmed_open_states);
 
 BugCheck("bugs WHERE bug_status IN ($confirmed_open_states) AND everconfirmed = 0",
diff --git a/search_plugin.cgi b/search_plugin.cgi
index 4dfe8fa..62483f4 100755
--- a/search_plugin.cgi
+++ b/search_plugin.cgi
@@ -32,7 +32,7 @@ my $vars = {};
# SECTION: BRAND_HEADER_AND_FRONT_PAGE
 print $cgi->header('application/xml');
 
 # Get the contents of favicon.ico
-my $filename = bz_locations()->{'libpath'} . "/images/favicon.ico";
+my $filename = bz_locations()->{'libpath'} . "/images/gnome-16.png";
 if (open(IN, $filename)) {
     local $/;
     binmode IN;
diff --git a/show_bug.cgi b/show_bug.cgi
index 42fad71..0767f83 100755
--- a/show_bug.cgi
+++ b/show_bug.cgi
@@ -37,9 +37,11 @@ my $vars = {};
# SECTION: XSS_IN_SHOW_BUG_CGI
 
 my $user = Bugzilla->login();
 
+my $format = $template->get_format("bug/show", scalar $cgi->param('format'),
+                                   scalar $cgi->param('ctype'));
+
 # Editable, 'single' HTML bugs are treated slightly specially in a few places
-my $single = !$cgi->param('format')
-  && (!$cgi->param('ctype') || $cgi->param('ctype') eq 'html');
+my $single = !$format->{format} && $format->{extension} eq 'html';
 
 # If we don't have an ID, _AND_ we're only doing a single bug, then prompt
 if (!$cgi->param('id') && $single) {
@@ -49,9 +51,6 @@ if (!$cgi->param('id') && $single) {
# SECTION: XSS_IN_SHOW_BUG_CGI
     exit;
 }
 
-my $format = $template->get_format("bug/show", scalar $cgi->param('format'), 
-                                   scalar $cgi->param('ctype'));
-
 my @bugs = ();
 my %marks;
 
@@ -140,5 +139,5 @@ $vars->{'displayfields'} = \%displayfields;
# SECTION: XSS_IN_SHOW_BUG_CGI
 
 print $cgi->header($format->{'ctype'});
 
-$template->process("$format->{'template'}", $vars)
+$template->process($format->{'template'}, $vars)
   || ThrowTemplateError($template->error());
diff --git a/skins/contrib/Dusk/show_bug.css b/skins/contrib/Dusk/show_bug.css
new file mode 100644
index 0000000..c0e7f8f
--- /dev/null
+++ b/skins/contrib/Dusk/show_bug.css
@@ -0,0 +1,4 @@
# SECTION: REQ_50_FLOAT_RIGHT_INFO_BOX
+#bug_summary table {
+    background-color: #ffffff;
+}
+
diff --git a/skins/contrib/GNOME/buglist.css b/skins/contrib/GNOME/buglist.css
new file mode 100644
index 0000000..e6b1ab6
--- /dev/null
+++ b/skins/contrib/GNOME/buglist.css
@@ -0,0 +1,3 @@
# SECTION: REQ_39_GNOME_SKIN
+.bz_enhancement {
+    color: #6c6e6a;
+}
diff --git a/skins/contrib/GNOME/global.css b/skins/contrib/GNOME/global.css
new file mode 100644
index 0000000..e93a653
--- /dev/null
+++ b/skins/contrib/GNOME/global.css
@@ -0,0 +1,141 @@
# SECTION: REQ_39_GNOME_SKIN
+/* global (begin) */
+    body {
+	margin: 0px;
+	padding: 0px;
+	font-family: "Bitstream Vera Sans", "Luxi Sans", "Lucida Grande", "Trebuchet MS", helvetica, verdana, arial, sans-serif;
+        /* font-size: small; */
+        color: #333;
+    }
+/* global (end) */
+
+/* header (begin) */
+  #header #titles {
+    -moz-border-radius: 0;
+  }
+/* header (end)   */
+
+/* banner (begin) */
+/* banner (end) */
+
+/* titles (begin) */
+/* titles (end) */
+
+/* footer (begin)
+ * See also the "header" section for styles that apply
+ * to both the header and footer. 
+ */
+/* footer (end) */
+
+/* link lists (begin) */
+/* link lists (end) */
+
+/* tabs (begin) */
+    #bugzilla-body .tabbed {
+        margin: 0 -1em;
+    }
+    #bugzilla-body .tabbody {
+        margin: 0 1em;
+    }
+/* tabs (end) */
+
+/* generic (begin) */
+    #bugzilla-body {
+        margin: 0 1em 1em 1em;
+    }
+    a img {
+         border: 0px;
+    }
+    a[name] {
+        text-decoration: inherit;
+    }
+    a[name][href] {
+        text-decoration: underline;
+    }
+    h1, h2, h3, h4 {
+        margin-top: 0;
+        margin-bottom: .5em;
+        padding-bottom: 0;
+    }
+    h1, h2 {
+        font-size: 1.3em;
+        margin: 0;
+        padding-bottom: 10px;
+    }
+    h1 {
+        padding-top: 0;
+        /* font-size: x-large; */
+        color: #000;
+    }
+    h2 {
+        font-size: medium;
+        margin: 0;
+        color: #777;
+        padding-top: 12px;
+    }
+    h3, h4 {
+        font-size: small;
+        margin-bottom: 0;
+    }
+    h4 {
+        font-size: x-small;
+    }
+    hr {
+        border-style: none;
+        border: 0px;
+        background-color: #ffffff;
+        color: #ffffff;
+        border-bottom: 1px dashed #ccc;
+        padding: 0.5em;
+    }
+    input, textarea {
+        border: 1px solid #6f6f6f;
+        /* background: #dddddd; */
+    }
+    input[type=radio] {
+        margin-left: 1em;
+    }
+    /* input[type=submit] {
+        background: #dddddd;
+        -moz-border-radius: 10%;
+    } */
+    /* input[type=username] {
+        padding-left: 18px;
+        background-image: url('/images/stock_person.png');
+        background-repeat: no-repeat;
+    }
+    input[type=password] {
+        padding-left: 18px;
+        background-image: url('/images/stock_keyring.png');
+        background-repeat: no-repeat;
+    } */
+    input:focus, textarea:focus {
+        background-color: #f7f2d0;
+        color: #000000;
+    }
+    option {
+        border: 0px none #ffffff;
+    }
+    /* select {
+        border: groove;
+    } */
+/* generic (end) */
+
+/************/
+/* Comments */
+/************/
+
+.bz_comment {
+    border-top: 1px solid #cccccc;
+    margin-top: 0.5em;
+    /* border-bottom: 1px dashed #ccc; */
+    /* border-top: 1px solid #ccc; */
+    padding: 0.2em;
+}
+
+.bz_comment_head, .bz_first_comment_head {
+    background-color: transparent;
+    font-size: 105%;
+    font-weight: bold;
+}
+
+/** End Comments **/
diff --git a/skins/standard/browse.css b/skins/standard/browse.css
new file mode 100644
index 0000000..693b2cc
--- /dev/null
+++ b/skins/standard/browse.css
@@ -0,0 +1,35 @@
# SECTION: REQ_4_BROWSE_CGI
+#product_summary {
+    float: right; 
+    -moz-border-radius-topleft: 20px;
+    -moz-border-radius-bottomleft: 20px; 
+    margin: 0;
+    background-color: #ffeafd; 
+    padding: 0 1em 1em 1em; 
+}
+
+#product_summary h3 {
+    padding: 1em 0 0 0; 
+}
+
+#product_summary ul {
+    padding: 0 0 0 1em;
+    margin: 0;
+}
+
+table.gnomeblocker td {
+    padding: 3px;
+}
+
+table.gnomeblocker thead {
+    background-color: #babdb6;
+}
+
+table.figures td {
+    padding: 0 3px 0 3px;
+    margin: 0;
+}
+
+table.figures tr { margin: 0; }
+
+a.boogle_edit { text-decoration: none; }
+a.boogle_edit:hover { color: #4e9a06 }
diff --git a/skins/standard/show_bug.css b/skins/standard/show_bug.css
index 3a91e8c..7473757 100644
--- a/skins/standard/show_bug.css
+++ b/skins/standard/show_bug.css
@@ -7,9 +7,6 @@
# SECTION: REQ_50_FLOAT_RIGHT_INFO_BOX
     font-weight: bold;
 }
 
-.bz_bug .edit_form {
-  width: 100%;
-}
 .bz_bug .edit_form table {
   width: 100%;
 }
@@ -91,3 +88,25 @@ table#flags {
# SECTION: REQ_50_FLOAT_RIGHT_INFO_BOX
 .knob-buttons {
     float: right;
 }
+
+.bottom_commit_container .knob-buttons {
+    float: none;
+}
+
+#bug_summary {
+    float: right;
+}
+
+#bug_summary table {
+    background-color: #edf2f2;
+    -moz-border-radius: 0.5em;
+    padding: 5px;
+    margin: 0;
+    margin-top: 1em;
+    margin-bottom: 1em;
+    clear: both;
+}
+
+#bug_summary td {
+    padding: 2px;
+}
diff --git a/template/en/custom/pages/email.html.tmpl b/template/en/custom/pages/email.html.tmpl
new file mode 100644
index 0000000..bc6fabe
--- /dev/null
+++ b/template/en/custom/pages/email.html.tmpl
@@ -0,0 +1,124 @@
# SECTION: REQ_40_PORT_FORWARD
+[%# -*- mode: html -*- %]
+[%# The contents of this file are subject to the Mozilla Public
+  # License Version 1.1 (the "License"); you may not use this file
+  # except in compliance with the License. You may obtain a copy of
+  # the License at http://www.mozilla.org/MPL/
+  #
+  # Software distributed under the License is distributed on an "AS
+  # IS" basis, WITHOUT WARRANTY OF ANY KIND, either express or
+  # implied. See the License for the specific language governing
+  # rights and limitations under the License.
+  #
+  # The Initial Developer of the Original Code is Elijah Newren
+  #
+  #%]
+
+[%# INTERFACE:
+  # This template has no interface.
+  #%]
+
+[% PROCESS global/variables.none.tmpl %]
+
+[% PROCESS global/header.html.tmpl
+    title = "About Bugzilla email" %]
+
+<p> 
+This page can help you
+<ul>
+  <li>Understand why you received email.</li>
+  <li>Learn how to stop receiving email.</li>
+  <li>Figure out how to change the conditions causing you receive
+      email, including turning email notifications off entirely.</li>
+  <li>Explain why you can't respond via email.</li>
+  <li>How you can get help if things don't seem to be working.</li>
+</ul>
+</p>
+
+<b>Why you receive email</b>
+<p>
+[% terms.Bugzilla %] sends out email to notify you of changes to bugs you
+reported, modified, put yourself on the cc list, etc.  The full list
+of reasons can be found at <a
+href="userprefs.cgi">[% Param("urlbase") %]userprefs.cgi</a>.
+There is a bug in the system in that it defaults to sending out mail
+when other bugs are marked as a duplicate of the bug you are watching;
+we intend to make that a configuration option defaulting to off.
+Sorry for the annoyance.
+</p>
+
+<b>How to stop receiving email</b>
+<p>
+If you are on the CC (carbon copy) list of any [% terms.Bugzilla %] bug report
+you can easily remove yourself. You receive a link 
+to the corresponding report in the last line of every email you get from 
+[% terms.Bugzilla %]. The link is also at the top. In order to unsubscribe
+open the report, scroll down to the bottom, select your email address within
+the  CC: box, tick <i>Remove selected CCs</i> and press the 
+"Submit Changes" button. <br>
+
+For other cases please refer to the comprehensive email settings 
+mentioned below. <br>
+
+Please keep in mind that we may depend on additional information from you to
+successfully tackle a software problem we all would like to see resolved.
+</p>
+
+<b>How to change when (or if) you get email.</b>
+<p>
+Go to <a
+href="userprefs.cgi?tab=email">[% Param("urlbase") %]userprefs.cgi?tab=email</a>
+and unselect (or select) any relevant boxes for when you don't want to
+get email.  If you want to disable email entirely, click on the
+"Disable All Mail" button. After any changes, make sure to press the
+"Submit Changes" button at the bottom of the page.
+</p>
+
+<b>Why you can't respond via email.</b>
+<p>
+Our version of [% terms.Bugzilla %] is simply a modified (albeit heavily)
+version of mozilla's <a href="http://www.bugzilla.org/">bugzilla</a>.  They
+provide no program to analyze emails, add relevant messages to the
+[% terms.Bugzilla %] database, and send out updated emails to the relevant
+individuals.  We haven't written one either.  Part of the reason for
+this is that it's a really hard problem:
+</p>
+<ul>
+  <li>There are lots of braindead mail clients that send emails in
+      both text and html. [% terms.Bugzilla %] comments should be text only.</li>
+  <li>Email clients and people often stick long footers on emails,
+      which would reduce readability unless they were removed.</li>
+  <li>People and email clients are horribly inconsistent about quoting
+      previous text, making it hard to prevent each comment from
+      including several previous comments with zillions of levels of
+      quoting.  Such a scenario would make bugs completely unreadable
+      with the web interface.</li>
+  <li>People do stupid braindead things like sending out-of-office
+      auto-replies to [% terms.Bugzilla %] messages; we don't want that spam being
+      archived and showing up in everyone's inboxes.  (So any program
+      analyzing emails needs to be able to discover these messages and
+      automatically disable the person's account.)</li>
+  <li>The standard issues -- how does one determine which fields
+      should be changed via an email?  How does one differentiate that
+      from normal text?  When a bug is filed against [% terms.Bugzilla %] itself,
+      how do we differentiate comments explaining how to send an email
+      in a way to change fields in a bug and actual attempt to change
+      fields within that bug?</li>
+  <li>Probably several more issues that we haven't thought of
+      yet.</li>
+</ul>
+<p>
+What this means is that if you want to send a response to someone, you
+need to use the webform by going to the link specified in the email
+sent to you.  If you are having problems with the system itself,
+contact the bugsquad or bugmasters (see last section of this page).
+Any email responses you send at this time will be discarded.
+</p>
+
+<b>Where to go for further help</b>
+<p>
+If things aren't working or you have a question not answered here
+about the email system, feel free to email gnome-bugsquad AT gnome dot
+org or bugmaster AT gnome dot org.
+</p>
+
+[% PROCESS global/footer.html.tmpl %]
diff --git a/template/en/custom/pages/points.html.tmpl b/template/en/custom/pages/points.html.tmpl
new file mode 100644
index 0000000..54bcabf
--- /dev/null
+++ b/template/en/custom/pages/points.html.tmpl
@@ -0,0 +1,78 @@
# SECTION: REQ_40_PORT_FORWARD
+[%# -*- mode: html -*- %]
+[%# The contents of this file are subject to the Mozilla Public
+  # License Version 1.1 (the "License"); you may not use this file
+  # except in compliance with the License. You may obtain a copy of
+  # the License at http://www.mozilla.org/MPL/
+  #
+  # Software distributed under the License is distributed on an "AS
+  # IS" basis, WITHOUT WARRANTY OF ANY KIND, either express or
+  # implied. See the License for the specific language governing
+  # rights and limitations under the License.
+  #
+  # The Initial Developer of the Original Code is Elijah Newren
+  #
+  #%]
+
+[%# INTERFACE:
+  # This template has no interface.
+  #%]
+
+[% PROCESS global/variables.none.tmpl %]
+
+[% PROCESS global/header.html.tmpl
+    title = "The 'Points' statistic" %]
+
+<p>
+Points is a fun statistic in [% terms.Bugzilla %].  It roughly
+measures how active you are in this [% terms.Bugzilla %] installation,
+and could be thought of as a form of aggregate-over-time score from
+the <a href="reports/weekly-bug-summary.cgi">Weekly [% terms.Bug %]
+Summary</a>.  The scoring mechanism is subject to the whim of the
+bugmasters, so don't take too much stock in it.  But it makes for a
+fun competition, by yourself or with others.  How many points do <a
+href="describeuser.cgi"><i>you</i></a> have?  Just a little more work
+could get you up to the next level.  :-)
+</p>
+
+<p>
+You can compare yourself to how many points other people have at the
+<a href="reports/points.cgi">users per points</a> page.  Watch out,
+though, if you try to inflate your score without doing <i>useful</i>
+work in [% terms.Bugzilla %], you may find your score manually altered
+in a very negative way.  If lots of people do this, we'll just alter
+the entire thing.  In particular, we are already considering replacing
+showing of points on each [% terms.bug %] page by some kind of <a
+href="show_bug.cgi?id=325562">more general descriptions</a>.
+</p>
+
+<p>
+The original idea behind points was that having a rough measure of how
+active a person was in [% terms.Bugzilla %] might help triagers
+(bugsquad volunteers) who are getting started by helping them know:
+<ul>
+  <li> which [% terms.bugs %] to avoid because they are either filed
+       by or being handled by an experienced user</li>
+  <li> whose comments are more likely to be worth learning from</li>
+</ul>
+but that is a somewhat error prone use of points as expert hackers or
+heavy users of distro [% terms.bug %] trackers might not have done as
+much in Gnome [% terms.Bugzilla %] and thus their points score might
+be 20 below what their 'experience' level might really reflect.  A
+much more important criteria to show is whether the person is a
+developer of the relevant module or the reporter of the given [%
+terms.bug %] (both of which are currently shown in addition to
+points).  However, even as an error prone rough estimate, it's still
+better than no information and might still be useful for such
+purposes.  Just realize that if you use it this way it's no silver
+bullet.
+</p>
+
+<p>
+The current formula for points (remember, this is subject to change on
+the whim of the bugmasters) is:
+  <blockquote>
+    log_10(1 + #comments) + log_2(1 + #bugs_closed) + log_2(1 + #bugs_reported)
+  </blockquote>
+</p>
+
+[% PROCESS global/footer.html.tmpl %]
diff --git a/template/en/custom/pages/reports.html.tmpl b/template/en/custom/pages/reports.html.tmpl
new file mode 100644
index 0000000..25384a9
--- /dev/null
+++ b/template/en/custom/pages/reports.html.tmpl
@@ -0,0 +1,180 @@
# SECTION: REQ_40_PORT_FORWARD
+[%# -*- mode: html -*- %]
+[%# The contents of this file are subject to the Mozilla Public
+  # License Version 1.1 (the "License"); you may not use this file
+  # except in compliance with the License. You may obtain a copy of
+  # the License at http://www.mozilla.org/MPL/
+  #
+  # Software distributed under the License is distributed on an "AS
+  # IS" basis, WITHOUT WARRANTY OF ANY KIND, either express or
+  # implied. See the License for the specific language governing
+  # rights and limitations under the License.
+  #
+  # The Original Code is the Bugzilla Bug Tracking System.
+  #
+  # The Initial Developer of the Original Code is Olav Vitters
+  # Corporation. Portions created by Netscape are
+  # Copyright (C) 1998 Olav Vitters Corporation. All
+  # Rights Reserved.
+  #
+  #%]
+
+[%# INTERFACE:
+  # This template has no interface.
+  #%]
+
+[% PROCESS global/variables.none.tmpl %]
+
+[% PROCESS global/header.html.tmpl
+    title = "Reports" %]
+
+
+<h3>Categories</h3>
+  <ul>
+    <li> <a href="[% self_url FILTER html %]#generic">Generic Gnome reports</a> </li>
+    <!-- 
+   <li> <a href="[% self_url FILTER html %]#byversion">Reports organized
+      by version</a> </li> -->
+    <li> <a href="[% self_url FILTER html %]#explain">Explanation of [% terms.bugzilla %] terms and fields</a></li>
+  </ul>
+
+<h2>Generic Gnome reports<a name="generic"></a></h2>
+  <ul>
# SECTION: WEEKLY_BUG_SUMMARY
+    <li>
+      <a href="page.cgi?id=weekly-bug-summary.html">Summary of [%
+      terms.bug %] activity for the last week</a>.
+    </li>
# SECTION: REQ_40_PORT_FORWARD
+    <li>
+      <a href="duplicates.cgi">Frequently (and recently)
+      duplicated [% terms.bugs %]</a>
+    </li>
+    <li>
+      <a href="page.cgi?id=popular-traces.html">Frequently Duplicated Stack 
+        Traces</a>
+    </li>
+    <!--
+    <li>
+      Products with the <a href="reports/patch-diligence-report.cgi">
+      fewest unreviewed patches per total patches</a>.
+    </li>
+    -->
+  <!--
+    <li>Unreviewed patches:
+      <ul>
+        <li>
+          <a href="reports/patch-report.cgi"> Comprehensive listing</a> (or by
+          <a href="reports/patch-status.cgi"> product</a>).
+        </li>
+      </ul>
+    </li>
+  -->
+    <li>
+      <a href="query.cgi?format=report-table">Generic tabular reports</a>
+    </li>
+    <li>
+      <a href="query.cgi?format=report-graph">Generic graphical reports</a>
+    </li>
+  </ul>
+
+<h2>Reports for Potential Contributors<a name="contributors"></a></h2>
+  <ul>
+    <li>[% terms.Bugs %] to <a href="http://live.gnome.org/Bugsquad/TriageGuide">triage</a></li>
+      <!--
+      <ul>
+        <li>
+          <a href="reports/core-bugs-today.cgi">[% terms.Bugs %] filed
+          today</a> against components listed at <a href=
+          "http://www.gnome.org/start/unstable/modules/">
+          gnome.org/start/</a> as core GNOME components.  </li>
+        <li>
+          <a href="reports/needinfo-updated.cgi">NEEDINFO reports
+          which have been updated</a> (e.g. given new info).
+        </li>
+        <li>
+          <a href="reports/unconfirmed-bugs.cgi">Products with the
+          most UNCONFIRMED [% terms.bugs %]</a>. Good starting point
+          for new bughunters looking to triage [% terms.bugs %].
+        </li>
+        <li>
+          <a href="reports/check-assignedto.cgi">[% terms.Bugs %]
+          likely not correctly assigned to the correct owner</a>.
+          Shows [% terms.bugs %] owned by the default owner of another
+          component.
+        </li>
+      </ul>
+      -->
+    <li>Finding tasks to work on</li>
+      <ul>
+        <!--
+        <li>
+          [% terms.Bugs %] marked by developers as being <a
+          href="reports/gnome-love.cgi">good tasks for new
+          developers</a>
+        </li>
+        -->
+        <li>
+          Looking at <a href="browse.cgi">product overviews</a>
+        </li>
+        <li>
+          <a href="http://live.gnome.org/JoinGnome">Other ways to help
+          Gnome</a>
+        </li>
+      </ul>
+  </ul>
+
+<!--
+<h2>Reports organized by version<a name="byversion"></a></h2>
+  <ul>
+    <li> Open [% terms.bugs %] for specific GNOME versions, broken down by
+         product, component, and developer:
+      <ul>
+        <li><a href="reports/gnome-218-report.html">GNOME 2.17/2.18</a> </li>
+        <li><a href="reports/gnome-220-report.html">GNOME 2.19/2.20</a> </li>
+        <li><a href="reports/gnome-222-report.html">GNOME 2.21/2.22</a> </li>
+      </ul>
+    </li>
+    <li> Summary of [% terms.bug %] activity for the last week, by GNOME version:
+      <ul>
+        <li> <a href="reports/weekly-bug-summary.cgi?version=2.17/2.18">GNOME 2.17/2.18</a></li>
+        <li> <a href="reports/weekly-bug-summary.cgi?version=2.19/2.20">GNOME 2.19/2.20</a></li>
+        <li> <a href="reports/weekly-bug-summary.cgi?version=2.21/2.22">GNOME 2.21/2.22</a></li>
+      </ul>
+    </li>
+  </ul>
+-->
+
+<h2>Explanation of various [% terms.bugzilla %] terms and fields<a name="explain"></a></h2>
+  <ul>
+    <li>
+      <a href="describecomponents.cgi">Products</a>
+    </li>
+    <li>
+      <a href="page.cgi?id=fields.html">[% terms.Bug %] Fields</a>
+      <ul>
+        <li> 
+          <a href="page.cgi?id=fields.html#status">[% terms.Bug %] status</a>
+        </li>
+        <li>
+          <a href="page.cgi?id=fields.html#resolution">Resolution</a>
+        </li>
+        <li>
+          <a href="page.cgi?id=fields.html#severity">Severities</a>
+        </li>
+        <li>
+          <a href="page.cgi?id=fields.html#priority">Priorities</a>
+        </li>
+        <li>
+          <a href="page.cgi?id=fields.html#gnome_version">Gnome Version</a>
+        </li>
+        <li>
+          <a href="page.cgi?id=fields.html#gnome_target">Gnome Target Milestone</a>
+        </li>
+      </ul>
+    </li>
+    <li>
+      <a href="describekeywords.cgi">Keywords</a>
+    </li>
+  </ul>
+
+If you have questions or suggestions for new reports, email the [% IF user.id %]<a href="mailto:bugmaster@gnome.org">[% END %] Gnome bugmasters.[% IF user.id %]</a>[% END %]<br><br>
+
+[% PROCESS global/footer.html.tmpl %]
diff --git a/template/en/default/account/prefs/email.html.tmpl b/template/en/default/account/prefs/email.html.tmpl
index a4d22db..07fe289 100644
--- a/template/en/default/account/prefs/email.html.tmpl
+++ b/template/en/default/account/prefs/email.html.tmpl
@@ -77,6 +77,18 @@ document.write('<input type="button" value="Disable All Mail" onclick="SetCheckb
# SECTION: REQ_13_SELF_GLOBALWATCHING
   <tr>
     <td width="150"></td>
     <td>
+      <label>
+      <input type="checkbox" value="1" name="globalwatcher" id="globalwatcher"
+             [% 'checked="checked"' IF user.is_global_watcher %]>
+      Get all [% terms.bug %]mail that [% terms.Bugzilla %] sends that I
+      am allowed to see. (Overrides all options below.)
+      </label>
+    </td>
+  </tr>
+
+  <tr>
+    <td width="150"></td>
+    <td>
       [% prefname = "email-$constants.REL_ANY-$constants.EVT_FLAG_REQUESTED" %]
       <input type="checkbox" name="[% prefname %]" id="[% prefname %]" 
         value="1"
@@ -98,16 +110,6 @@ document.write('<input type="button" value="Disable All Mail" onclick="SetCheckb
# SECTION: REQ_13_SELF_GLOBALWATCHING
       <br>
     </td>
   </tr>
-[% IF user.is_global_watcher %]
-  <tr>
-    <td width="150"></td>
-    <td>
-      You are watching all [% terms.bugs %]. To be removed from this role,
-      contact
-      <a href="mailto:[% Param("maintainer") %]">[% Param("maintainer") %]</a>.
-    </td>
-  </tr>
-[% END %]
 </table>
 
 <hr>
@@ -274,6 +276,13 @@ preferences for <u>their</u> relationship to the [% terms.bug %]
# SECTION: REQ_43_EXTRA_TEXT
 </p>
 
 <p>
+To watch an entire product, lookup the product in <a
+href="describecomponents.cgi">this page</a>. This will show the <i>default
+assignee</i> (often <tt><i>productname</i>-maint@gnome.bugs</tt>). Add that
+email address to the box below.
+</p>
+
+<p>
 [% IF watchedusers.size %]
 You are watching everyone in the following list:
   </p>
diff --git a/template/en/default/admin/classifications/add.html.tmpl b/template/en/default/admin/classifications/add.html.tmpl
index 7254779..707289b 100644
--- a/template/en/default/admin/classifications/add.html.tmpl
+++ b/template/en/default/admin/classifications/add.html.tmpl
@@ -44,6 +44,10 @@
# SECTION: REQ_19_CLASSIFICATION_GNOME
       <td><input id="sortkey" size="20" maxlength="20" name="sortkey" 
                  value=""></td>
     </tr>
+    <tr>
+      <th align="right"><label for="is_gnome">GNOME:</label></th>
+      <td><input name="is_gnome" type="checkbox"></td>
+    </tr>
   </table>
   <hr>
   <input type=submit value="Add">
diff --git a/template/en/default/admin/classifications/del.html.tmpl b/template/en/default/admin/classifications/del.html.tmpl
index 8e48768..7177d53 100644
--- a/template/en/default/admin/classifications/del.html.tmpl
+++ b/template/en/default/admin/classifications/del.html.tmpl
@@ -45,6 +45,10 @@
# SECTION: REQ_19_CLASSIFICATION_GNOME
   <td valign="top">Sortkey:</td>
   <td valign="top">[% classification.sortkey FILTER html %]</td>
 
+</tr><tr>
+  <td valign="top">GNOME:</td>
+  <td valign="top">[% classification.is_gnome ? "Yes" : "No" %]</td>
+
 </tr>
 </table>
 
diff --git a/template/en/default/admin/classifications/edit.html.tmpl b/template/en/default/admin/classifications/edit.html.tmpl
index b3ef22b..7d8cbd0 100644
--- a/template/en/default/admin/classifications/edit.html.tmpl
+++ b/template/en/default/admin/classifications/edit.html.tmpl
@@ -45,6 +45,13 @@
# SECTION: REQ_19_CLASSIFICATION_GNOME
       <td><input id="sortkey" size="20" maxlength="20" name="sortkey" value="
       [%- classification.sortkey FILTER html %]"></td>
     </tr>
+    <tr>
+      <th align="right"><label for="is_gnome">GNOME:</label></th>
+      <td>
+        <input type="checkbox" name="is_gnome" 
+               value="1" [% 'checked="checked"' IF classification.is_gnome %]>
+      </td>
+    </tr>
     <tr valign=top>
       <th align="right">
         <a href="editproducts.cgi?classification=[% classification.name FILTER url_quote %]">
diff --git a/template/en/default/admin/classifications/select.html.tmpl b/template/en/default/admin/classifications/select.html.tmpl
index d6b352d..660715c 100644
--- a/template/en/default/admin/classifications/select.html.tmpl
+++ b/template/en/default/admin/classifications/select.html.tmpl
@@ -27,6 +27,7 @@
# SECTION: REQ_19_CLASSIFICATION_GNOME
     <th align="left">Edit Classification ...</th>
     <th align="left">Description</th>
     <th align="left">Sortkey</th>
+    <th align="left">GNOME?</th>
     <th align="left">Products</th>
     <th align="left">Action</th>
   </tr>
@@ -42,6 +43,7 @@
# SECTION: REQ_19_CLASSIFICATION_GNOME
       [% END %]
       </td>
       <td valign="top">[% cl.sortkey FILTER html %]</td>
+      <td valign="top">[% cl.is_gnome ? "Yes" : "No" %]</td>
       [% IF (cl.id == 1) %]
         <td valign="top">[% cl.product_count FILTER html %]</td>
       [% ELSE %]
@@ -58,7 +60,7 @@
# SECTION: REQ_19_CLASSIFICATION_GNOME
   [% END %]
 
   <tr>
-    <td valign="top" colspan=4>Add a new classification</td>
+    <td valign="top" colspan=5>Add a new classification</td>
     <td valign="top" align="center"><a href="editclassifications.cgi?action=add">Add</a></td>
   </tr>
 </table>
diff --git a/template/en/default/admin/components/confirm-delete.html.tmpl b/template/en/default/admin/components/confirm-delete.html.tmpl
index 53bba1e..4e5cf87 100644
--- a/template/en/default/admin/components/confirm-delete.html.tmpl
+++ b/template/en/default/admin/components/confirm-delete.html.tmpl
@@ -72,7 +72,7 @@ from '[% product.name FILTER html %]' product
# SECTION: REQ_34_MILESTONE_URL_TO_HOME_PAGE
 [% IF Param('usetargetmilestone') %]
 </tr>
 <tr>
-  <td valign="top">Product Milestone URL:</td>
+  <td valign="top">Product Home Page:</td>
   <td valign="top">
     <a href="[% product.milestone_url FILTER html %]">
       [% product.milestone_url FILTER html %]
diff --git a/template/en/default/admin/fieldvalues/create.html.tmpl b/template/en/default/admin/fieldvalues/create.html.tmpl
index f1eec1a..1ad63f4 100644
--- a/template/en/default/admin/fieldvalues/create.html.tmpl
+++ b/template/en/default/admin/fieldvalues/create.html.tmpl
@@ -61,6 +61,13 @@
# SECTION: REQ_3_ATTACHMENT_STATUS
           the status. It cannot be edited later.
         </td>
       </tr>
+    [% ELSIF field.name == "attachments.status" %]
+      <tr>
+        <th align="right"><label for="description">Description:</label></th>
+        <td>
+          <textarea name="description" cols="64" rows="4"></textarea>
+        </td>
+      </tr>
     [% END %]
     [% IF field.value_field %]
       <tr>
diff --git a/template/en/default/admin/fieldvalues/edit.html.tmpl b/template/en/default/admin/fieldvalues/edit.html.tmpl
index b014155..7bef4ab 100644
--- a/template/en/default/admin/fieldvalues/edit.html.tmpl
+++ b/template/en/default/admin/fieldvalues/edit.html.tmpl
@@ -57,6 +57,14 @@
# SECTION: REQ_3_ATTACHMENT_STATUS
         <th align="right"><label for="is_open">Status Type:</label></th>
         <td>[% IF value.is_open %]Open[% ELSE %]Closed[% END %]</td>
       </tr>
+    [% ELSIF field.name == "attachments.status" %]
+      <tr>
+        <th align="right"><label for="description">Description:</label></th>
+        <td>
+          <textarea name="description" cols="64" rows="4">
+            [% value.description FILTER html %]</textarea>
+        </td>
+      </tr>
     [% END %]
     [% IF field.value_field %]
       <tr>
diff --git a/template/en/default/admin/keywords/create.html.tmpl b/template/en/default/admin/keywords/create.html.tmpl
index e5d6aa0..386121c 100644
--- a/template/en/default/admin/keywords/create.html.tmpl
+++ b/template/en/default/admin/keywords/create.html.tmpl
@@ -28,6 +28,30 @@
# SECTION: REQ_43_EXTRA_TEXT
   subheader = "This page allows you to add a new keyword."
 %]
 
+<p>
+At the risk of Elijah's wrath, <b>DO NOT</b> add any keywords without
+consensus of the active bugmasters.  We have too many keywords and
+should be removing them instead of adding them in most all cases.
+Basic criteria for adding new keywords that you should consider when
+trying to get approval of the other bugmasters:
+<ul>
+  <li> It should not be specific to any module or small set of modules</li>
+  <li> It must be used widely (i.e. by many different people and not
+       just some small niche) for querying.  (Using extra keywords to
+       categorize bugs, merely in order that they can be categorized
+       more, isn't useful unless multiple people actively use those
+       categories in searches)</li>
+  <li> It must be used for a long time, not just for some short term
+       purpose (e.g. something like "Gnome212blocker" wouldn't
+       fly)</li>
+</ul>
+Note that everyone is free to use the status whiteboard as an
+alternative to keywords.  It is helpful, when using the status
+whiteboard, if you namespace anything you add; for example,
+"evolution[IMAP]" instead of "IMAP" and "andrew[bigbadbug]" instead of
+"bigbadbug".
+</p>
+
 <form method="post" action="editkeywords.cgi">
   <table border="0" cellpadding="4" cellspacing="0">
     <tr>
diff --git a/template/en/default/admin/products/confirm-delete.html.tmpl b/template/en/default/admin/products/confirm-delete.html.tmpl
index 5166721..198a329 100644
--- a/template/en/default/admin/products/confirm-delete.html.tmpl
+++ b/template/en/default/admin/products/confirm-delete.html.tmpl
@@ -77,7 +77,7 @@
# SECTION: REQ_34_MILESTONE_URL_TO_HOME_PAGE
 
   [% IF Param('usetargetmilestone') %]
     <tr>
-      <td>Milestone URL:</td>
+      <td>Home Page:</td>
       <td>
         [% IF product.milestone_url %]
           <a href="[% product.milestone_url FILTER html %]">
diff --git a/template/en/default/admin/products/edit-common.html.tmpl b/template/en/default/admin/products/edit-common.html.tmpl
index c05a878..3c87383 100644
--- a/template/en/default/admin/products/edit-common.html.tmpl
+++ b/template/en/default/admin/products/edit-common.html.tmpl
@@ -77,6 +77,7 @@
# SECTION: REQ_25_UNCONFIRMED_ENABLED
   </td>
 </tr>
 
+<!--
 [% IF !Param('usevotes') %]
 <tr class="param_disabled">
   <td colspan="2"
@@ -112,3 +113,4 @@
# SECTION: REQ_25_UNCONFIRMED_ENABLED
            value="[% product.votestoconfirm FILTER html %]">
   </td>
 </tr>
+-->
diff --git a/template/en/default/admin/products/updated.html.tmpl b/template/en/default/admin/products/updated.html.tmpl
index b04fa46..2fd36e9 100644
--- a/template/en/default/admin/products/updated.html.tmpl
+++ b/template/en/default/admin/products/updated.html.tmpl
@@ -69,7 +69,7 @@
# SECTION: REQ_34_MILESTONE_URL_TO_HOME_PAGE
 
 [% IF changes.milestoneurl.defined %]
   <p>
-  Updated milestone URL 
+  Updated home page 
   [% IF changes.milestoneurl.0 != '' %]
     from<br> <a href="[%- changes.milestoneurl.0 FILTER html %]">
     [%- changes.milestoneurl.0 FILTER html %]</a>
diff --git a/template/en/default/attachment/content-types.html.tmpl b/template/en/default/attachment/content-types.html.tmpl
index 471222a..4d29fee 100644
--- a/template/en/default/attachment/content-types.html.tmpl
+++ b/template/en/default/attachment/content-types.html.tmpl
@@ -25,3 +25,4 @@
# SECTION: REQ_44_X_COMPRESSED_TAR
           <option value="image/jpeg">JPEG image (image/jpeg)</option>
           <option value="image/png">PNG image (image/png)</option>
           <option value="application/octet-stream">binary file (application/octet-stream)</option>
+          <option value="application/x-compressed-tar">tar compressed archive (application/x-compressed-tar)</option>
diff --git a/template/en/default/attachment/create.html.tmpl b/template/en/default/attachment/create.html.tmpl
index 687cd7c..009a893 100644
--- a/template/en/default/attachment/create.html.tmpl
+++ b/template/en/default/attachment/create.html.tmpl
@@ -34,7 +34,7 @@
# SECTION: REQ_3_ATTACHMENT_STATUS
   header = header
   subheader = subheader
   style_urls = [ 'skins/standard/create_attachment.css' ]
-  javascript_urls = [ "js/attachment.js", "js/util.js" ]
+  javascript_urls = [ "js/attachment.js", "js/field.js", "js/util.js" ]
   doc_section = "attachments.html"
 %]
 
diff --git a/template/en/default/attachment/createformcontents.html.tmpl b/template/en/default/attachment/createformcontents.html.tmpl
index 2cef632..0451734 100644
--- a/template/en/default/attachment/createformcontents.html.tmpl
+++ b/template/en/default/attachment/createformcontents.html.tmpl
@@ -68,8 +68,8 @@
# SECTION: REQ_3_ATTACHMENT_STATUS
   <td>
     <em>If the attachment is a patch, check the box below.</em><br>
     <input type="checkbox" id="ispatch" name="ispatch" value="1"
-           onchange="setContentTypeDisabledState(this.form);">
-    <label for="ispatch">patch</label><br><br>
+           onchange="setContentTypeDisabledState(this.form); setStatusDisabledState(this.form);">
+    <label for="ispatch">patch</label>
     [%# Reset this whenever the page loads so that the JS state is up to date %]
     <script type="text/javascript">
       YAHOO.util.Event.onDOMReady(function() {
@@ -77,6 +77,13 @@
# SECTION: REQ_3_ATTACHMENT_STATUS
       });
     </script>
 
+    <br><b><label for="status">Status</label>:</b>
+    [%+ PROCESS bug/field.html.tmpl field=Bugzilla.get_fields({name => 'attachments.status'})
+                                    value = 'none'
+                                    editable=user.in_group('editbugs')
+                                    no_tds=1 %]
+    <br><br>
+
     <em>Otherwise, choose a method for determining the content type.</em><br>
     <input type="radio" id="autodetect"
            name="contenttypemethod" value="autodetect" checked="checked">
diff --git a/template/en/default/attachment/edit.html.tmpl b/template/en/default/attachment/edit.html.tmpl
index 95c9087..b5f1905 100644
--- a/template/en/default/attachment/edit.html.tmpl
+++ b/template/en/default/attachment/edit.html.tmpl
@@ -224,6 +224,16 @@
# SECTION: REQ_3_ATTACHMENT_STATUS
             <label for="isprivate">private</label><br>
           [% END %]
           <br>
+
+          [% IF attachment.ispatch %]
+            <b><label for="status">Status</label>:</b>
+            [%+ PROCESS bug/field.html.tmpl field=Bugzilla.get_fields({name =>
+'attachments.status'})
+                                            value=attachment.status
+                                            editable=user.in_group('editbugs')
+                                            no_tds=1 %]
+            <br>
+          [% END %]
         </small>
 
         [% IF attachment.flag_types.size > 0 %]
diff --git a/template/en/default/attachment/list.html.tmpl b/template/en/default/attachment/list.html.tmpl
index 04894ff..5b8520b 100644
--- a/template/en/default/attachment/list.html.tmpl
+++ b/template/en/default/attachment/list.html.tmpl
@@ -51,7 +51,11 @@ function toggle_display(link) {
# SECTION: REQ_3_ATTACHMENT_STATUS
 <br>
 <table id="attachment_table" cellspacing="0" cellpadding="4">
   <tr>
-    <th colspan="[% show_attachment_flags ? 3 : 2 %]" align="left">
+    [% SET colspan = 3 %]
+    [% SET colspan = colspan+1 IF show_attachment_status %]
+    [% SET colspan = colspan+1 IF show_attachment_flags %]
+    
+    <th colspan="[% colspan %]" align="left">
       <a name="a0" id="a0">Attachments</a>
     </th>
   </tr>
@@ -99,6 +103,16 @@ function toggle_display(link) {
# SECTION: REQ_3_ATTACHMENT_STATUS
           </span>
         </td>
 
+        [% IF show_attachment_status %]
+          <td class="bz_attach_status" valign="top">
+            [% IF attachment.ispatch %]
+              [% attachment.status FILTER html %]
+            [% ELSE %]
+              &nbsp;
+            [% END %]
+          </td>
+        [% END %]
+
         [% IF show_attachment_flags %]
           <td class="bz_attach_flags" valign="top">
             [% IF attachment.flags.size == 0 %]
@@ -127,7 +141,7 @@ function toggle_display(link) {
# SECTION: REQ_3_ATTACHMENT_STATUS
   [% END %]
 
   <tr class="bz_attach_footer">
-    <td colspan="[% show_attachment_flags ? 3 : 2 %]">
+    <td colspan="[% colspan %]">
       [% IF attachments.size %]
         <span class="bz_attach_view_hide">
           [% IF obsolete_attachments %]
diff --git a/template/en/default/attachment/show-multiple.html.tmpl b/template/en/default/attachment/show-multiple.html.tmpl
index 36088c9..357a899 100644
--- a/template/en/default/attachment/show-multiple.html.tmpl
+++ b/template/en/default/attachment/show-multiple.html.tmpl
@@ -51,7 +51,7 @@
# SECTION: REQ_3_ATTACHMENT_STATUS
 
       <td valign="top">
         [% IF a.ispatch %]
-          <i>patch</i>
+          <i>patch</i> ([% a.status FILTER html %])
         [% ELSE %]
           [% a.contenttype FILTER html %]
         [% END %]
diff --git a/template/en/default/browse/main.html.tmpl b/template/en/default/browse/main.html.tmpl
new file mode 100644
index 0000000..3b0a3ff
--- /dev/null
+++ b/template/en/default/browse/main.html.tmpl
@@ -0,0 +1,457 @@
# SECTION: REQ_4_BROWSE_CGI
+[%# The contents of this file are subject to the Mozilla Public
+  # License Version 1.1 (the "License"); you may not use this file
+  # except in compliance with the License. You may obtain a copy of
+  # the License at http://www.mozilla.org/MPL/
+  #
+  # Software distributed under the License is distributed on an "AS
+  # IS" basis, WITHOUT WARRANTY OF ANY KIND, either express or
+  # implied. See the License for the specific language governing
+  # rights and limitations under the License.
+  #
+  # The Original Code is the Bugzilla Bug Tracking System.
+  #
+  # The Initial Developer of the Original Code is Netscape Communications
+  # Corporation. Portions created by Netscape are
+  # Copyright (C) 1998 Netscape Communications Corporation. All
+  # Rights Reserved.
+  #
+  # Contributor(s): Gervase Markham <gerv@gerv.net>
+  #                 Vaskin Kissoyan <vkissoyan@yahoo.com>
+  #                 Max Kanat-Alexander <mkanat@bugzilla.org>
+  #                 Frédéric Buclin <LpSolit@gmail.com>
+  #                 Olav Vitters <olav@bkor.dhs.org>
+  #                 Guy Pyrzak <guy.pyrzak@gmail.com>
+  #                 Elliotte Martin <emartin@everythingsolved.com>
+  #%]
+
+[% PROCESS global/variables.none.tmpl %]
+
+[% filtered_product = product.name FILTER html %]
+[% PROCESS global/header.html.tmpl
+  title = "Browse: $filtered_product"
+  h1 = ""
+  style_urls = [ "skins/standard/browse.css", "skins/standard/buglist.css" ]
+  javascript_urls = [ "js/browse.js" ]
+%]
+
+<div id="product_summary">
+  <h3>Project Summary</h3>
+
+  <table border="0" class="figures">
+
+  <tr>
+    <td>Total [% terms.Bugs %]</td>
+    <td align="right">
+      <a href="[% buglink FILTER html %]">
+        [%- total_open_bugs FILTER html %]</a>
+    </td>
+  </tr>
+
+  <tr>
+    <td>New [% terms.Bugs %]</td> 
+    <td align="right"><a href="[% buglink FILTER html %]&amp;chfield=[% "[Bug creation]" FILTER url_quote %]&amp;chfieldfrom=[% what_new_means FILTER html %]">
+    [% new_bugs FILTER html %]</a></li></td>
+  </tr>
+
+  <tr>
+    <td>New Patches</td>
+    <td align="right">
+      <a href="page.cgi?id=patchreport.html&amp;product=[%- product.name FILTER url_quote %]&amp;max_days=7">
+        [% new_patches FILTER html %]
+      </a>
+    </td>
+  </tr>
+
+  <tr>
+    <td>
+      <a class="boogle_edit" 
+         href="javascript:addText('keywords:gnome-love')">GNOME-love 
+        [%= terms.bugs %]</a>
+    </td>
+    <td align="right">
+      <!--
+      <a href="reports/keyword-search.cgi?product=
+               [%- product.name FILTER url_quote %]&amp;keyword=gnome-love">
+      -->
+        [%- gnome_love_bugs FILTER html %] <!-- </a> -->
+    </td>
+  </tr>
+  <tr>
+    <td>
+      <!-- <a class="boogle_edit"
+               href="javascript:addText('severity!=enhancement');addText('responders:0');addText('reporter!=developer')"> -->
+      [% terms.Bugs %] without a response <!-- </a> -->
+    </td>
+    <td align="right">
+      <!-- <a href="buglist.cgi?quicksearch=product:
+              [%- product.name FILTER url_quote %]+responders:0+severity!=enhancement+reporter!=developer"> -->
+        [% no_response_bugs FILTER html %] <!-- </a> -->
+    </td>
+  </tr>
+  [%######################################################################
+    # Temporary time-limited queries; Please just comment these out when
+    # they are not in use if they will be needed again next release
+    # cycle.  Also, be sure to leave these in italics so that people can
+    # notice they are different than the standard list.
+    ######################################################################
+   %]
+  <tr>
+    <td>
+      <em><a class="boogle_edit" 
+             href="javascript:addText('+G_LOG_LEVEL_CRITICAL')">Critical 
+        warning [% terms.bugs %]</a></em>
+    </td>
+    <td align="right">
+      <em><a href="[% buglink FILTER html %]&amp;content=G_LOG_LEVEL_CRITICAL">
+        [%- critical_warning_bugs FILTER html %]</a></em>
+    </td>
+  </tr>
+  <!-- 
+  <tr>
+    <td><a class="boogle_edit" href="javascript:addText('keyword:string')">String [% terms.bugs %]</a></td>
+    <td align="right"><a href="[% buglink FILTER html %]&amp;keywords=string">[% string_bugs FILTER html %]</a></td>
+  </tr>
+  -->
+  [%######################################################################
+    # End of temporary, time-limited queries
+    ######################################################################
+   %]
+  </table>
+  
+  [% IF by_patch_status.size %]
+    <h3>Patch Status</h3>
+    <table border="0" cellpadding="0" cellspacing="0" class="figures">
+    [% FOREACH col = by_patch_status %]
+      <tr>
+        <td>
+          <!--
+          <a class="boogle_edit" 
+             href="javascript:addText('patch-status:[% col.0 FILTER js %]')"> -->
+          [% col.0 FILTER html %] <!-- </a> -->
+          [% IF col.0 == 'none' %] (unreviewed)[% END %]
+        </td>
+        <td align="right">
+          <a href="page.cgi?id=patchreport.html&amp;product=[%- product.name FILTER url_quote %]&amp;patch-status=[% col.0 FILTER url_quote %]">
+            [% col.1 FILTER html %]
+          </a>
+        </td>
+      </tr>
+    [% END %]
+    </table>
+  [% END %]
+  
+  [% IF by_priority.size %]
+    <h3>Priority</h3>
+    <table border="0" cellpadding="0" cellspacing="0" class="figures">
+    [% FOREACH col = by_priority %]
+      <tr>
+        <td>
+          <a class="boogle_edit" 
+             href="javascript:addText('priority:[% col.0 FILTER js %]')">
+            [%- col.0 FILTER html %]</a>
+        </td>
+        <td align="right">
+          <a href="[% buglink FILTER html %]&amp;priority=
+                   [%- col.0 FILTER url_quote %]">[% col.1 FILTER html %]</a>
+        </td>
+      </tr>
+    [% END %]
+    </table>
+  [% END %]
+  
+  [% IF by_severity.size %]
+    <h3>Severity</h3>
+    <table border="0" cellpadding="0" cellspacing="0" class="figures">
+    [% FOREACH col = by_severity %]
+      <tr>
+        <td>
+          <a class="boogle_edit" 
+             href="javascript:addText('severity:[% col.0 FILTER js %]')">
+            [%- col.0 FILTER html %]</a>
+        </td>
+        <td align="right">
+          <a href="[% buglink FILTER html %]&amp;bug_severity=
+                   [%- col.0 FILTER url_quote %]">[% col.1 FILTER html %]</a>
+        </td>
+      </tr>
+    [% END %]
+    </table>
+  [% END %]
+  
+  <h3>Useful links</h3>
+  <ul>
+    <li>
+      <a href="http://www.gnome.org/start/unstable">Development schedule</a>
+    </li>
+    <li>
+      <a href="http://live.gnome.org/MaintainersCorner">Maintainers corner</a>
+    </li>
+    <li> [% terms.Bugzilla %]
+      <ul>
+        [% IF user.id && user.in_group('editbugs') %]
+          <li>
+            <a href="enter_bug.cgi?product=
+                     [%- product.name FILTER url_quote %]">File a
+              [%= terms.bug %]</a>
+            <!-- (<a href="simple-bug-guide.cgi?product=[% product.name FILTER url_quote %]">simple form</a>) -->
+          </li>
+        [% ELSE %]
+          <li>
+            <!--
+            <a href="simple-bug-guide.cgi?product=
+                     [%- product.name FILTER url_quote %]">File a 
+              [%= terms.bug %]</a> -->
+            <a href="enter_bug.cgi?product=
+                     [%- product.name FILTER url_quote %]">File a 
+              [%= terms.bug %]</a>
+          </li>
+        [% END %]
+        [% IF user.in_group('editcomponents', product.id) %]
+          <li>
+            <a href="editproducts.cgi?action=edit&amp;product=
+                    [%- product.name FILTER url_quote %]">Edit this product</a>
+          </li>
+        [% ELSE %]
+          <li>
+            Show <a href="describecomponents.cgi?product=
+                          [%- product.name FILTER url_quote %]">component
+              descriptions</a>
+          </li>
+        [% END %]
+        <li> <a href="http://live.gnome.org/Bugsquad/TriageGuide/ProductSpecificGuidelines">Triaging guidelines</a></li>
+        <li> <a href="http://live.gnome.org/Bugsquad/ForMaintainers">Contacting bugmasters</a></li>
+      </ul>
+    </li>
+    <li> Product Info
+      <ul>
+        <li><a href="http://git.gnome.org/cgit/
+                     [%- product.name FILTER lower FILTER url_quote %]">GNOME Git</a></li>
+        <li>
+          [% IF product.milestone_url %]
+            <a href="[% product.milestone_url FILTER html %]">
+          [% ELSE %]
+            <a href="http://bugzilla.gnome.org/">
+          [% END %]
+          [% product.name FILTER html %] homepage</a>
+        </li>
+      </ul>
+    </li>
+  </ul>
+</div>
+
+<form action="browse.cgi" method="get">
+<h1>
+Browse:
+  <select name="product">
+    [% FOREACH c = classifications %]
+      <optgroup label="[% c.name FILTER html %]">
+        [% FOREACH p = c.products %]
+          <option value="[% p.name FILTER html %]" 
+            [% IF p.name == product.name && seen != 1 %]selected="selected"[% seen = 1 %]
+            [% END %]>
+          [% p.name FILTER html %]</option>
+      [% END %]</optgroup>
+    [% END %]
+  </select>
+  <input type="submit" value="Show product">
+</h1>
+</form>
+
+<p><i>[% product.description FILTER none %]</i></p>
+
+[% PROCESS gnomeblocker list = blockers_development  
+                        target = target_development %]
+[% PROCESS gnomeblocker list = blockers_stable
+                        target = target_stable %]
+
+<form class="boogleform" id="boogle_search" action="buglist.cgi" 
+      method="get">
+<div>
+  <p>Search for [% terms.bugs %] in [% product.name FILTER html %]: <br />
+  <input id="boogle_search_box" name="quicksearch" type="text" 
+         value="product:&quot;[% product.name.replace('\\[', '\[').replace('\\]', '\]').replace(':','\:') FILTER none %]&quot; "
+         size="50">
+  <input id="show" type="submit" value="Show">
+  <a href="page.cgi?id=quicksearch.html">[Help]</a>
+  </p>
+</div>
+</form>
+
+<script  type="text/javascript">
+<!--
+  var search_box = document.getElementById('boogle_search_box');
+  search_box.focus();
+  setCaretToEnd(search_box);
+-->
+</script>
+
+<table cellpadding="3" cellspacing="0">
+<tr>
+  <th>Components</th>
+  <td>&nbsp;</td>
+  <th>Versions</th>
+</tr>
+<tr>
+  <td valign="top">
+
+  <table border="0" cellpadding="0" cellspacing="0" class="figures">
+  [% FOREACH col = by_component %]
+    <tr>
+      <td>
+        <a class="boogle_edit" href="javascript:addText('component:[% col.0 FILTER js %]')">[% col.0 FILTER html %]</a>
+      </td>
+      <td align="right">
+        <a href="[% buglink FILTER html %]&amp;component=[% col.0 FILTER url_quote %]">[% col.1 FILTER html %]</a>
+      </td>
+    </tr>
+  [% END %]
+  </table>
+
+  </td>
+  <td>&nbsp;</td>
+  <td valign="top">
+
+  <table border="0" cellpadding="0" cellspacing="0" class="figures">
+  [% FOREACH col = by_version %]
+    <tr>
+      <td>
+        <a class="boogle_edit" href="javascript:addText('version:[% col.0 FILTER js %]')">[% col.0 FILTER html %]</a>
+      </td>
+      <td align="right">
+        <a href="[% buglink FILTER html %]&amp;version=[% col.0 FILTER url_quote %]">[% col.1 FILTER html %]</a>
+      </td>
+    </tr>
+  [% END %]
+  </table>
+
+  </td>
+</tr>
+</table>
+
+<table cellpadding="3" cellspacing="0">
+<tr>
+  <th>Milestones</th>
+  <td>&nbsp;</td>
+  <th>NEEDINFO by last changed</th>
+</tr>
+<tr>
+  <td valign="top">
+
+  <table border="0" cellpadding="0" cellspacing="0" class="figures">
+  [% FOREACH col = by_target %]
+    <tr>
+      <td>
+        <a class="boogle_edit" href="javascript:addText('target:[% col.0 FILTER js %]')">[% col.0 FILTER html %]</a>
+      </td>
+      <td align="right">
+        <a href="[% buglink FILTER html %]&amp;target_milestone=[% col.0 FILTER url_quote %]">[% col.1 FILTER html %]</a>
+      </td>
+    </tr>
+  [% END %]
+  </table>
+
+  </td>
+  <td>&nbsp;</td>
+  <td valign="top">
+
+  <table border="0" cellpadding="0" cellspacing="0" class="figures">
+  <tr>
+    <td>&gt;= 1 year</a></td>
+    <td align="right"><a href="buglist.cgi?product=[% product.name FILTER url_quote %]&amp;bug_status=NEEDINFO&amp;chfieldfrom=&amp;chfieldto=-1y">
+    [% needinfo_split.F FILTER html %]</a></td>
+  </tr><tr>
+    <td>6 months - 1 year</a></td>
+    <td align="right"><a href="buglist.cgi?product=[% product.name FILTER url_quote %]&amp;bug_status=NEEDINFO&amp;chfieldfrom=-1y&amp;chfieldto=-6m">
+    [% needinfo_split.E FILTER html %]</a></td>
+  </tr><tr>
+    <td>3 months - 6 months</a></td>
+    <td align="right"><a href="buglist.cgi?product=[% product.name FILTER url_quote %]&amp;bug_status=NEEDINFO&amp;chfieldfrom=-6m&amp;chfieldto=-3m">
+    [% needinfo_split.D FILTER html %]</a></td>
+  </tr><tr>
+    <td>4 weeks - 3 months</a></td>
+    <td align="right"><a href="buglist.cgi?product=[% product.name FILTER url_quote %]&amp;bug_status=NEEDINFO&amp;chfieldfrom=-3m&amp;chfieldto=-4w">
+    [% needinfo_split.C FILTER html %]</a></td>
+  </tr><tr>
+    <td>2 weeks - 4 weeks</a></td>
+    <td align="right"><a href="buglist.cgi?product=[% product.name FILTER url_quote %]&amp;bug_status=NEEDINFO&amp;chfieldfrom=-4w&amp;chfieldto=-2w">
+    [% needinfo_split.B FILTER html %]</a></td>
+  </tr><tr>
+    <td>&lt; 2 weeks ago</a></td>
+    <td align="right"><a href="buglist.cgi?product=[% product.name FILTER url_quote %]&amp;bug_status=NEEDINFO&amp;chfieldfrom=-2w&amp;chfieldto=">
+    [% needinfo_split.A FILTER html %]</a></td>
+  </tr>
+  </table>
+</table>
+
+<form class="fixedquery" name="fixedquery" action="buglist.cgi" method="get">
+<div>
+  <p>Find all [% terms.bugs %] marked as fixed since
+  <input name="product" type="hidden" value="[% product.name FILTER html %]">
+  <input name="bug_status" type="hidden" value="RESOLVED">
+  <input name="bug_status" type="hidden" value="VERIFIED">
+  <input name="resolution" type="hidden" value="FIXED">
+  <input name="chfield" type="hidden" value="resolution">
+  <input name="chfieldvalue" type="hidden" value="FIXED">
+  <input name="chfieldfrom" type="text" size="8">  (YYYY-MM-DD)
+  <input id="show" type="submit" value="Show">
+  </p>
+</div>
+</form>
+
+<h3>Developers</h3>
+[% IF product.developers.size > 0 %]
+  <table cellpadding="3" cellspacing="0">
+  [% FOREACH developer = product.developers.sort('name') %]
+    <tr>
+      <td>
+        [% IF user.id %]
+          [%# XXX - describeuser.cgi will come eventually so commenting out for now %]
+          <!-- <a href="describeuser.cgi?login=[% developer.login FILTER url_quote %]"> -->
+        [% END %]
+        [% PROCESS "global/user.html.tmpl" who = developer %]
+        [% IF user.id %]
+          <!-- </a> -->
+        [% END %]
+      </td>
+    </tr>
+  [% END %]
+  </table>
+[% ELSE %]
+  No users are marked as being developers of this project; please contact the bugmasters and let us know who to mark as such 
+  (see also <a href="http://mail.gnome.org/archives/desktop-devel-list/2005-December/msg00149.html">this d-d-l email</a>).
+[% END %]
+
+[% BLOCK gnomeblocker %]
+  [% IF list.size %]
+    <table border="0" class="gnomeblocker" cellpadding="0" cellspacing="0">
+      <thead>
+      <tr>
+        <td colspan="5">Blocker [% terms.bugs %]: 
+          <b> <!-- <a class="boogle_edit"
+          href="javascript:addText('gnome-target:&quot;
+               [%- target FILTER js %]&quot;')"> -->
+            GNOME [% target FILTER html %] <!-- </a> --></b>
+          (these must be fixed before/in the specified GNOME version)
+        </td>
+      </tr>
+      </thead>
+      [% FOREACH bug = list %]
+        <tr class="[%+ IF loop.count() % 2 == 0 %]bz_row_even[% ELSE %]bz_row_odd[% END %]">
+          <td align="center">
+            <a href="show_bug.cgi?id=[% bug.bug_id FILTER url_quote %]">[% bug.bug_id FILTER html %]</a>
+          </td>
+          <td>
+            <a href="[% buglink FILTER html %]&amp;gnome_target=[% target FILTER url_quote %]">[% bug.product FILTER html %]</a>
+          </td>
+          <td align="center">[% bug.bug_status.truncate(4) FILTER html %]</td>
+          <td align="center">[% bug.bug_severity.truncate(3) FILTER html %]</td>
+          <td>
+            <a href="show_bug.cgi?id=[% bug.bug_id FILTER url_quote %]">[% bug.short_desc.truncate(70, '...') FILTER html %]</a>
+          </td>
+        </tr>
+      [% END %]
+    </table>
+  [% END %]
+[% END %]
+
+[% PROCESS global/footer.html.tmpl %]
diff --git a/template/en/default/bug/comments.html.tmpl b/template/en/default/bug/comments.html.tmpl
index 3166e13..7eb9477 100644
--- a/template/en/default/bug/comments.html.tmpl
+++ b/template/en/default/bug/comments.html.tmpl
@@ -104,7 +104,6 @@
     [% sort_order = "oldest_to_newest" %]
 [% END %]
 
-
 [%# Set up the variables as needed, depending on the sort order %]
 [% IF sort_order == "oldest_to_newest" %]
     [% count = 0 %]
@@ -124,7 +123,6 @@
# SECTION: REQ_50_FLOAT_RIGHT_INFO_BOX
 [% IF mode == "edit" %]
   <a href="#" onclick="toggle_all_comments('collapse'); return false;">Collapse All Comments</a> -
   <a href="#" onclick="toggle_all_comments('expand'); return false;">Expand All Comments</a>
-  <hr>
 [% END %]
 
 [% FOREACH comment = comments %]
@@ -189,6 +187,14 @@
# SECTION: REQ_24_USER_IS_REPORTER
 
         <span class="bz_comment_user">
           [% INCLUDE global/user.html.tmpl who = comment.author %]
+          [% IF comment.author.id == bug.reporter.id %]
+            <span class="comment_reporter_tag">[reporter]</span>
+          [% END %]
# SECTION: REQ_23_NOTE_DEVELOPER
+          [% IF comment.author.is_developer %]
+            <span class="comment_developer_tag">
+              [[% IF comment.author.is_developer(bug.product_obj) %][% bug.product FILTER html %]&nbsp;[% END %]developer]
+            </span>
+          [% END %]
         </span>
 
         <span class="bz_comment_user_images">
@@ -222,7 +228,7 @@
# SECTION: BUG_FORMAT_COMMENT_HOOK
 [% END %]
 <pre class="bz_comment_text" 
      [% ' id="comment_text_' _ count _ '"' IF mode == "edit" %]>
-  [%- wrapped_comment FILTER quoteUrls(bug.bug_id) -%]
+  [%- wrapped_comment FILTER quoteUrls(bug, comment) -%]
 </pre>
     </div>
   [% END %]
diff --git a/template/en/default/bug/create/create-guided.html.tmpl b/template/en/default/bug/create/create-guided.html.tmpl
index 9f2a21b..e316a8e 100644
--- a/template/en/default/bug/create/create-guided.html.tmpl
+++ b/template/en/default/bug/create/create-guided.html.tmpl
@@ -213,19 +213,6 @@ function PutDescription() {
# SECTION: REQ_47_REMOVE_REP_PLATFORM
     </td>
   </tr>
 
-  [%# We override rep_platform and op_sys for simplicity. The values chosen
-      are based on which are most common in the b.m.o database %]
-  [% rep_platform = [ "PC", "Macintosh", "All", "Other" ] %]
-
-  <tr bgcolor="[% tablecolour %]">
-    <td align="right" valign="top">
-      <b>Hardware Platform</b>
-    </td>
-    <td valign="top">
-      [% PROCESS select sel = 'rep_platform' %]
-    </td>
-  </tr>
-
   [% op_sys = [ "Windows 2000", "Windows XP", "Windows Vista", "Windows 7",
                 "Mac OS X", "Linux", "All", "Other" ] %]
 
@@ -265,21 +252,6 @@ function PutDescription() {
# SECTION: REQ_46_REMOVE_BUG_FILE_LOC
     </td>
   </tr>
 
-  <tr>
-    <td align="right" valign="top">
-      <b>URL</b>
-    </td>
-    <td valign="top">
-      <input type="text" size="80" name="bug_file_loc" value="http://">
-      <p>
-        URL that demonstrates the problem you are seeing (optional).<br>
-        <b>IMPORTANT</b>: if the problem is with a broken web page, you need
-        to report it
-        <a href="https://bugzilla.mozilla.org/page.cgi?id=broken-website.html">a different way</a>.
-      </p>
-   </td>
-  </tr>
-
   <tr bgcolor="[% tablecolour %]">
     <td align="right" valign="top">
       <b>Summary</b>
diff --git a/template/en/default/bug/create/create.html.tmpl b/template/en/default/bug/create/create.html.tmpl
index 2cee5c9..9ff979b 100644
--- a/template/en/default/bug/create/create.html.tmpl
+++ b/template/en/default/bug/create/create.html.tmpl
@@ -82,10 +82,10 @@ function set_assign_to() {
# SECTION: FIX_DESCRIPTION_UPDATING
     // with the default component owner, and the "QA Contact:" field
     // with the default QA Contact. It also selectively enables flags.
     var form = document.Create;
-    var assigned_to = form.assigned_to.value;
+//    var assigned_to = form.assigned_to.value;
 
 [% IF Param("useqacontact") %]
-    var qa_contact = form.qa_contact.value;
+//    var qa_contact = form.qa_contact.value;
 [% END %]
 
     var index = -1;
@@ -96,26 +96,27 @@ function set_assign_to() {
# SECTION: FIX_DESCRIPTION_UPDATING
         index = 0;
     }
     if (index != -1) {
-        var owner = initialowners[index];
+//        var owner = initialowners[index];
         var component = components[index];
-        if (assigned_to == last_initialowner
+/*        if (assigned_to == last_initialowner
             || assigned_to == owner
             || assigned_to == '') {
             form.assigned_to.value = owner;
             last_initialowner = owner;
         }
-
+*/
         document.getElementById('initial_cc').innerHTML = initialccs[index];
         document.getElementById('comp_desc').innerHTML = comp_desc[index];
 
         [% IF Param("useqacontact") %]
-            var contact = initialqacontacts[index];
+/*            var contact = initialqacontacts[index];
             if (qa_contact == last_initialqacontact
                 || qa_contact == contact
                 || qa_contact == '') {
                   form.qa_contact.value = contact;
                   last_initialqacontact = contact;
             }
+*/
         [% END %]
 
         // First, we disable all flags. Then we re-enable those
@@ -275,12 +276,6 @@ TUI_hide_default('expert_fields');
# SECTION: REQ_47_REMOVE_REP_PLATFORM
   </tr>
 
   <tr>
-    [% INCLUDE bug/field.html.tmpl
-      bug = default, field = select_fields.rep_platform, editable = 1,
-      value = default.rep_platform %]
-  </tr>
-
-  <tr>
     [% INCLUDE bug/field.html.tmpl 
        bug = default, field = select_fields.op_sys, editable = 1, 
        value = default.op_sys %]
@@ -306,19 +301,13 @@ TUI_hide_default('expert_fields');
# SECTION: REQ_47_REMOVE_REP_PLATFORM
   </tr>
 </tbody>
 
-[% IF !Param('defaultplatform') || !Param('defaultopsys') %]
+[% IF !Param('defaultopsys') %]
   <tbody>
     <tr>
       <th>&nbsp;</th>
       <td colspan="3" class="comment">
         We've made a guess at your
-        [% IF Param('defaultplatform') %]
           operating system. Please check it
-        [% ELSIF Param('defaultopsys') %]
-          platform. Please check it
-        [% ELSE %]
-          operating system and platform. Please check them
-        [% END %]
         and make any corrections if necessary.
       </td>
     </tr>
@@ -331,21 +320,12 @@ TUI_hide_default('expert_fields');
# SECTION: REQ_48_REARRANGE_ENTER_BUG_CGI
   </tr>
 
   <tr>
-[% IF bug_status.size <= 1 %]
-  <input type="hidden" name="bug_status" 
-         value="[% default.bug_status FILTER html %]">
-    <th>Initial State:</th>
-    <td>[% get_status(default.bug_status) FILTER html %]</td>
-[% ELSE %]
-    [% sel = { description => 'Initial State', name => 'bug_status' } %]
-    [% INCLUDE select %]
-[% END %]
-
+    <td>&nbsp;</td>
+    <td>&nbsp;</td>
     <td>&nbsp;</td>
     [%# Calculate the number of rows we can use for flags %]
-    [% num_rows = 6 + (Param("useqacontact") ? 1 : 0) +
-                      (user.in_group(Param('timetrackinggroup')) ? 3 : 0) +
-                      (Param("usebugaliases") ? 1 : 0)
+    [% num_rows = (user.in_group(Param('timetrackinggroup')) ? 3 : 0) +
+                  (Param("usebugaliases") ? 1 : 0)
     %]
 
     <td rowspan="[% num_rows FILTER html %]">
@@ -369,67 +349,6 @@ TUI_hide_default('expert_fields');
# SECTION: REQ_48_REARRANGE_ENTER_BUG_CGI
     </td>
   </tr>
 
-  <tr>
-    <th><a href="page.cgi?id=fields.html#assigned_to">Assign To</a>:</th>
-    <td colspan="2">
-      [% INCLUDE global/userselect.html.tmpl
-         name => "assigned_to"
-         value => assigned_to
-         disabled => assigned_to_disabled
-         size => 30
-         emptyok => 1
-         custom_userlist => assignees_list
-       %]
-      <noscript>(Leave blank to assign to component's default assignee)</noscript>
-    </td>
-  </tr>
-  
-[% IF Param("useqacontact") %]
-    <tr>
-      <th>QA Contact:</th>
-      <td colspan="2">
-      [% INCLUDE global/userselect.html.tmpl
-         name => "qa_contact"
-         value => qa_contact
-         disabled => qa_contact_disabled
-         size => 30
-         emptyok => 1
-         custom_userlist => qa_contacts_list
-       %]
-        <noscript>(Leave blank to assign to default qa contact)</noscript>
-      </td>
-    </tr>
-[% END %]
-
-  <tr>
-    <th>CC:</th>
-    <td colspan="2">
-      [% INCLUDE global/userselect.html.tmpl
-         name => "cc"
-         value => cc
-         disabled => cc_disabled
-         size => 30
-         multiple => 5
-       %]
-    </td>
-  </tr>
-
-  <tr>
-    <th>Default CC:</th>
-    <td colspan="2">
-      <div id="initial_cc">
-          <!-- This has to happen after everything above renders,
-               and onload doesn't work. So this is as good a place
-               as any to put it. -->
-          <script type="text/javascript">set_assign_to();</script>
-      </div>
-   </td>
-  </tr>
-  
-  <tr>
-    <td colspan="3">&nbsp;</td>
-  </tr>
-
 [% IF user.in_group(Param('timetrackinggroup')) %]
   <tr>
     <th>Estimated Hours:</th>
@@ -444,10 +363,6 @@ TUI_hide_default('expert_fields');
# SECTION: REQ_48_REARRANGE_ENTER_BUG_CGI
       <small>(YYYY-MM-DD)</small>
     </td>
   </tr>
-
-  <tr>
-    <td colspan="3">&nbsp;</td>
-  </tr>
 [% END %]
 
 [% IF Param("usebugaliases") %]
@@ -459,13 +374,6 @@ TUI_hide_default('expert_fields');
# SECTION: REQ_46_REMOVE_BUG_FILE_LOC
   </tr>
 [% END %]
 
-  <tr>
-    <th>URL:</th>
-    <td colspan="2">
-      <input name="bug_file_loc" size="40"
-             value="[% bug_file_loc FILTER html %]">
-    </td>
-  </tr>
 </tbody>
 
 <tbody class="expert_fields">
@@ -568,17 +476,17 @@ TUI_hide_default('expert_fields');
# SECTION: REQ_63_KEYWORDS_FIELD_FOR_ANYBODY
 </tbody>
 
 <tbody class="expert_fields">
-  [% IF user.in_group('editbugs', product.id) %]
     [% IF use_keywords %]
       <tr>
         <th><a href="describekeywords.cgi">Keywords</a>:</th>
         <td colspan="3">
           <input id="keywords" name="keywords" size="40"
# SECTION: REQ_48_REARRANGE_ENTER_BUG_CGI
-                 value="[% keywords FILTER html %]"> (optional)
+                 value="[% keywords FILTER html %]"> 
# SECTION: REQ_63_KEYWORDS_FIELD_FOR_ANYBODY
         </td>
       </tr>
     [% END %]
 
+  [% IF user.in_group('editbugs', product.id) %]
     <tr>
       <th>Depends on:</th>
       <td colspan="3">
@@ -592,6 +500,31 @@ TUI_hide_default('expert_fields');
# SECTION: REQ_48_REARRANGE_ENTER_BUG_CGI
       </td>
     </tr>
   [% END %]
+
+  <tr>
+    <th>CC:</th>
+    <td colspan="2">
+      [% INCLUDE global/userselect.html.tmpl
+         name => "cc"
+         value => cc
+         disabled => cc_disabled
+         size => 30
+         multiple => 5
+       %]
+    </td>
+  </tr>
+
+  <tr>
+    <th>Default CC:</th>
+    <td colspan="2">
+      <div id="initial_cc">
+          <!-- This has to happen after everything above renders,
+               and onload doesn't work. So this is as good a place
+               as any to put it. -->
+          <script type="text/javascript">set_assign_to();</script>
+      </div>
+   </td>
+  </tr>
 </tbody>
 
 <tbody class="expert_fields">
diff --git a/template/en/default/bug/create/user-message.html.tmpl b/template/en/default/bug/create/user-message.html.tmpl
index ac2cc29..ec7bd81 100644
--- a/template/en/default/bug/create/user-message.html.tmpl
+++ b/template/en/default/bug/create/user-message.html.tmpl
@@ -33,4 +33,6 @@ Before reporting [% terms.abug %], please read the
# SECTION: REQ_4_BROWSE_CGI
 <a href="page.cgi?id=bug-writing.html">
 [% terms.bug %] writing guidelines</a>, please look at the list of
 <a href="duplicates.cgi">most frequently reported [% terms.bugs %]</a>, and please
-<a href="query.cgi">search</a> for the [% terms.bug %].
+<a href="query.cgi">search</a> or 
+<a href="browse.cgi?product=[% product.name FILTER url_quote %]">browse</a>
+for the [% terms.bug %].
diff --git a/template/en/default/bug/edit.html.tmpl b/template/en/default/bug/edit.html.tmpl
index 0e1c4da..847c7a9 100644
--- a/template/en/default/bug/edit.html.tmpl
+++ b/template/en/default/bug/edit.html.tmpl
@@ -147,94 +147,63 @@
# SECTION: REQ_50_FLOAT_RIGHT_INFO_BOX
   <input type="hidden" name="token" value="[% issue_hash_token([bug.id, bug.delta_ts]) FILTER html %]">
 
   [% PROCESS section_title %]
-  <table class="edit_form">
-    <tr>
-      [%# 1st Column %]
-      <td id="bz_show_bug_column_1" class="bz_show_bug_column">     
-        <table>
-          [%# *** ID, product, component, status, resolution, Hardware, and  OS *** %]
-          [% PROCESS section_status %]
-          
-          [% PROCESS section_spacer %]
-          
-          [% PROCESS section_details1 %]
-          
-          [% PROCESS section_spacer %]
-          
-          [%# *** severity, priority, version and milestone *** %]
-          [% PROCESS section_details2 %]            
-          
-          [%# *** assigned to and qa contact *** %]
-          [% PROCESS section_people %]
-          
-          [% PROCESS section_spacer %]
-          
-          [% PROCESS section_url_keyword_whiteboard %]
-          
-          [% PROCESS section_spacer %]
-          
-          [%# *** Dependencies *** %]
-          [% PROCESS section_dependson_blocks %]
-          
-        </table>
-      </td>
-      <td>
-        <div class="bz_column_spacer">&nbsp;</div>
-      </td>
-      [%# 2nd Column %]
-      <td id="bz_show_bug_column_2" class="bz_show_bug_column">
-        <table cellpadding="3" cellspacing="1">
-        [%# *** Reported and modified dates *** %]
-         [% PROCESS section_dates %]
-         
-         [% PROCESS section_cclist %]
-         
-         [% PROCESS section_spacer %]
 
-         [% PROCESS section_see_also %] 
-         
-         [% PROCESS section_customfields %]
-         
-         [% PROCESS section_spacer %]
-         
-         [% Hook.process("after_custom_fields") %]
-                
-         [% PROCESS section_flags %]
+  [%# *** Bug Summary *** %]
 
-        </table>
+  <div id="bug_summary">
+    <table cellpadding="0" cellspacing="0" border="0">
+    <tr>
+      <td><b>Product:</b></td>
+      <td>
+        <a href="browse.cgi?product=[% bug.product FILTER url_quote %]">
+        [% bug.product FILTER html %]</a>
       </td>
     </tr>
     <tr>
-      <td colspan="3">
-          <hr id="bz_top_half_spacer">
-      </td>
+      <td><b>Component:</b></td>
+      <td>[% bug.component FILTER html %]</td>
     </tr>
-  </table>
-
-  
-  [% PROCESS section_restrict_visibility %]
-  [% IF user.in_group(Param('timetrackinggroup')) %]
-    <br>
-    [% PROCESS section_timetracking %]
-  [% END %]
-  
-
-[%# *** Attachments *** %]
-
-  [% PROCESS attachment/list.html.tmpl
-             attachments = bug.attachments
-             bugid       = bug.bug_id
-             num_attachment_flag_types = bug.num_attachment_flag_types
-             show_attachment_flags = bug.show_attachment_flags
-   %]
-
+    <tr>
+      <td><b>Version:</b></td>
+      <td>[% bug.version FILTER html %]</td>
+    </tr>
+    <tr>
+      <td><b>Status:</b></td>
+      <td>[% bug.bug_status FILTER html %]</td>
+    </tr>
# SECTION: ADD_RESOLUTION_BACK
+    [% IF bug.resolution %]
+      <tr>
+        <td><b>Resolution:</b></td>
+        <td>[% bug.resolution FILTER html %]
+          [%~ IF bug.dup_id %]
+            of [% bug.dup_id FILTER bug_link(bug.dup_id) %]
+          [% END %]
+      </tr>
+    [% END %]
# SECTION: REQ_50_FLOAT_RIGHT_INFO_BOX
+    <tr>
+      <td><b>Priority:</b></td>
+      <td>[% bug.priority FILTER html %]</td>
+    </tr>
+    <tr>
+      <td><b>Severity:</b></td>
+      <td>[% bug.bug_severity FILTER html %]</td>
+    </tr>
+    </table>
+  </div>
 
-[%# *** Comments Groups *** %]
+  [%# *** Comments *** %]
 
-  <br>
   <table cellpadding="1" cellspacing="1">
     <tr>
       <td id="comment_status_commit">
+        [%# *** Additional Comments *** %]
+        <div id="comments">
+        [% PROCESS bug/comments.html.tmpl
+           comments = bug.longdescs
+           mode = user.id ? "edit" : "show"
+         %]
+        </div>
+
         <!-- The table keeps the commit button aligned with the box. -->
         <a name="add_comment"></a>
         [% IF user.id %]
@@ -279,18 +248,89 @@
# SECTION: REQ_50_FLOAT_RIGHT_INFO_BOX
             </p>
           </fieldset>
         [% END %]
-        [%# *** Additional Comments *** %]
-        <hr>
-        <div id="comments">
-        [% PROCESS bug/comments.html.tmpl
-           comments = bug.longdescs
-           mode = user.id ? "edit" : "show"
-         %]
-        </div>
-        
       </td>
     </tr>
   </table>
+
+  [% PROCESS section_restrict_visibility %]
+  [% IF user.in_group(Param('timetrackinggroup')) %]
+    <br>
+    [% PROCESS section_timetracking %]
+  [% END %]
+
+  [%# *** Attachments *** %]
+
+  [% PROCESS attachment/list.html.tmpl
+             attachments = bug.attachments
+             bugid       = bug.bug_id
+             num_attachment_flag_types = bug.num_attachment_flag_types
+             show_attachment_flags = bug.show_attachment_flags
# SECTION: REQ_3_ATTACHMENT_STATUS
+             show_attachment_status = bug.show_attachment_status
# SECTION: REQ_50_FLOAT_RIGHT_INFO_BOX
+   %]
+
+  <table class="edit_form">
+    <tr>
+      <td colspan="3">
+          <hr id="bz_top_half_spacer">
+      </td>
+    </tr>
+    <tr>
+      [%# 1st Column %]
+      <td id="bz_show_bug_column_1" class="bz_show_bug_column">     
+        <table>
+          [%# *** ID, product, component, status, resolution, Hardware, and  OS *** %]
+          [% PROCESS section_status %]
+          
+          [% PROCESS section_spacer %]
+          
+          [% PROCESS section_details1 %]
+          
+          [% PROCESS section_spacer %]
+          
+          [%# *** severity, priority, version and milestone *** %]
+          [% PROCESS section_details2 %]            
+          
+          [%# *** assigned to and qa contact *** %]
+          [% PROCESS section_people %]
+          
+          [% PROCESS section_spacer %]
+          
+          [% PROCESS section_url_keyword_whiteboard %]
+          
+          [% PROCESS section_spacer %]
+          
+          [%# *** Dependencies *** %]
+          [% PROCESS section_dependson_blocks %]
+          
+        </table>
+      </td>
+      <td>
+        <div class="bz_column_spacer">&nbsp;</div>
+      </td>
+      [%# 2nd Column %]
+      <td id="bz_show_bug_column_2" class="bz_show_bug_column">
+        <table cellpadding="3" cellspacing="1">
+        [%# *** Reported and modified dates *** %]
+         [% PROCESS section_dates %]
+         
+         [% PROCESS section_cclist %]
+         
+         [% PROCESS section_spacer %]
+
+         [% PROCESS section_see_also %] 
+         
+         [% PROCESS section_customfields %]
+         
+         [% PROCESS section_spacer %]
+         
+         [% Hook.process("after_custom_fields") %]
+                
+         [% PROCESS section_flags %]
+
+        </table>
+      </td>
+    </tr>
+  </table>  
 </form>
 
 [%############################################################################%]
@@ -410,14 +450,10 @@
# SECTION: REQ_47_REMOVE_REP_PLATFORM
     [%############%]    
     <tr>
       <td class="field_label">
-        <label for="rep_platform" accesskey="h"><b>Platform</b></label>:
+        <label for="op_sys" accesskey="h"><b>OS</b></label>:
       </td>
       <td class="field_value">
-       [% INCLUDE bug/field.html.tmpl
-            bug = bug, field = select_fields.rep_platform,
-            no_tds = 1, value = bug.rep_platform
-            editable = bug.check_can_change_field('rep_platform', 0, 1) %]
-       [%+ INCLUDE bug/field.html.tmpl 
+       [% INCLUDE bug/field.html.tmpl 
             bug = bug, field = select_fields.op_sys, 
             no_tds = 1, value = bug.op_sys
             editable = bug.check_can_change_field('op_sys', 0, 1) %]
@@ -449,7 +485,7 @@
# SECTION: REQ_53_REPORTER_CANNOT_UNWONTFIX
             of [% "${terms.bug} ${bug.dup_id}" FILTER bug_link(bug.dup_id) FILTER none %]
           [% END %]
         [% END %]
-        [% IF bug.user.canedit || bug.user.isreporter %]
+        [% IF bug.user.canedit || (bug.user.isreporter && bug.resolution != 'WONTFIX') %]
           (<a href="#add_comment" 
               onclick="window.setTimeout(function() { document.getElementById('bug_status').focus(); }, 10)">edit</a>)
         [% END %]
@@ -504,10 +540,8 @@
# SECTION: REQ_34_MILESTONE_URL_TO_HOME_PAGE
       <tr>
         <td class="field_label">
           <label for="target_milestone"><b>
-            [% IF bug.milestoneurl %]
-              <a href="[% bug.milestoneurl FILTER html %]">
-            [% END %]
-            Target&nbsp;Milestone[% "</a>" IF bug.milestoneurl %]
+            <a href="page.cgi?id=fields.html#target_milestone">
+            Target&nbsp;Milestone</a>
           [%%]</b></label>:
         </td>
         [% PROCESS select selname = "target_milestone" %]
@@ -609,50 +643,8 @@
# SECTION: REQ_46_REMOVE_BUG_FILE_LOC
 [%# Block for URL Keyword and Whiteboard                                     #%]
 [%############################################################################%]
 [% BLOCK section_url_keyword_whiteboard %]
-[%# *** URL Whiteboard Keywords *** %]
-  <tr>
-    <td class="field_label">
-      <label for="bug_file_loc" accesskey="u"><b>
-        [% IF is_safe_url(bug.bug_file_loc) %]
-          <a href="[% bug.bug_file_loc FILTER html %]"><u>U</u>RL</a>
-        [% ELSE %]
-          <u>U</u>RL
-        [% END %]
-      [%%]</b></label>:
-    </td>
-    <td>
-      [% IF bug.check_can_change_field("bug_file_loc", 0, 1) %]
-        <span id="bz_url_edit_container" class="bz_default_hidden"> 
-        [% IF is_safe_url(bug.bug_file_loc) %]
-           <a href="[% bug.bug_file_loc FILTER html %]" target="_blank"
-              title="[% bug.bug_file_loc FILTER html %]">
-             [% bug.bug_file_loc FILTER truncate(40) FILTER html %]</a>
-        [% ELSE %]
-          [% bug.bug_file_loc FILTER html %]
-        [% END %]
-        (<a href="#" id="bz_url_edit_action">edit</a>)</span>
-      [% END %]
-      <span id="bz_url_input_area">
-        [% url_output =  PROCESS input no_td=1 inputname => "bug_file_loc" size => "40" colspan => 2 %]
-        [% IF NOT bug.check_can_change_field("bug_file_loc", 0, 1)
-              AND is_safe_url(bug.bug_file_loc)  %]
-          <a href="[% bug.bug_file_loc FILTER html %]">[% url_output FILTER none %]</a>
-        [% ELSE %]
-          [% url_output FILTER none %]
-        [% END %]
-      </span>
-      [% IF bug.check_can_change_field("bug_file_loc", 0, 1) %]
-        <script type="text/javascript">
-          hideEditableField('bz_url_edit_container', 
-                            'bz_url_input_area', 
-                            'bz_url_edit_action', 
-                            'bug_file_loc', 
-                            "[% bug.bug_file_loc FILTER js %]");
-        </script>
-      [% END %]
-    </td>
-  </tr>
-  
+[%# URL field disabled %]
+[%# *** Whiteboard Keywords *** %]
   [% IF Param('usestatuswhiteboard') %]
     <tr>
       <td class="field_label">
@@ -957,6 +949,11 @@
# SECTION: REQ_50_FLOAT_RIGHT_INFO_BOX
       </td>
     </tr>
   [% END %]
+
+  <tr class="bottom_commit_container">
+    <td>&nbsp;</td>
+    <td>[% PROCESS commit_button id = "_gnome_form" %]</td>
+  </tr>
 [% END %]
 
 [%############################################################################%]
diff --git a/template/en/default/bug/field-events.js.tmpl b/template/en/default/bug/field-events.js.tmpl
index 06fba12..af1305b 100644
--- a/template/en/default/bug/field-events.js.tmpl
+++ b/template/en/default/bug/field-events.js.tmpl
@@ -26,6 +26,21 @@
# SECTION: REQ_19_B_DISPLAY_STUFF_FOR_GNOME_ONLY
                 '[% field.name FILTER js %]',
                 '[% controlled_field.visibility_value.name FILTER js %]');
 [% END %]
+[%# These gnome fields depend on the classification, which for these
+  # purposes means the product.
+  # The fields should be visible whenever the product's classification
+  # has the 'is_gnome' flag set.
+  #%]
+[% IF field.name == 'product' %]
+  [% FOREACH controlled_field = [ 'cf_gnome_target', 'cf_gnome_version' ] %]
+    showFieldWhen('[% controlled_field FILTER js %]', 'product',
+                  new Array(
+                    [% FOREACH p = user.get_selectable_gnome_products %]
+                      '[% p.name FILTER js %]'[% ',' UNLESS loop.last %]
+                    [% END %]
+                  ));
+  [% END %]
+[% END %]
 [% FOREACH legal_value = field.legal_values %]
   [% FOREACH controlled_field = legal_value.controlled_values.keys %]
     [% SET cont_ids = [] %]
diff --git a/template/en/default/bug/field.html.tmpl b/template/en/default/bug/field.html.tmpl
index b406c21..8ea18b9 100644
--- a/template/en/default/bug/field.html.tmpl
+++ b/template/en/default/bug/field.html.tmpl
@@ -47,6 +47,9 @@
# SECTION: REQ_19_B_DISPLAY_STUFF_FOR_GNOME_ONLY
     [% SET hidden = 1 %]
   [% END %]
 [% END %]
+[% IF field.name == 'cf_gnome_target' OR field.name == 'cf_gnome_version' %]
+  [% SET hidden = 1 UNLESS bug.classification_obj.is_gnome %]
+[% END %]
 
 [% IF NOT no_tds %]
   <th class="field_label [% ' bz_hidden_field' IF hidden %]"
diff --git a/template/en/default/bug/knob.html.tmpl b/template/en/default/bug/knob.html.tmpl
index 49eb254..5de49bf 100644
--- a/template/en/default/bug/knob.html.tmpl
+++ b/template/en/default/bug/knob.html.tmpl
@@ -31,12 +31,14 @@
# SECTION: REQ_28_NEEDINFO
   [%# These actions are based on the current custom workflow. %]
   [% FOREACH bug_status = bug.status.can_change_to %]
     [% NEXT IF bug.isunconfirmed && bug_status.is_open && !bug.user.canconfirm %]
-    [% NEXT IF bug.isopened && !bug.isunconfirmed && bug_status.is_open && !bug.user.canedit %]
# SECTION: REQ_53_REPORTER_CANNOT_UNWONTFIX
-    [% NEXT IF (!bug_status.is_open || !bug.isopened) && !bug.user.canedit && !bug.user.isreporter %]
# SECTION: REQ_28_NEEDINFO
+    [% NEXT IF bug_status.name != 'UNCONFIRMED' && bug.isopened && !bug.isunconfirmed && bug_status.is_open && !bug.user.canedit %]
# SECTION: REQ_53_REPORTER_CANNOT_UNWONTFIX
+    [% NEXT IF (!bug_status.is_open || !bug.isopened) && !bug.user.canedit &&
+       !(bug.user.isreporter && bug.resolution != 'WONTFIX') %]
# SECTION: REQ_28_NEEDINFO
     [%# Special hack to only display UNCO or REOP when reopening, but not both;
       # for compatibility with older versions. %]
     [% NEXT IF !bug.isopened && (bug.everconfirmed && bug_status.name == "UNCONFIRMED"
                                  || !bug.everconfirmed && bug_status.name == "REOPENED") %]
+    [% NEXT IF bug.everconfirmed && bug_status.name == "UNCONFIRMED" %]
     [% IF NOT bug_status_select_displayed %]
       <select name="bug_status" id="bug_status">
       [% bug_status_select_displayed = 1 %]
@@ -54,7 +56,7 @@
# SECTION: REQ_53_REPORTER_CANNOT_UNWONTFIX
   [% END %]
 
   [%# These actions are special and are independent of the workflow. %]
-  [% IF bug.user.canedit || bug.user.isreporter %]
+  [% IF bug.user.canedit || (bug.user.isreporter && bug.resolution != 'WONTFIX') %]
     [% IF NOT bug_status_select_displayed %]
       <select name="bug_status" id="bug_status">
       [% bug_status_select_displayed = 1 %] 
@@ -80,7 +82,7 @@
# SECTION: REQ_53_REPORTER_CANNOT_UNWONTFIX
         [% END %]
       [% END %]
   [% END %]
-  [% IF bug.user.canedit || bug.user.isreporter %]  
+  [% IF bug.user.canedit || (bug.user.isreporter && bug.resolution != 'WONTFIX') %]  
     [% IF show_resolution %]
       <noscript><br>resolved&nbsp;as&nbsp;</noscript>
       <span id="resolution_settings">[% PROCESS select_resolution %]</span>
@@ -145,6 +147,8 @@
# SECTION: REQ_64_NO_GNOME_1_X_AND_NOTXIMIAN
   <select name="resolution" id="resolution">
     [% FOREACH r = bug.choices.resolution %]
       [% NEXT IF r == "MOVED" && bug.resolution != "MOVED" %]
+      [% NEXT IF r == "GNOME1.x" && bug.resolution != "GNOME1.x" %]
+      [% NEXT IF r == "NOTXIMIAN" && bug.resolution != "NOTXIMIAN" %]
       <option value="[% r FILTER html %]"
       [% "selected" IF r == bug.resolution %]>
         [% get_resolution(r) FILTER html %]</option>
diff --git a/template/en/default/bug/show-multiple.html.tmpl b/template/en/default/bug/show-multiple.html.tmpl
index a0e01e4..dd88a58 100644
--- a/template/en/default/bug/show-multiple.html.tmpl
+++ b/template/en/default/bug/show-multiple.html.tmpl
@@ -156,23 +156,8 @@
# SECTION: REQ_47_REMOVE_REP_PLATFORM
 
     [% PROCESS row cell = "version" %]
     [% PROCESS row cell = "target_milestone"  IF Param('usetargetmilestone') %]
-    [% PROCESS row cell = "rep_platform" %]
     [% PROCESS row cell = "op_sys"  %]
 
# SECTION: REQ_46_REMOVE_BUG_FILE_LOC
-    [% IF bug.bug_file_loc %]
-      <tr>
-        <th>[% field_descs.bug_file_loc FILTER html %]:</th>
-        <td colspan="3">
-          [% IF is_safe_url(bug.bug_file_loc) %]
-            <a href="[% bug.bug_file_loc FILTER html %]">
-                     [% bug.bug_file_loc FILTER html %]</a>
-          [% ELSE %]
-            [% bug.bug_file_loc FILTER html %]
-          [% END %]
-        </td>
-      </tr>
-    [% END %]
-
     [% IF Param("usestatuswhiteboard") %]
       [% PROCESS row cell = "status_whiteboard" fullrow = 1 %]
     [% END %]
diff --git a/template/en/default/bug/show.xml.tmpl b/template/en/default/bug/show.xml.tmpl
index 858ee1b..b80b3e7 100644
--- a/template/en/default/bug/show.xml.tmpl
+++ b/template/en/default/bug/show.xml.tmpl
@@ -22,7 +22,16 @@
# SECTION: NO_LARGE_DATA_RETRIEVAL_WARNING
 [% PROCESS bug/time.html.tmpl %]
 <?xml version="1.0" [% IF Param('utf8') %]encoding="UTF-8" [% END %]standalone="yes" ?>
 <!DOCTYPE bugzilla SYSTEM "[% urlbase FILTER html %]bugzilla.dtd">
+<!-- 
 
+WARNING:
+
+ Do NOT automatically retrieve large amounts of data from GNOME Bugzilla
+
+ This will likely result in a ban
+ bugmaster@amp;gnome.org
+
+ -->
 <bugzilla version="[% constants.BUGZILLA_VERSION %]"
           urlbase="[% urlbase FILTER xml %]"
           [%# Note that the maintainer's email is not filtered, 
@@ -106,6 +115,7 @@
# SECTION: REQ_3_ATTACHMENT_STATUS
             <type>[% a.contenttype FILTER xml %]</type>
             <size>[% a.datasize FILTER xml %]</size>
             <attacher>[% a.attacher.email FILTER email FILTER xml %]</attacher>
+            <status>[% a.ispatch ? a.status : "" FILTER xml %]</status>
             [%# This is here so automated clients can still use attachment.cgi %]
             [% IF displayfields.token && user.id %]
               <token>[% issue_hash_token([a.id, a.modification_time]) FILTER xml %]</token>
diff --git a/template/en/default/email/newchangedmail.txt.tmpl b/template/en/default/email/newchangedmail.txt.tmpl
index a9779c6..3c983c2 100644
--- a/template/en/default/email/newchangedmail.txt.tmpl
+++ b/template/en/default/email/newchangedmail.txt.tmpl
@@ -19,7 +19,7 @@
# SECTION: SHOW_PRODUCT_NAME_IN_MAIL
   #%]
 
 [% PROCESS "global/variables.none.tmpl" %]
-From: [% Param('mailfrom') %]
+From: "[% product %]" (bugzilla.gnome.org) <[% Param('mailfrom') %]>
 To: [% to %]
 Subject: [[% terms.Bug %] [%+ bugid %]] [% 'New: ' IF isnew %][%+ summary %]
 X-Bugzilla-Reason: [% reasonsheader %]
@@ -41,6 +41,7 @@ X-Bugzilla-Changed-Fields: [% changedfields %]
# SECTION: SHOW_PRODUCT_NAME_IN_MAIL
 [%+ threadingmarker %]
 
 [%+ urlbase %]show_bug.cgi?id=[% bugid %]
+  [%+ product %] | [% comp %] | [% version %]
 [%- IF diffs %]
 
 [%+ diffs %]
@@ -48,7 +49,7 @@ X-Bugzilla-Changed-Fields: [% changedfields %]
 [% FOREACH comment = new_comments %]
 
 [%- IF comment.count %]
---- Comment #[% comment.count %] from [% comment.author.identity %] [%+ comment.time FILTER time(undef, to_user.timezone) %] ---
+--- Comment #[% comment.count %] from [% comment.author.identity FILTER email('force') %] [%+ comment.time FILTER time(undef, to_user.timezone) %] ---
 [% END %]
 [%+ FILTER remove('^X') %][% PROCESS bug/format_comment.txt.tmpl %][% END %]
 [% END %]
diff --git a/template/en/default/global/choose-product.html.tmpl b/template/en/default/global/choose-product.html.tmpl
index 0a38db6..a159a63 100644
--- a/template/en/default/global/choose-product.html.tmpl
+++ b/template/en/default/global/choose-product.html.tmpl
@@ -56,7 +56,7 @@
# SECTION: NO_HYPHEN_ESCAPE
         <a href="[% target %]?product=[% p.name FILTER url_quote -%]
               [%- IF cloned_bug_id %]&amp;cloned_bug_id=[% cloned_bug_id FILTER url_quote %][% END -%] 
               [%- IF format %]&amp;format=[% format FILTER url_quote %][% END %]">
-        [% p.name FILTER html FILTER no_break %]</a>:&nbsp;
+        [% p.name FILTER html %]</a>:&nbsp;
       </th>
 
       <td valign="top">[% p.description FILTER html_light %]</td>
diff --git a/template/en/default/global/code-error.html.tmpl b/template/en/default/global/code-error.html.tmpl
index 47fa706..efb5de6 100644
--- a/template/en/default/global/code-error.html.tmpl
+++ b/template/en/default/global/code-error.html.tmpl
@@ -58,7 +58,8 @@
     [% ELSE %]
       [%+ Param('emailregexpdesc') %]
     [% END %]
-    It also must not contain any illegal characters.
+    It must also not contain any of these special characters:
+    <tt>\ ( ) &amp; &lt; &gt; , ; : &quot; [ ]</tt>, or any whitespace.
 
   [% ELSIF error == "authres_unhandled" %]
     The result value of [% value FILTER html %] was not handled by
diff --git a/template/en/default/global/common-links.html.tmpl b/template/en/default/global/common-links.html.tmpl
index d817c4d..3ef7dd3 100644
--- a/template/en/default/global/common-links.html.tmpl
+++ b/template/en/default/global/common-links.html.tmpl
@@ -25,6 +25,7 @@
# SECTION: REQ_4_BROWSE_CGI
 <ul class="links">
   <li><a href="./">Home</a></li>
   <li><span class="separator">| </span><a href="enter_bug.cgi">New</a></li>
+  <li><span class="separator">| </span><a href="browse.cgi">Browse</a></li>
   <li><span class="separator">| </span><a href="query.cgi">Search</a></li>
 
   <li class="form">
@@ -37,7 +38,7 @@
# SECTION: REQ_40_PORT_FORWARD
     <input class="btn" type="submit" value="Find" id="find[% qs_suffix FILTER html %]">
     [%-# Work around FF bug: keep this on one line %]</form></li>
 
-  <li><span class="separator">| </span><a href="report.cgi">Reports</a></li>
+  <li><span class="separator">| </span><a href="page.cgi?id=reports.html">Reports</a></li>
 
   <li>
     [% IF Param('shutdownhtml') || Bugzilla.has_flags %]
diff --git a/template/en/default/global/field-descs.none.tmpl b/template/en/default/global/field-descs.none.tmpl
index 2c70b11..49f66ad 100644
--- a/template/en/default/global/field-descs.none.tmpl
+++ b/template/en/default/global/field-descs.none.tmpl
@@ -37,7 +37,6 @@
# SECTION: REQ_46_REMOVE_BUG_FILE_LOC
                    "attachments.isurl"       => "Attachment is a URL",
                    "attachments.submitter"   => "Attachment creator",
                    "blocked"                 => "Blocks",
-                   "bug_file_loc"            => "URL",
                    "bug_group"               => "Group",
                    "bug_id"                  => "$terms.Bug ID",
                    "bug_severity"            => "Severity",
@@ -71,7 +70,6 @@
# SECTION: REQ_47_REMOVE_REP_PLATFORM
                    "product"                 => "Product",
                    "qa_contact"              => "QA Contact",
                    "remaining_time"          => "Hours Left",
-                   "rep_platform"            => "Hardware",
                    "reporter"                => "Reporter",
                    "reporter_accessible"     => "Reporter accessible",
                    "requestees.login_name"   => "Flag Requestee",
diff --git a/template/en/default/global/header.html.tmpl b/template/en/default/global/header.html.tmpl
index 3116f00..9b5a14e 100644
--- a/template/en/default/global/header.html.tmpl
+++ b/template/en/default/global/header.html.tmpl
@@ -229,8 +229,9 @@
# SECTION: BRAND_HEADER_AND_FRONT_PAGE
 
     [%# Required for the 'Autodiscovery' feature in Firefox 2 and IE 7. %]
     <link rel="search" type="application/opensearchdescription+xml"
-                       title="[% terms.Bugzilla %]" href="./search_plugin.cgi">
-    <link rel="shortcut icon" href="images/favicon.ico" >
+                       title="GNOME [% terms.Bugzilla %]" 
+                       href="./search_plugin.cgi">
+    <link rel="shortcut icon" href="images/gnome-16.png" >
     [% Hook.process("additional_header") %]
   </head>
 
@@ -255,7 +256,7 @@
# SECTION: BRAND_HEADER_AND_FRONT_PAGE
 <table border="0" cellspacing="0" cellpadding="0" id="titles">
 <tr>
     <td id="title">
-      <p>[% terms.Bugzilla %]
+      <p>GNOME [% terms.Bugzilla %]
       [% " &ndash; $header" IF header %]</p>
     </td>
 
diff --git a/template/en/default/global/messages.html.tmpl b/template/en/default/global/messages.html.tmpl
index 372a57f..163b1ef 100644
--- a/template/en/default/global/messages.html.tmpl
+++ b/template/en/default/global/messages.html.tmpl
@@ -193,6 +193,9 @@
# SECTION: REQ_19_CLASSIFICATION_GNOME
         [% IF changes.sortkey.defined %]
           <li>Sortkey updated to '[% classification.sortkey FILTER html %]'</li>
         [% END %]
+        [% IF changes.is_gnome.defined %]
+          <li>Classification marked as [%+ "not" IF !classification.is_gnome %] GNOME</li>
+        [% END %]
       </ul>
     [% ELSE %]
       No changes made to <em>[% classification.name FILTER html %]</em>.
@@ -322,6 +325,10 @@
# SECTION: REQ_3_ATTACHMENT_STATUS
# COMMENT: TODO: Eh? Looks unrelated...
           <li>Sortkey updated to 
             <em>[% changes.sortkey.1 FILTER html %]</em>.</li>
         [% END %]
+        [% IF changes.description %]
+          <li>Description updated to
+            <em>[% changes.description.1 FILTER html %]</em>.</li>
+        [% END %]
         [% IF changes.visibility_value_id %]
           [% IF value.visibility_value.defined %]
             <li>It only appears when 
@@ -786,16 +793,21 @@
# SECTION: MESSAGES_HOOK_BACKPORT
 
   [% ELSIF message_tag == "workflow_updated" %]
     The workflow has been updated.
+  [% END %]
+[% END %]
 
-  [% ELSE %]
-    [%# Give sensible error if error functions are used incorrectly.
-      #%]        
+[% IF !message %]
+  [% message = Hook.process('messages') %]
+[% END %]
+
+[%# Give sensible error if the message function is used incorrectly. #%]
+[% IF !message %]
+  [% message = BLOCK %]
     You are using [% terms.Bugzilla %]'s messaging functions incorrectly. You
     passed in the string '[% message_tag %]'. The correct use is to pass
     in a tag, and define that tag in the file messages.html.tmpl.<br>
     <br>
-    If you are a [% terms.Bugzilla %] end-user seeing this message, please 
+    If you are a [% terms.Bugzilla %] end-user seeing this message, please
     save this page and send it to [% Param('maintainer') %].
-    
   [% END %]
 [% END %]
diff --git a/template/en/default/global/user-error.html.tmpl b/template/en/default/global/user-error.html.tmpl
index a3bb7c8..c28314a 100644
--- a/template/en/default/global/user-error.html.tmpl
+++ b/template/en/default/global/user-error.html.tmpl
@@ -427,6 +427,7 @@
# SECTION: REQ_36_LINK_TO_LISTS_IN_ERRORS
     Sorry, either the product <em>[% product FILTER html %]</em>
     does not exist or you aren't authorized to
     enter [% terms.abug %] into it.
+    Please choose a <a href="describecomponents.cgi">valid product</a>.
 
   [% ELSIF error == "field_already_exists" %]
     [% title = "Field Already Exists" %]
@@ -797,8 +798,9 @@
     [% ELSE %]
       [%+ Param('emailregexpdesc') %]
     [% END %]
-    It also must not contain any illegal characters.
-
+    It must also not contain any of these special characters:
+    <tt>\ ( ) &amp; &lt; &gt; , ; : &quot; [ ]</tt>, or any whitespace.
+    
   [% ELSIF error == "illegal_frequency" %]
     [% title = "Too Frequent" %]
     Unless you are an administrator, you may not create series which are 
@@ -922,6 +924,7 @@
# SECTION: REQ_36_LINK_TO_LISTS_IN_ERRORS
   [% ELSIF error == "invalid_product_name" %]
     [% title = "Invalid Product Name" %]
     The product name '[% product FILTER html %]' is invalid or does not exist.
+    Please choose a <a href="describecomponents.cgi">valid product</a>.
 
   [% ELSIF error == "invalid_regexp" %]
     [% title = "Invalid regular expression" %]
@@ -1030,6 +1033,10 @@
# SECTION: REQ_3_ATTACHMENT_STATUS
   [% ELSIF error == "missing_attachment_description" %]
     [% title = "Missing Attachment Description" %]
     You must enter a description for the attachment.
+
+  [% ELSIF error == "missing_attachment_status" %]
+    [% title = "Missing Attachment Status" %]
+    You must select a valid status for the attachment.
     
   [% ELSIF error == "missing_category" %]
     [% title = "Missing Category" %]
@@ -1254,6 +1261,10 @@
# SECTION: REQ_36_LINK_TO_LISTS_IN_ERRORS
     [% IF class == "Bugzilla::User" %]
       Either you mis-typed the name or that user has not yet registered
       for a [% terms.Bugzilla %] account.
+    [% ELSIF class == "Bugzilla::Component" AND product.defined %]
+      Please choose a <a href="describecomponents.cgi?product=[% product.name FILTER url_quote %]">valid component</a>.
+    [% ELSIF class == "Bugzilla::Product" OR class == "Bugzilla::Component" %]
+      Please choose a <a href="describecomponents.cgi">valid product</a>.
     [% END %]
 
   [% ELSIF error == "old_password_incorrect" %]
@@ -1292,10 +1303,12 @@
# SECTION: REQ_36_LINK_TO_LISTS_IN_ERRORS
   [% ELSIF error == "product_access_denied" %]
     Either the product '[% product FILTER html %]' does not exist or
     you don't have access to it.
+    Please choose a <a href="describecomponents.cgi">valid product</a>.
 
   [% ELSIF error == "product_doesnt_exist" %]
     [% title = "Specified Product Does Not Exist" %]
     The product '[% product FILTER html %]' does not exist.
+    Please choose a <a href="describecomponents.cgi">valid product</a>.
 
   [% ELSIF error == "product_illegal_group" %]
     [% title = "Illegal Group" %]
@@ -1354,6 +1367,7 @@
# SECTION: REQ_36_LINK_TO_LISTS_IN_ERRORS
     [% admindocslinks = {'products.html' => 'Administering products'} %]
     Sorry, entering [% terms.abug %] into the
     product <em>[% product.name FILTER html %]</em> has been disabled.
+    Please choose a <a href="describecomponents.cgi">valid product</a>.
 
   [% ELSIF error == "product_edit_denied" %]
     [% title = "Product Edit Access Denied" %]
@@ -1361,6 +1375,7 @@
# SECTION: REQ_36_LINK_TO_LISTS_IN_ERRORS
                          'groups.html'   => 'Group security'} %]
     You are not permitted to edit [% terms.bugs %] in product 
     [%+ product FILTER html %].
+    Please choose a <a href="describecomponents.cgi">valid product</a>.
 
   [% ELSIF error == "product_has_bugs" %]
     [% title = BLOCK %]Product has [% terms.Bugs %][% END %]
@@ -1388,6 +1403,7 @@
# SECTION: REQ_36_LINK_TO_LISTS_IN_ERRORS
                          'versions.html'   => 'Administering versions'} %]
     No product specified when trying to edit components, milestones, versions
     or product.
+    Please choose a <a href="describecomponents.cgi">valid product</a>.
 
   [% ELSIF error == "query_name_exists" %]
     [% title = "Search Name Already In Use" %]
@@ -1429,8 +1445,9 @@
# SECTION: REQ_36_LINK_TO_LISTS_IN_ERRORS
 
   [% ELSIF error == "require_component" %]
     [% title = "Component Needed" %]
-    To file this [% terms.bug %], you must first choose a component.
-    If necessary, just guess.
+    To file this [% terms.bug %], you must first
+    <a href="describecomponents.cgi?product=[% product.name FILTER url_quote %]">
+    choose a component</a>. If necessary, just guess.
 
   [% ELSIF error == "require_new_password" %]
     [% title = "New Password Needed" %]
diff --git a/template/en/default/index.html.tmpl b/template/en/default/index.html.tmpl
index 6231baa..3b061e0 100644
--- a/template/en/default/index.html.tmpl
+++ b/template/en/default/index.html.tmpl
@@ -30,8 +30,8 @@
# SECTION: BRAND_HEADER_AND_FRONT_PAGE
 
 
 [% PROCESS global/header.html.tmpl
-   title = "$terms.Bugzilla Main Page"
-   header = "Main Page" 
+   title = "GNOME $terms.Bugzilla"
+   header = "Main Page"
    header_addl_info = "version $constants.BUGZILLA_VERSION"
    style_urls = [ 'skins/standard/index.css' ]
 %]
@@ -126,7 +126,7 @@ YAHOO.util.Event.onDOMReady(onLoadActions);
# SECTION: BRAND_HEADER_AND_FRONT_PAGE
   <table>
     <tr>
       <td>
-        <h1 id="welcome"> Welcome to [% terms.Bugzilla %]</h1>
+        <h1 id="welcome"> Welcome to GNOME [% terms.Bugzilla %]</h1>
         <div class="intro">[% Hook.process('intro') %]</div>
         <a id="enter_bug" class="bz_common_actions"
            href="enter_bug.cgi"><span>File [% terms.aBug %]</span></a>
diff --git a/template/en/default/list/edit-multiple.html.tmpl b/template/en/default/list/edit-multiple.html.tmpl
index 46130ef..dcfd75f 100644
--- a/template/en/default/list/edit-multiple.html.tmpl
+++ b/template/en/default/list/edit-multiple.html.tmpl
@@ -92,13 +92,13 @@
# SECTION: REQ_47_REMOVE_REP_PLATFORM
   <tr>
 
     <th>
-      <label for="rep_platform">
-        <a href="page.cgi?id=fields.html#rep_platform">Platform</a>:
+      <label for="op_sys">
+        <a href="page.cgi?id=fields.html#op_sys">OS</a>:
       </label>
     </th>
     <td>
-      [% PROCESS selectmenu menuname = "rep_platform"
-                            menuitems = platforms %]
+      [% PROCESS selectmenu menuname = "op_sys"
+                            menuitems = op_sys %]
     </td>
 
     <th>
@@ -113,25 +113,15 @@
# SECTION: REQ_47_REMOVE_REP_PLATFORM
 
   </tr>
 
-  <tr>
-    <th>
-      <label for="op_sys">
-        <a href="page.cgi?id=fields.html#op_sys">OS</a>:
-      </label>
-    </th>
-    <td [% " colspan=\"3\"" IF !Param("usetargetmilestone") %]>
-      [% PROCESS selectmenu menuname = "op_sys"
-                            menuitems = op_sys %]
-    </td>
-
-    [% IF Param("usetargetmilestone") %]
+  [% IF Param("usetargetmilestone") %]
+    <tr>
       <th><label for="target_milestone">Target Milestone:</label></th>
       <td>
         [% PROCESS selectmenu menuname = "target_milestone"
                               menuitems = targetmilestones %]
       </td>
-    [% END %]
-  </tr>
+    </tr>
+  [% END %]
   
   <tr>
     <th><label for="bug_status">Status:</label></th>
@@ -401,7 +391,8 @@
# SECTION: REQ_64_NO_GNOME_1_X_AND_NOTXIMIAN
       <option value="[% dontchange FILTER html %]" selected >[% dontchange FILTER html %]</option>
     [% FOREACH r = resolutions %]
       [% NEXT IF !r %]
-      [% NEXT IF r == "DUPLICATE" || r == "MOVED" %]
+      [% NEXT IF r == "DUPLICATE" || r == "MOVED"
+              || r == 'GNOME1.x' || r == 'NOTXIMIAN' %]
       <option value="[% r FILTER html %]">[% get_resolution(r) FILTER html %]</option>
     [% END %]
   </select>
diff --git a/template/en/default/list/list.ics.tmpl b/template/en/default/list/list.ics.tmpl
index d30b065..3f9e2b8 100644
--- a/template/en/default/list/list.ics.tmpl
+++ b/template/en/default/list/list.ics.tmpl
@@ -30,6 +30,7 @@ BEGIN:VTODO
# SECTION: REQ_57_ADD_PRIORITY_TO_ICAL
 [%+ PROCESS ics_url base_url=urlbase bug_id=bug.bug_id +%]
 [%+ PROCESS ics_status bug_status = bug.bug_status +%]
 [%+ PROCESS ics_dtstamp +%]
+[%+ ics_priorities.${bug.priority} FILTER ics('PRIORITY') +%]
 [% IF bug.changeddate %]
 [%+ bug.changedtime FILTER time("%Y%m%dT%H%M%SZ", "UTC") FILTER ics('LAST-MODIFIED') +%]
 [% END %]
diff --git a/template/en/default/list/list.js.tmpl b/template/en/default/list/list.js.tmpl
deleted file mode 100644
index 7e9664c..0000000
--- a/template/en/default/list/list.js.tmpl
+++ /dev/null
@@ -1,37 +0,0 @@
# SECTION: JS_TEMPLATE_SEE_ALL_BUGS
-[%# The contents of this file are subject to the Mozilla Public
-  # License Version 1.1 (the "License"); you may not use this file
-  # except in compliance with the License. You may obtain a copy of
-  # the License at http://www.mozilla.org/MPL/
-  #
-  # Software distributed under the License is distributed on an "AS
-  # IS" basis, WITHOUT WARRANTY OF ANY KIND, either express or
-  # implied. See the License for the specific language governing
-  # rights and limitations under the License.
-  #
-  # The Original Code is the Bugzilla Bug Tracking System.
-  #
-  # The Initial Developer of the Original Code is Netscape Communications
-  # Corporation. Portions created by Netscape are
-  # Copyright (C) 1998 Netscape Communications Corporation. All
-  # Rights Reserved.
-  #
-  # Contributor(s): Gervase Markham <gerv@gerv.net>
-  #%]
-
-// Note: only publicly-accessible bugs (those not in any group) will be
-// listed when using this JavaScript format. This is to prevent malicious
-// sites stealing information about secure bugs.
-  
-bugs = new Array; 
-
-[% FOREACH bug = bugs %]
-  bugs[[% bug.bug_id %]] = [ 
-    [% FOREACH column = displaycolumns %]
-      "[%- bug.$column FILTER js -%]"[% "," UNLESS loop.last %]
-    [% END %]
-  ];
-[% END %]
-
-if (window.buglistCallback) {
-  buglistCallback(bugs);
-}
diff --git a/template/en/default/list/table.html.tmpl b/template/en/default/list/table.html.tmpl
index fcbba3a..3a0a9c5 100644
--- a/template/en/default/list/table.html.tmpl
+++ b/template/en/default/list/table.html.tmpl
@@ -41,7 +41,6 @@
# SECTION: REQ_47_REMOVE_REP_PLATFORM
   {
     "bug_severity"         => { maxlength => 3 , title => "Sev" } , 
     "priority"             => { maxlength => 3 , title => "Pri" } , 
-    "rep_platform"         => { maxlength => 3 , title => "Plt" } , 
     "bug_status"           => { maxlength => 4 } , 
     "assigned_to"          => { maxlength => 30 , ellipsis => "..." } , 
     "assigned_to_realname" => { maxlength => 20 , ellipsis => "..." } , 
@@ -55,8 +54,8 @@
# SECTION: REQ_59_CHANGE_COLUMN_LENGTHS
     "status_whiteboard" => { title => "Whiteboard" , wrap => 1 } , 
     "keywords"          => { wrap => 1 } ,
     "component"         => { maxlength => 8 , title => "Comp" } , 
-    "product"           => { maxlength => 8 } , 
-    "version"           => { maxlength => 5 , title => "Vers" } , 
+    "product"           => { maxlength => 12 } , 
+    "version"           => { maxlength => 7 , title => "Vers" } , 
     "op_sys"            => { maxlength => 4 } , 
     "target_milestone"  => { title => "TargetM" } , 
     "percentage_complete" => { format_value => "%d %%" } , 
diff --git a/template/en/default/pages/403.html.tmpl b/template/en/default/pages/403.html.tmpl
new file mode 100644
index 0000000..09786f2
--- /dev/null
+++ b/template/en/default/pages/403.html.tmpl
@@ -0,0 +1,11 @@
# SECTION: REQ_1_403_PAGE
+[% PROCESS global/header.html.tmpl %]
+
+<h1>Either your network or ip address has been banned from Bugzilla</h1>
+
+<p>If you feel that this is unwarranted, feel free to include your IP
+  address in the subject of <a href="mailto:bugmaster&#64;gnome.org">an 
+  email</a>, and we will examine why there is a ban. If you fail to
+  include the IP address (again, in the subject!), then your message will
+  be deleted and ignored.</p>
+
+[% PROCESS global/footer.html.tmpl %]
diff --git a/template/en/default/pages/fields.html.tmpl b/template/en/default/pages/fields.html.tmpl
index eed8646..6e0d4fc 100644
--- a/template/en/default/pages/fields.html.tmpl
+++ b/template/en/default/pages/fields.html.tmpl
@@ -43,8 +43,8 @@ cycle of [% terms.abug %].
# SECTION: REQ_31_MIGRATE_BUG_STATUS_HTML
   </tr>
 
   <tr valign="top">
-    <td>The <b>status</b> field indicates the general health of a 
-    [% terms.bug %]. Only certain status transitions are allowed.</td>
+    <td>The <b>status</b> field indicates the general health of 
+    [% terms.abug %]. Only certain status transitions are allowed.</td>
 
     <td>The <b>resolution</b> field indicates what happened to this
     [%+ terms.bug %].</td>
@@ -59,9 +59,13 @@ cycle of [% terms.abug %].
# SECTION: REQ_31_MIGRATE_BUG_STATUS_HTML
         <dd>
           This [% terms.bug %] has recently been added to the database. 
           Nobody has validated that this [% terms.bug %] is true. Users
-          who have the "canconfirm" permission set may confirm
-          this [% terms.bug %], changing its state to [% get_status("NEW") FILTER html %]. Or, it may be
-          directly resolved and marked [% get_status("RESOLVED") FILTER html %].
+          who have obtained permissions from the
+          <a href="http://live.gnome.org/Bugsquad">bugsquad</a> may confirm
+          this [% terms.bug %], changing its state to
+          <b>[% get_status("NEW") FILTER html %]</b>. Or, it may be directly
+          resolved and marked <b>[% get_status("RESOLVED") FILTER html %]</b>,
+          or more information may be necessary, moving it to
+          <b>[% get_status("NEEDINFO") FILTER html %]</b>.
         </dd>
 
         <dt>
@@ -86,6 +90,18 @@ cycle of [% terms.abug %].
# SECTION: REQ_31_MIGRATE_BUG_STATUS_HTML
         </dd>
 
         <dt>
+          <b>[% get_status("NEEDINFO") FILTER html %]</b>
+        </dt>
+        <dd>
+          More information from the reporter is needed to proceed further in
+          fixing this [% terms.bug %]. This should <i>not</i> be used when
+          someone needs more information from a developer - a
+          <b>[% get_status("NEW") FILTER html %]</b> or
+          <b>[% get_status("ASSIGNED") FILTER html %]</b> [%+ terms.bug %]
+          implicitly needs more information from the developer.
+        </dd>
+
+        <dt>
           <b>[% get_status("REOPENED") FILTER html %]</b>
         </dt>
         <dd>
@@ -126,23 +142,15 @@ cycle of [% terms.abug %].
# SECTION: REQ_31_MIGRATE_BUG_STATUS_HTML
         </dd>
 
         <dt>
-          <b>[% get_status("VERIFIED") FILTER html %]</b>
-        </dt>
-        <dd>
-          QA has looked at the [% terms.bug %] and the resolution and 
-          agrees that the appropriate resolution has been taken. [% terms.Bugs %] remain
-          in this state until the product they were reported
-          against actually ships, at which point they become
-          <b>[% get_status("CLOSED") FILTER html %]</b>.
-        </dd>
-
-        <dt>
+          <b>[% get_status("VERIFIED") FILTER html %]</b> and
           <b>[% get_status("CLOSED") FILTER html %]</b>
         </dt>
         <dd>
-          The [% terms.bug %] is considered dead, the resolution is correct. 
-          Any zombie [% terms.bugs %] who choose to walk the earth again must 
-          do so by becoming <b>[% get_status("REOPENED") FILTER html %]</b>.
+          GNOME does not substantially use
+          <b>[%+ get_status("VERIFIED") FILTER html %]</b> or
+          <b>[% get_status("CLOSED") FILTER html %]</b>. When used, they
+          indicate that a third party has checked to see that [% terms.abug %]
+          was properly resolved.
         </dd>
       </dl>
     </td>
@@ -158,10 +166,13 @@ cycle of [% terms.abug %].
# SECTION: REQ_31_MIGRATE_BUG_STATUS_HTML
         </dd>
 
         <dt>
-          <b>[% get_resolution("INVALID") FILTER html %]</b>
+         <b>[% get_resolution("DUPLICATE") FILTER html %]</b>
         </dt>
         <dd>
-          The problem described is not [% terms.abug %].
+          The problem is a duplicate of an existing [% terms.bug %].
+          Marking [% terms.abug %] duplicate requires the [% terms.bug %]#
+          of the duplicating [% terms.bug %] and will at least put
+          that [% terms.bug %] number in the description field.
         </dd>
 
         <dt>
@@ -173,33 +184,46 @@ cycle of [% terms.abug %].
# SECTION: REQ_31_MIGRATE_BUG_STATUS_HTML
         </dd>
 
         <dt>
-         <b>[% get_resolution("DUPLICATE") FILTER html %]</b>
+          <b>[% get_resolution("NOTABUG") FILTER html %]</b>
         </dt>
         <dd>
-          The problem is a duplicate of an existing [% terms.bug %].
-          Marking [% terms.abug %] duplicate requires the [% terms.bug %]#
-          of the duplicating [% terms.bug %] and will at least put
-          that [% terms.bug %] number in the description field.
+          The problem described is not actually [% terms.abug %], but a
+          design choice of some sort.
+        </dd>
+
+        <dt>
+          <b>[% get_resolution("NOTGNOME") FILTER html %]</b>
+        </dt>
+        <dd>
+          The [% terms.bug %] is either not in a module that is part of GNOME,
+          or is caused by something outside of GNOME that cannot be worked
+          around or otherwise resolved by the GNOME application.
+        </dd>
+
+        <dt>
+          <b>[% get_resolution("INCOMPLETE") FILTER html %]</b>
+        </dt>
+        <dd>
+          The [% terms.bug %] lacks sufficient information to be fixed, and
+          unlike <b>[% get_status("NEEDINFO") %]</b>, no answer is possible
+          or expected.
         </dd>
 
         <dt>
-          <b>[% get_resolution("WORKSFORME") FILTER html %]</b>
+          <b>[% get_resolution("INVALID") FILTER html %]</b>
         </dt>
         <dd>
-          All attempts at reproducing this [% terms.bug %] were futile, 
-          and reading the code produces no clues as to why the described
-          behavior would occur. If more information appears later,
-          the [% terms.bug %] can be reopened.
+          This [% terms.bug %] is in some way not valid - usually used when
+          <b>[% get_resolution("INCOMPLETE") %]</b> or
+          <b>[% get_resolution("NOTABUG") %]</b> just don't quite fit.
         </dd>
 
         <dt>
-          <b>[% get_resolution("MOVED") FILTER html %]</b>
+          <b>[% get_resolution("OBSOLETE") %]</b>
         </dt>
         <dd>
-          The problem was specific to a related product 
-          whose [% terms.bugs %] are tracked in
-          another [% terms.bug %] database.
-          The [% terms.bug %] has been moved to that database.
+          This [% terms.bug %] is in an old (obsolete) or unmaintained
+          version. This includes GNOME 1.x.
         </dd>
       </dl>
     </td>
@@ -213,10 +237,59 @@ as described below.
# SECTION: REQ_31_MIGRATE_BUG_STATUS_HTML
 
 <h2><a name="priority">Priority</a></h2>
 This field describes the importance and order in which [% terms.abug %]
-should be fixed. This field is utilized by the
-programmers/engineers to prioritize their work to be done. The
-available priorities range from <b>P1</b> (most important) to
-<b>P5</b> (least important).
+should be fixed. This field is utilized by hackers to prioritize
+their work to be done. While each term has a description, it it important to
+note that priority is highly subjective, and [% terms.bugs %] can move up or
+down the priority scale based on subjective questions like 'would we be
+embarassed to release the software with this [% terms.bug %].'
+
+<table>
+  <tr>
+    <th>Immediate</th>
+
+    <td>
+      This [% terms.bug %] blocks development or testing work and should be
+      fixed ASAP, or is a security issue in a released version of the software.
+    </td>
+  </tr>
+
+  <tr>
+    <th>Urgent</th>
+
+    <td>
+      This [% terms.bug %] blocks usability of a large portion of the product,
+      and really should be fixed before the next planned release.
+    </td>
+  </tr>
+
+  <tr>
+    <th>High</th>
+
+    <td>
+      Seriously broken, but not as high impact. Should be fixed before next
+      major release. Frequently includes cosmetic [% terms.bugs %] of particularly
+      high visibility, regressions from functionality provided in previous releases,
+      and more minor [% terms.bugs %] that are frequently reported.
+    </td>
+  </tr>
+
+  <tr>
+    <th>Normal</th>
+
+    <td>
+      Either a fairly straightforward workaround exists or the functionality is
+      not very important and/or not frequently used.
+    </td>
+  </tr>
+
+  <tr>
+    <th>Low</th>
+
+    <td>
+      Just not all that important. Rarely used in GNOME.
+    </td>
+  </tr>
+</table>
 
 <h2><a name="bug_severity">Severity</a></h2>
 This field describes the impact of [% terms.abug %]. 
@@ -231,75 +304,49 @@ This field describes the impact of [% terms.abug %].
# SECTION: REQ_31_MIGRATE_BUG_STATUS_HTML
   <tr>
     <th>Critical</th>
 
-    <td>crashes, loss of data, severe memory leak</td>
+    <td>Crashes, causes loss of data, or is a severe memory leak</td>
   </tr>
 
   <tr>
     <th>Major</th>
 
-    <td>major loss of function</td>
+    <td>
+      Major loss of functionality - menu item broken, data output extremely
+      incorrect, or otherwise difficult/useless to use.
+    </td>
   </tr>
 
   <tr>
     <th>Normal</th>
 
-    <td>regular issue, some loss of functionality under specific circumstances</td>
+    <td>A minor part of the component is nonfunctional or broken.</td>
   </tr>
 
 
   <tr>
     <th>Minor</th>
 
-    <td>minor loss of function, or other problem where easy
-    workaround is present</td>
+    <td>Minor loss of function, or other problem where easy
+    workaround is present.</td>
   </tr>
 
   <tr>
     <th>Trivial</th>
 
-    <td>cosmetic problem like misspelled words or misaligned
-    text</td>
+    <td>Cosmetic problem like misspelled words or misaligned text.</td>
   </tr>
 
   <tr>
     <th>Enhancement</th>
 
-    <td>Request for enhancement</td>
+    <td>Request for a new feature or functionality.</td>
# SECTION: REQ_47_REMOVE_REP_PLATFORM
 </table>
 
-<h2><a name="rep_platform">Platform</a></h2>
-This is the hardware platform against which the [% terms.bug %] was
-reported. Legal platforms include: 
-
-<ul>
-  <li>All (happens on all platforms; cross-platform [% terms.bug %])</li>
-
-  <li>Macintosh</li>
-
-  <li>PC</li>
-</ul>
-<b>Note:</b> When searching, selecting the option "All" does not 
-select [% terms.bugs %]
-assigned against any platform. It merely selects [% terms.bugs %] that are
-marked as occurring on all platforms, i.e. are designated "All". 
-
# SECTION: REQ_31_MIGRATE_BUG_STATUS_HTML
 <h2><a name="op_sys">Operating System</a></h2>
-This is the operating system against which the [% terms.bug %] was
-reported. Legal operating systems include: 
-
-<ul>
-  <li>All (happens on all operating systems; cross-platform
-  [% terms.bug %])</li>
-
-  <li>Windows</li>
-
-  <li>Mac OS</li>
 
-  <li>Linux</li>
-</ul>
-Sometimes the operating system implies the platform, but not
-always. For example, Linux can run on PC and Macintosh and
-others. 
+<p>
+This field lists the operating system the [% terms.bug %] was found on.
+We know a lot of these are useless, bear with us. :)</p>
 
 <h2><a name="assigned_to">Assigned To</a></h2>
 
@@ -315,11 +362,73 @@ When searching for [% terms.bugs %] that have been resolved or
# SECTION: REQ_31_MIGRATE_BUG_STATUS_HTML
 verified, remember to set the status field appropriately. 
 </p>
 
+<h2><a name="target_milestone">Target Milestone</a></h2>
+
+<p>
+This field describes the version of the product that developers or the
+maintainers believe they should fix the [% terms.bug %] by. This field is
+not meant for use by general users, the bugsquad, or the release team. It
+is reserved for developers and maintainers of the given module.</p>
+
+<h2><a name="cf_gnome_version">Gnome Version</a></h2>
+
+<p>
+This field describes the version of GNOME that [% terms.abug %] has most
+recently been found in. This field is used by the GNOME release team and
+other interested parties to find all [% terms.bugs %] in a specific version
+of GNOME, no matter what program the [% terms.bug %] is in. For example, one
+query can find all GNOME 2.8 [% terms.bugs %], whether they are in Metacity
+2.91, totem 0.99, or nautilus 2.8.<br>
+<b>Don't</b> set update field if you haven't verified that the
+[% terms.bug %] exists in the version you're setting it to. <b>Don't</b>
+update this field without updating the product version field- that is still
+useful for maintainers.</p>
+
+<table>
+  <tr>
+    <th>Unspecified</th>
+
+    <td>
+      This [% terms.bug %] is in a module that is not in GNOME, or in an
+      unspecified version of GNOME.
+    </td>
+  </tr>
+
+  <tr>
+    <th>Unversioned Enhancement</th>
+
+    <td>
+      This [% terms.bug %] is an enhancement,and hence can be implemented at
+      any point.
+    </td>
+  </tr>
+
+  <tr>
+    <th>2.(odd)/2.(even)</th>
+
+    <td>
+      This [% terms.bug %] is in the odd/even-numbered series which culminates
+      in GNOME 2.even.
+    </td>
+  </tr>
+</table>
+
+<h2><a name="cf_gnome_target">Gnome Target Milestone</a></h2>
+
+<p>
+This field describes the version of GNOME that [% terms.abug %] should be
+fixed in. This is not a 'it would be nice' field, it is a 'Gnome releases may
+need to be delayed for this issue' field. It is intended for use by
+senior-ish [% terms.bug %] triagers and the release team. We allow others
+to nominate 'showstopper' [% terms.bugs %] by setting this field, but
+bugsquadders and release team members review such [% terms.bugs %] and unmark
+ones where the change is not warranted.</p>
+
 [% IF Param("use_see_also") %]
   <h2><a name="see_also"></a>See Also</h2>
 
   <p>This allows you to refer to [% terms.bugs %] in other installations.
-    You can enter a URL to a [%+ terms.bug %] in the "Add [% terms.Bug %] URLs"
+    You can enter a URL to [%+ terms.abug %] in the "Add [% terms.Bug %] URLs"
     field to note that that [% terms.bug %] is related to this one. You can
     enter multiple URLs at once by separating them with a comma.</p>
 
@@ -329,4 +438,21 @@ verified, remember to set the status field appropriately.
# SECTION: REQ_3_ATTACHMENT_STATUS
     fields.</p>
 [% END %]
 
+<h2><a name="attachments.status">Attachment status</a></h2>
+
+[% field = Bugzilla.get_fields({ name = 'attachments.status' }) %]
+<table border="1" cellpadding="4" cellspacing="0">
+  <tr>
+    <th align="left">Name</th>
+    <th align="left">Description</th>
+  </tr>
+
+  [% FOREACH v = field.legal_values %]
+  <tr>
+    <td>[% v.name FILTER html %]</td>
+    <td>[% v.description FILTER html %]</td>
+  </tr>
+  [% END %]
+</table>
+
 [% INCLUDE global/footer.html.tmpl %]
diff --git a/template/en/default/pages/quicksearchhack.html.tmpl b/template/en/default/pages/quicksearchhack.html.tmpl
index 4d96f5d..549add5 100644
--- a/template/en/default/pages/quicksearchhack.html.tmpl
+++ b/template/en/default/pages/quicksearchhack.html.tmpl
@@ -94,16 +94,6 @@
# SECTION: REQ_47_REMOVE_REP_PLATFORM
 </tr>
 <tr>
   <td>&nbsp;</td>
-  <td><i>as-is</i></td>
-  <td><tt>platform</tt></td>
-  <td>&nbsp;</td>
-  <td>
-    <a href="page.cgi?id=fields.html#rep_platform">Platform</a>
-    <i>(&ldquo;rep_platform&rdquo;)</i>
-  </td>
-</tr>
-<tr>
-  <td>&nbsp;</td>
   <td>&nbsp;</td>
   <td><tt>os</tt></td>
   <td><tt>opsys</tt></td>
@@ -216,13 +206,6 @@
# SECTION: REQ_46_REMOVE_BUG_FILE_LOC
   <td>[% terms.Bug %] Description / Comments (long text)</td>
 </tr>
 <tr>
-  <td><i>depends</i></td>
-  <td>&nbsp;</td>
-  <td><tt>url</tt></td>
-  <td>&nbsp;</td>
-  <td>URL <i>(&ldquo;bug_file_loc&rdquo;)</i></td>
-</tr>
-<tr>
   <td><i>yes</i></td>
   <td>&nbsp;</td>
   <td><tt>statuswhiteboard</tt></td>
diff --git a/template/en/default/pages/release-notes.html.tmpl b/template/en/default/pages/release-notes.html.tmpl
index 0773d8b..9ca1aae 100644
--- a/template/en/default/pages/release-notes.html.tmpl
+++ b/template/en/default/pages/release-notes.html.tmpl
@@ -59,12 +59,6 @@
 
 <h2><a name="v34_point"></a>Updates In This 3.4.x Release</h2>
 
-<h3>3.4.14</h3>
-
-<p>This release fixes a security issue. See the
-  <a href="http://www.bugzilla.org/security/3.4.13/">Security Advisory</a>
-  for details.</p>
-
 <h3>3.4.13</h3>
 
 <p>This release fixes two security issues. See the
diff --git a/template/en/default/reports/components.html.tmpl b/template/en/default/reports/components.html.tmpl
index eb08a35..2ff3d5c 100644
--- a/template/en/default/reports/components.html.tmpl
+++ b/template/en/default/reports/components.html.tmpl
@@ -25,8 +25,11 @@
# SECTION: REQ_4_BROWSE_CGI
 [% title = BLOCK %]
   Components for [% product.name FILTER html %]
 [% END %]
+[% header = BLOCK %]
+  Components for <a href="browse.cgi?product=[% product.name FILTER url_quote %]">[% product.name FILTER html %]</a>
+[% END %]
 
-[% PROCESS global/header.html.tmpl title = title %]
+[% PROCESS global/header.html.tmpl title = title header = header %]
 
 [% IF Param("useqacontact") %]
   [% numcols = 3 %]
diff --git a/template/en/default/search/form.html.tmpl b/template/en/default/search/form.html.tmpl
index 060e373..1936418 100644
--- a/template/en/default/search/form.html.tmpl
+++ b/template/en/default/search/form.html.tmpl
@@ -257,13 +257,12 @@ function doOnSelectProduct(selectmode) {
# SECTION: REQ_46_REMOVE_BUG_FILE_LOC
     </td>
   </tr>
 
-[%# *** Comment URL Whiteboard Keywords *** %]
+[%# URL field disabled %]
+[%# *** Comment Whiteboard Keywords *** %]
 
   [% FOREACH field = [
     { name => "longdesc", description => "A&nbsp;<u>C</u>omment",
       accesskey => 'c' },
-    { name => "bug_file_loc", description => "The&nbsp;<u>U</u>RL",
-      accesskey => 'u' },
     { name => "status_whiteboard", description => "<u>W</u>hiteboard",
       accesskey => 'w' } ] %]
 
@@ -326,7 +325,7 @@ function doOnSelectProduct(selectmode) {
# SECTION: REQ_16_GNOME_VERSION_AND_TARGET
 
 <hr>
 
-[%# *** Status Resolution Severity Priority Hardware OS *** %]
+[%# *** Status Resolution Severity Priority Hardware OS gnome_version gnome_target *** %]
 
 <table>
   <tr>
@@ -386,11 +385,11 @@ function doOnSelectProduct(selectmode) {
# SECTION: REQ_47_REMOVE_REP_PLATFORM
       <table>
         <tr>
           <th align="left">
-            <label for="rep_platform" accesskey="h"><u>H</u>ardware</label>:
+            <label for="op_sys" accesskey="o"><u>O</u>S</label>:
           </th>
         </tr>
         <tr valign="top">
-          [% PROCESS select sel = { name => 'rep_platform',
+          [% PROCESS select sel = { name => 'op_sys',
                                     size => 7 } %]
         </tr>
       </table>
@@ -399,11 +398,24 @@ function doOnSelectProduct(selectmode) {
# SECTION: REQ_16_GNOME_VERSION_AND_TARGET
       <table>
         <tr>
           <th align="left">
-            <label for="op_sys" accesskey="o"><u>O</u>S</label>:
+            <label for="gnome_version">GNOME Version</label>:
           </th>
         </tr>
         <tr valign="top">
-          [% PROCESS select sel = { name => 'op_sys',
+          [% PROCESS select sel = { name => 'cf_gnome_version',
+                                    size => 7 } %]
+        </tr>
+      </table>
+    </td>
+    <td>
+      <table>
+        <tr>
+          <th align="left">
+            <label for="gnome_target">GNOME Target</label>:
+          </th>
+        </tr>
+        <tr valign="top">
+          [% PROCESS select sel = { name => 'cf_gnome_target',
                                     size => 7 } %]
         </tr>
       </table>
diff --git a/template/en/default/search/search-help.html.tmpl b/template/en/default/search/search-help.html.tmpl
index 12e82ba..4e2c299 100644
--- a/template/en/default/search/search-help.html.tmpl
+++ b/template/en/default/search/search-help.html.tmpl
@@ -46,11 +46,6 @@
# SECTION: REQ_46_REMOVE_BUG_FILE_LOC
            You can<br>search for some text in those comments." },   
 { id => "longdesc_type",
   html => "The type of comment search you would like" },   
-{ id => "bug_file_loc", 
-  html => "$terms.Bugs can have a URL associated with them - for example, a 
-           pointer<br>to a web site where the problem is seen." },   
-{ id => "bug_file_loc_type", 
-  html => "The type of URL search you would like" },   
 { id => "status_whiteboard", 
   html => "Each $terms.bug has a free-form single line text entry box for 
            adding<br>tags and status information." },   
@@ -70,8 +65,6 @@
# SECTION: REQ_47_REMOVE_REP_PLATFORM
   html => "How severe the $terms.bug is, or whether it's an enhancement." },   
 { id => "priority", 
   html => "Engineers prioritize their $terms.bugs using this field." },   
-{ id => "rep_platform", 
-  html => "The hardware platform the $terms.bug was observed on." },   
 { id => "op_sys", 
   html => "The operating system the $terms.bug was observed on." },   
 { id => "email1", 
diff --git a/template/en/default/search/search-plugin.xml.tmpl b/template/en/default/search/search-plugin.xml.tmpl
index 8564dca..be95654 100644
--- a/template/en/default/search/search-plugin.xml.tmpl
+++ b/template/en/default/search/search-plugin.xml.tmpl
@@ -16,11 +16,11 @@
# SECTION: BRAND_HEADER_AND_FRONT_PAGE
 [% PROCESS global/variables.none.tmpl %]
 <?xml version="1.0" encoding="UTF-8"?>
 <OpenSearchDescription xmlns="http://a9.com/-/spec/opensearch/1.1/">
-<ShortName>[% terms.Bugzilla %]</ShortName>
-<Description>[% terms.Bugzilla %] Quick Search</Description>
+<ShortName>GNOME [% terms.Bugzilla %]</ShortName>
+<Description>GNOME [% terms.Bugzilla %] Quick Search</Description>
 <InputEncoding>UTF-8</InputEncoding>
 [% IF favicon %]
-  <Image width="16" height="16">data:image/x-icon;base64,[% favicon FILTER base64 %]</Image>
+  <Image width="16" height="16">data:image/png;base64,[% favicon FILTER base64 %]</Image>
 [% ELSE %]
   <Image width="16" height="16">data:image/x-icon;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAIAAACQkWg2AAAABGdBTUEAAK%2FINwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAALBSURBVHjaYnxckcEAA3%2F%2B%2FT%2F17LUcH%2Fevf%2F8U%2BHmYGBkZMABAALEgc%2B68%2F3T227cf2tJKKhJLt59n%2FfmbnYnZV1KEhYkJrgYggBghNrz78fPIi3d8uvKBIdb%2FOaWPnzitLc97%2Bc5rFXnhnVO3%2BslLwjUABBDIhnsfPl%2Fj53VO91FX4Gfgkjxw%2Fd%2F6Q49%2FWStqyAj%2B%2B88gZqn%2B9u5rYU52iAaAAGL69%2F%2F%2F2d9%2FYiMclGT4fv76%2BZ9DbO%2FeA39%2BfJHVcvj5l%2Bnh03e%2FWThOvnwLtwEgAAAxAM7%2FBPj8%2FRYkHQYHAf3%2F%2Fv%2F%2B%2Fv8BAVNTUPX18yorLNHE2S8mB%2FT2%2Bq7a4dvu8iUSDgAAAAKICRgUv3%2F8ZGKGeIvpz6eXBvq61lZWLMwMv%2F5zMP7%2FqSAjVFyZ%2FNvZftuT10DnAAQAMQDO%2FwQIBAPz5Or6%2Ff0CBQEAAgT99ubq38z2%2BwT18%2FAM%2F%2BkNDAv6%2FQMCAA1GVVrhMze5h4kCCORpkd9%2F3n74KiHO%2B%2BffX8b%2Ff7m%2BXWP985%2Bf5R%2BPLNdfoK%2F%2F%2Ffv39%2BePj2%2FkZYR0fe0BAgikQZGX%2B9b9FzLS%2FH%2F%2B%2FGVgYGRlZWNlA7nv7z9QuDP8%2B8nw%2FRXjn68Mv4Gu%2FAwQQCCni3FxPLn7nIGZGegfNhYmNjYWZnBMASOakZER6Eumf9%2FYGT4y%2FHx%2F%2BfBFgAAC2cDGzPT99WeGvwzvv%2Fx89vrr%2F39%2FJER4pcT5Gf4z%2FP37D2jtj9%2B%2FL918fmzrKSsWNoAAgiaN%2Fz9%2Fff%2F6S4CP8%2BWbz9vWHfv54aukpAAz0Og%2Ff%2F7%2F%2Bs36668cO3ugED9QJUAAQTUArf7%2F8x87D9vRjcejhPiZhAUYcACAAGI5%2FOHH9ddvXzAxmjz%2B8P8lw4fXn5l4eRlwA4AAYmaTkBFg%2FKvJwfbkwZuXN57y%2Fv%2F34stXGR4uRmxpGwgAAgwA4%2FkfrfCWvLQAAAAASUVORK5CYII%3D</Image>
 [% END %]
diff --git a/template/en/default/search/search-report-select.html.tmpl b/template/en/default/search/search-report-select.html.tmpl
index de64787..4710d0f 100644
--- a/template/en/default/search/search-report-select.html.tmpl
+++ b/template/en/default/search/search-report-select.html.tmpl
@@ -26,7 +26,7 @@
# SECTION: REQ_47_REMOVE_REP_PLATFORM
 [% PROCESS "global/field-descs.none.tmpl" %]
 
 [% BLOCK select %]
-  [% rep_fields = ["classification", "product", "component", "version", "rep_platform",  
+  [% rep_fields = ["classification", "product", "component", "version", 
                    "op_sys", "bug_status", "resolution", "bug_severity", 
                    "priority", "target_milestone", "assigned_to",
                    "reporter", "qa_contact", "votes" ] %]
diff --git a/template/en/default/whine/mail.html.tmpl b/template/en/default/whine/mail.html.tmpl
index 44795a5..706b0b0 100644
--- a/template/en/default/whine/mail.html.tmpl
+++ b/template/en/default/whine/mail.html.tmpl
@@ -63,7 +63,6 @@
# SECTION: REQ_47_REMOVE_REP_PLATFORM
       <th align="left">ID</th>
       <th align="left">Sev</th>
       <th align="left">Pri</th>
-      <th align="left">Plt</th>
       <th align="left">Assignee</th>
       <th align="left">Status</th>
       <th align="left">Resolution</th>
diff --git a/userprefs.cgi b/userprefs.cgi
index 57bfcca..bc4bf78 100755
--- a/userprefs.cgi
+++ b/userprefs.cgi
@@ -27,6 +27,7 @@ use strict;
# SECTION: REQ_13_SELF_GLOBALWATCHING
 use lib qw(. lib);
 
 use Bugzilla;
+use Bugzilla::Config qw(:admin);
 use Bugzilla::Constants;
 use Bugzilla::Search;
 use Bugzilla::Util;
@@ -301,6 +302,16 @@ sub SaveEmail {
# SECTION: REQ_13_SELF_GLOBALWATCHING
 
     $dbh->bz_commit_transaction();
 
+    my @watchers = split(/[,\s]+/, Bugzilla->params->{'globalwatchers'});
+    if ($cgi->param('globalwatcher') && !$user->is_global_watcher) {
+        push(@watchers, $user->login);
+    }
+    elsif (!$cgi->param('globalwatcher') && $user->is_global_watcher) {
+        @watchers = grep { $_ ne $user->login } @watchers;
+    }
+    SetParam('globalwatchers', join(',', @watchers));
+    write_params();
+
     ###########################################################################
     # User watching
     ###########################################################################
-- 
1.9.3

